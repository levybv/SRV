create or replace package body srv.pkg_srv_calc_rem_var is

   /*-------------------------------------------------------------------------------------------------
   -- Author  : MICHELE.BETAZZI
   -- Created : 10/08/2011
   -- Purpose : Package processamento remuneracao variavel
   -- Alteracao : 01) SRV - Alterar a query de apuracao da SAX que cria a tabela SRV_REALZFU_EMP_SEG_SAX_yyyymm, que esta com erro
                      no processo pkg_srv_calc_rem_var.prc_calc_realz_fil_Lj
                  02) Alterar a package do SRV, na procedure PRC_CALC_ATING_FIL_LJ , dentro da condic?o :
                  elsif r_indic_rem_loja.descr_indic = 'COMPRA TRANQUILA ITAU' select qtde da tabela SRV_TMP_META_CPR_TRANQI_yyyymm , o campo "qtde" nao existe, entao renomear o campo do select para QTDE_VDS_PARC_PL_ITA.
   -- Chamado : 701871
   -- Autor   :  Alexandre Bezerra
   -- Data    :  17/12/2012

   -- Chamado   : 728806
   -- Autor     :  Alexandre Bezerra
   -- Data      :  11/01/2013
   -- Alteracao : Calculo de compras com juros itau e adicionado filtros  para compras PL (prod_cod not in (10,91,99))


   -- Chamado   : 943660,928687,799048,759756,735348,732968,724025,683946,683758,669066
   -- Autor     : Alexandre Bezerra
   -- Data      : 18/09/2013
   -- Alteracao : Referente ao chamados acima descritos para a GMUD 7870

   -- Alt201401 : Inibir a consistencia da data de inauguracao
   -- Autor     : Silvia Kimie Taira
   -- Data      : 16/04/2014

   -- Alt201402 : Incluir trava nos indicadores da SAX
   -- Autor     : Silvia Kimie Taira
   -- Data      : 02/05/2014

   -------------------------------------------------------------------------------------------------*/
   v_ins_log_erro                   varchar2(4000);
   -- email
   v_body                           varchar2(4000);
   v_send_email                     number;


   -----------------------------------------------------------------------------------------------
   -- CALCULA META FILIAL
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_meta_fil (p_cod_indic        in  number
                               ,p_cod_emp          in  number
                               ,p_cod_fil          in  number
                               ,p_ano_meta         in  number
                               ,p_mes_meta         in  number
                               ,p_meta             out number
                               ,p_cod_un_meta      out number
                               ,p_vlr_premio_fil   out number
                               ,p_pct_calc_meta    out number
                               ,p_cod_erro         out number
                               ,p_descr_erro       out varchar2
                               ) is


   begin

       -- meta da filial para o indicador
       begin
          select m.num_meta
                ,m.cod_un_meta
                ,m.vlr_premio_fil
                ,m.pct_calc_meta
            into p_meta
                ,p_cod_un_meta
                ,p_vlr_premio_fil
                ,p_pct_calc_meta
            from srv_meta_filial   m
           where m.cod_indic     = p_cod_indic
             and m.cod_emp       = p_cod_emp
             and m.cod_fil       = p_cod_fil
             and m.num_ano       = p_ano_meta
             and m.num_mes       = p_mes_meta;
       exception
          when no_data_found then
             p_cod_erro     := 1;
             p_descr_erro   := 'Erro ao selecionar meta. Meta nao encontrada - p_cod_indic: '|| p_cod_indic  ||
                               ' - p_cod_fil: '                         || p_cod_fil    ||
                               ' - p_ano: '                             || p_ano_meta    ||
                               ' - p_mes: '                             || p_mes_meta    ||
                               ' - erro: '                              || sqlerrm;

          when too_many_rows then
             p_cod_erro     := 2;
             p_descr_erro   := 'Erro ao selecionar meta. Mais de uma meta encontrada - p_cod_indic: '|| p_cod_indic  ||
                               ' - p_cod_fil: '                         || p_cod_fil    ||
                               ' - p_ano: '                             || p_ano_meta    ||
                               ' - p_mes: '                             || p_mes_meta    ||
                               ' - erro: '                              || sqlerrm;

          when others then
             p_cod_erro     := 3;
             p_descr_erro   := 'Erro ao selecionar meta - p_cod_indic: '|| p_cod_indic  ||
                               ' - p_cod_fil: '                         || p_cod_fil    ||
                               ' - p_ano: '                             || p_ano_meta    ||
                               ' - p_mes: '                             || p_mes_meta    ||
                               ' - erro: '                              || sqlerrm;
       end;

   exception
      when others then
         p_cod_erro     := 4;
         p_descr_erro   := 'Erro ao selecionar meta - p_cod_indic: '|| p_cod_indic  ||
                           ' - p_cod_fil: '                         || p_cod_fil    ||
                           ' - p_ano: '                             || p_ano_meta    ||
                           ' - p_mes: '                             || p_mes_meta    ||
                           ' - erro: '                              || sqlerrm;
   end prc_calc_meta_fil;



   -----------------------------------------------------------------------------------------------
   -- ATUALIZA META FILIAL
   -----------------------------------------------------------------------------------------------
   procedure prc_atualiza_meta_fil (p_cod_indic        in  number
                                   ,p_cod_emp          in  number
                                   ,p_cod_fil          in  number
                                   ,p_ano_meta         in  number
                                   ,p_mes_meta         in  number
                                   ,p_meta             in  number
                                   ,p_cod_un_meta      in  number
                                   ,p_cod_erro         out number
                                   ,p_descr_erro       out varchar2
                                   ) is

   begin

    -- atualizar meta calculada a partir do percentual da filial para os indicadores VJ e CT
       update srv_meta_filial   m
          set m.num_meta      = p_meta
             ,m.cod_un_meta   = p_cod_un_meta
        where m.cod_indic     = p_cod_indic
          and m.cod_emp       = p_cod_emp
          and m.cod_fil       = p_cod_fil
          and m.num_ano       = p_ano_meta
          and m.num_mes       = p_mes_meta;

      --
      commit;

   exception
      when others then
         p_cod_erro     := 4;
         p_descr_erro   := 'Erro ao atualizar meta calculada - p_cod_indic: '|| p_cod_indic  ||
                                    ' - p_cod_fil: '                         || p_cod_fil    ||
                                    ' - p_ano: '                             || p_ano_meta   ||
                                    ' - p_mes: '                             || p_mes_meta   ||
                                    ' - p_meta: '                            || p_meta       ||
                                    ' - erro: '                              || sqlerrm;
   end prc_atualiza_meta_fil;


   -----------------------------------------------------------------------------------------------
   -- CALCULA ESCALA FAIXA
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_escala_fx (p_cod_indic         in  number
                                ,p_cod_grp_indic     in  number
                                ,p_cod_grp_rem_var   in  number
                                ,p_num_realz_x_meta  in  number
                                ,p_cod_escala        out number
                                ,p_num_seq_escala_fx out number
                                ,p_num_realz_fx      out number
                                ,p_cod_un_realz_fx   out number
                                ,p_flg_pct_100       out varchar2
                                ,p_num_limite_fx     out number
                                ,p_cod_erro          out number
                                ,p_descr_erro        out varchar2
                                ) is
   begin
      begin
         select e.cod_escala
               ,e.num_seq_escala_fx
               ,e.num_realz_fx
               ,e.cod_un_realz_fx
               ,e.flg_pct_100
               ,e.num_limite_fx
           into p_cod_escala
               ,p_num_seq_escala_fx
               ,p_num_realz_fx
               ,p_cod_un_realz_fx
               ,p_flg_pct_100
               ,p_num_limite_fx
           from srv_escala                 a
               ,srv_grupo_indicador        b
               ,srv_grupo_rem_variavel     c
               ,srv_indicador              d
               ,srv_escala_faixa           e
           where a.cod_grp_indic   = b.cod_grp_indic   (+)
             and a.cod_grp_rem_var = c.cod_grp_rem_var (+)
             and a.cod_indic       = d.cod_indic       (+)
             and a.cod_escala      = e.cod_escala
             and ((a.cod_indic        is not null and a.cod_indic = p_cod_indic
                   and
                   a.cod_grp_indic    is null
                   and
                   a.cod_grp_rem_var  is null
                  ))
             and e.num_ini_fx <= p_num_realz_x_meta
             and e.num_fim_fx >= p_num_realz_x_meta
         order by a.cod_escala, e.num_seq_escala_fx;
      exception
         when no_data_found then
            begin
               select e.cod_escala
                     ,e.num_seq_escala_fx
                     ,e.num_realz_fx
                     ,e.cod_un_realz_fx
                     ,e.flg_pct_100
                     ,e.num_limite_fx
                 into p_cod_escala
                     ,p_num_seq_escala_fx
                     ,p_num_realz_fx
                     ,p_cod_un_realz_fx
                     ,p_flg_pct_100
                     ,p_num_limite_fx
                 from srv_escala                 a
                     ,srv_grupo_indicador        b
                     ,srv_grupo_rem_variavel     c
                     ,srv_indicador              d
                     ,srv_escala_faixa           e
                 where a.cod_grp_indic   = b.cod_grp_indic   (+)
                   and a.cod_grp_rem_var = c.cod_grp_rem_var (+)
                   and a.cod_indic       = d.cod_indic       (+)
                   and a.cod_escala      = e.cod_escala
                   and ((a.cod_grp_indic    is not null and a.cod_grp_indic = p_cod_grp_indic
                         and
                         a.cod_indic        is null
                         and
                         a.cod_grp_rem_var  is null
                        ))
                   and e.num_ini_fx <= p_num_realz_x_meta
                   and e.num_fim_fx >= p_num_realz_x_meta
              order by a.cod_escala, e.num_seq_escala_fx;
            exception
               when no_data_found then
                  begin
                     select e.cod_escala
                           ,e.num_seq_escala_fx
                           ,e.num_realz_fx
                           ,e.cod_un_realz_fx
                           ,e.flg_pct_100
                           ,e.num_limite_fx
                       into p_cod_escala
                           ,p_num_seq_escala_fx
                           ,p_num_realz_fx
                           ,p_cod_un_realz_fx
                           ,p_flg_pct_100
                           ,p_num_limite_fx
                       from srv_escala                 a
                           ,srv_grupo_indicador        b
                           ,srv_grupo_rem_variavel     c
                           ,srv_indicador              d
                           ,srv_escala_faixa           e
                       where a.cod_grp_indic   = b.cod_grp_indic   (+)
                         and a.cod_grp_rem_var = c.cod_grp_rem_var (+)
                         and a.cod_indic       = d.cod_indic       (+)
                         and a.cod_escala      = e.cod_escala
                         and ((a.cod_grp_rem_var  is not null and a.cod_grp_rem_var = p_cod_grp_rem_var
                               and
                               a.cod_indic        is null
                               and
                               a.cod_grp_indic    is null
                              ))
                         and e.num_ini_fx <= p_num_realz_x_meta
                         and e.num_fim_fx >= p_num_realz_x_meta
                    order by a.cod_escala, e.num_seq_escala_fx;
                  --
                  exception
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao selecionar escala - p_cod_indic: '|| p_cod_indic        ||
                                          ' - p_grp_indic: '                         || p_cod_grp_indic    ||
                                          ' - p_cod_grp_rem_var: '                   || p_cod_grp_rem_var  ||
                                          ' - p_num_realz_x_meta: '                  || p_num_realz_x_meta ||
                                          ' - erro: '                                || sqlerrm;
                  end;
            end;
      end;
   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro ao selecionar escala - p_cod_indic: '|| p_cod_indic        ||
                           ' - p_grp_indic: '                         || p_cod_grp_indic    ||
                           ' - p_cod_grp_rem_var: '                   || p_cod_grp_rem_var  ||
                           ' - p_num_realz_x_meta: '                  || p_num_realz_x_meta ||
                           ' - erro: '                                || sqlerrm;
   end prc_calc_escala_fx;




   -----------------------------------------------------------------------------------------------
   -- CALCULA ESCALA FAIXA PARA O GRUPO CORPORATIVO
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_escala_fx_corp (p_indicador                   in number
                                     ,p_cod_escala                  in number
                                     ,p_num_realz_x_meta            in  number
                                     ,p_num_seq_escala_fx           out number
                                     ,p_num_realz_fx                out number
                                     ,p_cod_un_realz_fx             out number
                                     ,p_flg_pct_100                 out varchar2
                                     ,p_num_limite_fx               out number
                                     ,p_cod_erro                    out number
                                     ,p_descr_erro                  out varchar2
                                     ) is

   begin
      --
      select c.num_seq_escala_fx
            ,c.num_realz_fx
            ,c.cod_un_realz_fx
            ,c.flg_pct_100
            ,c.num_limite_fx
        into p_num_seq_escala_fx
            ,p_num_realz_fx
            ,p_cod_un_realz_fx
            ,p_flg_pct_100
            ,p_num_limite_fx
        from srv_escala                 b
            ,srv_escala_faixa           c
        where b.cod_escala      = c.cod_escala
          and b.cod_escala      = p_cod_escala
          and c.num_ini_fx     <= p_num_realz_x_meta
          and c.num_fim_fx     >= p_num_realz_x_meta
      order by c.cod_escala
              ,c.num_seq_escala_fx;

   exception
      when no_data_found then
         p_cod_erro     := 1;
         p_descr_erro   := 'Escala nao encontrada ' ||
                           ' - p_indicador: '                        || p_indicador        ||
                           ' - p_cod_escala: '                       || p_cod_escala       ||
                           ' - p_num_realz_x_meta: '                 || p_num_realz_x_meta ||
                           ' - erro: '                               || sqlerrm;

      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro ao selecionar escala  '              ||
                           ' - p_indicador: '                         || p_indicador        ||
                           ' - p_cod_escala: '                        || p_cod_escala       ||
                           ' - p_num_realz_x_meta: '                  || p_num_realz_x_meta ||
                           ' - erro: '                                || sqlerrm;

   end prc_calc_escala_fx_corp;

   -----------------------------------------------------------------------------------------------
   -- CALCULA PONDERACAO
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_ponderacao (p_cod_indic         in  number
                                 ,p_cod_grp_indic     in  number
                                 ,p_cod_cargo         in  number
                                 ,p_cod_grp_rem_var   in  number
                                 ,p_cod_pond          out number
                                 ,p_num_peso          out number
                                 ,p_cod_un_peso       out number
                                 ,p_vlr_premio        out number
                                 ,p_cod_erro          out number
                                 ,p_descr_erro        out varchar2
                                 ) is
   begin
      begin
         -- selecionar a ponderacao para o cargo e para o indicador
         select p.cod_pond
               ,p.num_peso
               ,p.cod_un_peso
               ,p.vlr_premio
           into p_cod_pond
               ,p_num_peso
               ,p_cod_un_peso
               ,p_vlr_premio
           from srv_ponderacao       p
          where (p.cod_grp_rem_var = p_cod_grp_rem_var or p_cod_grp_rem_var is null)
            and (p.cod_cargo       = p_cod_cargo       or p_cod_cargo       is null)
            and (p.cod_grp_indic   = p_cod_grp_indic   or p_cod_grp_indic   is null)
            and (p.cod_indic       = p_cod_indic       or p_cod_indic       is null);

      exception
         when no_data_found then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro na proc prc_calc_ponderacao - ponderacao nao encontrada : '     ||
                              'cargo - '                           || p_cod_cargo       || ', ' ||
                              'grp rem var - '                     || p_cod_grp_rem_var || ', ' ||
                              'grp indicador - '                   || p_cod_grp_indic   || ', ' ||
                              'indicador - '                       || p_cod_indic       || ', ' ||
                              'erro - '                            || sqlerrm;
            --
            p_cod_pond      := null;
            p_num_peso      := 0;
            p_cod_un_peso   := null;
            p_vlr_premio    := 0;

         when too_many_rows then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro na proc prc_calc_ponderacao - ponderacao - mais de uma linha retornada : ' ||
                              'cargo - '                           || p_cod_cargo       || ', ' ||
                              'grp rem var - '                     || p_cod_grp_rem_var || ', ' ||
                              'grp indicador - '                   || p_cod_grp_indic   || ', ' ||
                              'indicador - '                       || p_cod_indic       || ', ' ||
                              'erro - '                            || sqlerrm;
            --
            p_cod_pond      := null;
            p_num_peso      := 0;
            p_cod_un_peso   := null;
            p_vlr_premio    := 0;
      end;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro na proc prc_calc_ponderacao - ponderacao - erro geral : '||
                           'cargo - '                           || p_cod_cargo       || ', ' ||
                           'grp rem var - '                     || p_cod_grp_rem_var || ', ' ||
                           'grp indicador - '                   || p_cod_grp_indic   || ', ' ||
                           'indicador - '                       || p_cod_indic       || ', ' ||
                           'erro - '                            || sqlerrm;
         --
         p_cod_pond      := null;
         p_num_peso      := 0;
         p_cod_un_peso   := null;
         p_vlr_premio    := 0;

   end prc_calc_ponderacao;



   -----------------------------------------------------------------------------------------------
   -- CALCULA PONDERACAO POR TIPO FILIAL OU FILIAL
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_ponderacao_tp_fil (p_cod_indic         in  number
                                        ,p_cod_grp_indic     in  number
                                        ,p_cod_cargo         in  number
                                        ,p_cod_grp_rem_var   in  number
                                        ,p_cod_tipo_fil      in  number
                                        ,p_cod_emp           in  number
                                        ,p_cod_fil           in  number
                                        ,p_cod_pond          out number
                                        ,p_num_peso          out number
                                        ,p_cod_un_peso       out number
                                        ,p_vlr_premio        out number
                                        ,p_cod_erro          out number
                                        ,p_descr_erro        out varchar2
                                        ) is
   begin
      begin
         -- primeiro tenta selecionar a ponderacao para o cargo, indicador/grupo
         -- e para a filial
         select p.cod_pond
               ,p.num_peso
               ,p.cod_un_peso
               ,p.vlr_premio
           into p_cod_pond
               ,p_num_peso
               ,p_cod_un_peso
               ,p_vlr_premio
           from srv_ponderacao       p
          where (p.cod_cargo       = p_cod_cargo       or p_cod_cargo       is null)
            and (p.cod_grp_indic   = p_cod_grp_indic   or p_cod_grp_indic   is null)
            and (p.cod_indic       = p_cod_indic       or p_cod_indic       is null)
            and (p.cod_fil         = p_cod_fil         or p_cod_fil         is null);
      exception
         when others then
            begin
               -- tenta a ponderacao para o grp rem var, indicador/grupo
               -- e para a filial
               select p.cod_pond
                     ,p.num_peso
                     ,p.cod_un_peso
                     ,p.vlr_premio
                 into p_cod_pond
                     ,p_num_peso
                     ,p_cod_un_peso
                     ,p_vlr_premio
                 from srv_ponderacao       p
                where (p.cod_grp_rem_var = p_cod_grp_rem_var or p_cod_grp_rem_var is null)
                  and (p.cod_grp_indic   = p_cod_grp_indic   or p_cod_grp_indic   is null)
                  and (p.cod_indic       = p_cod_indic       or p_cod_indic       is null)
                  and (p.cod_fil         = p_cod_fil         or p_cod_fil         is null);
            exception
               when others then
                  begin
                     -- tenta a ponderacao para o cargo, indicador/grupo
                     -- e para o TIPO filial
                     select p.cod_pond
                           ,p.num_peso
                           ,p.cod_un_peso
                           ,p.vlr_premio
                       into p_cod_pond
                           ,p_num_peso
                           ,p_cod_un_peso
                           ,p_vlr_premio
                       from srv_ponderacao       p
                      where (p.cod_cargo       = p_cod_cargo       or p_cod_cargo       is null)
                        and (p.cod_grp_indic   = p_cod_grp_indic   or p_cod_grp_indic   is null)
                        and (p.cod_indic       = p_cod_indic       or p_cod_indic       is null)
                        and (p.cod_tipo_fil    = p_cod_tipo_fil    or p_cod_tipo_fil    is null);
                  exception
                     when others then
                        begin
                           -- tenta a ponderacao para o grp rem var, indicador/grupo
                           -- e para o TIPO filial
                           select p.cod_pond
                                 ,p.num_peso
                                 ,p.cod_un_peso
                                 ,p.vlr_premio
                             into p_cod_pond
                                 ,p_num_peso
                                 ,p_cod_un_peso
                                 ,p_vlr_premio
                             from srv_ponderacao       p
                            where (p.cod_grp_rem_var = p_cod_grp_rem_var or p_cod_grp_rem_var is null)
                              and (p.cod_grp_indic   = p_cod_grp_indic   or p_cod_grp_indic   is null)
                              and (p.cod_indic       = p_cod_indic       or p_cod_indic       is null)
                              and (p.cod_tipo_fil    = p_cod_tipo_fil    or p_cod_tipo_fil    is null);
                        exception
                           when no_data_found then
                              p_cod_erro     := 1;
                              p_descr_erro   := 'Erro na proc prc_calc_ponderacao_tp_fil - ponderacao nao encontrada : ' ||
                                                'cargo - '                           || p_cod_cargo       || ',  ' ||
                                                'grp rem var - '                     || p_cod_grp_rem_var || ',  ' ||
                                                'grp indicador - '                   || p_cod_grp_indic   || ',  ' ||
                                                'indicador - '                       || p_cod_indic       || ',  ' ||
                                                'tipo fil - '                        || p_cod_tipo_fil    || ',  ' ||
                                                'filial - '                          || p_cod_fil         || ',  ' ||
                                                'erro - '                            || sqlerrm;
                              --
                              p_cod_pond      := null;
                              p_num_peso      := 0;
                              p_cod_un_peso   := null;
                              p_vlr_premio    := 0;
                           --
                           when too_many_rows then
                              p_cod_erro     := 1;
                              p_descr_erro   := 'Erro na proc prc_calc_ponderacao_tp_fil - ponderacao mais de uma linha retornada : ' ||
                                                'cargo - '                           || p_cod_cargo       || ',  ' ||
                                                'grp rem var - '                     || p_cod_grp_rem_var || ',  ' ||
                                                'grp indicador - '                   || p_cod_grp_indic   || ',  ' ||
                                                'indicador - '                       || p_cod_indic       || ',  ' ||
                                                'tipo fil - '                        || p_cod_tipo_fil    || ',  ' ||
                                                'filial - '                          || p_cod_fil         || ',  ' ||
                                                'erro - '                            || sqlerrm;
                              --
                              p_cod_pond      := null;
                              p_num_peso      := 0;
                              p_cod_un_peso   := null;
                              p_vlr_premio    := 0;

                        end;
                  end;
            end;
      end;
   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro na proc prc_calc_ponderacao_tp_fil - ponderacao - erro geral: ' ||
                           'cargo - '                           || p_cod_cargo       || ',  ' ||
                           'grp rem var - '                     || p_cod_grp_rem_var || ',  ' ||
                           'grp indicador - '                   || p_cod_grp_indic   || ',  ' ||
                           'indicador - '                       || p_cod_indic       || ',  ' ||
                           'tipo fil - '                        || p_cod_tipo_fil    || ',  ' ||
                           'filial - '                          || p_cod_fil         || ',  ' ||
                           'erro - '                            || sqlerrm;
         --
         p_cod_pond      := null;
         p_num_peso      := 0;
         p_cod_un_peso   := null;
         p_vlr_premio    := 0;

   end prc_calc_ponderacao_tp_fil;

   -----------------------------------------------------------------------------------------------
   -- CALCULA PONDERACAO POR TIPO FILIAL OU FILIAL
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_ponderacao_tp_fil2 (p_cod_indic         in  number
                                        ,p_cod_grp_indic     in  number
                                        ,p_cod_cargo         in  number
                                        ,p_cod_grp_rem_var   in  number
                                        ,p_cod_tipo_fil      in  number
                                        ,p_cod_emp           in  number
                                        ,p_cod_fil           in  number
                                        ,p_cod_pond          out number
                                        ,p_num_peso          out number
                                        ,p_cod_un_peso       out number
                                        ,p_vlr_premio        out number
                                        ,p_cod_erro          out number
                                        ,p_descr_erro        out varchar2
                                        ) is
   begin

     -- primeiro tenta selecionar a ponderacao para o cargo, indicador/grupo
     -- e para a filial
     select p.cod_pond
           ,p.num_peso
           ,p.cod_un_peso
           ,p.vlr_premio
       into p_cod_pond
           ,p_num_peso
           ,p_cod_un_peso
           ,p_vlr_premio
       from srv_ponderacao p
      where p.cod_cargo    = p_cod_cargo
        and p.cod_indic    = p_cod_indic
        and p.cod_tipo_fil = p_cod_tipo_fil;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro na proc prc_calc_ponderacao_tp_fil - ponderacao - erro geral: ' ||
                           'cargo - '                           || p_cod_cargo       || ',  ' ||
                           'grp rem var - '                     || p_cod_grp_rem_var || ',  ' ||
                           'grp indicador - '                   || p_cod_grp_indic   || ',  ' ||
                           'indicador - '                       || p_cod_indic       || ',  ' ||
                           'tipo fil - '                        || p_cod_tipo_fil    || ',  ' ||
                           'filial - '                          || p_cod_fil         || ',  ' ||
                           'erro - '                            || sqlerrm;
         --
         p_cod_pond      := null;
         p_num_peso      := 0;
         p_cod_un_peso   := null;
         p_vlr_premio    := 0;

   end prc_calc_ponderacao_tp_fil2;

   -----------------------------------------------------------------------------------------------
   -- CALCULA PONDERACAO CORPORATIVO
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_ponderacao_corp (p_cod_indic         in  number
                                      ,p_cod_grp_indic     in  number
                                      ,p_cod_cargo         in  number
                                      ,p_cod_grp_rem_var   in  number
                                      ,p_cod_pond          out number
                                      ,p_num_peso          out number
                                      ,p_cod_un_peso       out number
                                      ,p_vlr_premio        out number
                                      ,p_cod_erro          out number
                                      ,p_descr_erro        out varchar2
                                      ) is
   begin
      begin
         -- selecionar a ponderacao
         select p.cod_pond
               ,p.num_peso
               ,p.cod_un_peso
               ,p.vlr_premio
           into p_cod_pond
               ,p_num_peso
               ,p_cod_un_peso
               ,p_vlr_premio
           from srv_ponderacao       p
          where (p.cod_indic = p_cod_indic and p.cod_cargo = p_cod_cargo);
      exception
         when no_data_found then
            begin
               select p.cod_pond
                     ,p.num_peso
                     ,p.cod_un_peso
                     ,p.vlr_premio
                 into p_cod_pond
                     ,p_num_peso
                     ,p_cod_un_peso
                     ,p_vlr_premio
                 from srv_ponderacao       p
                where (p.cod_indic = p_cod_indic and p.cod_grp_rem_var = p_cod_grp_rem_var);

            exception
               when no_data_found then
                  begin
                     select p.cod_pond
                           ,p.num_peso
                           ,p.cod_un_peso
                           ,p.vlr_premio
                       into p_cod_pond
                           ,p_num_peso
                           ,p_cod_un_peso
                           ,p_vlr_premio
                       from srv_ponderacao       p
                      where (p.cod_grp_indic = p_cod_grp_indic and p.cod_cargo = p_cod_cargo);
                  exception
                     when no_data_found then
                        begin
                           select p.cod_pond
                                 ,p.num_peso
                                 ,p.cod_un_peso
                                 ,p.vlr_premio
                             into p_cod_pond
                                 ,p_num_peso
                                 ,p_cod_un_peso
                                 ,p_vlr_premio
                             from srv_ponderacao       p
                            where (p.cod_grp_indic = p_cod_grp_indic and p.cod_grp_rem_var = p_cod_grp_rem_var);
                        exception
                           when no_data_found then
                              p_cod_erro     := 1;
                              p_descr_erro   := 'Erro na proc prc_calc_ponderacao_corp - ponderacao nao encontrada: ' ||
                                                ' - cargo: '                           || p_cod_cargo       || ', ' ||
                                                ' - grp rem var: '                     || p_cod_grp_rem_var || ', ' ||
                                                ' - grp indicador: '                   || p_cod_grp_indic   || ', ' ||
                                                ' - indicador: '                       || p_cod_indic       || ', ' ||
                                                ' - erro: '                            || sqlerrm;
                              --
                              p_cod_pond      := null;
                              p_num_peso      := 0;
                              p_cod_un_peso   := null;
                              p_vlr_premio    := 0;
                        end;
                  end;
            end;
         when too_many_rows then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro na proc prc_calc_ponderacao_corp - ponderacao mais de uma linha retornada : ' ||
                              ' - cargo: '                           || p_cod_cargo       || ', ' ||
                              ' - grp rem var: '                     || p_cod_grp_rem_var || ', ' ||
                              ' - grp indicador: '                   || p_cod_grp_indic   || ', ' ||
                              ' - indicador: '                       || p_cod_indic       || ', ' ||
                              ' - erro: '                            || sqlerrm;
            --
            p_cod_pond      := null;
            p_num_peso      := 0;
            p_cod_un_peso   := null;
            p_vlr_premio    := 0;

         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro na proc prc_calc_ponderacao_corp - ponderacao - erro geral 1 : ' ||
                              ' - cargo: '                           || p_cod_cargo       || ', ' ||
                              ' - grp rem var: '                     || p_cod_grp_rem_var || ', ' ||
                              ' - grp indicador: '                   || p_cod_grp_indic   || ', ' ||
                              ' - indicador: '                       || p_cod_indic       || ', ' ||
                              ' - erro: '                            || sqlerrm;
            --
            p_cod_pond      := null;
            p_num_peso      := 0;
            p_cod_un_peso   := null;
            p_vlr_premio    := 0;

      end;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro na proc prc_calc_ponderacao_corp - ponderacao - erro geral 2 : ' ||
                           ' - cargo: '                           || p_cod_cargo       || ', ' ||
                           ' - grp rem var: '                     || p_cod_grp_rem_var || ', ' ||
                           ' - grp indicador: '                   || p_cod_grp_indic   || ', ' ||
                           ' - indicador: '                       || p_cod_indic       || ', ' ||
                           ' - erro: '                            || sqlerrm;
         --
         p_cod_pond      := null;
         p_num_peso      := 0;
         p_cod_un_peso   := null;
         p_vlr_premio    := 0;

   end prc_calc_ponderacao_corp;


   -----------------------------------------------------------------------------------------------
   -- INSERE REALIZADO FILIAL
   -----------------------------------------------------------------------------------------------
   procedure prc_insere_realz_fil (p_rec_srv_realz_fil  in  srv_realizado_filial%rowtype
                                  ,p_cod_erro           out number
                                  ,p_descr_erro         out varchar2
                                  ) is

      --
      rec_srv_realizado_filial_hist    srv_realizado_filial_hist%rowtype;

   begin

      -----------------------------------------------------
      -- insere o realizado da filial na tabela
      -----------------------------------------------------
      begin
         insert into srv_realizado_filial
                     (cod_indic
                     ,cod_emp
                     ,cod_fil
                     ,num_ano
                     ,num_mes
                     ,num_meta
                     ,cod_un_meta
                     ,num_realz
                     ,cod_un_realz
                     ,qtd_realz
                     ,num_realz_x_meta
                     ,cod_un_realz_x_meta
                     ,vlr_premio_fil_calc
                     ,cod_un_premio_fil_calc
                     ,dt_ini_sit_srv
                     ,cod_usuario
                     ,cod_escala
                     ,num_seq_escala_fx
                     ,num_realz_fx
                     ,cod_un_realz_fx
                     )
              values (p_rec_srv_realz_fil.cod_indic
                     ,p_rec_srv_realz_fil.cod_emp
                     ,p_rec_srv_realz_fil.cod_fil
                     ,p_rec_srv_realz_fil.num_ano
                     ,p_rec_srv_realz_fil.num_mes
                     ,p_rec_srv_realz_fil.num_meta
                     ,p_rec_srv_realz_fil.cod_un_meta
                     ,p_rec_srv_realz_fil.num_realz
                     ,p_rec_srv_realz_fil.cod_un_realz
                     ,p_rec_srv_realz_fil.qtd_realz
                     ,p_rec_srv_realz_fil.num_realz_x_meta
                     ,p_rec_srv_realz_fil.cod_un_realz_x_meta
                     ,p_rec_srv_realz_fil.vlr_premio_fil_calc
                     ,p_rec_srv_realz_fil.cod_un_premio_fil_calc
                     ,p_rec_srv_realz_fil.dt_ini_sit_srv
                     ,p_rec_srv_realz_fil.cod_usuario
                     ,p_rec_srv_realz_fil.cod_escala
                     ,p_rec_srv_realz_fil.num_seq_escala_fx
                     ,p_rec_srv_realz_fil.num_realz_fx
                     ,p_rec_srv_realz_fil.cod_un_realz_fx
                    );
      --
      exception
         when dup_val_on_index then

            -- se ja existir a apuracao inserir o registro que ja existe na tabela de historico
            -- e gravar o calculado na tabela original
            begin
               --
               select  cod_indic
                      ,cod_emp
                      ,cod_fil
                      ,num_ano
                      ,num_mes
                      ,num_meta
                      ,cod_un_meta
                      ,num_realz
                      ,cod_un_realz
                      ,qtd_realz
                      ,num_realz_x_meta
                      ,cod_un_realz_x_meta
                      ,vlr_premio_fil_calc
                      ,cod_un_premio_fil_calc
                      ,dt_ini_sit_srv
                      ,cod_usuario
                      ,cod_escala
                      ,num_seq_escala_fx
                      ,num_realz_fx
                      ,cod_un_realz_fx
                 into  rec_srv_realizado_filial_hist.cod_indic
                      ,rec_srv_realizado_filial_hist.cod_emp
                      ,rec_srv_realizado_filial_hist.cod_fil
                      ,rec_srv_realizado_filial_hist.num_ano
                      ,rec_srv_realizado_filial_hist.num_mes
                      ,rec_srv_realizado_filial_hist.num_meta
                      ,rec_srv_realizado_filial_hist.cod_un_meta
                      ,rec_srv_realizado_filial_hist.num_realz
                      ,rec_srv_realizado_filial_hist.cod_un_realz
                      ,rec_srv_realizado_filial_hist.qtd_realz
                      ,rec_srv_realizado_filial_hist.num_realz_x_meta
                      ,rec_srv_realizado_filial_hist.cod_un_realz_x_meta
                      ,rec_srv_realizado_filial_hist.vlr_premio_fil_calc
                      ,rec_srv_realizado_filial_hist.cod_un_premio_fil_calc
                      ,rec_srv_realizado_filial_hist.dt_ini_sit_srv
                      ,rec_srv_realizado_filial_hist.cod_usuario
                      ,rec_srv_realizado_filial_hist.cod_escala
                      ,rec_srv_realizado_filial_hist.num_seq_escala_fx
                      ,rec_srv_realizado_filial_hist.num_realz_fx
                      ,rec_srv_realizado_filial_hist.cod_un_realz_fx
                  from srv_realizado_filial
                 where cod_indic            = p_rec_srv_realz_fil.cod_indic
                   and cod_emp              = p_rec_srv_realz_fil.cod_emp
                   and cod_fil              = p_rec_srv_realz_fil.cod_fil
                   and num_ano              = p_rec_srv_realz_fil.num_ano
                   and num_mes              = p_rec_srv_realz_fil.num_mes;

               if sql%rowcount > 0 then
                  --------------------------------------------------------------
                  -- insere registro no historico
                  --------------------------------------------------------------
                  insert into srv_realizado_filial_hist
                             (cod_indic
                             ,cod_emp
                             ,cod_fil
                             ,num_ano
                             ,num_mes
                             ,num_meta
                             ,cod_un_meta
                             ,num_realz
                             ,cod_un_realz
                             ,qtd_realz
                             ,num_realz_x_meta
                             ,cod_un_realz_x_meta
                             ,vlr_premio_fil_calc
                             ,cod_un_premio_fil_calc
                             ,dt_ini_sit_srv
                             ,cod_usuario
                             ,cod_escala
                             ,num_seq_escala_fx
                             ,num_realz_fx
                             ,cod_un_realz_fx
                             )
                      values (rec_srv_realizado_filial_hist.cod_indic
                             ,rec_srv_realizado_filial_hist.cod_emp
                             ,rec_srv_realizado_filial_hist.cod_fil
                             ,rec_srv_realizado_filial_hist.num_ano
                             ,rec_srv_realizado_filial_hist.num_mes
                             ,rec_srv_realizado_filial_hist.num_meta
                             ,rec_srv_realizado_filial_hist.cod_un_meta
                             ,rec_srv_realizado_filial_hist.num_realz
                             ,rec_srv_realizado_filial_hist.cod_un_realz
                             ,rec_srv_realizado_filial_hist.qtd_realz
                             ,rec_srv_realizado_filial_hist.num_realz_x_meta
                             ,rec_srv_realizado_filial_hist.cod_un_realz_x_meta
                             ,rec_srv_realizado_filial_hist.vlr_premio_fil_calc
                             ,rec_srv_realizado_filial_hist.cod_un_premio_fil_calc
                             ,rec_srv_realizado_filial_hist.dt_ini_sit_srv
                             ,rec_srv_realizado_filial_hist.cod_usuario
                             ,rec_srv_realizado_filial_hist.cod_escala
                             ,rec_srv_realizado_filial_hist.num_seq_escala_fx
                             ,rec_srv_realizado_filial_hist.num_realz_fx
                             ,rec_srv_realizado_filial_hist.cod_un_realz_fx
                             );

                  ----------------------------------------------------------------
                  -- atualiza o registro da tabela original
                  ----------------------------------------------------------------
                  update srv_realizado_filial
                     set num_meta                 = p_rec_srv_realz_fil.num_meta
                        ,cod_un_meta              = p_rec_srv_realz_fil.cod_un_meta
                        ,num_realz                = p_rec_srv_realz_fil.num_realz
                        ,cod_un_realz             = p_rec_srv_realz_fil.cod_un_realz
                        ,qtd_realz                = p_rec_srv_realz_fil.qtd_realz
                        ,num_realz_x_meta         = p_rec_srv_realz_fil.num_realz_x_meta
                        ,cod_un_realz_x_meta      = p_rec_srv_realz_fil.cod_un_realz_x_meta
                        ,vlr_premio_fil_calc      = p_rec_srv_realz_fil.vlr_premio_fil_calc
                        ,cod_un_premio_fil_calc   = p_rec_srv_realz_fil.cod_un_premio_fil_calc
                        ,dt_ini_sit_srv           = p_rec_srv_realz_fil.dt_ini_sit_srv
                        ,cod_usuario              = p_rec_srv_realz_fil.cod_usuario
                        ,cod_escala               = p_rec_srv_realz_fil.cod_escala
                        ,num_seq_escala_fx        = p_rec_srv_realz_fil.num_seq_escala_fx
                        ,num_realz_fx             = p_rec_srv_realz_fil.num_realz_fx
                        ,cod_un_realz_fx          = p_rec_srv_realz_fil.cod_un_realz_fx
                   --
                   where cod_indic                = p_rec_srv_realz_fil.cod_indic
                     and cod_emp                  = p_rec_srv_realz_fil.cod_emp
                     and cod_fil                  = p_rec_srv_realz_fil.cod_fil
                     and num_ano                  = p_rec_srv_realz_fil.num_ano
                     and num_mes                  = p_rec_srv_realz_fil.num_mes;
               --
               else
                  p_cod_erro     := 1;
                  p_descr_erro   := 'Erro ao selecionar realz fil p/ inserir no hist - reg nao encontrado ' ||
                                    ' - p_cod_indic: '                                   || p_rec_srv_realz_fil.cod_indic ||
                                    ' - p_cod_fil: '                                     || p_rec_srv_realz_fil.cod_fil   ||
                                    ' - erro: '                                          || sqlerrm;
               end if;
            exception
               when others then
                  p_cod_erro     := 1;
                  p_descr_erro   := 'Erro ao selecionar e atualizar realz fil no hist - p_cod_indic: '|| p_rec_srv_realz_fil.cod_indic ||
                                    ' - p_cod_fil: '                                                  || p_rec_srv_realz_fil.cod_fil   ||
                                    ' - erro: '                                                       || sqlerrm;
            end;
         --
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro geral ao inserir realizado filial - p_cod_indic: '|| p_rec_srv_realz_fil.cod_indic ||
                              ' - p_cod_fil: '                                        || p_rec_srv_realz_fil.cod_fil   ||
                              ' - erro: '                                             || sqlerrm;
      end;


      --
      commit;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na proc prc_insere_realz_fil - p_cod_indic: '|| p_rec_srv_realz_fil.cod_indic ||
                           ' - p_cod_fil: '                                         || p_rec_srv_realz_fil.cod_fil   ||
                           ' - erro: '                                              || sqlerrm;
   end prc_insere_realz_fil;






   -----------------------------------------------------------------------------------------------
   -- INSERE REALIZADO FUNCIONARIO INDICADOR
   -----------------------------------------------------------------------------------------------
   procedure prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  in  srv_realizado_func_indicador%rowtype
                                         ,p_cod_erro                  out number
                                         ,p_descr_erro                out varchar2
                                         ) is

      --
      rec_srv_realz_func_indic_hist    srv_realz_func_indic_hist%rowtype;

   begin

      ------------------------------------------------------------------------------
      -- insere o realizado do funcionario pelo indicador e filial na tabela
      ------------------------------------------------------------------------------
      begin
         insert into srv_realizado_func_indicador
                     (cod_func
                     ,cod_indic
                     ,cod_emp
                     ,cod_fil
                     ,num_ano
                     ,num_mes
                     ,cod_escala
                     ,num_seq_escala_fx
                     ,num_realz_fx
                     ,cod_un_realz_fx
                     ,cod_pond
                     ,num_peso
                     ,cod_un_peso
                     ,num_realz_pond
                     ,cod_un_realz_pond
                     ,num_meta
                     ,cod_un_meta
                     ,num_realz
                     ,cod_un_realz
                     ,num_realz_x_meta
                     ,cod_un_realz_x_meta
                     ,vlr_premio
                     ,vlr_premio_func_calc
                     ,cod_un_vlr_premio_func_calc
                     ,pct_calc_rateio
                     ,dt_ini_sit_srv
                     ,cod_usuario
                     ,vlr_desc_indicacao
                     ,descr_meta
                     ,cod_cargo
                     ,sta_calc_realz
                     ,qtd_desc_indicacao
                     )
              values (p_rec_srv_realz_func_indic.cod_func
                     ,p_rec_srv_realz_func_indic.cod_indic
                     ,p_rec_srv_realz_func_indic.cod_emp
                     ,p_rec_srv_realz_func_indic.cod_fil
                     ,p_rec_srv_realz_func_indic.num_ano
                     ,p_rec_srv_realz_func_indic.num_mes
                     ,p_rec_srv_realz_func_indic.cod_escala
                     ,p_rec_srv_realz_func_indic.num_seq_escala_fx
                     ,p_rec_srv_realz_func_indic.num_realz_fx
                     ,p_rec_srv_realz_func_indic.cod_un_realz_fx
                     ,p_rec_srv_realz_func_indic.cod_pond
                     ,p_rec_srv_realz_func_indic.num_peso
                     ,p_rec_srv_realz_func_indic.cod_un_peso
                     ,p_rec_srv_realz_func_indic.num_realz_pond
                     ,p_rec_srv_realz_func_indic.cod_un_realz_pond
                     ,p_rec_srv_realz_func_indic.num_meta
                     ,p_rec_srv_realz_func_indic.cod_un_meta
                     ,p_rec_srv_realz_func_indic.num_realz
                     ,p_rec_srv_realz_func_indic.cod_un_realz
                     ,p_rec_srv_realz_func_indic.num_realz_x_meta
                     ,p_rec_srv_realz_func_indic.cod_un_realz_x_meta
                     ,p_rec_srv_realz_func_indic.vlr_premio
                     ,p_rec_srv_realz_func_indic.vlr_premio_func_calc
                     ,p_rec_srv_realz_func_indic.cod_un_vlr_premio_func_calc
                     ,p_rec_srv_realz_func_indic.pct_calc_rateio
                     ,p_rec_srv_realz_func_indic.dt_ini_sit_srv
                     ,p_rec_srv_realz_func_indic.cod_usuario
                     ,p_rec_srv_realz_func_indic.vlr_desc_indicacao
                     ,p_rec_srv_realz_func_indic.descr_meta
                     ,p_rec_srv_realz_func_indic.cod_cargo
                     ,p_rec_srv_realz_func_indic.sta_calc_realz
                     ,p_rec_srv_realz_func_indic.qtd_desc_indicacao
                    );
      --
      exception
         when dup_val_on_index then

            -- se ja existir a apuracao inserir o registro que ja existe na tabela de historico
            -- e gravar o calculado na tabela original
            begin
               --
               select cod_func
                     ,cod_indic
                     ,cod_emp
                     ,cod_fil
                     ,num_ano
                     ,num_mes
                     ,cod_escala
                     ,num_seq_escala_fx
                     ,num_realz_fx
                     ,cod_un_realz_fx
                     ,cod_pond
                     ,num_peso
                     ,cod_un_peso
                     ,num_realz_pond
                     ,cod_un_realz_pond
                     ,num_meta
                     ,cod_un_meta
                     ,num_realz
                     ,cod_un_realz
                     ,num_realz_x_meta
                     ,cod_un_realz_x_meta
                     ,vlr_premio
                     ,vlr_premio_func_calc
                     ,cod_un_vlr_premio_func_calc
                     ,pct_calc_rateio
                     ,dt_ini_sit_srv
                     ,cod_usuario
                     ,vlr_desc_indicacao
                     ,descr_meta
                     ,cod_cargo
                     ,sta_calc_realz
                     ,qtd_desc_indicacao
                into  rec_srv_realz_func_indic_hist.cod_func
                     ,rec_srv_realz_func_indic_hist.cod_indic
                     ,rec_srv_realz_func_indic_hist.cod_emp
                     ,rec_srv_realz_func_indic_hist.cod_fil
                     ,rec_srv_realz_func_indic_hist.num_ano
                     ,rec_srv_realz_func_indic_hist.num_mes
                     ,rec_srv_realz_func_indic_hist.cod_escala
                     ,rec_srv_realz_func_indic_hist.num_seq_escala_fx
                     ,rec_srv_realz_func_indic_hist.num_realz_fx
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_fx
                     ,rec_srv_realz_func_indic_hist.cod_pond
                     ,rec_srv_realz_func_indic_hist.num_peso
                     ,rec_srv_realz_func_indic_hist.cod_un_peso
                     ,rec_srv_realz_func_indic_hist.num_realz_pond
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_pond
                     ,rec_srv_realz_func_indic_hist.num_meta
                     ,rec_srv_realz_func_indic_hist.cod_un_meta
                     ,rec_srv_realz_func_indic_hist.num_realz
                     ,rec_srv_realz_func_indic_hist.cod_un_realz
                     ,rec_srv_realz_func_indic_hist.num_realz_x_meta
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_x_meta
                     ,rec_srv_realz_func_indic_hist.vlr_premio
                     ,rec_srv_realz_func_indic_hist.vlr_premio_func_calc
                     ,rec_srv_realz_func_indic_hist.cod_un_vlr_premio_func_calc
                     ,rec_srv_realz_func_indic_hist.pct_calc_rateio
                     ,rec_srv_realz_func_indic_hist.dt_ini_sit_srv
                     ,rec_srv_realz_func_indic_hist.cod_usuario
                     ,rec_srv_realz_func_indic_hist.vlr_desc_indicacao
                     ,rec_srv_realz_func_indic_hist.descr_meta
                     ,rec_srv_realz_func_indic_hist.cod_cargo
                     ,rec_srv_realz_func_indic_hist.sta_calc_realz
                     ,rec_srv_realz_func_indic_hist.qtd_desc_indicacao
                 from srv_realizado_func_indicador
                where cod_func             = p_rec_srv_realz_func_indic.cod_func
                  and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
                  and cod_emp              = p_rec_srv_realz_func_indic.cod_emp
                  and cod_fil              = p_rec_srv_realz_func_indic.cod_fil
                  and num_ano              = p_rec_srv_realz_func_indic.num_ano
                  and num_mes              = p_rec_srv_realz_func_indic.num_mes;

               if sql%rowcount > 0 then
                  --------------------------------------------------------------
                  -- insere registro no historico
                  --------------------------------------------------------------
                  insert into srv_realz_func_indic_hist
                     (cod_func
                     ,cod_indic
                     ,cod_emp
                     ,cod_fil
                     ,num_ano
                     ,num_mes
                     ,cod_escala
                     ,num_seq_escala_fx
                     ,num_realz_fx
                     ,cod_un_realz_fx
                     ,cod_pond
                     ,num_peso
                     ,cod_un_peso
                     ,num_realz_pond
                     ,cod_un_realz_pond
                     ,num_meta
                     ,cod_un_meta
                     ,num_realz
                     ,cod_un_realz
                     ,num_realz_x_meta
                     ,cod_un_realz_x_meta
                     ,vlr_premio
                     ,vlr_premio_func_calc
                     ,cod_un_vlr_premio_func_calc
                     ,pct_calc_rateio
                     ,dt_ini_sit_srv
                     ,cod_usuario
                     ,vlr_desc_indicacao
                     ,descr_meta
                     ,cod_cargo
                     ,sta_calc_realz
                     ,qtd_desc_indicacao
                     )
              values (rec_srv_realz_func_indic_hist.cod_func
                     ,rec_srv_realz_func_indic_hist.cod_indic
                     ,rec_srv_realz_func_indic_hist.cod_emp
                     ,rec_srv_realz_func_indic_hist.cod_fil
                     ,rec_srv_realz_func_indic_hist.num_ano
                     ,rec_srv_realz_func_indic_hist.num_mes
                     ,rec_srv_realz_func_indic_hist.cod_escala
                     ,rec_srv_realz_func_indic_hist.num_seq_escala_fx
                     ,rec_srv_realz_func_indic_hist.num_realz_fx
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_fx
                     ,rec_srv_realz_func_indic_hist.cod_pond
                     ,rec_srv_realz_func_indic_hist.num_peso
                     ,rec_srv_realz_func_indic_hist.cod_un_peso
                     ,rec_srv_realz_func_indic_hist.num_realz_pond
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_pond
                     ,rec_srv_realz_func_indic_hist.num_meta
                     ,rec_srv_realz_func_indic_hist.cod_un_meta
                     ,rec_srv_realz_func_indic_hist.num_realz
                     ,rec_srv_realz_func_indic_hist.cod_un_realz
                     ,rec_srv_realz_func_indic_hist.num_realz_x_meta
                     ,rec_srv_realz_func_indic_hist.cod_un_realz_x_meta
                     ,rec_srv_realz_func_indic_hist.vlr_premio
                     ,rec_srv_realz_func_indic_hist.vlr_premio_func_calc
                     ,rec_srv_realz_func_indic_hist.cod_un_vlr_premio_func_calc
                     ,rec_srv_realz_func_indic_hist.pct_calc_rateio
                     ,rec_srv_realz_func_indic_hist.dt_ini_sit_srv
                     ,rec_srv_realz_func_indic_hist.cod_usuario
                     ,rec_srv_realz_func_indic_hist.vlr_desc_indicacao
                     ,rec_srv_realz_func_indic_hist.descr_meta
                     ,rec_srv_realz_func_indic_hist.cod_cargo
                     ,rec_srv_realz_func_indic_hist.sta_calc_realz
                     ,rec_srv_realz_func_indic_hist.qtd_desc_indicacao
                     );

                  ----------------------------------------------------------------
                  -- atualiza o registro da tabela original
                  ----------------------------------------------------------------
                  update srv_realizado_func_indicador
                     set cod_escala                   = p_rec_srv_realz_func_indic.cod_escala
                        ,num_seq_escala_fx            = p_rec_srv_realz_func_indic.num_seq_escala_fx
                        ,num_realz_fx                 = p_rec_srv_realz_func_indic.num_realz_fx
                        ,cod_un_realz_fx              = p_rec_srv_realz_func_indic.cod_un_realz_fx
                        ,cod_pond                     = p_rec_srv_realz_func_indic.cod_pond
                        ,num_peso                     = p_rec_srv_realz_func_indic.num_peso
                        ,cod_un_peso                  = p_rec_srv_realz_func_indic.cod_un_peso
                        ,num_realz_pond               = p_rec_srv_realz_func_indic.num_realz_pond
                        ,cod_un_realz_pond            = p_rec_srv_realz_func_indic.cod_un_realz_pond
                        ,num_meta                     = p_rec_srv_realz_func_indic.num_meta
                        ,cod_un_meta                  = p_rec_srv_realz_func_indic.cod_un_meta
                        ,num_realz                    = p_rec_srv_realz_func_indic.num_realz
                        ,cod_un_realz                 = p_rec_srv_realz_func_indic.cod_un_realz
                        ,num_realz_x_meta             = p_rec_srv_realz_func_indic.num_realz_x_meta
                        ,cod_un_realz_x_meta          = p_rec_srv_realz_func_indic.cod_un_realz_x_meta
                        ,vlr_premio                   = p_rec_srv_realz_func_indic.vlr_premio
                        ,vlr_premio_func_calc         = p_rec_srv_realz_func_indic.vlr_premio_func_calc
                        ,cod_un_vlr_premio_func_calc  = p_rec_srv_realz_func_indic.cod_un_vlr_premio_func_calc
                        ,pct_calc_rateio              = p_rec_srv_realz_func_indic.pct_calc_rateio
                        ,dt_ini_sit_srv               = p_rec_srv_realz_func_indic.dt_ini_sit_srv
                        ,vlr_desc_indicacao           = p_rec_srv_realz_func_indic.vlr_desc_indicacao
                        ,descr_meta                   = p_rec_srv_realz_func_indic.descr_meta
                        ,cod_cargo                    = p_rec_srv_realz_func_indic.cod_cargo
                        ,sta_calc_realz               = p_rec_srv_realz_func_indic.sta_calc_realz
                        ,qtd_desc_indicacao           = p_rec_srv_realz_func_indic.qtd_desc_indicacao
                   --
                   where cod_func             = p_rec_srv_realz_func_indic.cod_func
                     and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
                     and cod_emp              = p_rec_srv_realz_func_indic.cod_emp
                     and cod_fil              = p_rec_srv_realz_func_indic.cod_fil
                     and num_ano              = p_rec_srv_realz_func_indic.num_ano
                     and num_mes              = p_rec_srv_realz_func_indic.num_mes;
               --
               else
                  p_cod_erro     := 1;
                  p_descr_erro   := 'erro ao selecionar realz func indic p/ inserir no hist - reg nao encontrado ' ||
                                    ' - p_cod_func: '                     || p_rec_srv_realz_func_indic.cod_func   ||
                                    ' - p_cod_indic: '                    || p_rec_srv_realz_func_indic.cod_indic  ||
                                    ' - p_cod_fil: '                      || p_rec_srv_realz_func_indic.cod_fil    ||
                                    ' - erro: '                           || sqlerrm;
               end if;
            exception
               when others then
                  p_cod_erro     := 1;
                  p_descr_erro   := 'erro ao selecionar e atualizar realz func indic no hist : '||
                                    ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                                    ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                                    ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                                    ' - erro: '                       || sqlerrm;
            end;
         --
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'erro geral ao inserir realizado func indic '||
                              ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                              ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                              ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                              ' - erro: '                       || sqlerrm;
      end;

      --
      commit;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na proc prc_insere_realz_func_indic '||
                              ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                              ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                              ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                              ' - erro: '                       || sqlerrm;
   end prc_insere_realz_func_indic;




   -----------------------------------------------------------------------------------------------
   -- INSERE REALIZADO FUNCIONARIO INDICADOR
   -----------------------------------------------------------------------------------------------
   procedure prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  in  srv_realizado_func_indicador%rowtype
                                            ,p_cod_erro                  out number
                                            ,p_descr_erro                out varchar2
                                            ) is

      --
      v_existe_realz_func_indic_per    pls_integer := 0;

   begin

      ------------------------------------------------------------------------------------------------------
      -- insere o realizado do funcionario APENAS pelo indicador e periodo, SEM considerar a FILIAL do func
      ------------------------------------------------------------------------------------------------------
      -- verifica se ja existe um registro para o funcionario, indicador, mes e ano
      begin
         select count(1)
           into v_existe_realz_func_indic_per
           from srv_realizado_func_indicador
          where cod_func             = p_rec_srv_realz_func_indic.cod_func
            and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
            and num_ano              = p_rec_srv_realz_func_indic.num_ano
            and num_mes              = p_rec_srv_realz_func_indic.num_mes
            and nvl(seg_fil,'N')     = nvl(p_rec_srv_realz_func_indic.seg_fil,'N');
      exception
         when others then
            v_existe_realz_func_indic_per := 0;
      end;

      -- se ja existir manda para historico o reg atual e atualiza o registro
      if v_existe_realz_func_indic_per > 0 then

         --
         for c_realz_func_indic_hist in ( select cod_func
                                                ,cod_indic
                                                ,cod_emp
                                                ,cod_fil
                                                ,num_ano
                                                ,num_mes
                                                ,cod_escala
                                                ,num_seq_escala_fx
                                                ,num_realz_fx
                                                ,cod_un_realz_fx
                                                ,cod_pond
                                                ,num_peso
                                                ,cod_un_peso
                                                ,num_realz_pond
                                                ,cod_un_realz_pond
                                                ,num_meta
                                                ,cod_un_meta
                                                ,num_realz
                                                ,cod_un_realz
                                                ,num_realz_x_meta
                                                ,cod_un_realz_x_meta
                                                ,vlr_premio
                                                ,vlr_premio_func_calc
                                                ,cod_un_vlr_premio_func_calc
                                                ,pct_calc_rateio
                                                ,dt_ini_sit_srv
                                                ,cod_usuario
                                                ,vlr_desc_indicacao
                                                ,descr_meta
                                                ,cod_cargo
                                                ,sta_calc_realz
                                                ,qtd_desc_indicacao
                                                ,qtd_meses_prop
                                                ,vlr_premio_func_calc_prop
                                                ,cod_sit_calc_realz_func
                                                ,seg_fil
                                            from srv_realizado_func_indicador
                                           where cod_func             = p_rec_srv_realz_func_indic.cod_func
                                             and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
                                             and num_ano              = p_rec_srv_realz_func_indic.num_ano
                                             and num_mes              = p_rec_srv_realz_func_indic.num_mes
                                             and nvl(seg_fil,'N')     = nvl(p_rec_srv_realz_func_indic.seg_fil,'N')) loop


            --------------------------------------------------------------
            -- insere registro no historico
            --------------------------------------------------------------
            begin
               insert into srv_realz_func_indic_hist
                  (cod_func
                  ,cod_indic
                  ,cod_emp
                  ,cod_fil
                  ,num_ano
                  ,num_mes
                  ,cod_escala
                  ,num_seq_escala_fx
                  ,num_realz_fx
                  ,cod_un_realz_fx
                  ,cod_pond
                  ,num_peso
                  ,cod_un_peso
                  ,num_realz_pond
                  ,cod_un_realz_pond
                  ,num_meta
                  ,cod_un_meta
                  ,num_realz
                  ,cod_un_realz
                  ,num_realz_x_meta
                  ,cod_un_realz_x_meta
                  ,vlr_premio
                  ,vlr_premio_func_calc
                  ,cod_un_vlr_premio_func_calc
                  ,pct_calc_rateio
                  ,dt_ini_sit_srv
                  ,cod_usuario
                  ,vlr_desc_indicacao
                  ,descr_meta
                  ,cod_cargo
                  ,sta_calc_realz
                  ,qtd_desc_indicacao
                  ,qtd_meses_prop
                  ,vlr_premio_func_calc_prop
                  ,cod_sit_calc_realz_func
                  ,seg_fil
                  )
           values (c_realz_func_indic_hist.cod_func
                  ,c_realz_func_indic_hist.cod_indic
                  ,c_realz_func_indic_hist.cod_emp
                  ,c_realz_func_indic_hist.cod_fil
                  ,c_realz_func_indic_hist.num_ano
                  ,c_realz_func_indic_hist.num_mes
                  ,c_realz_func_indic_hist.cod_escala
                  ,c_realz_func_indic_hist.num_seq_escala_fx
                  ,c_realz_func_indic_hist.num_realz_fx
                  ,c_realz_func_indic_hist.cod_un_realz_fx
                  ,c_realz_func_indic_hist.cod_pond
                  ,c_realz_func_indic_hist.num_peso
                  ,c_realz_func_indic_hist.cod_un_peso
                  ,c_realz_func_indic_hist.num_realz_pond
                  ,c_realz_func_indic_hist.cod_un_realz_pond
                  ,c_realz_func_indic_hist.num_meta
                  ,c_realz_func_indic_hist.cod_un_meta
                  ,c_realz_func_indic_hist.num_realz
                  ,c_realz_func_indic_hist.cod_un_realz
                  ,c_realz_func_indic_hist.num_realz_x_meta
                  ,c_realz_func_indic_hist.cod_un_realz_x_meta
                  ,c_realz_func_indic_hist.vlr_premio
                  ,c_realz_func_indic_hist.vlr_premio_func_calc
                  ,c_realz_func_indic_hist.cod_un_vlr_premio_func_calc
                  ,c_realz_func_indic_hist.pct_calc_rateio
                  ,c_realz_func_indic_hist.dt_ini_sit_srv
                  ,c_realz_func_indic_hist.cod_usuario
                  ,c_realz_func_indic_hist.vlr_desc_indicacao
                  ,c_realz_func_indic_hist.descr_meta
                  ,c_realz_func_indic_hist.cod_cargo
                  ,c_realz_func_indic_hist.sta_calc_realz
                  ,c_realz_func_indic_hist.qtd_desc_indicacao
                  ,c_realz_func_indic_hist.qtd_meses_prop
                  ,c_realz_func_indic_hist.vlr_premio_func_calc_prop
                  ,c_realz_func_indic_hist.cod_sit_calc_realz_func
                  ,c_realz_func_indic_hist.seg_fil
                  );

            exception
               when others then
                  p_cod_erro     := 1;
                  p_descr_erro   := 'erro ao inserir realz func indic no hist : '||
                                    ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                                    ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                                    ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                                    ' - erro: '                       || sqlerrm;
            end;

         -- c_realz_func_indic_hist
         end loop;


         ----------------------------------------------------------------
         -- atualiza o registro da tabela original
         ----------------------------------------------------------------
         begin
            -- se houver mais de um registro elimina os outros e deixa so 1
            if v_existe_realz_func_indic_per > 1 then
               delete from srv_realizado_func_indicador
                     where cod_func             = p_rec_srv_realz_func_indic.cod_func
                       and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
                       and num_ano              = p_rec_srv_realz_func_indic.num_ano
                       and num_mes              = p_rec_srv_realz_func_indic.num_mes
                       and nvl(seg_fil,'N')     = nvl(p_rec_srv_realz_func_indic.seg_fil,'N')
                       and rownum              <= (v_existe_realz_func_indic_per - 1);

            end if;
            --
            update srv_realizado_func_indicador
               set cod_escala                   = p_rec_srv_realz_func_indic.cod_escala
                  ,num_seq_escala_fx            = p_rec_srv_realz_func_indic.num_seq_escala_fx
                  ,num_realz_fx                 = p_rec_srv_realz_func_indic.num_realz_fx
                  ,cod_un_realz_fx              = p_rec_srv_realz_func_indic.cod_un_realz_fx
                  ,cod_pond                     = p_rec_srv_realz_func_indic.cod_pond
                  ,num_peso                     = p_rec_srv_realz_func_indic.num_peso
                  ,cod_un_peso                  = p_rec_srv_realz_func_indic.cod_un_peso
                  ,num_realz_pond               = p_rec_srv_realz_func_indic.num_realz_pond
                  ,cod_un_realz_pond            = p_rec_srv_realz_func_indic.cod_un_realz_pond
                  ,num_meta                     = p_rec_srv_realz_func_indic.num_meta
                  ,cod_un_meta                  = p_rec_srv_realz_func_indic.cod_un_meta
                  ,num_realz                    = p_rec_srv_realz_func_indic.num_realz
                  ,cod_un_realz                 = p_rec_srv_realz_func_indic.cod_un_realz
                  ,num_realz_x_meta             = p_rec_srv_realz_func_indic.num_realz_x_meta
                  ,cod_un_realz_x_meta          = p_rec_srv_realz_func_indic.cod_un_realz_x_meta
                  ,vlr_premio                   = p_rec_srv_realz_func_indic.vlr_premio
                  ,vlr_premio_func_calc         = p_rec_srv_realz_func_indic.vlr_premio_func_calc
                  ,cod_un_vlr_premio_func_calc  = p_rec_srv_realz_func_indic.cod_un_vlr_premio_func_calc
                  ,pct_calc_rateio              = p_rec_srv_realz_func_indic.pct_calc_rateio
                  ,dt_ini_sit_srv               = p_rec_srv_realz_func_indic.dt_ini_sit_srv
                  ,vlr_desc_indicacao           = p_rec_srv_realz_func_indic.vlr_desc_indicacao
                  ,descr_meta                   = p_rec_srv_realz_func_indic.descr_meta
                  ,cod_emp                      = p_rec_srv_realz_func_indic.cod_emp
                  ,cod_fil                      = p_rec_srv_realz_func_indic.cod_fil
                  ,cod_cargo                    = p_rec_srv_realz_func_indic.cod_cargo
                  ,sta_calc_realz               = p_rec_srv_realz_func_indic.sta_calc_realz
                  ,qtd_desc_indicacao           = p_rec_srv_realz_func_indic.qtd_desc_indicacao
                  ,qtd_meses_prop               = p_rec_srv_realz_func_indic.qtd_meses_prop
                  ,vlr_premio_func_calc_prop    = p_rec_srv_realz_func_indic.vlr_premio_func_calc_prop
                  ,cod_sit_calc_realz_func      = p_rec_srv_realz_func_indic.cod_sit_calc_realz_func
             where cod_func             = p_rec_srv_realz_func_indic.cod_func
               and cod_indic            = p_rec_srv_realz_func_indic.cod_indic
               and num_ano              = p_rec_srv_realz_func_indic.num_ano
               and num_mes              = p_rec_srv_realz_func_indic.num_mes
               and nvl(seg_fil,'N')     = nvl(p_rec_srv_realz_func_indic.seg_fil,'N');

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'erro ao atualizar realz func indic desconsiderando a fil : '||
                                 ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                                 ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                                 ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                                 ' - erro: '                       || sqlerrm;
         end;

      -- se nao existe o registro pelo func, indic e periodo
      else
         --
         begin
            insert into srv_realizado_func_indicador
                        (cod_func
                        ,cod_indic
                        ,cod_emp
                        ,cod_fil
                        ,num_ano
                        ,num_mes
                        ,cod_escala
                        ,num_seq_escala_fx
                        ,num_realz_fx
                        ,cod_un_realz_fx
                        ,cod_pond
                        ,num_peso
                        ,cod_un_peso
                        ,num_realz_pond
                        ,cod_un_realz_pond
                        ,num_meta
                        ,cod_un_meta
                        ,num_realz
                        ,cod_un_realz
                        ,num_realz_x_meta
                        ,cod_un_realz_x_meta
                        ,vlr_premio
                        ,vlr_premio_func_calc
                        ,cod_un_vlr_premio_func_calc
                        ,pct_calc_rateio
                        ,dt_ini_sit_srv
                        ,cod_usuario
                        ,vlr_desc_indicacao
                        ,descr_meta
                        ,cod_cargo
                        ,sta_calc_realz
                        ,qtd_desc_indicacao
                        ,qtd_meses_prop
                        ,vlr_premio_func_calc_prop
                        ,cod_sit_calc_realz_func
                        ,seg_fil
                        )
                 values (p_rec_srv_realz_func_indic.cod_func
                        ,p_rec_srv_realz_func_indic.cod_indic
                        ,p_rec_srv_realz_func_indic.cod_emp
                        ,p_rec_srv_realz_func_indic.cod_fil
                        ,p_rec_srv_realz_func_indic.num_ano
                        ,p_rec_srv_realz_func_indic.num_mes
                        ,p_rec_srv_realz_func_indic.cod_escala
                        ,p_rec_srv_realz_func_indic.num_seq_escala_fx
                        ,p_rec_srv_realz_func_indic.num_realz_fx
                        ,p_rec_srv_realz_func_indic.cod_un_realz_fx
                        ,p_rec_srv_realz_func_indic.cod_pond
                        ,p_rec_srv_realz_func_indic.num_peso
                        ,p_rec_srv_realz_func_indic.cod_un_peso
                        ,p_rec_srv_realz_func_indic.num_realz_pond
                        ,p_rec_srv_realz_func_indic.cod_un_realz_pond
                        ,p_rec_srv_realz_func_indic.num_meta
                        ,p_rec_srv_realz_func_indic.cod_un_meta
                        ,p_rec_srv_realz_func_indic.num_realz
                        ,p_rec_srv_realz_func_indic.cod_un_realz
                        ,p_rec_srv_realz_func_indic.num_realz_x_meta
                        ,p_rec_srv_realz_func_indic.cod_un_realz_x_meta
                        ,p_rec_srv_realz_func_indic.vlr_premio
                        ,p_rec_srv_realz_func_indic.vlr_premio_func_calc
                        ,p_rec_srv_realz_func_indic.cod_un_vlr_premio_func_calc
                        ,p_rec_srv_realz_func_indic.pct_calc_rateio
                        ,p_rec_srv_realz_func_indic.dt_ini_sit_srv
                        ,p_rec_srv_realz_func_indic.cod_usuario
                        ,p_rec_srv_realz_func_indic.vlr_desc_indicacao
                        ,p_rec_srv_realz_func_indic.descr_meta
                        ,p_rec_srv_realz_func_indic.cod_cargo
                        ,p_rec_srv_realz_func_indic.sta_calc_realz
                        ,p_rec_srv_realz_func_indic.qtd_desc_indicacao
                        ,p_rec_srv_realz_func_indic.qtd_meses_prop
                        ,p_rec_srv_realz_func_indic.vlr_premio_func_calc_prop
                        ,p_rec_srv_realz_func_indic.cod_sit_calc_realz_func
                        ,p_rec_srv_realz_func_indic.seg_fil
                        );
         --
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'erro ao inserir realizado func indic sem cosniderar a filial'||
                                 ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                                 ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                                 ' - p_ano: '                      || p_rec_srv_realz_func_indic.num_ano   ||
                                 ' - p_mes: '                      || p_rec_srv_realz_func_indic.num_mes   ||
                                 ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                                 ' - erro: '                       || sqlerrm;

         end;

      end if;

      --
      commit;

   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na proc prc_ins_realz_func_indic_ultfi '||
                              ' - p_cod_func: '                 || p_rec_srv_realz_func_indic.cod_func  ||
                              ' - p_cod_indic: '                || p_rec_srv_realz_func_indic.cod_indic ||
                              ' - p_cod_fil: '                  || p_rec_srv_realz_func_indic.cod_fil   ||
                              ' - erro: '                       || sqlerrm;

   end prc_ins_realz_func_indic_ultfi;

   -----------------------------------------------------------------------------------------------
   -- LOGA ERRO OU OBSERVACAO DO PROCESSO NA TABELA DE LOG
   -----------------------------------------------------------------------------------------------
   function fnc_insere_log_processo (p_cod_proc    in  number
                                    ,p_nome_proc   in  varchar2
                                    ,p_num_ano     in  number
                                    ,p_num_mes     in  number
                                    ,p_cod_fil     in  number
                                    ,p_cod_func    in  number
                                    ,p_cod_indic   in  number
                                    ,p_erro        in  varchar2) return varchar2 is

      --
      v_sqlerrm_log_erro   varchar2(2000);

   begin
      --
      insert into srv_processo_log_erro
                  (cod_proc
                  ,nome_proc
                  ,dt_log
                  ,num_ano
                  ,num_mes
                  ,cod_fil
                  ,cod_func
                  ,cod_indic
                  ,erro
                  )
           values (p_cod_proc
                  ,p_nome_proc
                  ,sysdate
                  ,p_num_ano
                  ,p_num_mes
                  ,p_cod_fil
                  ,p_cod_func
                  ,p_cod_indic
                  ,substr(p_erro, 1, 4000)
                  );


      --
      commit;

      --
      return (v_sqlerrm_log_erro);


   exception
      when others then
         v_sqlerrm_log_erro := sqlerrm;
         return (v_sqlerrm_log_erro);

   end fnc_insere_log_processo;




   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FILIAL
   -----------------------------------------------------------------------------------------------

    procedure prc_calc_realz_fil_Lj (p_num_ano      in number
                                    ,p_num_mes      in number
                                    ,p_cod_emp      in number    default null
                                    ,p_cod_fil      in number    default null
                                    ,p_cod_indic    in number    default null
                                    ,p_descr_indic  in varchar2  default null
                                    ,p_cod_usuario  in number
                                    ,p_cod_erro     out number
                                    ,p_descr_erro   out varchar2
                                     ) is


      -- variaveis controle
      v_alias_tab                      varchar2(50);
      v_p_cod_fil                      varchar2(50);
      v_nm_tab_realz_fu                varchar2(30);
      v_nm_tab_realz_fi                varchar2(30);
      v_nm_tab_realz_tod_func          varchar2(30);
      v_nm_tab_realz_fin_movto_premi   varchar2(30);
      v_nm_tab_realz_PL_tot            varchar2(30);
      v_nm_tab_realz_ita_tot           varchar2(30);
      v_nm_tab_realz_ita_parc          varchar2(30);
      v_nm_tab_ctr_psf_canc            varchar2(30);
      v_nm_tab_ctr_psfDep_canc         varchar2(30);
      v_nm_tab_ctr_odoIta_canc         varchar2(30);
      v_nm_tab_ctr_OdepIta_canc        varchar2(30);
      v_nm_tab_realz_fu_ca             varchar2(30);
      v_nm_tab_realz_vendas            varchar2(30);
      v_nm_tab_realz_tot_cartao_pl     varchar2(30);
      v_nm_tab_realz_tot_cartao_it     varchar2(30);

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_dt_ini1                        varchar2(20);
      v_dt_fim1                        varchar2(20);

      i_cod_fil			                   dbms_sql.number_table	;
      i_dt_trans		                   dbms_sql.date_table	;
      i_id_movto_fin		               dbms_sql.number_table	;
      i_cod_forma_pgto		             dbms_sql.number_table	;
      i_descr_forma_pgto	             dbms_sql.varchar2_table;
      i_cod_plano_pgto		             dbms_sql.number_table;
      i_descr_plano		                 dbms_sql.varchar2_table;
      i_cod_tot_meio_pgto	             dbms_sql.varchar2_table;
      i_num_nsu			                   dbms_sql.number_table;
      i_dt_hr_movto		                 dbms_sql.date_table;
      i_num_cupom		                   dbms_sql.number_table;
      i_qtd_parc		                   dbms_sql.number_table;
      i_vlr_movto		                   dbms_sql.number_table;
      i_vlr_juro		                   dbms_sql.number_table;
      i_vlr_liq_trans                  dbms_sql.number_table;
      i_matricula_vend		             dbms_sql.number_table;
      i_cpf_vend		                   dbms_sql.number_table;
      i_cod_prod_cpa_tranq	           dbms_sql.number_table;
      i_vlr_tot_cpa_tranq	             dbms_sql.number_table;
      i_cod_fam_prod		               dbms_sql.varchar2_table;
      i_num_ccm			                   dbms_sql.number_table;
      i_vlr_parc		                   dbms_sql.number_table;
      i_vlr_prim_parc		               dbms_sql.number_table;

      type SRV_TMP_REALZ_PARC_ITAU     is ref cursor;
      cur_itau SRV_TMP_REALZ_PARC_ITAU;

      mov_cod_fil                      dbms_sql.NUMBER_table;
      mov_num_ccm                      dbms_sql.NUMBER_table;
      mov_num_nsu                      dbms_sql.NUMBER_table;
      mov_dt_emis                      dbms_sql.DATE_table;
      mov_vlr_parc                     dbms_sql.NUMBER_table;
      mov_qtd_parc                     dbms_sql.NUMBER_table;
      mov_vlr_prim_parc                dbms_sql.NUMBER_table;
      mov_num_cupom                    dbms_sql.NUMBER_table;
      mov_num_matr                     dbms_sql.NUMBER_table;

      type srv_tmp_fin_movto_premiacao is ref cursor;
      cur_movto srv_tmp_fin_movto_premiacao;

      c_fil_cod     			             dbms_sql.NUMBER_table;
      c_cod_indic     		             dbms_sql.NUMBER_table;
      c_descr_indic   		             dbms_sql.VARCHAR2_table;
      c_vlr_vdas_bruta		             dbms_sql.NUMBER_table;
      c_vlr_devolucao 		             dbms_sql.NUMBER_table;
      c_vlr_realizado			             dbms_sql.NUMBER_table;

      TYPE SRV_REALZFI_VENDAS          IS REF CURSOR;
      cur_vendas SRV_REALZFI_VENDAS;

      c_FIL_COD_VDS                    dbms_sql.NUMBER_table;
      c_QTDE_VDS_PARC_PL_ITA           dbms_sql.NUMBER_table;

      TYPE SRV_TMP_META_CPR_TRANQI     IS REF CURSOR;
      cur_cpr_tranqi SRV_TMP_META_CPR_TRANQI;


   ---------------------------------------------------------------------------
   begin

      --------------------------------------------------------------
      -- inicia variaveis
      --------------------------------------------------------------
      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;
      --
      v_cod_fil    := p_cod_fil;
      v_cod_indic  := p_cod_indic;




      --------------------------------------------------------------
      -- VENDAS
      --------------------------------------------------------------
      if p_descr_indic is null or p_descr_indic = 'VENDAS' then

         v_nm_tab_realz_fi := 'SRV_REALZFI_VENDAS_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));

         --
         v_alias_tab := 'fm.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;


         -- APURAR NO ATM INDICADOR VENDAS
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fi ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '||v_nm_tab_realz_fi||'
                                     (
                                       fil_cod        number,
                                       cod_indic      number(4),
                                       descr_indic    varchar2(6),
                                       vlr_vdas_bruta number,
                                       vlr_devolucao  number,
                                       vlr_realizado  number
                                     )
                                     pctfree 0';
         exception
           when others then
             null;
         end;
         --
         begin
            open cur_vendas for 'select /*+ index_ffs(fin_movto@ccm_fin fin.FK_TRANS_CX_FIN_MOVTO) */
                                            fm.cod_fil                         as fil_cod
                                            ,1                                 as cod_indic
                                            ,''VENDAS''                        as descr_indic
                                            ,sum(fm.vlr_movto)                 as vlr_vdas_bruta
                                            ,d.devolucao                       as vlr_devolucao
                                            ,(sum(fm.vlr_movto) - d.devolucao) as vlr_realizado
                                        from fin_movto@ccm_fin                    fm
                                            ,srv_calendario_comercial             cc
                                            ,(select sum(d.vlr_movto)          as Devolucao
                                                    ,d.cod_fil
                                                    ,cc.num_ano
                                                    ,cc.num_mes
                                                from fin_movto@ccm_fin            d
                                                    ,srv_calendario_comercial     cc
                                               where d.cod_fil      not in (668)  --LOJA VIRTUAL
                                                 and d.cod_trans_cx = 8  --1: Venda | 8: Devolucao Venda | 15: Cartao Presente | 24: Cancelamento Cartao Presente
                                                 and d.dt_emis      between to_date(to_char(cc.dt_ini_periodo, ''dd/mm/yyyy'') || '' 00:00:00'', ''dd/mm/yyyy hh24:mi:ss'')
                                                                        and to_date(to_char(cc.dt_fim_periodo, ''dd/mm/yyyy'') || '' 23:59:59'', ''dd/mm/yyyy hh24:mi:ss'')
                                                 and cc.num_ano     = ' || p_num_ano || '
                                                 and cc.num_mes     = ' || p_num_mes || '
                                            group by d.cod_fil
                                                    ,cc.num_ano
                                                    ,cc.num_mes) d
                                       where d.cod_fil       = fm.cod_fil
                                         and d.cod_fil       not in (668)  --LOJA VIRTUAL
                                         and fm.cod_trans_cx =1  --1: Venda | 8: Devolucao Venda | 15: Cartao Presente | 24: Cancelamento Cartao Presente
                                         and fm.dt_emis  between to_date(to_char(cc.dt_ini_periodo, ''dd/mm/yyyy'') || '' 00:00:00'', ''dd/mm/yyyy hh24:mi:ss'')
                                                             and to_date(to_char(cc.dt_fim_periodo, ''dd/mm/yyyy'') || '' 23:59:59'', ''dd/mm/yyyy hh24:mi:ss'')
                                         and cc.num_ano      = d.num_ano
                                         and cc.num_mes      = d.num_mes'
                                         || v_p_cod_fil  || '
                                    group by fm.cod_fil
                                            ,1
                                            ,''VENDAS''
                                            ,d.devolucao ';
               fetch cur_vendas
               bulk collect into c_fil_cod,c_cod_indic,c_descr_indic,c_vlr_vdas_bruta,c_vlr_devolucao,c_vlr_realizado;

                     forall x in 1..c_fil_cod.count
                     execute immediate 'insert into '||v_nm_tab_realz_fi||' values (:1,:2,:v,:3,:4,:5) ' using c_fil_cod(x),c_cod_indic(x),c_descr_indic(x),c_vlr_vdas_bruta(x),c_vlr_devolucao(x),c_vlr_realizado(x);


              close cur_vendas;
              commit;
          exception
            when others then
             p_cod_erro     := 1;
             p_descr_erro   := 'Erro ao inserir na tabela ' || v_nm_tab_realz_fi ||
                               ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fi || ' - index: i_' || substr(v_nm_tab_realz_fi,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;

         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


      -- SE INDICADOR VENDAS
      end if;

      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------
      -- VENDA COM JUROS PL
      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------

      if p_descr_indic is null or p_descr_indic in ('VENDA COM JUROS PL') then

         v_nm_tab_realz_fu              := 'SRV_REALZFU_CPR_JUR_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi              := 'SRV_REALZFI_CPR_JUR_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func        := 'SRV_REALZ_TOD_FU_VJ_PL_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_PL_tot          := 'SRV_TMP_REALZ_PL_TOT_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));

         --
         begin
           execute immediate 'drop table '||v_nm_tab_realz_PL_tot;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '||v_nm_tab_realz_PL_tot||'  pctfree 0 nologging as
                                 select cc.cli_cpf                           as cli_cpf
                                       ,cc.plas_num_cartao                   as plast_titular
                                       ,cc.cpr_num_cartao                    as plast_compra
                                       ,cc.fat_transacao_cod                 as fat_transacao_cod
                                       ,cc.cpr_autorizacao                   as cod_autorizacao
                                       ,cc.fat_dt_transacao                  as fat_dt_transacao
                                       ,cc.fil_cod                           as filial_cpra
                                       ,cc.prod_cod                          as cod_prod
                                       ,cp.prod_descr                        as descr_produto
                                       ,cc.cpr_vr_total                      as vlr_bruto_trans
                                       ,cc.cpr_vr_financ                     as vlr_juros
                                       ,cc.cpr_vr_total - cc.cpr_vr_financ   as vlr_liq_trans
                                       ,cc.cpr_prod_cod_comp_tranq           as cpr_prod_cod_comp_tranq
                                       ,cp.prod_desc_comp_tranq              as prod_desc_comp_tranq
                                       ,cc.cpr_vr_prc_comp_tranq             as vlr_parc_seguro
                                       ,cc.cpr_vr_total_comp_tranq           as vlr_total_seguro
                                       ,cc.cpr_cod_matricula                 as matricula_vendedor
                                       ,cc.stat_cod                          as cod_status_cpra
                                       ,cc.eve_cod                           as eve_cod
                                       ,cc.cpr_qt_prc                        as cpr_qt_prc
                                   from ccm_compra  cc
                                       ,ccm_produto cp
                                  where cc.car_bin = cp.car_bin
                                    and cc.prod_cod = cp.prod_cod
                                    and cc.stat_cod in (6, 8)
                                    and cp.prod_tipo = upper(''l'')
                                    and cc.prod_cod not in (10  -- acordo parcelado
                                                           ,91  -- prod. saque ta na m?o
                                                           ,99) -- prod. parcelamento de fatura
                                    and cc.fat_dt_transacao between to_date(' || chr(39) || v_dt_ini || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')
                                                                and to_date(' || chr(39) || v_dt_fim || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')
                                    and(cc.stat_cod in (6,8) or
                                        cc.stat_cod in (5,7) and cc.cpr_dt_cancel > to_date(' || chr(39) || v_dt_fim || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'') + 5)
                                    and cc.fil_cod not in (188,668) -- sem loja VIRTUAL
                                    ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_PL_tot ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_PL_tot || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_PL_tot || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- cria tabela de apuracao VJ base para o realizado filial,
         -- apurando todas as vendas sem fazer join com a srv_funcionario
         -- e apurando inclusive vendas de temporarios
         --
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_tod_func ;
         exception
           when others then
             null;
         end;
         begin
            execute immediate 'create table ' || v_nm_tab_realz_tod_func || '  pctfree 0 nologging as
                               select c.cli_cpf
                                     ,c.plast_titular
                                     ,c.plast_compra
                                     ,c.fat_transacao_cod
                                     ,c.cod_autorizacao
                                     ,c.fat_dt_transacao
                                     ,c.filial_cpra             as fil_cod
                                     ,4                         as cod_indic
                                     ,''VENDA COM JUROS PL''    as descr_indic
                                     --,c.cod_fam_prod
                                     --,c.descr_fam_prod
                                     ,c.cod_prod
                                     ,c.descr_produto
                                     ,c.vlr_bruto_trans
                                     ,c.vlr_juros
                                     ,c.vlr_liq_trans
                                     ,c.cpr_prod_cod_comp_tranq
                                     ,c.prod_desc_comp_tranq
                                     ,c.vlr_parc_seguro
                                     ,c.vlr_total_seguro
                                     ,c.matricula_vendedor
                                     ,c.cod_status_cpra
                                     --,c.descr_status_cpra
                                     ,c.eve_cod
                                     ,c.cpr_qt_prc
                                 from '||v_nm_tab_realz_PL_tot||'  c
                                where to_char(c.cod_prod) in(select ip.cod_prod
                                                               from srv_tipo_rem_var        t
                                                                   ,srv_grupo_indicador     g
                                                                   ,srv_indicador           i
                                                                   ,srv_indicador_produto   ip
                                                                   ,srv_produto             p
                                                               where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                 and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                 and g.cod_grp_indic       = i.cod_grp_indic
                                                                 and i.descr_indic         = ''VENDA COM JUROS PL''
                                                                 and i.flg_indic_ativ      = ''S''
                                                                 and i.cod_indic           = ip.cod_indic
                                                                 and ip.cod_orig_prod      = p.cod_orig_prod
                                                                 and ip.cod_prod           = p.cod_prod) ';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_tod_func,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_tod_func,1,28) ||' on ' || v_nm_tab_realz_tod_func || ' (fil_cod, matricula_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_tod_func || ' - index: i_' || substr(v_nm_tab_realz_tod_func,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_tod_func || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



         -- tabela de apuracao de funcionarios
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fu ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                               select c.cli_cpf
                                     ,c.plast_titular
                                     ,c.plast_compra
                                     ,c.fat_transacao_cod
                                     ,c.cod_autorizacao
                                     ,c.fat_dt_transacao
                                     ,c.fat_dt_transacao data_adesao_titular
                                     ,c.filial_cpra             as fil_cod
                                     ,4                         as cod_indic
                                     ,''VENDA COM JUROS PL''    as descr_indic
                                     --,c.cod_fam_prod
                                     --,c.descr_fam_prod
                                     ,c.cod_prod
                                     ,c.descr_produto
                                     ,c.vlr_bruto_trans
                                     ,c.vlr_juros
                                     ,c.vlr_liq_trans
                                     ,c.cpr_prod_cod_comp_tranq
                                     ,c.prod_desc_comp_tranq
                                     ,c.vlr_parc_seguro
                                     ,c.vlr_total_seguro
                                     ,c.matricula_vendedor
                                     ,c.cod_status_cpra
                                     --,c.descr_status_cpra
                                     ,c.eve_cod
                                     ,c.cpr_qt_prc
                                     ,f.num_cpf_func            as cpf_vendedor
                                 from '||v_nm_tab_realz_PL_tot||'  c
                                     ,srv_funcionario       f
                                where to_char(c.matricula_vendedor) = to_char(f.cod_cracha)
                                  and f.cod_sit_rh <> 2
                                  and to_char(c.cod_prod) in(select ip.cod_prod
                                                               from srv_tipo_rem_var        t
                                                                   ,srv_grupo_indicador     g
                                                                   ,srv_indicador           i
                                                                   ,srv_indicador_produto   ip
                                                                   ,srv_produto            p
                                                               where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                 and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                 and g.cod_grp_indic       = i.cod_grp_indic
                                                                 and i.descr_indic         = ''VENDA COM JUROS PL''
                                                                 and i.flg_indic_ativ      = ''S''
                                                                 and i.cod_indic           = ip.cod_indic
                                                                 and ip.cod_orig_prod      = p.cod_orig_prod
                                                                 and ip.cod_prod           = p.cod_prod) ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fu || ' - index: i_' || substr(v_nm_tab_realz_fu,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' where '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;

         --
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fi ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_fi || '  pctfree 0 nologging as
                               select fil_cod
                                     ,cod_indic
                                     ,descr_indic
                                     ,count(cli_cpf)                       as qtde
                                     ,sum(vlr_bruto_trans)                 as vlr_realz_bruto_cpr_jur
                                     ,sum(vlr_juros)                       as vlr_realz_juros_cpr_jur
                                     ,sum(vlr_liq_trans)                   as vlr_realz_cpr_jur
                                 from ' || v_nm_tab_realz_tod_func || ''
                                 || v_p_cod_fil || '
                           group by fil_cod
                                   ,cod_indic
                                   ,descr_indic ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- META VENDAS PL
         begin
           execute immediate 'drop table SRV_TMP_META_VENDAS_PL_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table SRV_TMP_META_VENDAS_PL_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00'))
                                           || ' pctfree 0 nologging as
                               select a.filial_cpra           as cod_fil
                                     ,sum(a.vlr_liq_trans)    as vlr_liq_vda_total_PL_ita
                                 from ' || v_nm_tab_realz_PL_tot    || ' a
                             group by a.filial_cpra';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || ' SRV_TMP_META_VENDAS_PL_'
                                 || trim(to_char(p_num_ano, '0000'))
                                 || trim(to_char(p_num_mes, '00'))
                                 || ' - erro - '
                                 || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'grant select on SRV_TMP_META_VENDAS_PL_' || trim(to_char(p_num_ano, '0000')) || trim(to_char(p_num_mes, '00')) || ' to SRV_SEL';
            execute immediate 'grant select on SRV_TMP_META_VENDAS_PL_' || trim(to_char(p_num_ano, '0000')) || trim(to_char(p_num_mes, '00')) || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
      -- if p_descr_indic in ('VENDA COM JUROS PL'
      end if;



      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- REALIZADO COMPRA TRANQUILA PL
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if p_descr_indic is null or p_descr_indic in ('COMPRA TRANQUILA PL') then

         v_nm_tab_realz_fu     := 'SRV_REALZFU_CPRA_TRANQ_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi     := 'SRV_REALZFI_CPRA_TRANQ_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_PL_tot := 'TMP_REALZ_CPRA_TRANQ_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));

         v_alias_tab := 'cc.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;

         -- tabela de apuracao de funcionarios
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_PL_tot;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_PL_tot || '  pctfree 0 nologging as
                                 select cc.cli_cpf                           as cli_cpf
                                       ,cc.plas_num_cartao                   as plast_titular
                                       ,cc.cpr_num_cartao                    as plast_compra
                                       ,cc.fat_transacao_cod                 as fat_transacao_cod
                                       ,cc.cpr_autorizacao                   as cod_autorizacao
                                       ,cc.fat_dt_transacao                  as fat_dt_transacao
                                       ,cc.fil_cod                           as fil_cod
                                       ,cc.prod_cod                          as cod_prod
                                       ,5                                    as cod_indic
                                       ,upper(''COMPRA TRANQUILA PL'')       as descr_indic
                                       ,cc.cpr_vr_total                      as vlr_bruto_trans
                                       ,cc.cpr_vr_financ                     as vlr_juros
                                       ,cc.cpr_vr_total - cc.cpr_vr_financ   as vlr_liq_trans
                                       ,cc.cpr_prod_cod_comp_tranq           as cpr_prod_cod_comp_tranq
                                       ,cc.cpr_vr_prc_comp_tranq             as vlr_parc_seguro
                                       ,cc.cpr_vr_total_comp_tranq           as vlr_total_seguro
                                       ,cc.cpr_cod_matricula                 as matricula_vendedor
                                       ,cc.stat_cod                          as cod_status_cpra
                                       ,cc.eve_cod                           as eve_cod
                                       ,cc.cpr_qt_prc                        as cpr_qt_prc
                                       ,cc.fat_transacao_cod_pg              as fat_transacao_cod_pg
                                   from ccm_compra                 cc
                                  inner join ccm_recebimento       cr on cc.car_bin = cr.car_bin
                                                                            and cc.cli_cpf = cr.cli_cpf
                                                                            and cc.fat_transacao_cod_pg = cr.fat_transacao_cod
                                                                            and (cr.fat_dt_transacao - 180) <= cc.fat_dt_transacao --consider adesoes pagas em ate 180 dias apos a adesao
                                                                            and cr.fat_dt_transacao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                                        and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                  where cc.car_bin = 603475
                                    and cc.fil_cod not in (188,668) -- sem loja VIRTUAL
                                    and cc.fat_transacao_cod_pg is not null
                                    and cc.fat_dt_transacao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                                    and cc.prod_cod not in (10 -- ACORDO PARCELADO
                                                           ,91 -- PROD. SAQUE TA NA M?O
                                                           ,99)-- PROD. PARCELAMENTO DE FATURA
                                    '|| v_p_cod_fil;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao inserir na a tabela ' || v_nm_tab_realz_PL_tot ||
                                 ' erro - '                     || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_PL_tot,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_PL_tot,1,28) ||' on ' || v_nm_tab_realz_PL_tot || ' (fil_cod, matricula_vendedor)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_PL_tot || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_PL_tot || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_PL_tot || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --Tabela de Funcionarios
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fu;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                                 select cc.*
                                      , fu.num_cpf_func as cpf_vendedor
                                   from ' || v_nm_tab_realz_PL_tot || ' cc
                                  inner join srv_funcionario fu on fu.cod_cracha = cc.matricula_vendedor
                                                               and fu.cod_sit_rh <> 2
                                  where cc.cpr_prod_cod_comp_tranq in (418,437)';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao inserir na a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                     || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, matricula_vendedor)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --Filial
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                 select cc.fil_cod                                as fil_cod
                                       ,5                                         as cod_indic
                                       ,upper(''COMPRA TRANQUILA PL'')            as descr_indic
                                       ,count(*)                                  as qtde
                                       ,sum(cc.cpr_vr_total)                      as vlr_realz_bruto_cpr_tranq
                                       ,sum(cc.cpr_vr_financ)                     as vlr_realz_juros_cpr_tranq
                                       ,sum(cc.cpr_vr_total - cc.cpr_vr_financ)   as vlr_realz_cpra_tranq
                                   from ccm_compra cc
                                  where cc.car_bin = 603475
                                    and cc.fil_cod not in (188,668) -- sem loja VIRTUAL
                                    and cc.fat_dt_transacao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                    and cc.prod_cod not in (10 -- ACORDO PARCELADO
                                                           ,91 -- PROD. SAQUE TA NA M?O
                                                           ,99)-- PROD. PARCELAMENTO DE FATURA
                                    and(cc.stat_cod in (6,8)
                                     or cc.stat_cod in (5,7) and cc.cpr_dt_cancel > to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)
                                    and cc.cpr_prod_cod_comp_tranq in (418,437)
                                    '|| v_p_cod_fil ||'
                                  group by cc.fil_cod';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- META VENDAS PARCELADAS PL (META PARA COMPRA TRANQUILA)
         begin
           execute immediate 'drop table SRV_TMP_META_CPR_TRANQ_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table SRV_TMP_META_CPR_TRANQ_' || trim(to_char(p_num_ano, '0000')) || trim(to_char(p_num_mes, '00')) || ' pctfree 0 nologging as
                                 select cc.fil_cod fil_cod
                                      , count(*)   qtde
                                   from ccm_compra cc
                                  where cc.car_bin = 603475
                                    and cc.fil_cod not in (188,668) -- sem loja VIRTUAL
                                    and cc.fat_dt_transacao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                    and cc.prod_cod not in (10 -- ACORDO PARCELADO
                                                           ,91 -- PROD. SAQUE TA NA M?O
                                                           ,99)-- PROD. PARCELAMENTO DE FATURA
                                    and(cc.stat_cod in (6,8)
                                     or cc.stat_cod in (5,7) and cc.cpr_dt_cancel > to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)
                                    and cc.cpr_qt_prc >= 2
                                  group by cc.fil_cod';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || ' SRV_TMP_META_CPR_TRANQ_'
                                 || trim(to_char(p_num_ano, '0000'))
                                 || trim(to_char(p_num_mes, '00'))
                                 || ' - erro - '
                                 || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'grant select on SRV_TMP_META_CPR_TRANQ_' || trim(to_char(p_num_ano, '0000')) || trim(to_char(p_num_mes, '00')) || ' to SRV_SEL';
            execute immediate 'grant select on SRV_TMP_META_CPR_TRANQ_' || trim(to_char(p_num_ano, '0000')) || trim(to_char(p_num_mes, '00')) || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- if p_descr_indic in ('COMPRA TRANQUILA PL')
      end if;

      --------------------------------------------------------------------------------------------------
      -- VENDA COM JUROS ITAU, COMPRA TRANQUILA ITAU
      --------------------------------------------------------------------------------------------------
      if p_descr_indic is null or p_descr_indic in ('VENDA COM JUROS ITAU', 'COMPRA TRANQUILA ITAU') then
         --
         v_nm_tab_realz_fu := 'SRV_REALZFU_CPR_JUR_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CPR_JUR_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func := 'SRV_REALZ_TOD_FU_VJ_IT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_ita_tot := 'SRV_TMP_REALZ_ITAU_TOT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_ita_parc := 'SRV_TMP_REALZ_PARC_ITAU_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));


         -- COMPRA TOTAL ITAU
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_ita_tot;
         exception
           when others then
             null;
         end;
         --

         begin
            execute immediate 'create table ' || v_nm_tab_realz_ita_tot || ' (
                                                COD_FIL            NUMBER(4) not null,
                                                DT_TRANS           DATE,
                                                ID_MOVTO_FIN       NUMBER(12) not null,
                                                COD_FORMA_PGTO     NUMBER(4) not null,
                                                DESCR_FORMA_PGTO   VARCHAR2(50) not null,
                                                COD_PLANO_PGTO     NUMBER(4),
                                                DESCR_PLANO        VARCHAR2(30),
                                                COD_TOT_MEIO_PGTO  VARCHAR2(20),
                                                NUM_NSU            NUMBER(9),
                                                DT_HR_MOVTO        DATE not null,
                                                NUM_CUPOM          NUMBER(6),
                                                QTD_PARC           NUMBER(4),
                                                VLR_MOVTO          NUMBER(12,2),
                                                VLR_JURO           NUMBER(12,2),
                                                vlr_liq_trans      NUMBER(12,2),
                                                MATRICULA_VEND     NUMBER(10),
                                                CPF_VEND           NUMBER(11),
                                                COD_PROD_CPA_TRANQ NUMBER,
                                                VLR_TOT_CPA_TRANQ  NUMBER,
                                                COD_FAM_PROD       VARCHAR2(3),
                                                NUM_CCM            NUMBER(20),
                                                VLR_PARC           NUMBER(12,2),
                                                VLR_PRIM_PARC      NUMBER(12,2)
                                              ) pctfree 0 nologging ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_ita_tot ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;




         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_ita_tot || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_ita_tot || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         begin
            open cur_itau for ('select /*+ FIRST_ROWS(50) */
                                        fm.cod_fil
                                       ,fm.dt_emis                    dt_trans
                                       ,fm.id_movto_fin
                                       ,fm.cod_forma_pgto             cod_forma_pgto -- OBS. ESTE COD. ORIGINALMENTE DEVERA SER SEMPRE 3
                                       ,sta.descr_forma_pgto          descr_forma_pgto
                                       ,fm.cod_plano_pgto
                                       ,fm.descr_plano
                                       ,fm.cod_tot_meio_pgto
                                       ,fm.num_nsu
                                       ,fm.dt_hr_movto
                                       ,fm.num_cupom
                                       ,fm.qtd_parc
                                       ,fm.vlr_movto
                                       ,fm.vlr_juro
                                       ,(fm.vlr_movto + nvl(fm.vlr_tot_cpa_tranq, 0))  as vlr_liq_trans
                                       ,pu.num_matr                    matricula_vend
                                       ,pu.num_cpf_usu                 cpf_vend
                                       ,nvl(fm.cod_prod_cpa_tranq, 0)  as cod_prod_cpa_tranq -- Codigo do Produto Compra Tranquila
                                       ,nvl(fm.vlr_tot_cpa_tranq, 0)   as vlr_tot_cpa_tranq  -- Valor Total do Seguro Compra Tranquila
                                       ,case when fm.qtd_parc >= 7 and fm.vlr_juro <> 0 -- PARCELADO COM JUROS
                                              then
                                               102
                                              else
                                              0
                                              end as  cod_fam_prod
                                       ,fm.num_ccm
                                       ,fm.vlr_parc
                                       ,fm.vlr_prim_parc
                                  from  fin_movto@ccm_fin       fm
                                       ,pub_usuario@ccm_fin     pu
                                       ,fin_forma_pgto@ccm_fin  sta
                                 where fm.id_usu              = pu.id_usu(+)
                                 and   fm.cod_forma_pgto      = sta.cod_forma_pgto
                                 and   fm.cod_rede_tef        = 160 -- CARTAO ITAU
                                 and   fm.dt_emis             between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                 and   nvl(fm.flg_estorno,0) = 0
                                 and   fm.cod_forma_pgto     = 3
                                 and   fm.cod_trans_cx       = 1 ' );         -- 1: Venda | 8: Devolucao Venda | 15: Cartao Presente | 24: Cancelamento Cartao Presente
               fetch cur_itau
               bulk collect into i_cod_fil
                                ,i_dt_trans
                                ,i_id_movto_fin
                                ,i_cod_forma_pgto
                                ,i_descr_forma_pgto
                                ,i_cod_plano_pgto
                                ,i_descr_plano
                                ,i_cod_tot_meio_pgto
                                ,i_num_nsu
                                ,i_dt_hr_movto
                                ,i_num_cupom
                                ,i_qtd_parc
                                ,i_vlr_movto
                                ,i_vlr_juro
                                ,i_vlr_liq_trans
                                ,i_matricula_vend
                                ,i_cpf_vend
                                ,i_cod_prod_cpa_tranq
                                ,i_vlr_tot_cpa_tranq
                                ,i_cod_fam_prod
                                ,i_num_ccm
                                ,i_vlr_parc
                                ,i_vlr_prim_parc;
                     forall x in 1..i_cod_fil.count
                     execute immediate 'insert into ' || v_nm_tab_realz_ita_tot ||
                                            ' values (:1
                                                    ,:d1
                                                    ,:2
                                                    ,:3
                                                    ,:v1
                                                    ,:4
                                                    ,:v2
                                                    ,:v3
                                                    ,:5
                                                    ,:d2
                                                    ,:6
                                                    ,:7
                                                    ,:8
                                                    ,:9
                                                    ,:10
                                                    ,:11
                                                    ,:12
                                                    ,:13
                                                    ,:14
                                                    ,:v3
                                                    ,:15
                                                    ,:16
                                                    ,:17) '
                                               using i_cod_fil(x)
                                                    ,i_dt_trans(x)
                                                    ,i_id_movto_fin(x)
                                                    ,i_cod_forma_pgto(x)
                                                    ,i_descr_forma_pgto(x)
                                                    ,i_cod_plano_pgto(x)
                                                    ,i_descr_plano(x)
                                                    ,i_cod_tot_meio_pgto(x)
                                                    ,i_num_nsu(x)
                                                    ,i_dt_hr_movto(x)
                                                    ,i_num_cupom(x)
                                                    ,i_qtd_parc(x)
                                                    ,i_vlr_movto(x)
                                                    ,i_vlr_juro(x)
                                                    ,i_vlr_liq_trans(x)
                                                    ,i_matricula_vend(x)
                                                    ,i_cpf_vend(x)
                                                    ,i_cod_prod_cpa_tranq(x)
                                                    ,i_vlr_tot_cpa_tranq(x)
                                                    ,i_cod_fam_prod(x)
                                                    ,i_num_ccm(x)
                                                    ,i_vlr_parc(x)
                                                    ,i_vlr_prim_parc(x);
              close cur_itau;

              commit;
          exception
            when others then
             p_cod_erro     := 1;
             p_descr_erro   := 'Erro ao inserir na tabela '||v_nm_tab_realz_ita_tot ||' erro - '|| sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         -- COMPRA PARCELADA ITAU
         begin
           execute immediate 'drop table '||v_nm_tab_realz_ita_parc;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '||v_nm_tab_realz_ita_parc||'  pctfree 0 nologging as
                                  select ita.id_movto_fin                                  as id_movto_fin
                                        ,ita.num_nsu                                       as num_nsu
                                        ,ita.num_cupom                                     as num_cupom
                                        ,ita.dt_trans                                      as fat_dt_transacao
                                        ,ita.cod_fil                                       as filial_cpra
                                        ,to_number(102)                                    as cod_fam_prod
                                        ,''MARISA ITAUCARD PARCELADO''                     as descr_fam_prod
                                        ,to_number(ita.cod_forma_pgto || 000)              as cod_prod
                                        ,''CARTAO MARISA ITAUCARD PARCELADO''              as descr_produto
                                        ,ita.vlr_movto                                     as vlr_bruto_trans
                                        ,ita.vlr_juro                                      as vlr_juros
                                        ,(ita.vlr_movto -ita.vlr_juro)                     as vlr_liq_trans
                                        ,ita.cod_prod_cpa_tranq                            as cpr_prod_cod_comp_tranq
                                        ,''CPRA.TRANQ.CARTAO MARISA ITAUCARD''             as prod_desc_comp_tranq
                                        ,ita.vlr_tot_cpa_tranq                             as vlr_parc_seguro -->>> VERIFICAR
                                        ,ita.vlr_tot_cpa_tranq                             as vlr_total_seguro
                                        ,302                                               as eve_cod -->>> VERIFICAR
                                        ,matricula_vend                                    as matricula_vendedor
                                        ,ita.qtd_parc                                      as qtd_parc
                                        ,ita.cpf_vend                                      as cpf_vend
                                  from   '|| v_nm_tab_realz_ita_tot ||' ita
                                   where ita.qtd_parc >= 2
                                  ';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_ita_parc ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_ita_parc || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_ita_parc || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- cria tabela de apuracao base para o realizado filial,
         -- apurando todas as vendas sem fazer join com a srv_funcionario
         -- e apurando inclusive vendas de temporarios
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_tod_func ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_tod_func || '  pctfree 0 nologging as
                               select c.id_movto_fin
                                     ,c.num_nsu
                                     ,c.num_cupom
                                     ,c.fat_dt_transacao
                                     ,c.filial_cpra             as fil_cod
                                     ,6                         as cod_indic
                                     ,''VENDA COM JUROS ITAU''  as descr_indic
                                     ,c.cod_fam_prod
                                     ,c.descr_fam_prod
                                     ,c.cod_prod
                                     ,c.descr_produto
                                     ,c.vlr_bruto_trans
                                     ,c.vlr_juros
                                     ,c.vlr_liq_trans
                                     ,c.cpr_prod_cod_comp_tranq
                                     ,c.prod_desc_comp_tranq
                                     ,c.vlr_parc_seguro
                                     ,c.vlr_total_seguro
                                     ,c.matricula_vendedor
                                     ,c.eve_cod
                                     ,c.cpf_vend                 as cpf_vendedor
                                     ,c.qtd_parc
                                 from '||v_nm_tab_realz_ita_parc||'  c
                                where c.vlr_juros > 0
                                 ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_tod_func,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_tod_func,1,28) ||' on ' || v_nm_tab_realz_tod_func || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_tod_func || ' - index: i_' || substr(v_nm_tab_realz_tod_func,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_tod_func || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- tabela de apuracao de funcionarios
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fu ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                               select c.id_movto_fin
                                     ,c.num_nsu
                                     ,c.num_cupom
                                     ,c.fat_dt_transacao
                                     ,c.fat_dt_transacao data_adesao_titular
                                     ,c.filial_cpra             as fil_cod
                                     ,6                         as cod_indic
                                     ,''VENDA COM JUROS ITAU''  as descr_indic
                                     ,c.cod_fam_prod
                                     ,c.descr_fam_prod
                                     ,c.cod_prod
                                     ,c.descr_produto
                                     ,c.vlr_bruto_trans
                                     ,c.vlr_juros
                                     ,c.vlr_liq_trans
                                     ,c.cpr_prod_cod_comp_tranq
                                     ,c.prod_desc_comp_tranq
                                     ,c.vlr_parc_seguro
                                     ,c.vlr_total_seguro
                                     ,c.matricula_vendedor
                                     ,c.eve_cod
                                     ,f.num_cpf_func             as cpf_vendedor
                                     ,c.qtd_parc
                                 from '||v_nm_tab_realz_ita_parc||'  c
                                     ,srv_funcionario       f
                                where c.vlr_juros > 0
                                  and (c.matricula_vendedor = f.cod_func or c.matricula_vendedor = to_number(f.cod_cracha))';
         exception
            when invalid_number then
               begin
                  execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                                     select c.id_movto_fin
                                           ,c.num_nsu
                                           ,c.num_cupom
                                           ,c.fat_dt_transacao
                                           ,c.fat_dt_transacao data_adesao_titular
                                           ,c.filial_cpra             as fil_cod
                                           ,6                         as cod_indic
                                           ,''VENDA COM JUROS ITAU''  as descr_indic
                                           ,c.cod_fam_prod
                                           ,c.descr_fam_prod
                                           ,c.cod_prod
                                           ,c.descr_produto
                                           ,c.vlr_bruto_trans
                                           ,c.vlr_juros
                                           ,c.vlr_liq_trans
                                           ,c.cpr_prod_cod_comp_tranq
                                           ,c.prod_desc_comp_tranq
                                           ,c.vlr_parc_seguro
                                           ,c.vlr_total_seguro
                                           ,c.matricula_vendedor
                                           ,c.eve_cod
                                           ,f.num_cpf_func             as cpf_vendedor
                                           ,c.qtd_parc
                                 from '||v_nm_tab_realz_ita_parc||'  c
                                     ,srv_funcionario       f
                                where c.vlr_juros > 0
                                  and (c.matricula_vendedor = f.cod_func or to_char(c.matricula_vendedor) = f.cod_cracha)';
               exception
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao criar na segunda tentativa a tabela ' || v_nm_tab_realz_fu ||
                                       ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               end;

            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fu || ' - index: i_' || substr(v_nm_tab_realz_fu,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;

         --
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fi ;
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table ' || v_nm_tab_realz_fi || '  pctfree 0 nologging as
                               select fil_cod
                                     ,cod_indic
                                     ,descr_indic
                                     ,count(id_movto_fin)                  as qtde
                                     ,sum(vlr_bruto_trans)                 as vlr_realz_bruto_cpr_jur
                                     ,sum(vlr_juros)                       as vlr_realz_juros_cpr_jur
                                     ,sum(vlr_liq_trans)                   as vlr_realz_cpr_jur
                                 from ' || v_nm_tab_realz_tod_func || v_p_cod_fil||'
                           group by fil_cod
                                   ,cod_indic
                                   ,descr_indic ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fi ||  ' - index: i_' || substr(v_nm_tab_realz_fi,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- META PARA VENDAS PARCELADAS ITAU
         begin
           execute immediate 'drop table SRV_TMP_META_VENDAS_I_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table SRV_TMP_META_VENDAS_I_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00'))
                                           || ' pctfree 0 nologging as
                                       select ita.cod_fil                      as cod_fil
                                             ,sum(ita.VLR_MOVTO)               as VLR_MOVTO
                                         from '||v_nm_tab_realz_ita_tot||'        ita
                                     group by ita.COD_FIL ';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || ' SRV_TMP_META_VENDAS_I_'
                                 || trim(to_char(p_num_ano, '0000'))
                                 || trim(to_char(p_num_mes, '00'))
                                 || ' - erro - '
                                 || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_SRV_TMP_META_VENDAS_I_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'));
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_SRV_TMP_META_VENDAS_I_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'))
                              || '  on ' || 'SRV_TMP_META_VENDAS_I_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'))
                              || '  (cod_fil)';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'analyze table SRV_TMP_META_VENDAS_I_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00'))
                                           || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on SRV_TMP_META_VENDAS_I_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00')) || ' to SRV_SEL';
            execute immediate 'grant select on SRV_TMP_META_VENDAS_I_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00')) || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

          -----------------------------------------------------------------------------------------------------
         -- REALIZADO COMPRA TRANQUILA ITAU
         -----------------------------------------------------------------------------------------------------
         v_nm_tab_realz_fu := 'SRV_REALZFU_CPRA_TRANQI_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CPRA_TRANQI_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func := 'SRV_REALZ_TOD_FU_CT_IT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));


         -- cria tabela de apuracao base para o realizado filial,
         -- apurando todas as vendas sem fazer join com a srv_funcionario
         -- e apurando inclusive vendas de temporarios
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_tod_func ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_tod_func ||' (
                               id_movto_fin              number
                              ,num_nsu                   number
                              ,num_cupom                 number
                              ,fat_dt_transacao          date
                              ,fil_cod                   number(4)
                              ,cod_prod                  number
                              ,descr_produto             varchar2(40)
                              ,vlr_bruto_trans           number
                              ,vlr_juros                 number
                              ,vlr_liq_trans             number
                              ,cpr_prod_cod_comp_tranq   number
                              ,prod_desc_comp_tranq      varchar2(40)
                              ,vlr_parc_seguro           number
                              ,vlr_total_seguro          number
                              ,matricula_vendedor        number
                              ,cod_indic                 number
                              ,descr_indic               varchar2(50)
                              ,qtd_parc                  number(4)
                              ,cpf_vendedor              number    )
                               pctfree 0 nologging';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         --
         begin
            execute immediate 'insert into '|| v_nm_tab_realz_tod_func ||'
                                  select cpr.id_movto_fin
                                        ,cpr.num_nsu
                                        ,cpr.num_cupom
                                        ,cpr.fat_dt_transacao
                                        ,cpr.filial_cpra                 as fil_cod
                                        ,cpr.cod_prod
                                        ,cpr.descr_produto
                                        ,cpr.vlr_bruto_trans
                                        ,cpr.vlr_juros
                                        ,cpr.vlr_liq_trans
                                        ,cpr.cpr_prod_cod_comp_tranq
                                        ,cpr.prod_desc_comp_tranq
                                        ,cpr.vlr_parc_seguro
                                        ,cpr.vlr_total_seguro
                                        ,cpr.matricula_vendedor
                                        ,7                               as cod_indic
                                        ,''COMPRA TRANQUILA ITAU''       as descr_indic
                                        ,cpr.qtd_parc
                                        ,cpr.cpf_vend                    as cpf_vendedor
                                from  '||v_nm_tab_realz_ita_parc||'         cpr
                                where to_char(cpr.cpr_prod_cod_comp_tranq) in ((select ip.cod_prod
                                                                         from srv_tipo_rem_var        t
                                                                             ,srv_grupo_indicador     g
                                                                             ,srv_indicador           i
                                                                             ,srv_indicador_produto   ip
                                                                             ,srv_produto             p
                                                                         where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                           and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                           and g.cod_grp_indic       = i.cod_grp_indic
                                                                           and i.descr_indic         = ''COMPRA TRANQUILA ITAU''
                                                                           and i.flg_indic_ativ      = ''S''
                                                                           and i.cod_indic           = ip.cod_indic
                                                                           and ip.cod_orig_prod      = p.cod_orig_prod
                                                                           and ip.cod_prod           = p.cod_prod))';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao inserir na a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                     || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_tod_func,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_tod_func,1,28) ||' on ' || v_nm_tab_realz_tod_func || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_tod_func || ' - index: i_' || substr(v_nm_tab_realz_tod_func,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_tod_func || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||' (
                               id_movto_fin              number
                              ,num_nsu                   number
                              ,num_cupom                 number
                              ,fat_dt_transacao          date
                              ,data_adesao_titular       date
                              ,fil_cod                   number(4)
                              ,cod_prod                  number
                              ,descr_produto             varchar2(40)
                              ,vlr_bruto_trans           number
                              ,vlr_juros                 number
                              ,vlr_liq_trans             number
                              ,cpr_prod_cod_comp_tranq   number
                              ,prod_desc_comp_tranq      varchar2(40)
                              ,vlr_parc_seguro           number
                              ,vlr_total_seguro          number
                              ,matricula_vendedor        number
                              ,cod_indic                 number
                              ,descr_indic               varchar2(50)
                              ,qtd_parc                  number(4)
                              ,cpf_vendedor              number    )
                               pctfree 0 nologging';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         --
         begin
            execute immediate 'insert into '|| v_nm_tab_realz_fu ||'
                                  select cpr.id_movto_fin
                                        ,cpr.num_nsu
                                        ,cpr.num_cupom
                                        ,cpr.fat_dt_transacao
                                        ,cpr.fat_dt_transacao
                                        ,cpr.filial_cpra                 as fil_cod
                                        ,cpr.cod_prod
                                        ,cpr.descr_produto
                                        ,cpr.vlr_bruto_trans
                                        ,cpr.vlr_juros
                                        ,cpr.vlr_liq_trans
                                        ,cpr.cpr_prod_cod_comp_tranq
                                        ,cpr.prod_desc_comp_tranq
                                        ,cpr.vlr_parc_seguro
                                        ,cpr.vlr_total_seguro
                                        ,cpr.matricula_vendedor
                                        ,7                               as cod_indic
                                        ,''COMPRA TRANQUILA ITAU''       as descr_indic
                                        ,cpr.qtd_parc
                                        ,f.num_cpf_func                  as cpf_vendedor
                                from  '||v_nm_tab_realz_ita_parc||'   cpr
                                     ,srv_funcionario        f
                                where (cpr.matricula_vendedor = f.cod_func or cpr.matricula_vendedor = to_number(f.cod_cracha))
                                  and cpr.cpr_prod_cod_comp_tranq in ((select ip.cod_prod
                                                                         from srv_tipo_rem_var        t
                                                                             ,srv_grupo_indicador     g
                                                                             ,srv_indicador           i
                                                                             ,srv_indicador_produto   ip
                                                                             ,srv_produto             p
                                                                         where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                           and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                           and g.cod_grp_indic       = i.cod_grp_indic
                                                                           and i.descr_indic         = ''COMPRA TRANQUILA ITAU''
                                                                           and i.flg_indic_ativ      = ''S''
                                                                           and i.cod_indic           = ip.cod_indic
                                                                           and ip.cod_orig_prod      = p.cod_orig_prod
                                                                           and ip.cod_prod           = p.cod_prod))';
         exception
            when invalid_number then
               begin
                  execute immediate 'insert into '|| v_nm_tab_realz_fu ||'
                                  select cpr.id_movto_fin
                                        ,cpr.num_nsu
                                        ,cpr.num_cupom
                                        ,cpr.fat_dt_transacao
                                        ,cpr.fat_dt_transacao
                                        ,cpr.filial_cpra                 as fil_cod
                                        ,cpr.cod_prod
                                        ,cpr.descr_produto
                                        ,cpr.vlr_bruto_trans
                                        ,cpr.vlr_juros
                                        ,cpr.vlr_liq_trans
                                        ,cpr.cpr_prod_cod_comp_tranq
                                        ,cpr.prod_desc_comp_tranq
                                        ,cpr.vlr_parc_seguro
                                        ,cpr.vlr_total_seguro
                                        ,cpr.matricula_vendedor
                                        ,7                               as cod_indic
                                        ,''COMPRA TRANQUILA ITAU''       as descr_indic
                                        ,cpr.qtd_parc
                                        ,f.num_cpf_func                  as cpf_vendedor
                                      from  '||v_nm_tab_realz_ita_parc||'   cpr
                                           ,srv_funcionario        f
                                      where (cpr.matricula_vendedor = f.cod_func or to_char(cpr.matricula_vendedor) = f.cod_cracha)
                                        and cpr.cpr_prod_cod_comp_tranq in ((select ip.cod_prod
                                                                               from srv_tipo_rem_var        t
                                                                                   ,srv_grupo_indicador     g
                                                                                   ,srv_indicador           i
                                                                                   ,srv_indicador_produto   ip
                                                                                   ,srv_produto             p
                                                                               where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                                 and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                                 and g.cod_grp_indic       = i.cod_grp_indic
                                                                                 and i.descr_indic         = ''COMPRA TRANQUILA ITAU''
                                                                                 and i.flg_indic_ativ      = ''S''
                                                                                 and i.cod_indic           = ip.cod_indic
                                                                                 and ip.cod_orig_prod      = p.cod_orig_prod
                                                                                 and ip.cod_prod           = p.cod_prod))';

               exception
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao criar na segunda tentativa a tabela ' || v_nm_tab_realz_fu ||
                                       ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               end;


            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao inserir na a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                     || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;



         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fu || ' - index: i_' || substr(v_nm_tab_realz_fu,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := 'where fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;

         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                               select fil_cod
                                     ,cod_indic
                                     ,descr_indic
                                     ,count(id_movto_fin)                  as qtde
                                     ,sum(vlr_bruto_trans)                 as vlr_realz_bruto_cpr_tranq
                                     ,sum(vlr_juros)                       as vlr_realz_juros_cpr_tranq
                                     ,sum(vlr_liq_trans)                   as vlr_realz_cpra_tranq
                                 from '|| v_nm_tab_realz_tod_func || v_p_cod_fil ||'
                             group by fil_cod
                                     ,cod_indic
                                     ,descr_indic';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fi || ' - index: i_' || substr(v_nm_tab_realz_fi,1,28) ||
                                 ' erro - '                || sqlerrm;


               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- META PARA COMPRA TRANQUILA ITAU
         begin
           execute immediate 'drop table SRV_TMP_META_CPR_TRANQI_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table SRV_TMP_META_CPR_TRANQI_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'))||'
                                            (
                                              FIL_COD              NUMBER(4) not null,
                                              QTDE_VDS_PARC_PL_ITA NUMBER
                                            ) pctfree 0 nologging';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || ' SRV_TMP_META_CPR_TRANQI_'
                                 || trim(to_char(p_num_ano, '0000'))
                                 || trim(to_char(p_num_mes, '00'))
                                 || ' - erro - '
                                 || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         ---
         begin
            open cur_cpr_tranqi for 'select /*+ first_rows (50) */
                                            filial_cpra             as fil_cod
                                           ,count(id_movto_fin)     as qtde_vds_parc_PL_ITA
                                      from  '||v_nm_tab_realz_ita_parc ||'
                                    group by filial_cpra ';
               fetch cur_cpr_tranqi
               bulk collect into c_fil_cod_vds,c_qtde_vds_parc_pl_ita;

                     forall x in 1..c_fil_cod_vds.count
                     execute immediate 'insert into SRV_TMP_META_CPR_TRANQI_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||' values (:1,:2) ' using c_fil_cod_vds(x),c_qtde_vds_parc_pl_ita(x);

              close cur_cpr_tranqi;
              commit;
          exception
            when others then
             p_cod_erro     := 1;
             p_descr_erro   := 'Erro ao inserir na tabela ' || trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00')) ||
                               ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_SRV_T_META_CPR_TRANQI_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'));
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'create index i_SRV_T_META_CPR_TRANQI_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'))
                              || '  on ' || 'SRV_TMP_META_CPR_TRANQI_'
                              || trim(to_char(p_num_ano, '0000'))
                              || trim(to_char(p_num_mes, '00'))
                              || '  (fil_cod)';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'analyze table SRV_TMP_META_CPR_TRANQI_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00'))
                                           || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on SRV_TMP_META_CPR_TRANQI_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00')) || ' to SRV_SEL';
            execute immediate 'grant select on SRV_TMP_META_CPR_TRANQI_'
                                           || trim(to_char(p_num_ano, '0000'))
                                           || trim(to_char(p_num_mes, '00')) || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



      -- if p_descr_indic is null or p_descr_indic in ('VENDA COM JUROS ITAU', 'COMPRA TRANQUILA ITAU')
      end if;

      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------
      -- VENDA COM JUROS PL E ITAU
      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------
      if p_descr_indic is null or p_descr_indic in ('VENDA COM JUROS PL E ITAU') then

         v_nm_tab_realz_fu              := 'SRV_REALZFU_VJ_PL_ITAU_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));

        v_nm_tab_realz_fi               := 'SRV_REALZFI_VJ_PL_ITAU_'
                                            ||trim(to_char(p_num_ano, '0000'))
                                            ||trim(to_char(p_num_mes, '00'));

        begin
          execute immediate 'drop table ' || v_nm_tab_realz_fu ;
        exception
          when others then
            null;
        end;
        --
        begin
          execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                               select fil_cod
                                     ,matricula_vendedor
                                     ,cpf_vendedor
                                 from srv_realzfu_cpr_jur_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                  union all
                               select fil_cod
                                     ,matricula_vendedor
                                     ,cpf_vendedor
                                 from srv_realzfu_cpr_jur_it_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'';

        exception
          when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                              ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

        end;

        begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
        exception
            when others then
               null;
        end;

        begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
        exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fu || ' - index: i_' || substr(v_nm_tab_realz_fu,1,28) ||
                                 ' erro - '                || sqlerrm;


               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

        end;

        begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
        exception
            when others then
               null;
        end;

        begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
        exception
            when others then
               null;
        end;

        --
        begin
          execute immediate 'drop table ' || v_nm_tab_realz_fi ;
        exception
          when others then
            null;
        end;

        begin
          execute immediate 'create table ' || v_nm_tab_realz_fi || '  pctfree 0 nologging as
            select fil_cod
                 , 35                             cod_indic
                 , ''VENDA COM JUROS PL E ITAU''  descr_indic
                 , sum(qtde)                      qtde
                 , sum(vlr_realz_bruto_cpr_jur)   vlr_realz_bruto_cpr_jur
                 , sum(vlr_realz_juros_cpr_jur)   vlr_realz_juros_cpr_jur
                 , sum(vlr_realz_cpr_jur)         vlr_realz_cpr_jur
              from (select * from SRV_REALZFI_CPR_JUR_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                      union all
                    select * from SRV_REALZFI_CPR_JUR_IT_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||')
             group by fil_cod';

        exception
          when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                              ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );


         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fi || ' - index: i_' || substr(v_nm_tab_realz_fi,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;
         end;

         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
      END IF;

      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------
      -- COMPRA TRANQUILA PL E ITAU
      -------------------------------------------------------------------------------------------------
      -------------------------------------------------------------------------------------------------

      if p_descr_indic is null or p_descr_indic in ('COMPRA TRANQUILA PL E ITAU') then

        v_nm_tab_realz_fu := 'SRV_REALZFU_CT_PL_ITAU_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));
        v_nm_tab_realz_fi := 'SRV_REALZFI_CT_PL_ITAU_'
                             ||trim(to_char(p_num_ano, '0000'))
                             ||trim(to_char(p_num_mes, '00'));

        begin
          execute immediate 'drop table ' || v_nm_tab_realz_fu ;
        exception
          when others then
            null;
        end;
        --
        begin
          execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                                SELECT 22 COD_INDIC
                                     , ''COMPRA TRANQUILA PL E ITAU'' DESCR_INDIC
                                     , FIL_COD
                                     , CPF_VENDEDOR
                                  FROM SRV_REALZFU_CPRA_TRANQ_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                UNION ALL
                                SELECT 22 COD_INDIC
                                     , ''COMPRA TRANQUILA PL E ITAU'' DESCR_INDIC
                                     , FIL_COD
                                     , CPF_VENDEDOR
                                  FROM SRV_REALZFU_CPRA_TRANQI_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'));

        exception
          when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                              ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

        end;

        begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
        exception
            when others then
               null;
        end;

        begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
        exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fu || ' - index: i_' || substr(v_nm_tab_realz_fu,1,28) ||
                                 ' erro - '                || sqlerrm;


               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;

        end;

        begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
        exception
            when others then
               null;
        end;

        begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
        exception
            when others then
               null;
        end;

        --Filial
        begin
          execute immediate 'drop table ' || v_nm_tab_realz_fi ;
        exception
          when others then
            null;
        end;

        begin
          execute immediate 'create table ' || v_nm_tab_realz_fi || '  pctfree 0 nologging as
             select fil_cod
                 , 22                             cod_indic
                 , ''COMPRA TRANQUILA PL E ITAU''  descr_indic
                 , sum(qtde)                      qtde
                 , sum(vlr_realz_bruto_cpr_tranq) vlr_realz_bruto_cpr_tranq
                 , sum(vlr_realz_juros_cpr_tranq) vlr_realz_juros_cpr_tranq
                 , sum(vlr_realz_cpra_tranq)      vlr_realz_cpra_tranq
              from (select * from SRV_REALZFI_CPRA_TRANQ_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                      union all
                    select * from SRV_REALZFI_CPRA_TRANQI_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||')
             group by fil_cod';

        exception
          when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                              ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );


         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar indice na tabela ' || v_nm_tab_realz_fi || ' - index: i_' || substr(v_nm_tab_realz_fi,1,28) ||
                                 ' erro - '                || sqlerrm;

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Realizado Filial - Erro exception create index: '
                                                                       ,p_body    => v_body
                                                                       );
               --v_ins_log_erro is not null
               end if;
         end;

         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      end if;


      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- PRODUTOS PSF (EXCETO compra tranquila e compra com juros)
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      --#####################################################################
      -- cria tabela de cancelamentos de contratos do pss
      --#####################################################################
      v_nm_tab_ctr_psf_canc := 'SRV_TMP_CTR_PSF_CANC_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
      --
      begin
        execute immediate 'drop table ' || v_nm_tab_ctr_psf_canc;
      exception
        when others then
          null;
      end;
      --
      begin
         execute immediate 'create table '|| v_nm_tab_ctr_psf_canc ||'  pctfree 0 nologging as
                               select f.pss_prd_codigo
                                     ,f.cli_cpf
                                     ,f.pss_ctr_codigo
                                     ,f.pss_lnc_dt_lanc_premio
                                from ccm_pss_lancamento_premio  f
                                    ,ccm_pss_contrato_cliente   g
                               where f.pss_ctr_codigo         = g.pss_ctr_codigo
                                 and g.pss_ctr_in_situacao    = 2
                                 and f.pss_lnc_tipo           = 5 -- cancelamento
                                 and f.pss_lnc_dt_lanc_premio > (to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)';
      exception
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_ctr_psf_canc ||
                              ' erro - '                || sqlerrm;
            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => null
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --
      begin
         execute immediate 'drop index i_' || substr(v_nm_tab_ctr_psf_canc,1,28);
      exception
         when others then
            null;
      end;
      begin
         execute immediate 'create index i_' || substr(v_nm_tab_ctr_psf_canc,1,28) ||' on ' || v_nm_tab_ctr_psf_canc || ' (pss_ctr_codigo)';
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'analyze table ' || v_nm_tab_ctr_psf_canc || ' estimate statistics sample 10 percent';
      exception
         when others then
            null;
      end;
      --
      begin
         execute immediate 'grant select on ' || v_nm_tab_ctr_psf_canc || ' to SRV_SEL';
         execute immediate 'grant select on ' || v_nm_tab_ctr_psf_canc || ' to CCM_SEL';
      exception
         when others then
            null;
      end;

      --#####################################################################
      -- cria tabela de cancelamentos de dependentes do pss
      --#####################################################################
      v_nm_tab_ctr_psfdep_canc := 'SRV_TMP_CTR_PSFDEP_CANC_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));

      begin
        execute immediate 'drop table ' || v_nm_tab_ctr_psfdep_canc;
      exception
        when others then
          null;
      end;
      --
      begin
         execute immediate 'create table '|| v_nm_tab_ctr_psfdep_canc ||'  pctfree 0 nologging as
                               select f.pss_prd_codigo
                                      ,f.cli_cpf
                                      ,f.pss_ctr_codigo
                                      ,f.pss_lnc_dt_lanc_premio
                                 from ccm_pss_lancamento_premio         f
                                     ,ccm_pss_dependente                g
                                where f.pss_ctr_codigo                = g.pss_ctr_codigo
                                  and g.stat_cod                      = 2 -- cancelado
                                  and f.pss_lnc_tipo                  = 2 -- alteracao
                                  and trunc(f.pss_lnc_dt_lanc_premio) = trunc(g.pss_dpt_dt_alteracao)
                                  and g.pss_dpt_dt_alteracao > (to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)';
      exception
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_ctr_psfdep_canc ||
                              ' erro - '                || sqlerrm;
            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => null
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --
      begin
         execute immediate 'drop index i_' || substr(v_nm_tab_ctr_psfdep_canc,1,28);
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'create index i_' || substr(v_nm_tab_ctr_psfdep_canc,1,28) ||' on ' || v_nm_tab_ctr_psfdep_canc || ' (pss_ctr_codigo)';
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'analyze table ' || v_nm_tab_ctr_psfdep_canc || ' estimate statistics sample 10 percent';
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'grant select on ' || v_nm_tab_ctr_psfdep_canc || ' to SRV_SEL';
         execute immediate 'grant select on ' || v_nm_tab_ctr_psfdep_canc || ' to CCM_SEL';
      exception
         when others then
           null;
      end;

      --#####################################################################
      -- cria tabela de cancelamentos de marisa odonto itau
      --#####################################################################
      v_nm_tab_ctr_odoIta_canc := 'SRV_TMP_CTR_odoIta_CANC_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));
      --
      begin
        execute immediate 'drop table ' || v_nm_tab_ctr_odoIta_canc;
      exception
        when others then
          null;
      end;
      --
      begin
         execute immediate 'create table '|| v_nm_tab_ctr_odoIta_canc ||'  pctfree 0 nologging as
                               select f.prod_cod
                                     ,f.cli_cpf
                                     ,f.ctr_codigo
                                     ,f.data_alteracao
                                from ccm_itau_cliente_produto    f
                               where f.stat_cod                = 2 --  cancelado
                                 and f.data_alteracao > (to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)
                           ';
      exception
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_ctr_odoIta_canc ||
                              ' erro - '                || sqlerrm;
            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => null
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --
      begin
         execute immediate 'drop index i_' || substr(v_nm_tab_ctr_odoIta_canc,1,28);
      exception
         when others then
            null;
      end;
      --
      begin
         execute immediate 'create index i_' || substr(v_nm_tab_ctr_odoIta_canc,1,28) ||' on ' || v_nm_tab_ctr_odoIta_canc || ' (ctr_codigo)';
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'analyze table ' || v_nm_tab_ctr_odoIta_canc || ' estimate statistics sample 10 percent';
      exception
         when others then
           null;
      end;
      --
      begin
         execute immediate 'grant select on ' || v_nm_tab_ctr_odoIta_canc || ' to SRV_SEL';
         execute immediate 'grant select on ' || v_nm_tab_ctr_odoIta_canc || ' to CCM_SEL';
      exception
         when others then
           null;
      end;

      --#####################################################################
      -- cria tabela de cancelamentos de dependentes marisa odonto itau
      --#####################################################################

      v_nm_tab_ctr_OdepIta_canc := 'SRV_TMP_CTR_OdepIt_CANC_'
                                  ||trim(to_char(p_num_ano, '0000'))
                                  ||trim(to_char(p_num_mes, '00'));
      begin
        execute immediate 'drop table ' || v_nm_tab_ctr_OdepIta_canc;
      exception
        when others then
          null;
      end;
      --
      begin
         execute immediate 'create table '|| v_nm_tab_ctr_OdepIta_canc ||'  pctfree 0 nologging as
                               select f.prod_cod
                                     ,f.cli_cpf
                                     ,f.ctr_codigo
                                     ,f.data_alteracao
                                from ccm_itau_cliente_produto_depen    f
                               where f.stat_cod                      = 2 --  cancelado
                                 and f.data_alteracao > (to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)';
      exception
         when others then
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_ctr_OdepIta_canc ||
                              ' erro - '                || sqlerrm;
            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => null
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --
      begin
         execute immediate 'drop index i_' || substr(v_nm_tab_ctr_OdepIta_canc,1,28);
      exception
         when others then
            null;
      end;
      --
      begin
         execute immediate 'create index i_' || substr(v_nm_tab_ctr_OdepIta_canc,1,28) ||' on ' || v_nm_tab_ctr_OdepIta_canc || ' (ctr_codigo)';
      exception
         when others then
            null;
      end;
      --
      begin
         execute immediate 'analyze table ' || v_nm_tab_ctr_OdepIta_canc || ' estimate statistics sample 10 percent';
      exception
         when others then
            null;
      end;
      --
      begin
         execute immediate 'grant select on ' || v_nm_tab_ctr_OdepIta_canc || ' to SRV_SEL';
         execute immediate 'grant select on ' || v_nm_tab_ctr_OdepIta_canc || ' to CCM_SEL';
      exception
         when others then
            null;
      end;


      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      --ASSISTENCIA ODONTOLOGICA LOJA
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'ASSISTENCIA ODONTOLOGICA LOJA') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_ASS_ODO_LJ_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_ASS_ODO_LJ_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
          execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                    select d.fil_cod                         fil_cod
                          ,a.cli_cpf                         cli_cpf
                          ,41                                cod_indic
                          ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_indic
                          ,c.pss_vnd_cpf                     cpf_vendedor
                          ,a.pss_prd_codigo                  cod_prod
                          ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_prod
                          ,a.pss_ctr_codigo                  contrato_titular
                          ,a.pss_ctr_data_adesao             data_adesao_titular
                      from ccm_pss_contrato_cliente a
                     inner join ccm_pss_lancamento_premio b on b.pss_ctr_codigo  = a.pss_ctr_codigo
                                                           and b.pss_lnc_nro_parcela = 1 --primeira parcela do produto
                                                           and b.pss_lnc_tipo = 3 --pagamento do produto
                                                           and b.pss_lnc_valor_pago >= b.pss_lnc_vr_lanc_premio --o valor pago deve ser maior ou igual ao valor do contrato
                                                           and(b.pss_lnc_data_pagto - 180) <= a.pss_ctr_data_adesao --consider adesoes pagas em ate 180 dias apos a adesao
                                                           and b.pss_lnc_data_pagto between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                        and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') --considerar apenas pagamentos no mes de referencia do calculo
                      left join ccm_pss_vendedor c on c.pss_vnd_codigo = a.pss_vnd_codigo
                      left join ccm_pss_canal_venda d on d.pss_cnl_codigo = a.pss_cnl_codigo
                     where a.pss_prd_codigo in(21,41) --ASSISTENCIA ODONTOLOGICA LOJA
                       and a.pss_ctr_data_adesao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')--considerar adesao feitas a partir de 01/06/2016

                    union all

                    select e.fil_cod
                          ,a.cli_cpf                         cli_cpf
                          ,41                                cod_indic
                          ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_indic
                          ,c.pss_vnd_cpf                     cpf_vend
                          ,a.pss_prd_codigo                  cod_prod
                          ,b.pss_prd_nome                    descr_prod
                          ,a.pss_ctr_codigo                  contrato_titular
                          ,f.pss_dpt_dt_adesao               data_adesao_titular
                     from ccm_pss_dependente            f
                         ,ccm_pss_vendedor              c
                         ,ccm_pss_canal_venda           e
                         ,ccm_pss_contrato_cliente      a
                         ,ccm_pss_produto               b
                    where a.pss_ctr_codigo              = f.pss_ctr_codigo
                      and a.pss_prd_codigo              = b.pss_prd_codigo
                      and f.pss_cnl_codigo              = e.pss_cnl_codigo
                      and f.stat_cod                    = 1
                      and ( f.stat_cod                  = 1
                            OR
                           (f.stat_cod                  = 2 and exists (select 1 from '|| v_nm_tab_ctr_psfdep_canc || ' g where g.pss_ctr_codigo = f.pss_ctr_codigo))
                          )
                      and e.fil_cod                     <> 900
                      and f.pss_dpt_dt_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                      and f.pss_vnd_codigo              = c.pss_vnd_codigo (+)

                    union all

                    --ADESAO ODONTO ITAU TITULAR
                    select e.fil_cod
                          ,i.cli_cpf                         cli_cpf
                          ,41                                cod_indic
                          ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_indic
                          ,i.cpf_vendedor                    cpf_vendedor
                          ,b.pss_prd_codigo                  cod_prod
                          ,b.pss_prd_nome                    descr_prod
                          ,i.ctr_codigo                      contrato_titular
                          ,i.data_adesao                     data_adesao_titular
                      from ccm_itau_cliente_produto           i
                          ,ccm_pss_produto                    b
                          ,ccm_status                         sta
                          ,ccm_usuario                        e
                          ,ccm_itau_cliente                   c
                     where i.cli_cpf                        = c.cli_cpf
                       and i.stat_cod                       = sta.stat_cod
                       and i.prod_cod                       = b.pss_prd_codigo
                       and i.prod_cod                       in (select ip.cod_prod
                                                                  from srv_tipo_rem_var        t
                                                                      ,srv_grupo_indicador     g
                                                                      ,srv_indicador           i
                                                                      ,srv_indicador_produto   ip
                                                                      ,srv_produto             p
                                                                  where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                    and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                    and g.cod_grp_indic       = i.cod_grp_indic
                                                                    and i.descr_indic         = ''ASSISTENCIA ODONTOLOGICA LOJA''
                                                                    and i.flg_indic_ativ      = ''S''
                                                                    and i.cod_indic           = ip.cod_indic
                                                                    and ip.cod_orig_prod      = p.cod_orig_prod
                                                                    and ip.cod_prod           = p.cod_prod
                                                                    and ip.cod_orig_prod      = ''ITAU'' )
                       and i.stat_tabela                    = sta.stat_tabela
                       and c.cod_mot_recusa                 is null
                       and ( i.stat_cod                  <> 2
                             OR
                            (i.stat_cod                  = 2 and exists (select 1 from '|| v_nm_tab_ctr_odoIta_canc || ' f where f.ctr_codigo = i.ctr_codigo))
                           )
                       and c.stat_cod                       in (5,6,7,9,10,11,13)
                       and e.usu_cpf                        = i.cpf_vendedor
                       and e.fil_cod                        <> 900
                       and i.data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                             and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')

                    union all

                    --ADESAO ODONTO ITAU DEPENDENTE
                    select e.fil_cod
                          ,i.cli_cpf                         cli_cpf
                          ,41                                cod_indic
                          ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_indic
                          ,i.cpf_vendedor                    cpf_vendedor
                          ,b.pss_prd_codigo                  cod_prod
                          ,b.pss_prd_nome                    descr_prod
                          ,i.ctr_codigo                      contrato_titular
                          ,i.data_adesao                     data_adesao_titular
                      from ccm_itau_cliente_produto_depen     i
                          ,ccm_pss_produto                    b
                          ,ccm_status                         sta
                          ,ccm_usuario                        e
                          ,ccm_itau_cliente                   c
                     where i.cli_cpf                        = c.cli_cpf
                       and i.stat_cod                       = sta.stat_cod
                       and i.prod_cod                       = b.pss_prd_codigo
                       and i.prod_cod                       in (select ip.cod_prod
                                                                  from srv_tipo_rem_var        t
                                                                      ,srv_grupo_indicador     g
                                                                      ,srv_indicador           i
                                                                      ,srv_indicador_produto   ip
                                                                      ,srv_produto             p
                                                                  where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
                                                                    and t.descr_tipo_rem_var  = ''REMUNERACAO_LOJA''
                                                                    and g.cod_grp_indic       = i.cod_grp_indic
                                                                    and i.descr_indic         = ''ASSISTENCIA ODONTOLOGICA LOJA''
                                                                    and i.flg_indic_ativ      = ''S''
                                                                    and i.cod_indic           = ip.cod_indic
                                                                    and ip.cod_orig_prod      = p.cod_orig_prod
                                                                    and ip.cod_prod           = p.cod_prod
                                                                    and ip.cod_orig_prod      = ''ITAU'' )
                       and i.stat_tabela                    = sta.stat_tabela
                       and c.cod_mot_recusa                 is null
                       and ( i.stat_cod                  <> 2
                             OR
                            (i.stat_cod                  = 2 and exists (select 1 from '|| v_nm_tab_ctr_OdepIta_canc || ' f where f.ctr_codigo = i.ctr_codigo))
                           )
                       and c.stat_cod                       in (5,6,7,9,10,11,13)
                       and e.usu_cpf                        = i.cpf_vendedor
                       and e.fil_cod                        <> 900
                       and i.data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                             and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                  select fil_cod
                                       , cod_indic
                                       , descr_indic
                                       , sum(qtde) qtde
                                    from (select e.fil_cod fil_cod
                                                ,41 cod_indic
                                                ,''ASSISTENCIA ODONTOLOGICA LOJA'' descr_indic
                                                ,count(*) qtde
                                            from ccm_pss_contrato_cliente a,
                                                 ccm_pss_canal_venda      e
                                           where a.pss_cnl_codigo = e.pss_cnl_codigo
                                             and a.pss_prd_codigo in(21,41)
                                             and(a.pss_ctr_in_situacao = 1
                                              or(a.pss_ctr_in_situacao = 2 and exists (select 1 from '|| v_nm_tab_ctr_psf_canc || ' f where f.pss_ctr_codigo = a.pss_ctr_codigo)))
                                             and e.fil_cod <> 900
                                             and a.pss_ctr_data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                           and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                           group by e.fil_cod

                                          union all

                                          select e.fil_cod
                                               , 41
                                               , ''ASSISTENCIA ODONTOLOGICA LOJA''
                                               , count(*)
                                            from ccm_pss_dependente       f,
                                                 ccm_pss_vendedor         c,
                                                 ccm_pss_canal_venda      e,
                                                 ccm_pss_contrato_cliente a,
                                                 ccm_pss_produto                 b
                                           where a.pss_ctr_codigo = f.pss_ctr_codigo
                                             and a.pss_prd_codigo = b.pss_prd_codigo
                                             and f.pss_cnl_codigo = e.pss_cnl_codigo
                                             and f.stat_cod = 1
                                             and(f.stat_cod = 1
                                              or(f.stat_cod = 2 and exists (select 1 from '|| v_nm_tab_ctr_psfdep_canc || ' g where g.pss_ctr_codigo = f.pss_ctr_codigo)))
                                             and e.fil_cod <> 900
                                             and f.pss_dpt_dt_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                         and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                             and f.pss_vnd_codigo = c.pss_vnd_codigo(+)
                                           group by e.fil_cod

                                          union all

                                          --ADESAO ODONTO ITAU TITULAR
                                          select e.fil_cod
                                               , 41
                                               , ''ASSISTENCIA ODONTOLOGICA LOJA''
                                               , count(*)
                                            from ccm_itau_cliente_produto i,
                                                 ccm_pss_produto          b,
                                                 ccm_status               sta,
                                                 ccm_usuario              e,
                                                 ccm_itau_cliente         c
                                           where i.cli_cpf = c.cli_cpf
                                             and i.stat_cod = sta.stat_cod
                                             and i.prod_cod = b.pss_prd_codigo
                                             and i.prod_cod in (select ip.cod_prod
                                                                  from srv_tipo_rem_var      t,
                                                                       srv_grupo_indicador   g,
                                                                       srv_indicador         i,
                                                                       srv_indicador_produto ip,
                                                                       srv_produto           p
                                                                 where t.cod_tipo_rem_var = g.cod_tipo_rem_var
                                                                   and t.descr_tipo_rem_var = ''REMUNERACAO_LOJA''
                                                                   and g.cod_grp_indic = i.cod_grp_indic
                                                                   and i.descr_indic = ''ASSISTENCIA ODONTOLOGICA LOJA''
                                                                   and i.flg_indic_ativ = ''S''
                                                                   and i.cod_indic = ip.cod_indic
                                                                   and ip.cod_orig_prod = p.cod_orig_prod
                                                                   and ip.cod_prod = p.cod_prod
                                                                   and ip.cod_orig_prod = ''ITAU'')
                                             and i.stat_tabela = sta.stat_tabela
                                             and c.cod_mot_recusa is null
                                             and(i.stat_cod <> 2
                                              or(i.stat_cod = 2 and exists (select 1 from '|| v_nm_tab_ctr_odoIta_canc || ' f where f.ctr_codigo = i.ctr_codigo)))
                                             and c.stat_cod in (5, 6, 7, 9, 10, 11, 13)
                                             and e.usu_cpf = i.cpf_vendedor
                                             and e.fil_cod <> 900
                                             and i.data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                   and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                           group by e.fil_cod

                                          union all

                                          --ADESAO ODONTO ITAU DEPENDENTE
                                          select e.fil_cod
                                               , 41
                                               , ''ASSISTENCIA ODONTOLOGICA LOJA''
                                               , count(*)
                                            from ccm_itau_cliente_produto_depen i,
                                                 ccm_pss_produto                b,
                                                 ccm_status                     sta,
                                                 ccm_usuario                    e,
                                                 ccm_itau_cliente               c
                                           where i.cli_cpf = c.cli_cpf
                                             and i.stat_cod = sta.stat_cod
                                             and i.prod_cod = b.pss_prd_codigo
                                             and i.prod_cod in (select ip.cod_prod
                                                                  from srv_tipo_rem_var      t,
                                                                       srv_grupo_indicador   g,
                                                                       srv_indicador         i,
                                                                       srv_indicador_produto ip,
                                                                       srv_produto           p
                                                                 where t.cod_tipo_rem_var = g.cod_tipo_rem_var
                                                                   and t.descr_tipo_rem_var = ''REMUNERACAO_LOJA''
                                                                   and g.cod_grp_indic = i.cod_grp_indic
                                                                   and i.descr_indic = ''ASSISTENCIA ODONTOLOGICA LOJA''
                                                                   and i.flg_indic_ativ = ''S''
                                                                   and i.cod_indic = ip.cod_indic
                                                                   and ip.cod_orig_prod = p.cod_orig_prod
                                                                   and ip.cod_prod = p.cod_prod
                                                                   and ip.cod_orig_prod = ''ITAU'')
                                             and i.stat_tabela = sta.stat_tabela
                                             and c.cod_mot_recusa is null
                                             and(i.stat_cod <> 2
                                              or(i.stat_cod = 2 and exists (select 1 from '|| v_nm_tab_ctr_OdepIta_canc || ' f where f.ctr_codigo = i.ctr_codigo)))
                                             and c.stat_cod in (5, 6, 7, 9, 10, 11, 13)
                                             and e.usu_cpf = i.cpf_vendedor
                                             and e.fil_cod <> 900
                                             and i.data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                   and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                           group by e.fil_cod
                                           )
                                   group by fil_cod, cod_indic, descr_indic';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


      -- SE INDICADOR ASSISTENCIA ODONTOLOGICA LOJA
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- BOLSA PROTEGIDA
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'BOLSA PROTEGIDA PL') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_MAR_PROT_LJ_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_MAR_PROT_LJ_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         --
         v_alias_tab := 'd.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                      select /*+ OPT_PARAM(''optimizer_index_cost_adj'' ''100'') */
                             d.fil_cod                            fil_cod
                            ,a.cli_cpf                            cli_cpf
                            ,9                                    cod_indic
                            ,''BOLSA PROTEGIDA PL''               descr_indic
                            ,c.pss_vnd_cpf                        cpf_vendedor
                            ,a.pss_prd_codigo                     cod_prod
                            ,''BOLSA PROTEGIDA PL''               descr_prod
                            ,a.pss_ctr_codigo                     contrato_titular
                            ,a.pss_ctr_codigo                     contrato_dependente
                            ,a.pss_ctr_data_adesao                data_adesao_titular
                        from ccm_pss_contrato_cliente a
                       inner join ccm_pss_lancamento_premio b on b.pss_ctr_codigo  = a.pss_ctr_codigo
                                                             and b.pss_lnc_nro_parcela = 1 --primeira parcela do produto
                                                             and b.pss_lnc_tipo = 3 --pagamento do produto
                                                             and b.pss_lnc_valor_pago >= b.pss_lnc_vr_lanc_premio --o valor pago deve ser maior ou igual ao valor do contrato
                                                             and(b.pss_lnc_data_pagto - 180) <= a.pss_ctr_data_adesao --consider adesoes pagas em ate 180 dias apos a adesao
                                                             and b.pss_lnc_data_pagto between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                          and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') --considerar apenas pagamentos no mes de referencia do calculo
                        left join ccm_pss_vendedor c on c.pss_vnd_codigo = a.pss_vnd_codigo
                        left join ccm_pss_canal_venda d on d.pss_cnl_codigo = a.pss_cnl_codigo
                       where a.pss_prd_codigo in(69,105,96,17,65) --BOLSA PROTEGIDA PL
                         and a.pss_ctr_data_adesao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')--considerar adesao feitas a partir de 01/06/2016'
                          || v_p_cod_fil ;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --


         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                 select e.fil_cod                 fil_cod
                                      , 9                         cod_indic
                                      , ''BOLSA PROTEGIDA PL''    descr_indic
                                      , count(*)                  qtde
                                   from ccm_pss_contrato_cliente a,
                                        ccm_pss_canal_venda      e
                                  where a.pss_cnl_codigo = e.pss_cnl_codigo
                                    and a.pss_prd_codigo in(69,105,96,17,65)
                                    and(a.pss_ctr_in_situacao = 1
                                     or(a.pss_ctr_in_situacao = 2 and exists (select 1 from '|| v_nm_tab_ctr_psf_canc || ' f where f.pss_ctr_codigo = a.pss_ctr_codigo)))
                                    and e.fil_cod <> 900
                                    and a.pss_ctr_data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                    '|| v_p_cod_fil ||'
                                  group by e.fil_cod';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- BOLSA PROTEGIDA ITAU
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'BOLSA PROTEGIDA ITAU') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_MAR_PROT_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_MAR_PROT_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));


         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;

            --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                     ---- ADESAO SEGURO BOLSA PROTEGIDA ACEITE CLIENTES ITAU
                               select /*+ OPT_PARAM(''optimizer_index_cost_adj'' ''100'') */
                                      e.fil_cod                fil_cod
                                     ,a.cli_cpf                cli_cpf
                                     ,13                       cod_indic
                                     ,''BOLSA PROTEGIDA ITAU'' descr_indic
                                     ,e.usu_cpf                cpf_vendedor
                                     ,a.cod_prod_cartao        cod_prod
                                     ,''BOLSA PROTEGIDA ITAU'' descr_prod
                                     ,a.cli_cpf                contrato_titular
                                 from ccm_itau_cliente           a
                                     ,ccm_itau_cliente_log       e
                                where a.cli_cpf                = e.cli_cpf
                                  and a.data_aceite            = e.dt_log
                                  and e.stat_cod               = 2
                                  and e.stat_cod_ant           = 1
                                  and a.stat_cod               in (2,3,4,5,6,7,9,10,11,13)
                                  and a.flag_seg_perda_roubo   = ''S''
                                  and a.data_aceite between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                        and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                  '|| v_p_cod_fil;
       exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                      select fil_cod
                            ,cod_indic
                            ,descr_indic
                            ,count(cli_cpf)  qtde
                       from  '|| v_nm_tab_realz_fu ||'
                    group by fil_cod
                            ,cod_indic
                            ,descr_indic ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- BOLSA PROTEGIDA PL E ITAU
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'BOLSA PROTEGIDA PL E ITAU') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_BPROT_PL_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_BPROT_PL_IT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));

         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                select /*+ OPT_PARAM(''optimizer_index_cost_adj'' ''100'') */
                                       d.fil_cod                       fil_cod
                                      ,a.cli_cpf                       cli_cpf
                                      ,37                              cod_indic
                                      ,''BOLSA PROTEGIDA PL E ITAU''   descr_indic
                                      ,c.pss_vnd_cpf                   cpf_vendedor
                                      ,a.pss_prd_codigo                cod_prod
                                      ,a.pss_ctr_data_adesao           data_adesao_titular
                                  from ccm_pss_contrato_cliente a
                                 inner join ccm_pss_lancamento_premio b on b.pss_ctr_codigo  = a.pss_ctr_codigo
                                                                       and b.pss_lnc_nro_parcela = 1 --primeira parcela do produto
                                                                       and b.pss_lnc_tipo = 3 --pagamento do produto
                                                                       and b.pss_lnc_valor_pago >= b.pss_lnc_vr_lanc_premio --o valor pago deve ser maior ou igual ao valor do contrato
                                                                       and(b.pss_lnc_data_pagto - 180) <= a.pss_ctr_data_adesao --consider adesoes pagas em ate 180 dias apos a adesao
                                                                       and b.pss_lnc_data_pagto between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                                    and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') --considerar apenas pagamentos no mes de referencia do calculo
                                  left join ccm_pss_vendedor c on c.pss_vnd_codigo = a.pss_vnd_codigo
                                  left join ccm_pss_canal_venda d on d.pss_cnl_codigo = a.pss_cnl_codigo
                                 where a.pss_prd_codigo in(69,105,96,17,65) --BOLSA PROTEGIDA PL E ITAU
                                   and a.pss_ctr_data_adesao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')--considerar adesao feitas a partir de 01/06/2016

                                union all

                               select /*+ OPT_PARAM(''optimizer_index_cost_adj'' ''100'') */
                                      e.fil_cod
                                     ,a.cli_cpf                     cli_cpf
                                     ,37                            cod_indic
                                     ,''BOLSA PROTEGIDA PL E ITAU'' descr_indic
                                     ,e.usu_cpf                     cpf_vendedor
                                     ,a.cod_prod_cartao             cod_prod
                                     ,a.data_aceite                 data_adesao_titular
                                 from ccm_itau_cliente           a
                                     ,ccm_itau_cliente_log       e
                                where a.cli_cpf                = e.cli_cpf
                                  and a.data_aceite            = e.dt_log
                                  and e.stat_cod               = 2
                                  and e.stat_cod_ant           = 1
                                  and a.stat_cod               in (2,3,4,5,6,7,9,10,11,13)
                                  and a.flag_seg_perda_roubo   = ''S''
                                  and a.data_aceite between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                        and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')';
       exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                  select fil_cod
                                       , cod_indic
                                       , descr_indic
                                       , sum(qtde) qtde
                                   from (select e.fil_cod                     fil_cod
                                               ,37                            cod_indic
                                               ,''BOLSA PROTEGIDA PL E ITAU'' descr_indic
                                               , count(*)                     qtde
                                           from ccm_pss_contrato_cliente       a
                                               ,ccm_pss_canal_venda            e
                                          where a.pss_cnl_codigo              = e.pss_cnl_codigo
                                            and a.pss_prd_codigo in(69,105,96,17,65)
                                            and ( a.pss_ctr_in_situacao       = 1
                                                  OR
                                                 (a.pss_ctr_in_situacao       = 2 and exists (select 1 from '|| v_nm_tab_ctr_psf_canc || ' f where f.pss_ctr_codigo = a.pss_ctr_codigo))
                                                )
                                            and e.fil_cod                     <> 900
                                            and a.pss_ctr_data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                          and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                         group by e.fil_cod

                                          union all

                                         select e.fil_cod
                                               ,37
                                               ,''BOLSA PROTEGIDA PL E ITAU''
                                               , count(*)
                                           from ccm_itau_cliente           a
                                               ,ccm_itau_cliente_log       e
                                          where a.cli_cpf                = e.cli_cpf
                                            and a.data_aceite            = e.dt_log
                                            and e.stat_cod               = 2
                                            and e.stat_cod_ant           = 1
                                            and a.stat_cod               in (2,3,4,5,6,7,9,10,11,13)
                                            and a.flag_seg_perda_roubo   = ''S''
                                            and a.data_aceite between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                        group by e.fil_cod
                                        )
                                   group by fil_cod, cod_indic, descr_indic';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
            null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- CARTAO MARISA APROVADO PL E ITAU
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'CARTAO MARISA APROVADO PL E ITAU') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_CART_APROV_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CART_APROV_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func := 'SRV_REALZ_TOD_FU_CTAP_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));
         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and (decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table srv_tmp_realz_Func_Ct_Ap_PL1 ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Func_Ct_Ap_PL1  pctfree 0 nologging as
                                  select decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) fil_cod
                                        ,cli.cli_cpf                                                     cli_cpf
                                        ,2                                                               cod_indic
                                        ,''CARTAO MARISA APROVADO PL E ITAU''                            descr_indic
                                    from ccm_cliente      cli
                                   inner join ccm_cad_log cad on cad.car_bin     = 603475
                                                             and cad.cad_log_cpf = cli.cli_cpf
                                                             and cad.stat_cod   in (1)
                                                             and upper(cad.stat_tabela) = ''CCM_CLIENTE''
                                                             and cad.cad_log_data between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                      and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5
                                   where cli.cli_dt_cadastro between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                 and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                     and cli.stat_cod in (1,92,93)
                                     and decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) <> 900
                                     '|| v_p_cod_fil ||'
                                   group by decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda), cli.cli_cpf';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Func_Ct_Ap_PL1' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Func_Ct_Ap_PL1' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         begin
           execute immediate 'drop table srv_tmp_realz_Func_Ct_Ap_PL ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Func_Ct_Ap_PL pctfree 0 nologging as
                               select  e.fil_cod
                                      ,b.cli_cpf
                                      ,e.cod_indic
                                      ,e.descr_indic
                                      ,c.cpf_vendedor
                                      ,b.prim_dt_cadastro  data_cadastro
                                      ,to_char(''S'') as flg_doc_digitalizado
                                      --,null                as data_aceite
                                      --,d.num_campanha
                               from   ccm_cli_campanha           c,
                                     ( select min(b.dt_cadastro) prim_dt_cadastro,
                                              a.cli_cpf
                                       from   srv_tmp_realz_Func_Ct_Ap_PL1 a,
                                              ccm_cli_campanha         b
                                       where  b.car_bin = '||cn_car_bin||'
                                       and    b.cli_cpf = a.cli_cpf
                                       and    b.cpf_vendedor <> 11111111111
                                       group by a.cli_cpf ) b,
                                     ( select min(b.num_campanha) num_campanha,
                                              a.cli_cpf
                                       from   srv_tmp_realz_Func_Ct_Ap_PL1  a,
                                              ccm_cli_campanha          b
                                       where  b.car_bin  = '||cn_car_bin||'
                                       and    b.cli_cpf  = a.cli_cpf
                                       and    b.cpf_vendedor <> 11111111111
                                       group by a.cli_cpf ) d
                                      ,srv_tmp_realz_Func_Ct_Ap_PL1 e
                               where  c.car_bin       = '||cn_car_bin||'
                               and    c.cli_cpf       = b.cli_cpf
                               and    c.cli_cpf       = d.cli_cpf
                               and    c.num_campanha  = d.num_campanha
                               and    c.cpf_vendedor  is not null
                               and    b.prim_dt_cadastro = c.dt_cadastro
                               and    b.cli_cpf       = e.cli_cpf
                               and    d.cli_cpf       = e.cli_cpf
                               and    c.cli_cpf       = e.cli_cpf
                               ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Func_Ct_Ap_PL' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Func_Ct_Ap_PL' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- cria tabela de apuracao base para o realizado filial,
         -- apurando todas as vendas sem fazer join com a srv_funcionario
         -- e apurando inclusive vendas de temporarios
         --
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_tod_func ;
         exception
           when others then
             null;
         end;
         begin
            execute immediate 'create table '|| v_nm_tab_realz_tod_func ||'  pctfree 0 nologging as
                            select fil_cod
                                  ,cli_cpf
                                  ,cod_indic
                                  ,descr_indic
                              from srv_tmp_realz_Func_Ct_Ap_PL1
                            /*union all
                            select fil_cod
                                  ,cli_cpf
                                  ,cod_indic
                                  ,descr_indic
                              from srv_tmp_realz_Func_Ct_Ap_Ita*/';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_tod_func,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_tod_func,1,28) ||' on ' || v_nm_tab_realz_tod_func || ' (fil_cod)';
         exception
            when others then
              null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_tod_func || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



         -- tabela de apuracao de funcionarios
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                  select fil_cod
                                        ,cli_cpf
                                        ,cod_indic
                                        ,descr_indic
                                        ,cpf_vendedor
                                        ,data_cadastro
                                        ,flg_doc_digitalizado
                                        --,data_aceite
                                        --,num_campanha
                                    from srv_tmp_realz_Func_Ct_Ap_PL';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                            select fil_cod
                                  ,cod_indic
                                  ,descr_indic
                                  ,count(cli_cpf)   qtde
                              from '|| v_nm_tab_realz_tod_func ||'
                           group by fil_cod
                                   ,cod_indic
                                   ,descr_indic';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


      -- SE INDICADOR CARTAO MARISA APROVADO PL E ITAU
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- CARTAO MARISA ATIVADO PL
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'CARTAO MARISA ATIVADO PL E ITAU') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_CART_ATIV_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CART_ATIV_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func := 'SRV_REALZ_TOD_FU_CTAT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));

         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         -- cartoes PL
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ_PL ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ_PL  pctfree 0 nologging as
                               select decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) as fil_cod
                                     ,cli.cli_cpf                                                     as cli_cpf
                                     ,cli.cli_dt_cadastro                                             as dt_cadastro
                                     ,3                                                               as cod_indic
                                     ,''CARTAO MARISA ATIVADO PL E ITAU''                             as descr_indic
                                 from ccm_cliente cli
                                where cli.cli_dt_cadastro between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') - 30
                                                              and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 30
                                  and decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) <> 900
                                  and cli.stat_cod in (1,93)
                                  '|| v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ_PL' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;


         begin
            execute immediate 'drop index i_srv_tmp_realz_Cart_Ativ_PL';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_srv_tmp_realz_Cart_Ativ_PL on srv_tmp_realz_Cart_Ativ_PL (cli_cpf)';
            execute immediate 'analyze table srv_tmp_realz_Cart_Ativ_PL estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;


         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ_PL' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- compras PL
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ_PLcpr ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ_PLcpr  pctfree 0 nologging as
                               select e.fil_cod
                                     ,a.cli_cpf
                                     ,e.cod_indic
                                     ,e.descr_indic
                                     ,e.dt_cadastro
                                     ,a.fat_dt_transacao
                                 from ccm_compra                  a
                                     ,srv_tmp_realz_Cart_Ativ_PL  e
                                where a.car_bin                  = '||cn_car_bin||'
                                  and a.cli_cpf                  = e.cli_cpf
                                  and e.fil_cod                 <> 900
                                  and a.fat_dt_transacao         =    (select min(a2.fat_dt_transacao)
                                                                        from ccm_compra    a2
                                                                       where a2.cli_cpf  = a.cli_cpf
                                                                         and(a2.stat_cod in (6,8)
                                                                          or a2.stat_cod in (5,7) and a2.cpr_dt_cancel > to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5))
                                  and a.fat_dt_transacao         between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                     and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                  and  trunc(a.fat_dt_transacao) between trunc(e.dt_cadastro)
                                                                     and trunc(e.dt_cadastro) + 30
                                 ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ_PLcpr' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ_PLcpr' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- cartoes Itau
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ_Itau ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ_Itau  pctfree 0 nologging as
                               select decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) as fil_cod
                                     ,ita.cli_cpf
                                     ,ita.data_aceite                      as dt_cadastro
                                     ,3                                    as cod_indic
                                     ,''CARTAO MARISA ATIVADO PL E ITAU''  as descr_indic
                                 from ccm_itau_cliente           ita
                                     ,ccm_cliente                cli
                                where ita.cli_cpf               = cli.cli_cpf
                                  and ita.cod_logo_itau_adesao  = 2
                                  and ita.cod_prod_cartao       = 1851
                                  and ita.stat_cod              in (2,3,5,6,7,9,11,13)
                                  and decode(cli.fil_cod_venda, null, cli.fil_cod, cli.fil_cod_venda) <> 900
                                  and ita.data_aceite          between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') - 30
                                                                   and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 30
                                  ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ_Itau' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_srv_tmp_realz_Cart_Ativ_Itau';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_srv_tmp_realz_Cart_Ativ_Itau on srv_tmp_realz_Cart_Ativ_Itau (cli_cpf)';
            execute immediate 'analyze table srv_tmp_realz_Cart_Ativ_Itau estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;


         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ_Itau' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- compras Itau
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ_Itcp1 ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ_Itcp1   pctfree 0 nologging as
                                select cre.car_bin
                                      ,cre.plas_num_cartao
                                      ,ita.fil_cod
                                      ,ita.cod_indic
                                      ,ita.descr_indic
                                      ,ita.cli_cpf                   cli_cpf
                                      ,ita.dt_cadastro
                                      ,lib.usu_cpf               cpf_func
                                  from ccm_liberacao                  lib
                                      ,ccm_credito                    cre
                                      ,srv_tmp_realz_Cart_Ativ_Itau   ita
                                 where lib.car_bin                   = cre.car_bin
                                   and lib.plas_num_cartao           = cre.plas_num_cartao
                                   and cre.cli_cpf                   = ita.cli_cpf
                                   and trunc(lib.mvlib_dt_liberacao) =  trunc(ita.dt_cadastro)
                                   and lib.mvlib_utilizacao          = ''S''';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ_Itcp1' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_realz_Cart_Ativ_Itcp1';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_realz_Cart_Ativ_Itcp1 on srv_tmp_realz_Cart_Ativ_Itcp1 (cli_cpf)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ_Itcp1' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



         --
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ_Itcp2 ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ_Itcp2  pctfree 0 nologging as
                               select e.car_bin
                                     ,e.plas_num_cartao
                                     ,e.fil_cod
                                     ,e.cod_indic
                                     ,e.descr_indic
                                     ,a.cli_cpf
                                     ,e.dt_cadastro
                                     ,e.cpf_func
                                     ,a.fat_dt_transacao
                                 from ccm_compra                     a
                                     ,srv_tmp_realz_Cart_Ativ_Itcp1  e
                                where a.car_bin                  = '||cn_car_bin||'
                                  and a.cli_cpf                  = e.cli_cpf
                                  and(a.stat_cod                 in (6,8)
                                   or a.stat_cod                 in (5,7) and a.cpr_dt_cancel > to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') + 5)
                                  and e.fil_cod                  <> 900
                                  and a.fat_dt_transacao         = (select min(a2.fat_dt_transacao)
                                                                      from ccm_compra a2
                                                                     where a2.cli_cpf = a.cli_cpf)
                                  and a.fat_dt_transacao         between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                     and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                  and  trunc(a.fat_dt_transacao) between trunc(e.dt_cadastro)
                                                                     and trunc(e.dt_cadastro) + 30
                                  ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ_Itcp2' ||
                                 ' erro - '                || sqlerrm;

         end;

         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ_Itcp2' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --OX - Realizado do Originacao Ativa
         begin
           execute immediate 'drop table srv_tmp_realz_ox ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_ox  pctfree 0 nologging as
                                select e.cli_cpf
                                      ,3 cod_indic
                                      ,''CARTAO MARISA ATIVADO PL E ITAU'' descr_indic
                                      ,e.cpf_func_indicacao
                                      ,e.data_aprovacao
                                      ,e.data_ativacao
                                      ,e.cod_filial
                                      ,e.flg_ativacao_cartao
                                  from srv_ox_ativacao e
                                 where e.cod_filial <> 900
                                   and e.flg_ativacao_cartao = 1
                                   and e.data_aprovacao between to_date('|| chr(39) || v_dt_ini || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'') - 30
                                                            and to_date('|| chr(39) || v_dt_fim || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'') + 30
                                   and e.data_ativacao between to_date('|| chr(39) || v_dt_ini || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')
                                                           and to_date('|| chr(39) || v_dt_fim || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')
                                   and e.data_ativacao between to_date(e.data_aprovacao)
                                                           and to_date(e.data_aprovacao) + 30' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_ox' ||
                                 ' erro - '                || sqlerrm;

         end;

         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_ox' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- cartoes ativados
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ1 ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ1   pctfree 0 nologging as
                               select cli.fil_cod
                                     ,cli.cod_indic
                                     ,cli.descr_indic
                                     ,cli.cli_cpf
                                     ,cli.dt_cadastro
                                     ,min (cli.fat_dt_transacao)   dt_compra
                                 from srv_tmp_realz_Cart_Ativ_PLcpr  cli
                             group by cli.fil_cod
                                     ,cli.cod_indic
                                     ,cli.descr_indic
                                     ,cli.cli_cpf
                                     ,cli.dt_cadastro
                               union
                               select ita.fil_cod
                                     ,ita.cod_indic
                                     ,ita.descr_indic
                                     ,ita.cli_cpf
                                     ,ita.dt_cadastro
                                     ,min (ita.fat_dt_transacao)   dt_compra
                                 from srv_tmp_realz_Cart_Ativ_Itcp2  ita
                             group by ita.fil_cod
                                     ,ita.cod_indic
                                     ,ita.descr_indic
                                     ,ita.cli_cpf
                                     ,ita.dt_cadastro
                               union
                               select ox.cod_filial
                                     ,ox.cod_indic
                                     ,ox.descr_indic
                                     ,ox.cli_cpf
                                     ,ox.data_aprovacao
                                     ,min(ox.data_ativacao) dt_compra
                                 from srv_tmp_realz_ox ox
                             group by ox.cod_filial
                                     ,ox.cod_indic
                                     ,ox.descr_indic
                                     ,ox.cli_cpf
                                     ,ox.data_aprovacao';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || 'srv_tmp_realz_Cart_Ativ1' ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         begin
            execute immediate 'grant select on ' || 'srv_tmp_realz_Cart_Ativ1' || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         -- cria tabela de apuracao base para o realizado filial,
         -- apurando todas as vendas sem fazer join com a srv_funcionario
         -- e apurando inclusive vendas de temporarios
         --
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_tod_func ;
         exception
           when others then
             null;
         end;
         begin
            execute immediate 'create table '|| v_nm_tab_realz_tod_func ||'  pctfree 0 nologging as
                                  select cli.fil_cod
                                        ,cli.cod_indic
                                        ,cli.descr_indic
                                        ,cli.cli_cpf
                                        ,cli.dt_cadastro
                                        ,min (cli.fat_dt_transacao)   dt_compra
                                    from srv_tmp_realz_Cart_Ativ_PLcpr  cli
                                group by cli.fil_cod
                                        ,cli.cod_indic
                                        ,cli.descr_indic
                                        ,cli.cli_cpf
                                        ,cli.dt_cadastro
                                  union
                                  select ita.fil_cod
                                        ,ita.cod_indic
                                        ,ita.descr_indic
                                        ,ita.cli_cpf
                                        ,ita.dt_cadastro
                                        ,min (ita.fat_dt_transacao)   dt_compra
                                    from srv_tmp_realz_Cart_Ativ_Itcp2  ita
                                group by ita.fil_cod
                                        ,ita.cod_indic
                                        ,ita.descr_indic
                                        ,ita.cli_cpf
                                        ,ita.dt_cadastro
                                  union
                                  select ox.cod_filial
                                     ,ox.cod_indic
                                     ,ox.descr_indic
                                     ,ox.cli_cpf
                                     ,ox.data_aprovacao
                                     ,min(ox.data_ativacao) dt_compra
                                 from srv_tmp_realz_ox ox
                             group by ox.cod_filial
                                     ,ox.cod_indic
                                     ,ox.descr_indic
                                     ,ox.cli_cpf
                                     ,ox.data_aprovacao';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_tod_func ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_tod_func,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_tod_func,1,28) ||' on ' || v_nm_tab_realz_tod_func || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_tod_func || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_tod_func || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         ---###
         begin
           execute immediate 'drop table srv_tmp_realz_Cart_Ativ2 ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table srv_tmp_realz_Cart_Ativ2 pctfree 0 nologging as
                                 select b.prim_dt_cadastro
                                       ,c.cpf_vendedor        cpf_vendedor
                                       ,b.cli_cpf
                                       ,d.num_campanha
                                       ,b.fil_cod
                                       ,b.cod_indic
                                       ,b.descr_indic
                                       ,b.dt_compra
                                       ,b.dt_compra data_adesao_titular
                                 from   ccm_cli_campanha      c,
                                        ( select min(b.dt_cadastro) prim_dt_cadastro
                                                ,a.fil_cod
                                                ,a.cod_indic
                                                ,a.descr_indic
                                                ,a.cli_cpf
                                                ,a.dt_compra
                                          from   srv_tmp_realz_Cart_Ativ1      a,
                                                 ccm_cli_campanha              b
                                          where  b.car_bin      = '||cn_car_bin||'
                                          and    b.cli_cpf      = a.cli_cpf
                                          and    b.cpf_vendedor <> 11111111111
                                       group by  a.fil_cod
                                                ,a.cod_indic
                                                ,a.descr_indic
                                                ,a.cli_cpf
                                                ,a.dt_compra ) b,
                                        ( select min(b.num_campanha) num_campanha
                                                ,a.fil_cod
                                                ,a.cod_indic
                                                ,a.descr_indic
                                                ,a.cli_cpf
                                                ,a.dt_compra
                                          from   srv_tmp_realz_Cart_Ativ1      a,
                                                 ccm_cli_campanha              b
                                          where  b.car_bin      = '||cn_car_bin||'
                                          and    b.cli_cpf      = a.cli_cpf
                                          and    b.cpf_vendedor <> 11111111111
                                       group by  a.fil_cod
                                                ,a.cod_indic
                                                ,a.descr_indic
                                                ,a.cli_cpf
                                                ,a.dt_compra ) d
                                 where  c.car_bin          = '||cn_car_bin||'
                                 and    c.cli_cpf          = b.cli_cpf
                                 and    c.cli_cpf          = d.cli_cpf
                                 and    c.num_campanha     = d.num_campanha
                                 and    c.cpf_vendedor     is not null
                                 and    b.prim_dt_cadastro = c.dt_cadastro';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela srv_tmp_realz_Cart_Ativ2 erro - ' || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'grant select on srv_tmp_realz_Cart_Ativ2 to CCM_SEL';
         exception
            when others then
               null;
         end;

         ---###
         -- tabela de apuracao de funcionarios
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||' pctfree 0 nologging as
                                 select prim_dt_cadastro
                                       ,cpf_vendedor
                                       ,cli_cpf
                                       ,num_campanha
                                       ,fil_cod
                                       ,cod_indic
                                       ,descr_indic
                                       ,dt_compra
                                       ,data_adesao_titular
                                   from srv_tmp_realz_Cart_Ativ2
                                  union
                                 select data_aprovacao
                                       ,cpf_func_indicacao
                                       ,cli_cpf
                                       ,0 num_campanha
                                       ,cod_filial
                                       ,cod_indic
                                       ,descr_indic
                                       ,data_ativacao
                                       ,data_aprovacao
                                   from srv_tmp_realz_ox';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- cartoes ativados loja
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'   pctfree 0 nologging as
                               select a.fil_cod
                                     ,a.cod_indic
                                     ,a.descr_indic
                                     ,count(cli_cpf)  qtde
                                  from '|| v_nm_tab_realz_tod_func ||' a
                              group by a.fil_cod
                                      ,a.cod_indic
                                      ,a.descr_indic ';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR CARTAO MARISA ATIVADO PL E ITAU
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- CARTAO BONUS CELULAR
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'BONUS CELULAR') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_BONUS_CEL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_BONUS_CEL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tod_func := 'SRV_REALZ_TOD_FU_BCEL_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));

         v_nm_tab_realz_fu_ca := 'SRV_REALZFU_CART_ATIV_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));

         --
         v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and a.fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         -- cartoes bonus celular
         begin
           execute immediate 'drop table ' || v_nm_tab_realz_fu;
         exception
           when others then
             null;
         end;
         --

         begin
            execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                                select a.prim_dt_cadastro
                                     , a.cpf_vendedor
                                     , a.cli_cpf
                                     , a.num_campanha
                                     , a.fil_cod
                                     , 19 cod_indic
                                     , ''BONUS CELULAR'' descr_indic
                                     , a.dt_compra
                                  from ' || v_nm_tab_realz_fu_ca || ' a
                                     , ccm_credito c
                                 where c.car_bin = 603475
                                   and c.cli_cpf = a.cli_cpf
                                   and c.crd_tipo_ct = 2
                                   and c.crd_dt_abertura between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                             and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')

                                  ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu || ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;


         begin
            execute immediate 'drop index ' || v_nm_tab_realz_fu;
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || v_nm_tab_realz_fu || ' on ' || v_nm_tab_realz_fu || ' (cli_cpf)';
            execute immediate 'analyze table srv_tmp_realz_bonus_cel_PL estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- cartoes ativados loja
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'   pctfree 0 nologging as
                              select a.fil_cod, a.cod_indic, a.descr_indic, count(1) qtde
                                from ' || v_nm_tab_realz_fu || ' a
                              group by a.fil_cod, a.cod_indic, a.descr_indic
                              order by a.fil_cod, a.cod_indic, a.descr_indic';


         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



      -- SE INDICADOR BONUS CELULAR
      end if;


      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- PARTICIPACAO DO CARTAO %
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'PARTICIPACAO DO CARTAO %') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_PART_CARTAO_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_PART_CARTAO_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));


         v_nm_tab_realz_vendas := 'SRV_REALZFI_VENDAS_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tot_cartao_pl := 'SRV_TMP_REALZ_PL_TOT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_tot_cartao_it := 'SRV_TMP_REALZ_ITAU_TOT_'
                                   ||trim(to_char(p_num_ano, '0000'))
                                   ||trim(to_char(p_num_mes, '00'));


         /*v_alias_tab := '';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and a.fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if; */

         --
         begin
           execute immediate 'drop table tmp_vnd_s_juros_pl';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table tmp_vnd_s_juros_pl pctfree 0 nologging as
                                select clc.fil_cod         fil_cod
                                     , clc.cod_matricula   cod_matricula--cracha
                                     , clc.usu_cpf         cpf_vendedor
                                     , cc.fat_dt_transacao fat_dt_transacao
                                     , ''PL''              tipo_venda
                                     , sysdate             dt_processamento
                                  from ccm_compra cc
                                 inner join ccm_clc_compra clc on clc.car_bin   = 603475
                                                              and clc.plas_num_cartao  = cc.cpr_num_cartao --> old: plast_compra COLOCAR O ALIAS COMO cpr_num_cartao
                                                              and clc.fil_cod          = cc.fil_cod
                                                              and clc.prod_cod         = cc.prod_cod
                                                              and clc.cpr_autorizacao  = cc.cpr_autorizacao
                                                              and clc.flg_integrado    <> 2
                                                              and clc.cod_matricula    <> 0
                                 where cc.stat_cod in (6, 8)
                                   and cc.fat_dt_transacao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                               and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                   and cc.cpr_tp_autorizacao <> 30
                                   and cc.cpr_vr_financ = 0';
         exception
            when others then
               null;
         end;
         --
         begin
           execute immediate 'drop table tmp_vnd_s_juros_itau';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table tmp_vnd_s_juros_itau pctfree 0 nologging as
                                select fm.cod_fil     fil_cod
                                     , pu.num_matr    cod_matricula--cracha
                                     , pu.num_cpf_usu cpf_vendedor
                                     , fm.dt_emis     fat_dt_transacao
                                     , ''ITAU''       tipo_venda
                                     , sysdate        dt_processamento
                                  from fin_movto@ccm_fin fm
                                 inner join pub_usuario@ccm_fin pu on fm.id_usu = pu.id_usu
                                 where nvl(fm.vlr_juro,0)       = 0
                                   and fm.cod_rede_tef          = 160 -- CARTAO ITAU
                                   and nvl(fm.flg_estorno,0)    = 0
                                   and nvl(fm.cod_forma_pgto,0) = 3
                                   and fm.cod_trans_cx          = 1
                                   and fm.id_usu is not null
                                   and pu.num_cpf_usu is not null
                                   and fm.dt_emis between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                      and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')';
         exception
            when others then
               null;
         end;
         --

         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                select * from tmp_vnd_s_juros_pl
                                 union all
                                select * from tmp_vnd_s_juros_itau';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         -- PARTICIPACAO DO CARTAO %
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'   pctfree 0 nologging as
                              select vnd_tot.fil_cod
                                   , vnd_tot.vlr_realizado
                                   , vnd_pl.vlr_liq_trans
                                   , vnd_ita.vlr_liq_trans_i
                                   , vnd_pl.vlr_liq_trans + vnd_ita.vlr_liq_trans_i vnd_pl_ita
                                   , round( ( (vnd_pl.vlr_liq_trans + vnd_ita.vlr_liq_trans_i) / vnd_tot.vlr_realizado ) * 100, 2) part
                                from ' || v_nm_tab_realz_vendas || ' vnd_tot
                                   , (
                                      select filial_cpra, sum(vlr_liq_trans) vlr_liq_trans
                                        from ' || v_nm_tab_realz_tot_cartao_pl || '
                                      group by filial_cpra
                                     ) vnd_pl
                                   , (
                                      select cod_fil, sum(vlr_liq_trans) vlr_liq_trans_i
                                        from ' || v_nm_tab_realz_tot_cartao_it || '
                                       group by cod_fil
                                     ) vnd_ita
                              where vnd_tot.fil_cod = vnd_pl.filial_cpra (+)
                                and vnd_tot.fil_cod = vnd_ita.cod_fil(+)
                              order by vnd_tot.fil_cod';
                                 -- ' || v_p_cod_fil;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;



      -- SE INDICADOR PARTICIPACAO DO CARTAO %
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- TOMBAMENTO ITAUCARD
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'CARTAO MARISA TOMBAMENTO ITAUCARD') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_CART_TOMB_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CART_TOMB_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));

         --
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                               select distinct (c.cli_cpf)                  as cli_cpf
                                     ,11                                    as cod_indic
                                     ,''CARTAO MARISA TOMBAMENTO ITAUCARD'' as descr_indic
                                     ,c.data_aceite
                                     ,c.data_aceite data_adesao_titular
                                     ,c.cpf_vendedor
                                     ,e.fil_cod
                                     ,c.stat_cod
                                     ,sta.stat_descr
                                 from ccm_itau_cliente        c
                                     ,ccm_status              sta
                                    ,( select c.cli_cpf
                                             ,c.dt_log
                                             ,c.fil_cod
                                       from  ccm_itau_cliente_log  c
                                       where c.stat_cod     = 2
                                       and   c.stat_cod_ant = 1 ) e
                               where c.cli_cpf            = e.cli_cpf
                                 and c.cod_prod_cartao    = 1850
                                 and trunc(c.data_aceite) = trunc(e.dt_log)
                                 and sta.stat_cod         = c.stat_cod
                                 and sta.stat_tabela      = c.stat_tabela
                                 and c.stat_cod           not in (1, 8, 96, 97, 98)
                                 and e.fil_cod            <> 900
                                 and c.data_aceite between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                       and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')

                               UNION
                               select distinct (f.cli_cpf)                  as cli_cpf
                                     ,11                                    as cod_indic
                                     ,''CARTAO MARISA TOMBAMENTO ITAUCARD'' as descr_indic
                                     ,g.dt_log                              as data_aceite
                                     ,g.dt_log                              as data_adesao_titular
                                     ,f.cpf_vendedor
                                     ,h.cod_fil                             as fil_cod
                                     ,f.stat_cod
                                     ,null                                  as stat_descr
                                 from ccm_itau_cliente            f
                                     ,ccm_itau_cliente_log        g
                                     ,srv_funcionario             h
                               where f.cod_prod_cartao          = 1852
                                 and f.cli_cpf                  = g.cli_cpf
                                 and f.cpf_vendedor             = h.num_cpf_func
                                 and f.cpf_vendedor            <> 11111111111
                                 and g.dt_log                   = (select max(i.dt_log)
                                                                     from ccm_itau_cliente_log i
                                                                    where i.cli_cpf = f.cli_cpf
                                                                      and i.stat_cod in (3,11))
                                 and h.cod_fil                 <> 900
                                 and g.dt_log                  between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                   and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                 ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                               select a.fil_cod
                                     ,a.cod_indic
                                     ,a.descr_indic
                                     ,count(a.cli_cpf)              qtde
                                 from '|| v_nm_tab_realz_fu ||'  a
                            group by a.fil_cod
                                    ,a.cod_indic
                                    ,a.descr_indic';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


      -- SE INDICADOR CARTAO MARISA TOMBAMENTO ITAUCARD
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- DESBLOQUEIO ITAUCARD
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

        if (p_descr_indic is null or p_descr_indic = 'CARTAO MARISA DESBLOQUEIO ITAUCARD') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_CT_IT_DESB_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CT_IT_DESB_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_dt_ini1 := substr(v_dt_ini,7,4) || '-' || substr(v_dt_ini,4,2) || '-' || substr(v_dt_ini,1,2);
         v_dt_fim1 := substr(v_dt_fim,7,4) || '-' || substr(v_dt_fim,4,2) || '-' || substr(v_dt_fim,1,2);
         --
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                               select c.cli_cpf
                                     ,12                                     as cod_indic
                                     ,''CARTAO MARISA DESBLOQUEIO ITAUCARD'' as descr_indic
                                     ,c.data_aceite
                                     ,c.data_aceite data_adesao_titular
                                     ,c.cpf_vendedor
                                     ,e.fil_cod
                                     ,c.stat_cod
                                     ,sta.stat_descr
                                 from ccm_itau_cliente  c
                                     ,ccm_status        sta
                                     ,(select c.cli_cpf
                                             ,c.dt_log
                                             ,c.fil_cod
                                       from  ccm_itau_cliente_log c
                                       where c.stat_cod     = 2
                                       and   c.stat_cod_ant = 1 ) e
                               where c.cli_cpf            = e.cli_cpf
                                 and trunc(c.data_aceite) = trunc(e.dt_log)
                                 and sta.stat_cod         = c.stat_cod
                                 and sta.stat_tabela      = c.stat_tabela
                                 and c.stat_cod           in ( 4, 5, 6, 7, 9, 11, 13 )
                                 and e.fil_cod            <> 900
                                 and to_date(substr(c.dt_proc_desbloq_itau,1,10 ),''yyyy-mm-dd'') between to_date(' || chr(39) || v_dt_ini1 || chr(39) ||', ''yyyy-mm-dd'')
                                                       and to_date(' || chr(39) || v_dt_fim1 || chr(39) ||', ''yyyy-mm-dd'')
                                 ' || v_p_cod_fil;
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                               select a.fil_cod
                                     ,a.cod_indic
                                     ,a.descr_indic
                                     ,count(a.cli_cpf)               qtde
                                 from '|| v_nm_tab_realz_fu ||'  a
                            group by a.fil_cod
                                    ,a.cod_indic
                                    ,a.descr_indic';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;


      -- SE INDICADOR CARTAO MARISA DESBLOQUEIO ITAUCARD
      end if;


      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- PROTECAO CELULAR MARISA
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'PROTECAO CELULAR MARISA') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_PROT_CEL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_PROT_CEL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         --
         v_alias_tab := 'd.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                      select d.fil_cod                            fil_cod
                            ,a.cli_cpf                            cli_cpf
                            ,21                                   cod_indic
                            ,''PROTECAO CELULAR MARISA''          descr_indic
                            ,c.pss_vnd_cpf                        cpf_vendedor
                            ,a.pss_prd_codigo                     cod_prod
                            ,''PROTECAO CELULAR MARISA''          descr_prod
                            ,a.pss_ctr_codigo                     contrato_titular
                            ,a.pss_ctr_codigo                     contrato_dependente
                            ,a.pss_ctr_data_adesao                data_adesao_titular
                        from ccm_pss_contrato_cliente a
                       inner join ccm_pss_lancamento_premio b on b.pss_ctr_codigo  = a.pss_ctr_codigo
                                                             and b.pss_lnc_nro_parcela = 1 --primeira parcela do produto
                                                             and b.pss_lnc_tipo = 3 --pagamento do produto
                                                             and b.pss_lnc_valor_pago >= b.pss_lnc_vr_lanc_premio --o valor pago deve ser maior ou igual ao valor do contrato
                                                             and(b.pss_lnc_data_pagto - 180) <= a.pss_ctr_data_adesao --consider adesoes pagas em ate 180 dias apos a adesao
                                                             and b.pss_lnc_data_pagto between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                          and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') --considerar apenas pagamentos no mes de referencia do calculo
                        left join ccm_pss_vendedor c on c.pss_vnd_codigo = a.pss_vnd_codigo
                        left join ccm_pss_canal_venda d on d.pss_cnl_codigo = a.pss_cnl_codigo
                       where a.pss_prd_codigo in(119) --PROTECAO CELULAR MARISA
                         and a.pss_ctr_data_adesao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')--considerar adesao feitas a partir de 01/06/2016'
                          || v_p_cod_fil;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                 select e.fil_cod                       fil_cod
                                      , 21                              cod_indic
                                      , ''PROTECAO CELULAR MARISA''     descr_indic
                                      , count(*)                        qtde
                                   from ccm_pss_contrato_cliente a,
                                        ccm_pss_canal_venda      e
                                  where a.pss_cnl_codigo = e.pss_cnl_codigo
                                    and a.pss_prd_codigo in(119)
                                    and(a.pss_ctr_in_situacao = 1
                                     or(a.pss_ctr_in_situacao = 2 and exists (select 1 from '|| v_nm_tab_ctr_psf_canc || ' f where f.pss_ctr_codigo = a.pss_ctr_codigo)))
                                    and e.fil_cod <> 900
                                    and a.pss_ctr_data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                    '|| v_p_cod_fil ||'
                                  group by e.fil_cod';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR PROTECAO CELULAR MARISA
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_SEG_MAR_MUL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_SEG_MAR_MUL_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));


         --
         v_alias_tab := 'd.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                      select d.fil_cod                                       fil_cod
                            ,a.cli_cpf                                       cli_cpf
                            ,24                                              cod_indic
                            ,''MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA''  descr_indic
                            ,c.pss_vnd_cpf                                   cpf_vendedor
                            ,a.pss_prd_codigo                                cod_prod
                            ,''MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA''  descr_prod
                            ,a.pss_ctr_codigo                                contrato_titular
                            ,a.pss_ctr_codigo                                contrato_dependente
                            ,a.pss_ctr_data_adesao                           data_adesao_titular
                        from ccm_pss_contrato_cliente a
                       inner join ccm_pss_lancamento_premio b on b.pss_ctr_codigo  = a.pss_ctr_codigo
                                                             and b.pss_lnc_nro_parcela = 1 --primeira parcela do produto
                                                             and b.pss_lnc_tipo = 3 --pagamento do produto
                                                             and b.pss_lnc_valor_pago >= b.pss_lnc_vr_lanc_premio --o valor pago deve ser maior ou igual ao valor do contrato
                                                             and(b.pss_lnc_data_pagto - 180) <= a.pss_ctr_data_adesao --consider adesoes pagas em ate 180 dias apos a adesao
                                                             and b.pss_lnc_data_pagto between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                                          and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'') --considerar apenas pagamentos no mes de referencia do calculo
                        left join ccm_pss_vendedor c on c.pss_vnd_codigo = a.pss_vnd_codigo
                        left join ccm_pss_canal_venda d on d.pss_cnl_codigo = a.pss_cnl_codigo
                       where a.pss_prd_codigo in(104,109,110, --PRODUTOS ANTIGOS
                                                 127, --AUTO PROTECAO
                                                 128, --CASA PROTEGIDA
                                                 126) --MARISA MULHER
                         and a.pss_ctr_data_adesao >= to_date(''01/06/2016 00:00:00'',''dd/mm/yyyy hh24:mi:ss'')--considerar adesao feitas a partir de 01/06/2016'
                          || v_p_cod_fil;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
              null;

         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

         --Filial
         v_alias_tab := 'e.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                 select e.fil_cod                                      fil_cod
                                      , 24                                             cod_indic
                                      , ''MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA'' descr_indic
                                      , count(*)                                       qtde
                                   from ccm_pss_contrato_cliente a,
                                        ccm_pss_canal_venda      e
                                  where a.pss_cnl_codigo = e.pss_cnl_codigo
                                    and a.pss_prd_codigo in(104,109,110, --PRODUTOS ANTIGOS
                                                            127, --AUTO PROTECAO
                                                            128, --CASA PROTEGIDA
                                                            126) --MARISA MULHER
                                    and(a.pss_ctr_in_situacao = 1
                                     or(a.pss_ctr_in_situacao = 2 and exists (select 1 from '|| v_nm_tab_ctr_psf_canc || ' f where f.pss_ctr_codigo = a.pss_ctr_codigo)))
                                    and e.fil_cod <> 900
                                    and a.pss_ctr_data_adesao between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                  and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                    '|| v_p_cod_fil ||'
                                  group by e.fil_cod';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
              null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR MARISA FAMILIA PL
      end if;



      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- CARTAO ADICIONAL PL E ITAU
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'CARTAO ADICIONAL PL E ITAU') then

         v_nm_tab_realz_fu := 'SRV_REALZFU_CT_ADIC_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_CT_ADIC_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         --
         v_alias_tab := 'b.';

         if p_cod_fil is not null then
            v_p_cod_fil := ' and '|| v_alias_tab || 'fil_cod = ' || p_cod_fil;
         else
            v_p_cod_fil := null;
         end if;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                select b.fil_cod                      fil_cod
                                     , a.cli_cpf                      cli_cpf
                                     , 34                             cod_indic
                                     , ''CARTAO ADICIONAL PL E ITAU'' descr_indic
                                     , nvl(a.vend_cpf, a.usu_cpf)     cpf_vendedor
                                     , trunc(a.adi_dt_cadast)         adi_dt_cadast
                                     , 1                              tipo_cartao
                                  from ccm_cli_adicional a
                                 inner join ccm_usuario b on b.usu_cpf  = a.usu_cpf
                                 where a.adi_dt_cadast between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                           and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                   and a.stat_cod = 1
                                   and b.fil_cod not in(900)
                                   '|| v_p_cod_fil;

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro);
         end;
         --
         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                      select fil_cod
                            ,cod_indic
                            ,descr_indic
                            ,count(cli_cpf)             qtde
                       from  '|| v_nm_tab_realz_fu ||'
                    group by fil_cod
                            ,cod_indic
                            ,descr_indic';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );
         end;


         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR PROTECAO CELULAR MARISA
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- PARCELAMENTO DE FATURAS
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'PARCELAMENTO DE FATURAS') then

         v_nm_tab_realz_fi := 'SRV_REALZFI_PARC_FAT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));

         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;

         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                      select FILIAL                       fil_cod
                           , 36                           cod_indic
                           , ''PARCELAMENTO DE FATURAS''  descr_indic
                           , SUM(CONVERSAO)               qtde
                        from MV_CCM_TERMOMETRO_PARC_FATURA
                       where ano = '||p_num_ano||'
                         and mes = '||p_num_mes||'
                       group by FILIAL';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;

         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR PROTECAO CELULAR MARISA
      end if;

      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- PPT - PECAS POR TICKET
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic = 'PPT - PECAS POR TICKET') then

         v_nm_tab_realz_fi := 'SRV_REALZFI_PPT_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));

         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;

         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                select cod_fil                      fil_cod
                                     , 23                           cod_indic
                                     , ''PPT - PECAS POR TICKET''   descr_indic
                                     , num_realz                    qtde
                                  from srv_realizado_filial_indic
                                 where num_ano = ' || p_num_ano ||'
                                   and num_mes = ' || p_num_mes ||'
                                   and cod_indic = 23';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;
         --
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to SRV_SEL';
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR PPT - PECAS POR TICKET
      end if;


      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------
      -- EMPRESTIMO_PESSOAL_SAX
      -----------------------------------------------------------------------------------------------------
      -----------------------------------------------------------------------------------------------------

      if (p_descr_indic is null or p_descr_indic in ('EMPRESTIMO PESSOAL (EP) SAX / PSF', 'SEGURO EMPRESTIMO PESSOAL (EP) SAX / PSF')) then

         v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                              ||trim(to_char(p_num_ano, '0000'))
                              ||trim(to_char(p_num_mes, '00'));
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fu ||' pctfree 0 as
                               select a.cod_loja_origem       as fil_cod
                                     ,c.num_cpf               as cli_cpf
                                     ,min(f.dthora_inclusao)  as dt_captura
                                     ,a.dthora_formaliza      as dt_formaliz_emprest
                                     ,a.data_protocolo        as dt_proposta
                                     ,a.data_incl_contr       as dt_operacao
                                     ,e.nome_usuario          as nome_usu_captura
                                     ,e.num_cpf               as cpf_vendedor
                                     ,f.cod_usuario           as login_usu_captura
                                     ,a.cod_contrato          as cod_contrato
                                     ,decode(D.FLAG_LIQUIDADO,''S'',''LIQUIDADO'',''N'',''ATIVO'', ''I'',''ATIVO'', ''V'',''ATIVO'',''R'',''ATIVO'',''OUTROS'') as status_liquid
                                     ,case when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''S''
                                           then ''FORMALIZACAO/APROVADO PELA ANALISE/ACEITO PELO CLIENTE''
                                           when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''N''
                                           then ''FORMALIZACAO/APROVADO PELA ANALISE''
                                           when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''R''
                                           then ''FORMALIZACAO/APROVADO PELA ANALISE/RECUSADO PELO CLIENTE''
                                           when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''T''
                                           then ''FORMALIZACAO/APROVADO PELA ANALISE/AGUARDANDO LIBERACAO DO DINHEIRO NO PDV''
                                           when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''I''
                                           then ''FORMALIZACAO/APROVADO AUTOMATICAMENTE/EFETUANDO SAQUE DO DINHEIRO NO PDV''
                                           when a.tipo_sit_contrato = ''2'' and a.flag_integrar = ''N''
                                           then ''FORMALIZACAO/REPROVADO PELA ANALISE''
                                           when a.tipo_sit_contrato = ''2'' and a.flag_integrar = ''R''
                                           then ''FORMALIZACAO/REPROVADO AUTOMATICAMENTE/RECUSADO PELA LOJA''
                                           when a.tipo_sit_contrato = ''3'' and a.flag_integrar = ''N''
                                           then ''FORMALIZACAO/AGUARDANDO PELA ANALISE''
                                           when a.tipo_sit_contrato = ''9'' and a.flag_integrar = ''9''
                                           then ''FORMALIZACAO/CANCELADO''
                                           when a.tipo_sit_contrato = ''Z'' and a.flag_integrar = ''N''
                                           then ''FORMALIZACAO/PROPOSTA EXPIRADA''
                                           when a.tipo_sit_contrato = ''Z'' and a.flag_integrar = ''T''
                                           then ''FORMALIZACAO/PROPOSTA EXPIRADA''
                                           else ''OUTROS''
                                      end as formalizacao
                                     ,a.val_financ                          as vlr_bruto_emprest
                                     ,a.val_compra                          as vlr_liquido_emprest
                                     ,a.qtde_prestacoes                     as quant_parcelas
                                     ,a.val_prestacao                       as vlr_parcelas
                                     ,d.cod_produto                         as cod_produto
                                     ,a.num_transacao                       as num_transacao
                                     ,decode(a.tipo_aprov_cred, ''M'',''NAO'',''A'',''SIM'',''OUTROS'') as resaque
                                     ,decode(a.tipo_sit_contrato, ''1'',''APROVADO'',''2'',''REPROVADO'',''3'',''PENDENTE_ANALISE'',''9'',''CANCELADO'',''Z'',''EXPIRADO'',''OUTROS'') as situacao_contrato
                                     ,d.data_liquidacao
                                     ,d.data_cancelamento
                                     ,d.flag_seguro                         as seguro
                                     ,g.cpf_atendente                       as cpf_usu_indicador
                                     ,to_char(a.data_protocolo,''mm/yyyy'') as mes_proposta
                                     ,to_char(''S'')                        as flg_doc_digitalizado
                                from vw_econ_emprestimos@SYSIN d
                           left join dfen_contrato@SYSIN      a on (a.cod_contrato = d.cod_contrato)
                           left join dfen_sitef@SYSIN         b on (a.cod_loja = b.cod_loja and a.num_transacao = b.num_transacao)
                           left join bcli_fis_base@SYSIN      c on (c.cod_cliente = d.cod_cliente)
                           left join dfen_fluxo_prop@SYSIN    f on (a.cod_loja = f.cod_loja and a.num_transacao = f.num_transacao)
                           left join iseg_usu_base@SYSIN      e on (e.cod_usuario = f.cod_usuario )
                           left join dfen_contrato_cmpl@SYSIN g on (a.cod_loja = g.cod_loja and a.num_transacao = g.num_transacao)
                               where f.tipo_fluxo = ''C''
                                 and a.data_protocolo between to_date(' || chr(39) || v_dt_ini || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')
                                                                 and to_date(' || chr(39) || v_dt_fim || chr(39) ||', ''dd/mm/yyyy hh24:mi:ss'')

                                 and ( d.data_cancelamento is null or
                                          a.data_protocolo not in ( select y.data_cancelamento
                                                                      from vw_econ_emprestimos@SYSIN y
                                                                     where to_char(y.data_cancelamento,''mm/yyyy'') = ''' || to_char(p_num_mes, '00')||'/'|| to_char(p_num_ano,'0000')||'''))
                            group by a.cod_loja_origem
                                    ,c.num_cpf
                                    ,a.dthora_formaliza
                                    ,a.data_protocolo
                                    ,a.data_incl_contr
                                    ,e.nome_usuario
                                    ,e.num_cpf
                                    ,f.cod_usuario
                                    ,a.cod_contrato
                                    ,decode(d.flag_liquidado,''S'',''LIQUIDADO'',''N'',''ATIVO'', ''I'',''ATIVO'', ''V'',''ATIVO'',''R'',''ATIVO'',''OUTROS'')
                                    ,a.val_financ
                                    ,a.val_compra
                                    ,a.qtde_prestacoes
                                    ,a.val_prestacao
                                    ,d.cod_produto
                                    ,a.num_transacao
                                    ,d.data_cancelamento
                                    ,decode(a.tipo_aprov_cred, ''M'',''NAO'',''A'',''SIM'',''OUTROS'')
                                    ,d.data_liquidacao
                                    ,f.tipo_fluxo
                                    ,d.flag_seguro
                                    ,decode(a.tipo_sit_contrato, ''1'',''APROVADO'',''2'',''REPROVADO'',''3'',''PENDENTE_ANALISE'',''9'',''CANCELADO'',''Z'',''EXPIRADO'',''OUTROS'')
                                    ,g.cpf_atendente
                                    ,to_char(''S'')
                                    ,case when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''S''
                                          then ''FORMALIZACAO/APROVADO PELA ANALISE/ACEITO PELO CLIENTE''
                                          when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''N''
                                          then ''FORMALIZACAO/APROVADO PELA ANALISE''
                                          when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''R''
                                          then ''FORMALIZACAO/APROVADO PELA ANALISE/RECUSADO PELO CLIENTE''
                                          when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''T''
                                          then ''FORMALIZACAO/APROVADO PELA ANALISE/AGUARDANDO LIBERACAO DO DINHEIRO NO PDV''
                                          when a.tipo_sit_contrato = ''1'' and a.flag_integrar = ''I''
                                          then ''FORMALIZACAO/APROVADO AUTOMATICAMENTE/EFETUANDO SAQUE DO DINHEIRO NO PDV''
                                          when a.tipo_sit_contrato = ''2'' and a.flag_integrar = ''N''
                                          then ''FORMALIZACAO/REPROVADO PELA ANALISE''
                                          when a.tipo_sit_contrato = ''2'' and a.flag_integrar = ''R''
                                          then ''FORMALIZACAO/REPROVADO AUTOMATICAMENTE/RECUSADO PELA LOJA''
                                          when a.tipo_sit_contrato = ''3'' and a.flag_integrar = ''N''
                                          then ''FORMALIZACAO/AGUARDANDO PELA ANALISE''
                                          when a.tipo_sit_contrato = ''9'' and a.flag_integrar = ''9''
                                          then ''FORMALIZACAO/CANCELADO''
                                          when a.tipo_sit_contrato = ''Z'' and a.flag_integrar = ''N''
                                          then ''FORMALIZACAO/PROPOSTA EXPIRADA''
                                          when a.tipo_sit_contrato = ''Z'' and a.flag_integrar = ''T''
                                          then ''FORMALIZACAO/PROPOSTA EXPIRADA''
                                          else ''OUTROS''
                                     end

                               order by 1,5,7';

         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fu,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
         exception
            when others then
               null;
         end;
         --
         begin
           execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
         exception
           when others then
             null;
         end;
         --
         begin
            execute immediate 'create table '|| v_nm_tab_realz_fi ||' as
                               select a.fil_cod
                                     ,c.quant_seguro_real                   as quant_seguro_real
                                     ,nvl(count(distinct a.cod_contrato),0) as quant_ep_real
                                     ,sum(vlr_liquido_emprest)              as vlr_liquido_emprest
                                     ,flg_doc_digitalizado                  as flg_doc_digitalizado
                                 from '|| v_nm_tab_realz_fu ||'  a
                                     ,(select c.fil_cod
                                             ,nvl(count(distinct c.cod_contrato),0) as quant_seguro_real
                                         from '|| v_nm_tab_realz_fu ||' c
                                        where c.seguro = ''S''
                                          and c.situacao_contrato in (''APROVADO'')
                                        group by c.fil_cod
                                        order by 1
                                      ) c
                                where a.fil_cod   = c.fil_cod (+)
                                  and a.situacao_contrato in (''APROVADO'')
                             group by a.fil_cod
                                     ,c.quant_seguro_real
                                     ,flg_doc_digitalizado
                             order by 1';
         exception
            when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                 ' erro - '                || sqlerrm;
               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

         end;

         begin
            execute immediate 'drop index i_' || substr(v_nm_tab_realz_fi,1,28);
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'create index i_' || substr(v_nm_tab_realz_fi,1,28) ||' on ' || v_nm_tab_realz_fi || ' (fil_cod)';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'analyze table ' || v_nm_tab_realz_fi || ' estimate statistics sample 10 percent';
         exception
            when others then
               null;
         end;
         begin
            execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
         exception
            when others then
               null;
         end;

      -- SE INDICADOR EMPRESTIMO_PESSOAL_SAX
      end if;

   exception
      when e_erro then
         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                 ,p_subject => 'SRV Calculo Realizado Filial - Erro exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                    ,p_subject => 'SRV Calculo Realizado Filial - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


         -- retorna
         return;
      --
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral ao calcular realizado Filiais Remun Loja: ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' || sqlerrm;


         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                 ,p_subject => 'SRV Calculo Realizado Filial - Erro geral exception: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 1
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FIL_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 68 -- SRV - PRC_CALC_REALZ_FIL_LJ
                                                                    ,p_subject => 'SRV Calculo Realizado Filial - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

   end prc_calc_realz_fil_Lj;

   -----------------------------------------------------------------------------------------------
   -- CALCULA ATINGIMENTO (CALCULO) FILIAL
   -----------------------------------------------------------------------------------------------
    procedure prc_calc_ating_fil_Lj (p_num_ano      in number
                                    ,p_num_mes      in number
                                    ,p_cod_emp      in number    default null
                                    ,p_cod_fil      in number    default null
                                    ,p_cod_indic    in number    default null
                                    ,p_descr_indic  in varchar2  default null
                                    ,p_cod_usuario  in number
                                    ,p_cod_erro     out number
                                    ,p_descr_erro   out varchar2
                                     ) is

      -- REMUNERACAO LOJAS
      cursor c_indic_rem_loja is
         select t.cod_tipo_rem_var
               ,t.descr_tipo_rem_var
               ,g.cod_grp_indic
               ,g.descr_grp_indic
               ,i.cod_indic
               ,i.descr_indic
           from srv_tipo_rem_var        t
               ,srv_grupo_indicador     g
               ,srv_indicador           i
          where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
            and t.descr_tipo_rem_var  = 'REMUNERACAO_LOJA'
            and g.cod_grp_indic       = i.cod_grp_indic
            and i.cod_grp_indic       NOT IN (4,5,9) -- SAX e Seguro SAX
            and i.cod_indic_sis       is null
            and (i.descr_indic        = nvl(p_descr_indic, i.descr_indic))
            and i.flg_indic_ativ      = 'S'
       order by g.cod_grp_indic
               ,i.cod_indic;


      -- FILIAIS
      cursor c_fil (p_cod_emp number
                   ,p_cod_fil number) is
         select f.cod_emp
               ,f.cod_fil
               ,nvl(f.flg_meta_100_pct_realz, 'N') flg_meta_100_pct_realz
           from srv_filial               f
          where f.flg_ativ             = 'S'
            and (f.cod_emp             = nvl(p_cod_emp, f.cod_emp)) --p_cod_emp or p_cod_emp is null)
            and (f.cod_fil             = nvl(p_cod_fil, f.cod_fil)) --p_cod_fil or p_cod_fil is null);
       order by f.cod_fil;


      -- variaveis controle
      v_var_sql                        varchar2(2000);
      v_nm_tab_realz_fu                varchar2(30);
      v_nm_tab_realz_fi                varchar2(30);
      v_nm_tab_realz_fi_lr_vs          varchar2(30);
      v_nm_tab_meta                    varchar2(30);
      v_nm_tab_realz_fi_pc             varchar2(30);
      v_nm_tab_realz_fi_bp             varchar2(30);
      v_nm_tab_realz_fi_odo             varchar2(30);
      v_nm_tab_realz_fi_mm          varchar2(30);

      -- variaveis calculo
      v_vlr_vdas_bruta                 number(11,2);
      v_vlr_devolucao                  number(11,2);
      v_vlr_realizado                  srv_realizado_filial.num_realz%type;
      v_qtd_realizado                  number(11,2);--srv_realizado_filial.qtd_realz%type;
      v_cod_un_realz                   srv_realizado_filial.cod_un_realz%type;
      v_meta                           srv_meta_filial.num_meta%type;
      v_cod_un_meta                    srv_meta_filial.cod_un_meta%type;
      v_vlr_premio_fil                 srv_meta_filial.vlr_premio_fil%type;
      v_pct_calc_meta                  srv_meta_filial.pct_calc_meta%type;
      v_num_realz_x_meta               srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta            srv_realizado_filial.cod_un_realz_x_meta%type;
      v_vlr_premio_fil_calc            srv_realizado_filial.vlr_premio_fil_calc%type := 0;
      v_cod_escala                     srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx              srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                   srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx                srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                    srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                  srv_escala_faixa.num_limite_fx%type;
      --v_flg_meta_100_pct_realz         srv_filial.flg_meta_100_pct_realz%type;
      v_vr_vendas_tot                  srv_meta_filial.num_meta%type;
      v_qtde_vendas_parc               srv_meta_filial.num_meta%type;

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_tipo_rem_var               srv_tipo_rem_var.cod_tipo_rem_var%type;
      v_cod_grp_indic                  srv_grupo_indicador.cod_grp_indic%type;
      v_cod_indic                      srv_indicador.cod_indic%type;

      -- cursores
      cur_realz                        pkg_srv_calc_rem_var.typ_cursor;

      --
      rec_srv_realizado_filial         srv_realizado_filial%rowtype;

      -- exception
      e_erro_cria_tab                  exception;

   ---------------------------------------------------------------------------
   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;


      -----------------------------------------------------------------------
      -- INICIO CALCULO
      -- SELECIONA FILIAIS ATIVAS
      -----------------------------------------------------------------------
      for r_fil in c_fil (p_cod_emp
                         ,p_cod_fil) loop


         v_cod_fil := r_fil.cod_fil;

         -----------------------------------------------------------------------
         -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
         -----------------------------------------------------------------------
         for r_indic_rem_loja in c_indic_rem_loja loop


            v_cod_tipo_rem_var := r_indic_rem_loja.cod_tipo_rem_var;
            v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
            v_cod_indic        := r_indic_rem_loja.cod_indic;


            -----------------------------------------------------------------------
            -- SE INDICADOR VENDAS
            -----------------------------------------------------------------------
            if r_indic_rem_loja.descr_indic = 'VENDAS' then

               --
               v_nm_tab_realz_fi := 'SRV_REALZFI_VENDAS_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_vlr_vdas_bruta                 := 0;
               v_vlr_devolucao                  := 0;
               v_vlr_realizado                  := 0;
               v_qtd_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;


               --
               v_var_sql :=              ' select nvl(r.vlr_vdas_bruta,0) vlr_vdas_bruta ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(r.vlr_devolucao,0)  vlr_devolucao '  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(r.vlr_realizado,0)  vlr_realizado '  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||'  r '           || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where r.fil_cod = '                            || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_vlr_vdas_bruta
                       ,v_vlr_devolucao
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;

               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_vlr_vdas_bruta      := nvl(v_vlr_vdas_bruta, 0);
               v_vlr_devolucao       := nvl(v_vlr_devolucao, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               --
               --
               v_cod_un_realz           := 1; -- unidade de valor


               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then

                  -- se erro ao calcular a meta utilizar o realizado
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor


                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --1 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               -- calcula realizado X meta da filial
               -- se a meta estiver zerada entao assumir como vlr de meta X realizado o realizado
               if v_meta > 0 then
                  v_num_realz_x_meta       := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta       := 2; -- unidade de percentual


               -- verificar o realizado x meta na escala (guardar na variavel v_num_realz_fx)
               -- para calcular o vr do premio calculado para a filial para rateio entre os cargos operacionais
               -- verificar se existe uma escala cadastrada para o indicador,
               -- se nao houver procurar para o grupo de indic
               -- se nao houver procurar para o grupo de rem var
               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx (r_indic_rem_loja.cod_indic      -- p_cod_indic
                                  ,r_indic_rem_loja.cod_grp_indic  -- p_cod_grp_indic
                                  ,null                            -- p_cod_grp_rem_var
                                  ,v_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );
               if p_cod_erro is not null then
                  --
                  v_num_realz_fx := 0;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                          ,p_subject => 'SRV Calculo Atingimento Filial - Escala nao encontrada: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                            ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => null
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

--                  raise e_erro;
               end if;


               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                  --
                  v_num_realz_fx := v_num_realz_x_meta;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
                  v_num_realz_x_meta := v_num_limite_fx;
               end if;

               -- vlr do premio calculado para a filial, conforme o atingimento da meta
               v_vlr_premio_fil_calc         := (v_vlr_premio_fil * v_num_realz_fx) / 100;


               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_qtd_realizado := null;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARTAO MARISA APROVADO PL E ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARTAO MARISA APROVADO PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CART_APROV_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CART_APROV_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));

               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;


               --

               v_var_sql :=              ' select (nvl(a.qtde ,0) - nvl(b.qtd,0)) qtde ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||' a ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '        ,(select count(cli_cpf) qtd'  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '            from '||v_nm_tab_realz_fu||' c  ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '           where c.flg_doc_digitalizado =''N''' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '             and c.fil_cod =  '|| r_fil.cod_fil ||') b ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   where a.fil_cod = '|| r_fil.cod_fil || chr(13) || chr(10);


               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;

               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --2 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado      = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARTAO MARISA ATIVADO PL E ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARTAO MARISA ATIVADO PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CART_ATIV_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CART_ATIV_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '             || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''     || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                    || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --3 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR BONUS CELULAR
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'BONUS CELULAR' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_BONUS_CEL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_BONUS_CEL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '             || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''     || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                    || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --3 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR PARTICIPACAO DO CARTAO %
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'PARTICIPACAO DO CARTAO %' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_PART_CARTAO_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_PART_CARTAO_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select part qtde '             || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '             || r_fil.cod_fil;

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 2; -- unidade de PERCENTUAL

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );
               v_meta          := nvl(v_pct_calc_meta,0);
               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 2; -- unidade de PERCENTUAL

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;
               --3 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;


            --------------------------------------------------------------------------------------
            -- SE INDICADOR VENDA COM JUROS PL
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'VENDA COM JUROS PL' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CPR_JUR_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CPR_JUR_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0)              qtde '               || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(vlr_realz_cpr_jur,0) vlr_realz_cpr_jur '  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi||''                     || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                   || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas total PL e Itau
               -- para ter q meta em valor
               --ALTERADO ALEXANDRE BEZERRA nome da tabela
               begin
                  execute immediate 'select vlr_liq_vda_total_PL_ita
                                       from SRV_TMP_META_VENDAS_PL_'||
                                       trim(to_char(p_num_ano, '0000'))  ||
                                       trim(to_char(p_num_mes, '00'))    ||
                                    ' where cod_fil = :cod_fil ' into v_vr_vendas_tot using r_fil.cod_fil;
               exception
                  when others then
                     v_vr_vendas_tot := 0;
                     p_cod_erro      := 3;
               end;
               v_meta          := (nvl(v_pct_calc_meta,0) * v_vr_vendas_tot) / 100;
               v_cod_un_meta   := 1; -- unidade de VALOR


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de VALOR

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );


               --4 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL


            --------------------------------------------------------------------------------------
            -- SE INDICADOR VENDA COM JUROS ITAU
            --------------------------------------------------------------------------------------

            elsif r_indic_rem_loja.descr_indic = 'VENDA COM JUROS ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CPR_JUR_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CPR_JUR_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0)              qtde '               || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(VLR_REALZ_BRUTO_CPR_JUR,0) VLR_REALZ_BRUTO_CPR_JUR '  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi||''                     || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                   || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas total Itau
               -- para ter q meta em valor
               begin
                  execute immediate 'select VLR_MOVTO
                                       from SRV_TMP_META_VENDAS_I_'||
                                       trim(to_char(p_num_ano, '0000'))  ||
                                       trim(to_char(p_num_mes, '00'))    ||
                                    ' where cod_fil = :cod_fil ' into v_vr_vendas_tot using r_fil.cod_fil;
               exception
                  when others then
                     v_vr_vendas_tot := 0;
                     p_cod_erro      := 3;
               end;
               v_meta          := (nvl(v_pct_calc_meta,0) * v_vr_vendas_tot) / 100;
               v_cod_un_meta   := 1; -- unidade de VALOR


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de VALOR

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --5 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

            --------------------------------------------------------------------------------------
            -- SE INDICADOR VENDA COM JUROS PL E ITAU
            --------------------------------------------------------------------------------------

            elsif r_indic_rem_loja.descr_indic = 'VENDA COM JUROS PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_VJ_PL_ITAU_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_VJ_PL_ITAU_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              'select sum(nvl(qtde,0))                                        ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '      ,sum(nvl(vlr_realz_cpr_jur,0))                           ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  from (select fil_cod                                         ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '             , qtde                                            ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '             , vlr_realz_cpr_jur                               ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '          from srv_realzfi_cpr_jur_'
                                                             ||trim(to_char(p_num_ano,'0000'))
                                                             ||trim(to_char(p_num_mes, '00'))||'         ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       union all                                               ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '        select fil_cod                                         ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '             , qtde                                            ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '             , vlr_realz_bruto_cpr_jur                         ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '          from srv_realzfi_cpr_jur_it_'
                                                             ||trim(to_char(p_num_ano,'0000'))
                                                             ||trim(to_char(p_num_mes, '00'))||')        ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || ' where fil_cod = ' || r_fil.cod_fil                              || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas total Itau
               -- para ter q meta em valor
               begin
                  execute immediate 'select sum(vlr_movto) vlr_movto
                                       from(select *
                                              from srv_tmp_meta_vendas_i_'||trim(to_char(p_num_ano,'0000'))||trim(to_char(p_num_mes,'00'))||'
                                               union all
                                            select *
                                              from srv_tmp_meta_vendas_pl_'||trim(to_char(p_num_ano,'0000'))||trim(to_char(p_num_mes,'00'))||')
                                      where cod_fil = :cod_fil ' into v_vr_vendas_tot using r_fil.cod_fil;
               exception
                  when others then
                     v_vr_vendas_tot := 0;
                     p_cod_erro      := 3;
               end;

               v_meta          := (nvl(v_pct_calc_meta,0) * v_vr_vendas_tot) / 100;
               v_cod_un_meta   := 1; -- unidade de VALOR


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de VALOR

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --6 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then--
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL


            --------------------------------------------------------------------------------------
            -- SE INDICADOR COMPRA TRANQUILA PL
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'COMPRA TRANQUILA PL' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CPRA_TRANQ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CPRA_TRANQ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '                                 || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(vlr_realz_cpra_tranq,0) vlr_realz_cpra_tranq ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''                         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                        || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas com juros PL e Itau
               -- para ter a meta em valor
               v_nm_tab_meta := 'SRV_TMP_META_CPR_TRANQ_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));
               begin
                  execute immediate 'select qtde from ' || v_nm_tab_meta || ' where fil_cod = :cod_fil ' into v_qtde_vendas_parc using r_fil.cod_fil;
               exception
                  when others then
                     v_qtde_vendas_parc := 0;
                     p_cod_erro         := 3;
               end;

               v_meta         := (nvl(v_pct_calc_meta,0) * v_qtde_vendas_parc) / 100;
               v_cod_un_meta  := 3; -- unidade de UNIDADE


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --6 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;


            --------------------------------------------------------------------------------------
            -- SE INDICADOR COMPRA TRANQUILA ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'COMPRA TRANQUILA ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CPRA_TRANQI_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CPRA_TRANQI_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '                                 || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(VLR_REALZ_BRUTO_CPR_TRANQ,0) VLR_REALZ_BRUTO_CPR_TRANQ ' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''                         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                        || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas com juros PL e Itau
               -- para ter a meta em valor
               v_nm_tab_meta := 'SRV_TMP_META_CPR_TRANQI_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));
               begin
                  execute immediate 'select qtde_vds_parc_pl_ita  from ' || v_nm_tab_meta || ' where fil_cod = :cod_fil ' into v_qtde_vendas_parc using r_fil.cod_fil;
               exception
                  when others then
                     v_qtde_vendas_parc := 0;
                     p_cod_erro         := 3;
               end;

               v_meta         := (nvl(v_pct_calc_meta,0) * v_qtde_vendas_parc) / 100;
               v_cod_un_meta  := 3; -- unidade de UNIDADE


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --7 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR COMPRA TRANQUILA PL E ITAU
            --------------------------------------------------------------------------------------

            elsif r_indic_rem_loja.descr_indic = 'COMPRA TRANQUILA PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CPRA_TRANQI_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CPRA_TRANQI_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql := 'select sum(qtde) qtde
                                   ,sum(vlr_realz_cpra_tranq) vlr_realz_cpra_tranq
                               from(select nvl(qtde,0) qtde
                                          ,nvl(vlr_realz_cpra_tranq,0) vlr_realz_cpra_tranq
                                      from srv_realzfi_cpra_tranq_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0)
                                          ,nvl(vlr_realz_bruto_cpr_tranq,0)
                                      from srv_realzfi_cpra_tranqi_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                   )';

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas com juros PL e Itau
               -- para ter a meta em valor
               v_nm_tab_meta := 'SRV_TMP_META_CPR_TRANQI_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));
               begin
                  execute immediate 'select sum(qtde) qtde
                                       from(select qtde
                                              from SRV_TMP_META_CPR_TRANQ_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                             where fil_cod = ' || r_fil.cod_fil ||'
                                             union all
                                            select qtde_vds_parc_pl_ita
                                              from SRV_TMP_META_CPR_TRANQI_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))||'
                                             where fil_cod = ' || r_fil.cod_fil ||'
                                           )' into v_qtde_vendas_parc;
               exception
                  when others then
                     v_qtde_vendas_parc := 0;
                     p_cod_erro         := 3;
               end;

               v_meta         := (nvl(v_pct_calc_meta,0) * v_qtde_vendas_parc) / 100;
               v_cod_un_meta  := 3; -- unidade de UNIDADE


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --7 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;


            --------------------------------------------------------------------------------------
            -- SE INDICADOR BOLSA PROTEGIDA
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'BOLSA PROTEGIDA PL' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_MAR_PROT_LJ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_MAR_PROT_LJ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '           || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                  || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --9 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR BOLSA PROTEGIDA ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'BOLSA PROTEGIDA ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_MAR_PROT_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_MAR_PROT_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '           || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                  || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --10 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR BOLSA PROTEGIDA PL E ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'BOLSA PROTEGIDA PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_BPROT_PL_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_BPROT_PL_IT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '           || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                  || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --10 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;


            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARTAO MARISA TOMBAMENTO ITAUCARD
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARTAO MARISA TOMBAMENTO ITAUCARD' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CART_TOMB_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CART_TOMB_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '          || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '||v_nm_tab_realz_fi||''    || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                 || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --12 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARTAO MARISA DESBLOQUEIO ITAUCARD
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARTAO MARISA DESBLOQUEIO ITAUCARD' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CT_IT_DESB_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CT_IT_DESB_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '          || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                 || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;

                  --
                  exit when cur_realz%notfound;

               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --13 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR ASSISTENCIA ODONTOLOGICA LOJA
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'ASSISTENCIA ODONTOLOGICA LOJA' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_ASS_ODO_LJ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_ASS_ODO_LJ_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||'' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --14 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARRO E LAR PL MARISA FAMILIA CASA PROTEGIDA
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARRO E LAR PL MARISA FAMILIA CASA PROTEGIDA' then
               --
               v_nm_tab_realz_fi_mm    := 'SRV_REALZFI_SEG_MAR_MUL_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               v_nm_tab_realz_fi_pc    := 'SRV_REALZFI_PROT_CEL_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               v_nm_tab_realz_fi_bp    := 'SRV_REALZFI_BPROT_PL_IT_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql := 'select sum(qtde) qtde
                               from(select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_mm||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_pc||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_bp||'
                                     where fil_cod = ' || r_fil.cod_fil ||')';


               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
              begin
                select sum(m.num_meta)
                      ,m.cod_un_meta
                      ,sum(m.vlr_premio_fil)
                      ,sum(m.pct_calc_meta)
                  into v_meta
                      ,v_cod_un_meta
                      ,v_vlr_premio_fil
                      ,v_pct_calc_meta
                  from srv_meta_filial   m
                 where m.cod_indic     in (21,24,37)
                   and m.cod_emp       = r_fil.cod_emp
                   and m.cod_fil       = r_fil.cod_fil
                   and m.num_ano       = p_num_ano
                   and m.num_mes       = p_num_mes
                   group by m.cod_un_meta;
               exception
                 when no_data_found then
                   null;
               end;

               --15 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR SEGUROS + ODONTO
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'SEGUROS + ODONTO' then
               --
               v_nm_tab_realz_fi_mm    := 'SRV_REALZFI_SEG_MAR_MUL_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               v_nm_tab_realz_fi_pc    := 'SRV_REALZFI_PROT_CEL_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               v_nm_tab_realz_fi_bp    := 'SRV_REALZFI_BPROT_PL_IT_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               v_nm_tab_realz_fi_odo   := 'SRV_REALZFI_ASS_ODO_LJ_'
                                       ||trim(to_char(p_num_ano, '0000'))
                                       ||trim(to_char(p_num_mes, '00'));

               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql := 'select sum(qtde) qtde
                               from(select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_mm||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_pc||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_bp||'
                                     where fil_cod = ' || r_fil.cod_fil ||'
                                       union all
                                    select nvl(qtde,0) qtde
                                      from '||v_nm_tab_realz_fi_odo||'
                                     where fil_cod = ' || r_fil.cod_fil ||')';

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
              begin
                select sum(m.num_meta)
                      ,m.cod_un_meta
                      ,sum(m.vlr_premio_fil)
                      ,sum(m.pct_calc_meta)
                  into v_meta
                      ,v_cod_un_meta
                      ,v_vlr_premio_fil
                      ,v_pct_calc_meta
                  from srv_meta_filial   m
                 where m.cod_indic     in (21,24,37,41)
                   and m.cod_emp       = r_fil.cod_emp
                   and m.cod_fil       = r_fil.cod_fil
                   and m.num_ano       = p_num_ano
                   and m.num_mes       = p_num_mes
                   group by m.cod_un_meta;
               exception
                 when no_data_found then
                   null;
               end;

               --15 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;


            --------------------------------------------------------------------------------------
            -- SE INDICADOR PROTECAO CELULAR MARISA
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'PROTECAO CELULAR MARISA' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_PROT_CEL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_PROT_CEL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '||v_nm_tab_realz_fi||''   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --11 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_SEG_MAR_MUL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_SEG_MAR_MUL_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '           || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '||v_nm_tab_realz_fi         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = ' || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 3; -- unidade de UNIDADE

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 3; -- unidade de UNIDADE

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --11 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR CARTAO ADICIONAL PL E ITAU
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'CARTAO ADICIONAL PL E ITAU' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_CT_ADIC_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_CT_ADIC_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
 --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0)              qtde '               || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi||''                     || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                   || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas total PL e Itau
               -- para ter q meta em valor
               --ALTERADO ALEXANDRE BEZERRA nome da tabela
               begin
                  execute immediate 'select qtde
                                       from SRV_REALZFI_CART_APROV_'||
                                       trim(to_char(p_num_ano, '0000'))  ||
                                       trim(to_char(p_num_mes, '00'))    ||
                                    ' where fil_cod = :cod_fil ' into v_vr_vendas_tot using r_fil.cod_fil;
               exception
                  when others then
                     v_vr_vendas_tot := 0;
                     p_cod_erro      := 3;
               end;
               v_meta          := (nvl(v_pct_calc_meta,0) * v_vr_vendas_tot) / 100;
               v_cod_un_meta   := 1; -- unidade de VALOR


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 1; -- unidade de VALOR

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );


               --4 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR PARCELAMENTO DE FATURAS
            --------------------------------------------------------------------------------------

            elsif r_indic_rem_loja.descr_indic = 'PARCELAMENTO DE FATURAS' then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_PARC_FAT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_PARC_FAT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0)              qtde '               || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi                         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                   || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- calcula a meta, que veio em percentual, sobre o valor de vendas total Itau
               -- para ter q meta em valor
               begin
                  execute immediate ' select sum(oferta) qtde
                                        from MV_CCM_TERMOMETRO_PARC_FATURA
                                       where ano = '||p_num_ano||'
                                         and mes = '||p_num_mes||'
                                         and filial = :cod_fil ' into v_vr_vendas_tot using r_fil.cod_fil;
               exception
                  when others then
                     v_vr_vendas_tot := 0;
                     p_cod_erro      := 3;
               end;
               v_meta          := (nvl(v_pct_calc_meta,0) * v_vr_vendas_tot) / 100;
               v_cod_un_meta   := 1; -- unidade de VALOR


               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 1; -- unidade de VALOR

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_qtd_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               -- atualizar o valor da meta com o calculado pelo percentual
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_atualiza_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                     ,p_cod_emp          => r_fil.cod_emp
                                     ,p_cod_fil          => r_fil.cod_fil
                                     ,p_ano_meta         => p_num_ano
                                     ,p_mes_meta         => p_num_mes
                                     ,p_meta             => v_meta
                                     ,p_cod_un_meta      => v_cod_un_meta
                                     ,p_cod_erro         => p_cod_erro
                                     ,p_descr_erro       => p_descr_erro
                                     );

               --5 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

             elsif r_indic_rem_loja.descr_indic = 'PPT - PECAS POR TICKET' then

               --
               v_nm_tab_realz_fi := 'SRV_REALZFI_PPT_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(qtde,0) qtde '         || chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '||v_nm_tab_realz_fi||''   || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 14; -- unidade de PECAS/TKT

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_qtd_realizado;
                  v_cod_un_meta      := 14; -- unidade de PECAS/TKT

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --11 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            end if;

            --
            rec_srv_realizado_filial.cod_indic               := r_indic_rem_loja.cod_indic;
            rec_srv_realizado_filial.cod_emp                 := r_fil.cod_emp;
            rec_srv_realizado_filial.cod_fil                 := r_fil.cod_fil;
            rec_srv_realizado_filial.num_ano                 := p_num_ano;
            rec_srv_realizado_filial.num_mes                 := p_num_mes;
            rec_srv_realizado_filial.num_meta                := v_meta;
            rec_srv_realizado_filial.cod_un_meta             := v_cod_un_meta;
            rec_srv_realizado_filial.num_realz               := v_vlr_realizado;
            rec_srv_realizado_filial.cod_un_realz            := v_cod_un_realz;
            rec_srv_realizado_filial.qtd_realz               := v_qtd_realizado;
            rec_srv_realizado_filial.num_realz_x_meta        := v_num_realz_x_meta;
            rec_srv_realizado_filial.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;
            if r_indic_rem_loja.descr_indic = 'VENDAS' then
               rec_srv_realizado_filial.vlr_premio_fil_calc     := v_vlr_premio_fil_calc;
               rec_srv_realizado_filial.cod_un_premio_fil_calc  := 1; -- unidade de VALOR
            else
               rec_srv_realizado_filial.vlr_premio_fil_calc     := null;
               rec_srv_realizado_filial.cod_un_premio_fil_calc  := null;
            end if;
            rec_srv_realizado_filial.dt_ini_sit_srv          := v_data;
            rec_srv_realizado_filial.cod_usuario             := p_cod_usuario;
            rec_srv_realizado_filial.cod_escala              := v_cod_escala;
            rec_srv_realizado_filial.num_seq_escala_fx       := v_num_seq_escala_fx;
            rec_srv_realizado_filial.num_realz_fx            := v_num_realz_fx;
            rec_srv_realizado_filial.cod_un_realz_fx         := v_cod_un_realz_fx;


            -- insere o realizado da filial para o indicador
            prc_insere_realz_fil (p_rec_srv_realz_fil  => rec_srv_realizado_filial
                                 ,p_cod_erro           => p_cod_erro
                                 ,p_descr_erro         => p_descr_erro
                                  );
            --
            if p_cod_erro is not null then

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                       ,p_subject => 'SRV Calculo Atingimento Filial - Erro ao inserir tabela realizado filial: '
                                                                       ,p_body    => v_body
                                                                       );

               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                         ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

--               raise e_erro;
            -- if p_cod_erro is not null
            end if;



            -- commit por indicador
            commit;

         -- c_indic_rem_loja
         end loop;

         -- commit por filial
         commit;

      -- c_fil
      end loop;

      --
      commit;


   exception

      when e_erro_cria_tab then

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial - Erro ao criar tabelas de apuracao: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


         -- retorna
         return;


      when e_erro then
         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial - Erro exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


         -- retorna
         return;
      --
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral ao calcular Atingimento Filiais Remun Loja: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_tipo_rem_var: '  || v_cod_tipo_rem_var    || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' || sqlerrm;


         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial - Erro geral exception: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

   end prc_calc_ating_fil_Lj;



   -----------------------------------------------------------------------------------------------
   -- CALCULA ATINGIMENTO (CALCULO) SAX
   -----------------------------------------------------------------------------------------------
    procedure prc_calc_ating_fil_SAX (p_num_ano      in number
                                     ,p_num_mes      in number
                                     ,p_cod_emp      in number    default null
                                     ,p_cod_fil      in number    default null
                                     ,p_cod_indic    in number    default null
                                     ,p_descr_indic  in varchar2  default null
                                     ,p_cod_usuario  in number
                                     ,p_cod_erro     out number
                                     ,p_descr_erro   out varchar2
                                      ) is

      -- REMUNERACAO LOJAS
      cursor c_indic_rem_loja is
         select t.cod_tipo_rem_var
               ,t.descr_tipo_rem_var
               ,g.cod_grp_indic
               ,g.descr_grp_indic
               ,i.cod_indic
               ,i.descr_indic
           from srv_tipo_rem_var        t
               ,srv_grupo_indicador     g
               ,srv_indicador           i
          where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
            and t.descr_tipo_rem_var  = 'REMUNERACAO_LOJA'
            and g.cod_grp_indic       = i.cod_grp_indic
            and i.cod_grp_indic       in (4,5,9,3) -- SAX e Seguro SAX
            and i.cod_indic_sis       ='SAX_PSF'
            and (i.descr_indic        = nvl(p_descr_indic, i.descr_indic))
            and i.flg_indic_ativ      = 'S'
       order by g.cod_grp_indic
               ,i.cod_indic;


      -- FILIAIS
      cursor c_fil (p_cod_emp number
                   ,p_cod_fil number) is
         select f.cod_emp
               ,f.cod_fil
               ,nvl(f.flg_meta_100_pct_realz, 'N') flg_meta_100_pct_realz
--Alt201401               ,FLOOR(MONTHS_BETWEEN(SYSDATE,trunc(nvl(f.dt_inaug_filial,sysdate)) )) mes_inauguracao
               ,0 mes_inauguracao
           from srv_filial               f
          where f.flg_ativ             = 'S'
            and (f.cod_emp             = nvl(p_cod_emp, f.cod_emp)) --p_cod_emp or p_cod_emp is null)
            and (f.cod_fil             = nvl(p_cod_fil, f.cod_fil)) --p_cod_fil or p_cod_fil is null);
       order by f.cod_fil;


      -- variaveis controle
      v_var_sql                        varchar2(2000);
      v_nm_tab_realz_fu                varchar2(30);
      v_nm_tab_realz_fi                varchar2(30);
      v_mes                            number;

      v_vlr_realizado                  srv_realizado_filial.num_realz%type;
      v_qtd_realizado                  srv_realizado_filial.qtd_realz%type;
      v_cod_un_realz                   srv_realizado_filial.cod_un_realz%type;
      v_meta                           srv_meta_filial.num_meta%type;
      v_cod_un_meta                    srv_meta_filial.cod_un_meta%type;
      v_vlr_premio_fil                 srv_meta_filial.vlr_premio_fil%type;
      v_pct_calc_meta                  srv_meta_filial.pct_calc_meta%type;
      v_num_realz_x_meta               srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta            srv_realizado_filial.cod_un_realz_x_meta%type;
      v_vlr_premio_fil_calc            srv_realizado_filial.vlr_premio_fil_calc%type := 0;
      v_cod_escala                     srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx              srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                   srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx                srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                    srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                  srv_escala_faixa.num_limite_fx%type;
      --v_flg_meta_100_pct_realz         srv_filial.flg_meta_100_pct_realz%type;

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_tipo_rem_var               srv_tipo_rem_var.cod_tipo_rem_var%type;
      v_cod_grp_indic                  srv_grupo_indicador.cod_grp_indic%type;
      v_cod_indic                      srv_indicador.cod_indic%type;

      -- cursores
      cur_realz                        pkg_srv_calc_rem_var.typ_cursor;

      --
      rec_srv_realizado_filial         srv_realizado_filial%rowtype;

      -- exception
      e_erro_cria_tab                  exception;

   ---------------------------------------------------------------------------
   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;


      -----------------------------------------------------------------------
      -- INICIO CALCULO
      -- SELECIONA FILIAIS ATIVAS
      -----------------------------------------------------------------------
      for r_fil in c_fil (p_cod_emp
                         ,p_cod_fil) loop


         v_cod_fil := r_fil.cod_fil;
         v_mes     := r_fil.mes_inauguracao;
         -----------------------------------------------------------------------
         -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
         -----------------------------------------------------------------------
         for r_indic_rem_loja in c_indic_rem_loja loop


            v_cod_tipo_rem_var := r_indic_rem_loja.cod_tipo_rem_var;
            v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
            v_cod_indic        := r_indic_rem_loja.cod_indic;



            --------------------------------------------------------------------------------------
            -- SE INDICADOR EMPRESTIMO PESSOAL (EP) SAX
            --------------------------------------------------------------------------------------
            if r_indic_rem_loja.descr_indic = 'EMPRESTIMO PESSOAL (EP) SAX'  then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               -- nao tem meta, entao o realizado X meta sera
               -- o realizado do seguro em quantidade (nao pegar valor) dividido pelo realizado
               -- em quantidade (nao pegar valor) do emprestimo
               v_var_sql :=              ' select nvl(quant_ep_real,0) quant_ep_real '            || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(vlr_liquido_emprest,0) vlr_liquido_emprest '|| chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''                      || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                     || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial SAX - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - prc_calc_ating_fil_SAX
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial SAX - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --17 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL


            --------------------------------------------------------------------------------------
            -- SE INDICADOR SEGURO EMPRESTIMO PESSOAL (EP) SAX
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'SEGURO EMPRESTIMO PESSOAL (EP) SAX'  then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               -- nao tem meta, entao o realizado X meta sera
               -- o realizado do seguro em quantidade (nao pegar valor) dividido pelo realizado
               -- em quantidade (nao pegar valor) do emprestimo
               v_var_sql :=              ' select nvl(quant_seguro_real,0) quant_seguro_real' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(quant_ep_real,0) quant_seguro_real    ' || chr(13)  || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''                  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                 || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --

               --ALTERACAO PARA O INDICADOR 17
               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - prc_calc_ating_fil_SAX
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial SAX - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;


               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               v_meta                := nvl(v_meta, 0);
               --
               v_cod_un_meta   := 3; -- unidade de UNIDADE
               v_cod_un_realz     := 3; -- unidade de UNIDADE

               --18 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

            --------------------------------------------------------------------------------------
            -- SE INDICADOR EMPRESTIMO PESSOAL (EP) SAX / PSF
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'EMPRESTIMO PESSOAL (EP) SAX / PSF'  then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               -- nao tem meta, entao o realizado X meta sera
               -- o realizado do seguro em quantidade (nao pegar valor) dividido pelo realizado
               -- em quantidade (nao pegar valor) do emprestimo

               v_var_sql :=              ' select  nvl(a.quant_ep_real,0) quant_ep_real '|| chr(13) || chr(10);
               v_var_sql := v_var_sql || '       , nvl(a.vlr_liquido_emprest,0) vlr_liquido_emprest '|| chr(13) || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||' a '|| chr(13) || chr(10);
               v_var_sql := v_var_sql || '   where fil_cod = '|| r_fil.cod_fil || chr(13) || chr(10);


               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => (case when r_indic_rem_loja.cod_indic = 28 then 16 end)
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial SAX - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - prc_calc_ating_fil_SAX
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial SAX - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --19 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

-- ini Alt201402 - Inclusao de trava para este indicadore
               -- verificar o realizado x meta na escala (guardar na variavel v_num_realz_fx)
               -- para calcular o vr do premio calculado para a filial para rateio entre os cargos operacionais
               -- verificar se existe uma escala cadastrada para o indicador,
               -- se nao houver procurar para o grupo de indic
               -- se nao houver procurar para o grupo de rem var
               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx (r_indic_rem_loja.cod_indic      -- p_cod_indic
                                  ,r_indic_rem_loja.cod_grp_indic  -- p_cod_grp_indic
                                  ,null                            -- p_cod_grp_rem_var
                                  ,v_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );
               if p_cod_erro is not null then
                  --
                  v_num_realz_fx := 0;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                          ,p_subject => 'SRV Calculo Atingimento Filial - Escala nao encontrada: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                            ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => null
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

--                  raise e_erro;
               end if;


               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                  --
                  v_num_realz_fx := v_num_realz_x_meta;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
               end if;

               -- vlr do premio calculado para a filial, conforme o atingimento da meta
               v_vlr_premio_fil_calc         := (v_vlr_premio_fil * v_num_realz_fx) / 100;

-- fim Alt201402

            --------------------------------------------------------------------------------------
            -- SE INDICADOR SEGURO EMPRESTIMO PESSOAL (EP) SAX / PSF
            --------------------------------------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic = 'SEGURO EMPRESTIMO PESSOAL (EP) SAX / PSF'  then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               -- nao tem meta, entao o realizado X meta sera
               -- o realizado do seguro em quantidade (nao pegar valor) dividido pelo realizado
               -- em quantidade (nao pegar valor) do emprestimo
               v_var_sql :=              ' select nvl(quant_seguro_real,0) quant_seguro_real' || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(quant_ep_real,0) quant_ep_real    ' || chr(13)  || chr(10);
               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||''                  || chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '                                 || r_fil.cod_fil || chr(13) || chr(10);

               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => (case when r_indic_rem_loja.cod_indic = 29 then 17 end)
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial EMPRESTIMO SAX - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - prc_calc_ating_fil_SAX
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial SAX - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;


               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               v_meta                := nvl(v_meta, 0);
               --
               v_cod_un_meta   := 3; -- unidade de UNIDADE
               v_cod_un_realz     := 3; -- unidade de UNIDADE

               --20 Alt201401
               if v_meta = 0 and v_qtd_realizado > 0 then
                  v_meta := v_qtd_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
               elsif v_qtd_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

               -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
               v_vlr_realizado := v_qtd_realizado;

-- ini Alt201402 - Inclusao de trava para este indicador
               -- verificar o realizado x meta na escala (guardar na variavel v_num_realz_fx)
               -- para calcular o vr do premio calculado para a filial para rateio entre os cargos operacionais
               -- verificar se existe uma escala cadastrada para o indicador,
               -- se nao houver procurar para o grupo de indic
               -- se nao houver procurar para o grupo de rem var
               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx (r_indic_rem_loja.cod_indic      -- p_cod_indic
                                  ,r_indic_rem_loja.cod_grp_indic  -- p_cod_grp_indic
                                  ,null                            -- p_cod_grp_rem_var
                                  ,v_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );
               if p_cod_erro is not null then
                  --
                  v_num_realz_fx := 0;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                          ,p_subject => 'SRV Calculo Atingimento Filial - Escala nao encontrada: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                            ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => null
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

--                  raise e_erro;
               end if;


               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                  --
                  v_num_realz_fx := v_num_realz_x_meta;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
               end if;

               -- vlr do premio calculado para a filial, conforme o atingimento da meta
               v_vlr_premio_fil_calc         := (v_vlr_premio_fil * v_num_realz_fx) / 100;

-- fim Alt201402

            -- if r_indic_rem_loja.descr_indic = ...
            --------------------------------------------------------------------------------------
            -- SE INDICACAO EMPRESTIMO PESSOAL (EP) SAX / PSF
            --------------------------------------------------------------------------------------

            elsif r_indic_rem_loja.descr_indic = 'INDICACAO EMPRESTIMO PESSOAL (EP) SAX / PSF'  then

               --
               v_nm_tab_realz_fu := 'SRV_REALZFU_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               v_nm_tab_realz_fi := 'SRV_REALZFI_EMP_SEG_SAX_'
                                    ||trim(to_char(p_num_ano, '0000'))
                                    ||trim(to_char(p_num_mes, '00'));
               --
               v_qtd_realizado                  := 0;
               v_vlr_realizado                  := 0;
               --
               v_cod_un_realz                   := null;
               v_meta                           := 0;
               v_cod_un_meta                    := null;
               v_vlr_premio_fil                 := 0;
               v_num_realz_x_meta               := 0;
               v_cod_un_realz_x_meta            := null;
               v_vlr_premio_fil_calc            := 0;
               v_cod_escala                     := null;
               v_num_seq_escala_fx              := null;
               v_num_realz_fx                   := 0;
               v_cod_un_realz_fx                := null;
               v_flg_pct_100                    := 0;
               v_num_limite_fx                  := 0;

               --
               v_var_sql :=              ' select nvl(quant_ep_real,0) quant_ep_real '            || chr(13) || chr(10);
               v_var_sql := v_var_sql || '       ,nvl(vlr_liquido_emprest,0) vlr_liquido_emprest '|| chr(13) || chr(10);               v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi ||' a '|| chr(13) || chr(10);
               v_var_sql := v_var_sql || '  where fil_cod = '|| r_fil.cod_fil || chr(13) || chr(10);


               open cur_realz for v_var_sql;
               loop
                  fetch cur_realz
                   into v_qtd_realizado
                       ,v_vlr_realizado;
                  --
                  exit when cur_realz%notfound;
               -- cur_venda
               end loop;
               --
               close cur_realz;
               --
               v_qtd_realizado       := nvl(v_qtd_realizado, 0);
               v_vlr_realizado       := nvl(v_vlr_realizado, 0);
               --
               v_cod_un_realz           := 1; -- unidade de VALOR

               -- calcular meta da filial para o indicador
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_meta_fil (p_cod_indic        => (case when r_indic_rem_loja.cod_indic = 30 then 16 end)
                                 ,p_cod_emp          => r_fil.cod_emp
                                 ,p_cod_fil          => r_fil.cod_fil
                                 ,p_ano_meta         => p_num_ano
                                 ,p_mes_meta         => p_num_mes
                                 ,p_meta             => v_meta
                                 ,p_cod_un_meta      => v_cod_un_meta
                                 ,p_vlr_premio_fil   => v_vlr_premio_fil
                                 ,p_pct_calc_meta    => v_pct_calc_meta
                                 ,p_cod_erro         => p_cod_erro
                                 ,p_descr_erro       => p_descr_erro
                                 );

               -- se nao exitir a meta, assumir o valor de realizado como meta
               if p_cod_erro is not null then
                  v_meta             := v_vlr_realizado;
                  v_cod_un_meta      := 1; -- unidade de valor

                  -- se nao encontrou meta para a filial => enviar email
                  if p_cod_erro in (1,2) then
                     --
                     if p_cod_erro = 1 then -- no_data_found
                        v_body       := 'SRV Calculo Atingimento Filial SAX - A Meta nao foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     elsif p_cod_erro = 2 then -- too_many_rows
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Mais de uma Meta foi encontrada para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     else
                        v_body       := 'SRV Calculo Atingimento Filial SAX - Erro ao selecionar Meta para a filial: '||
                                        r_fil.cod_fil || ' , para o indicador: '||
                                        r_indic_rem_loja.descr_indic || ' , e esta sendo considerado o Vlr do realizado: ' ||
                                        to_char(v_vlr_realizado,'99G999D99') || ' como meta.';
                     end if;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - prc_calc_ating_fil_SAX
                                                                             ,p_subject => 'SRV Calculo Atingimento Filial SAX - Meta nao encontrada filial: '||r_fil.cod_fil
                                                                             ,p_body    => v_body
                                                                             );
                  -- if p_cod_erro is not null
                  end if;

               -- se retornou erro ao selecionar calcular a meta
               end if;

               --21 Alt201401
               if v_meta = 0 and v_vlr_realizado > 0 then
                  v_meta := v_vlr_realizado;
               end if;

               if v_meta > 0 then
                  v_num_realz_x_meta      := (v_vlr_realizado / v_meta) * 100;
               elsif v_vlr_realizado = 0 then
                  v_num_realz_x_meta       := 0;
               elsif r_fil.flg_meta_100_pct_realz = 'S' then
                  v_num_realz_x_meta       := 100;
               else
                  v_num_realz_x_meta       := 0;
               end if;
               v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

-- ini Alt201402 - Inclusao de trava para este indicador
               -- verificar o realizado x meta na escala (guardar na variavel v_num_realz_fx)
               -- para calcular o vr do premio calculado para a filial para rateio entre os cargos operacionais
               -- verificar se existe uma escala cadastrada para o indicador,
               -- se nao houver procurar para o grupo de indic
               -- se nao houver procurar para o grupo de rem var
               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx (r_indic_rem_loja.cod_indic      -- p_cod_indic
                                  ,r_indic_rem_loja.cod_grp_indic  -- p_cod_grp_indic
                                  ,null                            -- p_cod_grp_rem_var
                                  ,v_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );
               if p_cod_erro is not null then
                  --
                  v_num_realz_fx := 0;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 72 -- SRV - PRC_CALC_ATING_FIL_LJ
                                                                          ,p_subject => 'SRV Calculo Atingimento Filial - Escala nao encontrada: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                            ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => null
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

--                  raise e_erro;
               end if;


               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                  --
                  v_num_realz_fx := v_num_realz_x_meta;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
               end if;

               -- vlr do premio calculado para a filial, conforme o atingimento da meta
               v_vlr_premio_fil_calc         := (v_vlr_premio_fil * v_num_realz_fx) / 100;
-- fim Alt201402
            -- if r_indic_rem_loja.descr_indic = ...
            end if;

            --
            rec_srv_realizado_filial.cod_indic               := r_indic_rem_loja.cod_indic;
            rec_srv_realizado_filial.cod_emp                 := r_fil.cod_emp;
            rec_srv_realizado_filial.cod_fil                 := r_fil.cod_fil;
            rec_srv_realizado_filial.num_ano                 := p_num_ano;
            rec_srv_realizado_filial.num_mes                 := p_num_mes;
            rec_srv_realizado_filial.num_meta                := v_meta;
            rec_srv_realizado_filial.cod_un_meta             := v_cod_un_meta;
            rec_srv_realizado_filial.num_realz               := v_vlr_realizado;
            rec_srv_realizado_filial.cod_un_realz            := v_cod_un_realz;
            rec_srv_realizado_filial.qtd_realz               := v_qtd_realizado;
            rec_srv_realizado_filial.num_realz_x_meta        := v_num_realz_x_meta;
            rec_srv_realizado_filial.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;
            rec_srv_realizado_filial.vlr_premio_fil_calc     := null;
            rec_srv_realizado_filial.cod_un_premio_fil_calc  := null;
            rec_srv_realizado_filial.dt_ini_sit_srv          := v_data;
            rec_srv_realizado_filial.cod_usuario             := p_cod_usuario;
            rec_srv_realizado_filial.cod_escala              := v_cod_escala;
            rec_srv_realizado_filial.num_seq_escala_fx       := v_num_seq_escala_fx;
            rec_srv_realizado_filial.num_realz_fx            := v_num_realz_fx;
            rec_srv_realizado_filial.cod_un_realz_fx         := v_cod_un_realz_fx;


            -- insere o realizado da filial para o indicador
            prc_insere_realz_fil (p_rec_srv_realz_fil  => rec_srv_realizado_filial
                                 ,p_cod_erro           => p_cod_erro
                                 ,p_descr_erro         => p_descr_erro
                                  );
            --
            if p_cod_erro is not null then

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                       ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro ao inserir tabela realizado filial: '
                                                                       ,p_body    => v_body
                                                                       );

               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                         ,p_nome_proc   => 'prc_calc_ating_fil_SAX'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => null
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

--               raise e_erro;
            -- if p_cod_erro is not null
            end if;



            -- commit por indicador
            commit;

         -- c_indic_rem_loja
         end loop;

         -- commit por filial
         commit;

      -- c_fil
      end loop;

      --
      commit;


   exception

      when e_erro_cria_tab then

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro ao criar tabelas de apuracao: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'prc_calc_ating_fil_SAX'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


         -- retorna
         return;


      when e_erro then
         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'prc_calc_ating_fil_SAX'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


         -- retorna
         return;
      --
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral ao calcular Atingimento Filiais Remun Loja: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_tipo_rem_var: '  || v_cod_tipo_rem_var    || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' || sqlerrm;


         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                 ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro geral exception: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                   ,p_nome_proc   => 'prc_calc_ating_fil_SAX'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => null
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 73 -- SRV - prc_calc_ating_fil_SAX
                                                                    ,p_subject => 'SRV Calculo Atingimento Filial SAX - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

   end prc_calc_ating_fil_SAX;


   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO LJ
   -----------------------------------------------------------------------------------------------


   procedure prc_calc_realz_Func_Indic_Lj (p_num_ano      in number
                                          ,p_num_mes      in number
                                          ,p_cod_emp      in number     default null
                                          ,p_cod_fil      in number     default null
                                          ,p_cod_indic    in number     default null
                                          ,p_descr_indic  in varchar2   default null
                                          ,p_cod_usuario  in number
                                          ,p_cod_erro     out number
                                          ,p_descr_erro   out varchar2
                                           ) is

      -- FILIAIS
      cursor c_fil (p_cod_emp number
                   ,p_cod_fil number) is
         select distinct f.cod_emp
                        ,f.cod_fil
                        ,f.cod_tipo_fil
           from srv_filial               f
               ,srv_realizado_filial     r
          where f.cod_emp              = r.cod_emp
            and f.cod_fil              = r.cod_fil
            and f.flg_ativ             = 'S'
            --and f.cod_fil              >= 48
            and (f.cod_emp             = p_cod_emp or p_cod_emp is null)
            and (f.cod_fil             = p_cod_fil or p_cod_fil is null)
            and r.num_ano              = p_num_ano
            and r.num_mes              = p_num_mes
       order by f.cod_fil;


      -- Salario Base dos Funcionarios (Operacionais)
      cursor c_func_base_rem_var (p_cur_cod_emp           number
                                 ,p_cur_cod_fil           number
                                 ,p_cod_grp_rem_var       number) is
         select b.cod_func
               ,b.cod_cargo
               ,b.cod_fil
           from srv_funcionario                     b
               ,srv_cargo                           c
               ,srv_grupo_cargo                     d
               ,srv_grupo_rem_variavel              e
          where b.cod_cargo                       = c.cod_cargo
            and c.cod_cargo                       = d.cod_cargo
            and d.cod_grp_rem_var                 = e.cod_grp_rem_var
            and(b.cod_emp                         = p_cur_cod_emp          or p_cur_cod_emp is null)
            and(b.cod_fil                         = p_cur_cod_fil          or p_cur_cod_fil is null)
            and e.cod_grp_rem_var                 = p_cod_grp_rem_var
            and (nvl(c.flg_agrupa_fil_lider, 'N') = 'N')
             -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                       '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                       ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                              '/' || trim(to_char(p_num_ano, '0000')) ||
                                                              ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                  OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                  >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                               '/' || trim(to_char(p_num_ano, '0000')) ||
                                                               ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                  )
                 )
                )
       order by b.cod_func
               ,b.cod_fil;


      -- cursor Cargos para os grupos de Remuneracao Variavel LIDERANCA
      cursor c_cargo_grp_rem_var (p_descr_grp_rem_var     varchar2
                                 ,p_flg_agrupa_fil_lider  varchar2) is
         select b.cod_cargo
               ,b.cod_grp_rem_var
           from srv_grupo_rem_variavel             a
               ,srv_grupo_cargo                    b
               ,srv_cargo                          c
          where a.cod_grp_rem_var                = b.cod_grp_rem_var
            and b.cod_cargo                      = c.cod_cargo
            and nvl(c.flg_agrupa_fil_lider, 'N') = p_flg_agrupa_fil_lider
            and a.descr_grp_rem_var              = p_descr_grp_rem_var
       order by b.cod_cargo;



      -- cursor dos funcionarios para o cargo LIDERANCA para a filial
      cursor c_func_cargo (p_cod_cargo              number
                          ,p_cur_cod_emp            number
                          ,p_cur_cod_fil            number
                          ,p_flg_agrupa_fil_lider   varchar2) is
         select b.cod_func
               ,b.cod_cargo
           from srv_cargo                         a
               ,srv_funcionario                   b
          where a.cod_cargo                      = b.cod_cargo
            and a.cod_cargo                      = p_cod_cargo
            and b.cod_emp                        = p_cur_cod_emp
            and b.cod_fil                        = p_cur_cod_fil
            and nvl(a.flg_agrupa_fil_lider, 'N') = p_flg_agrupa_fil_lider
            -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                       '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                       ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                              '/' || trim(to_char(p_num_ano, '0000')) ||
                                                              ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                   OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                  >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                               '/' || trim(to_char(p_num_ano, '0000')) ||
                                                               ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                  )
                 )
                )
       order by b.cod_func;

      -- cursor dos funcionarios para o cargo LIDERANCA 2 Lojas
      cursor c_func_cargo_2_fil (p_cod_cargo              number
                                ,p_cur_cod_emp            number
                                ,p_cur_cod_fil            number
                                ,p_flg_agrupa_fil_lider   varchar2) is
         select b.cod_func
               ,b.cod_cargo
           from srv_gerente_2_lojas   a
               ,srv_funcionario       b
               ,srv_cargo             c
          where c.cod_cargo                      = b.cod_cargo
            and a.cod_func                       = b.cod_func
            and a.cod_fil                       <> b.cod_fil
            and c.cod_cargo                      = p_cod_cargo
            and b.cod_emp                        = p_cur_cod_emp
            and a.cod_fil                        = p_cur_cod_fil
            --and c.cod_atuacao                    = 1
            and nvl(c.flg_agrupa_fil_lider, 'N') = p_flg_agrupa_fil_lider
            -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                       '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                       ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                              '/' || trim(to_char(p_num_ano, '0000')) ||
                                                              ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                   OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                  >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                               '/' || trim(to_char(p_num_ano, '0000')) ||
                                                               ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                  )
                 )
                )
       order by b.cod_func;

      -- Funcionarios LIDERANCA que recebem premio por 2 filiais
      -- fazer o calculo das outras filiais pelas quais que receberao premio
      -- pegar apenas as filiais diferentes da filial de cadastro
         cursor c_func_Lid_premio_2_fil (p_descr_indic        varchar2
                                        ,p_cod_fil            number
                                        ,p_descr_grp_rem_var  varchar2) is
           select a.cod_func          cod_func
                 ,b.cod_emp           cod_emp
                 ,a.cod_fil           cod_fil
                 ,b.cod_cargo         cod_cargo
                 ,e.cod_grp_rem_var   cod_grp_rem_var
                 ,f.num_meta          num_meta
                 ,f.num_realz         num_realz
                 ,f.qtd_realz         qtd_realz
             from srv_gerente_2_lojas                 a
                 ,srv_funcionario                     b
                 ,srv_cargo                           c
                 ,srv_grupo_cargo                     d
                 ,srv_grupo_rem_variavel              e
                 ,srv_realizado_filial                f
                 ,srv_indicador                       i
             where a.cod_func                        = b.cod_func
               and b.cod_cargo                       = c.cod_cargo
               and c.cod_cargo                       = d.cod_cargo
               and d.cod_grp_rem_var                 = e.cod_grp_rem_var
               and f.cod_emp                         = 1
               and a.cod_fil                         = p_cod_fil
               and a.cod_fil                        <> b.cod_fil
               --and a.cod_atuacao                     = 1
               and f.cod_fil                         = a.cod_fil
               and f.num_ano                         = p_num_ano
               and f.num_mes                         = p_num_mes
               and f.cod_indic                       = i.cod_indic
               and i.descr_indic                     = p_descr_indic
               and e.descr_grp_rem_var               = p_descr_grp_rem_var
               and (nvl(c.flg_agrupa_fil_lider, 'N') = 'N')
               -- funcionario esteve empregado pelo menos 1 dia no mes
               and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                          '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                          ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
               and (b.dt_demissao                    is null
                    OR
                    b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                 '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                 ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                   )
               -- situacao do funcionario
               and (b.cod_sit_rh                     = 1 -- Em Atividade
                    OR
                    nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                    OR
                      -- situacao atual Gozando Ferias OU
                      -- situacao anterior Gozando Ferias E
                      -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                    ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                      OR
                     (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                      and
                      nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                     '/' || trim(to_char(p_num_ano, '0000')) ||
                                                     ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                     >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                     )
                    )
                   )
             order by a.cod_func;


      -- REMUNERACAO LOJAS
      cursor c_indic_rem_loja is
         select t.cod_tipo_rem_var
               ,t.descr_tipo_rem_var
               ,g.cod_grp_indic
               ,g.descr_grp_indic
               ,i.cod_indic
               ,i.descr_indic
           from srv_tipo_rem_var        t
               ,srv_grupo_indicador     g
               ,srv_indicador           i
          where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
            and t.descr_tipo_rem_var  = 'REMUNERACAO_LOJA'
            and g.cod_grp_indic       = i.cod_grp_indic
            and i.cod_grp_indic       NOT IN (4,5,9) -- SAX e Seguro SAX
            and (i.cod_indic_sis       is null or i.cod_indic = 28)
            and (i.descr_indic        = p_descr_indic or p_descr_indic is null)
            and i.flg_indic_ativ      = 'S'
       order by g.cod_grp_indic
               ,i.cod_indic;


      -- AGRUPAMENTOS LIDERANCA (PSF E VENDAS)
      cursor c_indic_sistemico (p_cod_indic_sistemico varchar2) is
         select t.cod_tipo_rem_var
               ,t.descr_tipo_rem_var
               ,g.cod_grp_indic
               ,g.descr_grp_indic
               ,i.cod_indic
               ,i.descr_indic
           from srv_tipo_rem_var        t
               ,srv_grupo_indicador     g
               ,srv_indicador           i
          where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
            and t.descr_tipo_rem_var  = 'REMUNERACAO_LOJA'
            and g.cod_grp_indic       = i.cod_grp_indic
            and i.cod_indic_sis       = p_cod_indic_sistemico
            and i.flg_indic_ativ      = 'S'
       order by g.cod_grp_indic
               ,i.cod_indic;


         -- LIDER REGIONAL / NACIONAL
         -- realizado e meta de todas as filiais do Lider Regional / Nacional pelo indicador
         -- usado para indicador VENDAS, VM e PSF
         cursor c_lid_reg_nac (p_descr_indic        varchar2
                              ,p_descr_grp_rem_var  varchar2) is
            select distinct a.cod_func                 cod_func
                  ,b.cod_emp                           cod_emp
                  ,b.cod_fil                           cod_fil
                  ,b.cod_cargo                         cod_cargo
                  ,e.cod_grp_rem_var                   cod_grp_rem_var
                  ,sum(f.num_meta)                     num_meta
                  ,sum(f.num_realz)                    num_realz
                  ,sum(f.qtd_realz)                    qtd_realz
              from srv_func_base_rem_var               a
                  ,srv_funcionario                     b
                  ,srv_cargo                           c
                  ,srv_grupo_cargo                     d
                  ,srv_grupo_rem_variavel              e
                  ,srv_realizado_filial                f
                  ,srv_indicador                       i
             where a.cod_func                        = b.cod_func
               and b.cod_cargo                       = c.cod_cargo
               and c.cod_cargo                       = d.cod_cargo
               and d.cod_grp_rem_var                 = e.cod_grp_rem_var
               and a.cod_emp                         = f.cod_emp
               and a.cod_fil                         = f.cod_fil
               and a.num_ano                         = f.num_ano
               and a.num_mes                         = f.num_mes
               and f.cod_indic                       = i.cod_indic
               and i.descr_indic                     = p_descr_indic
               and e.descr_grp_rem_var               = p_descr_grp_rem_var
               and a.num_ano                         = p_num_ano
               and a.num_mes                         = p_num_mes
               and (nvl(c.flg_agrupa_fil_lider, 'N') = 'S')
               -- funcionario esteve empregado pelo menos 1 dia no mes
               and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                          '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                          ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
               and (b.dt_demissao                    is null
                    OR
                    b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                 '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                 ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                   )
               -- situacao do funcionario
               and (b.cod_sit_rh                     = 1 -- Em Atividade
                    OR
                    nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                    OR
                      -- situacao atual Gozando Ferias OU
                      -- situacao anterior Gozando Ferias E
                      -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                    ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                      OR
                     (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                      and
                      nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                     '/' || trim(to_char(p_num_ano, '0000')) ||
                                                     ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                     >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                     )
                    )
                   )
          group by a.cod_func
                  ,b.cod_emp
                  ,b.cod_fil
                  ,b.cod_cargo
                  ,e.cod_grp_rem_var
          order by a.cod_func;



      -- var controle
      v_var_sql                        varchar2(4000);

      -- variaveis
      v_cod_grp_rem_var               srv_grupo_rem_variavel.cod_grp_rem_var%type;

      v_vlr_premio_fil_calc           srv_realizado_filial.vlr_premio_fil_calc%type;
      v_meta                          srv_realizado_filial.num_meta%type;
      v_cod_un_meta                   srv_realizado_filial.cod_un_meta%type;
      v_num_realz_fil                 srv_realizado_filial.num_realz%type;
      v_cod_un_realz                  srv_realizado_filial.cod_un_realz%type;
      v_num_realz                     srv_realizado_filial.num_realz%type;
      v_qtd_realz                     srv_realizado_filial.qtd_realz%type;
      v_num_realz_x_meta              srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta           srv_realizado_filial.cod_un_realz_x_meta%type;
      v_num_realz_x_meta_limitador    srv_realizado_filial.num_realz_x_meta%type;
      v_vlr_premio_fil                srv_meta_filial.vlr_premio_fil%type;


      v_cod_pond                      srv_ponderacao.cod_pond%type;
      v_num_peso                      srv_ponderacao.num_peso%type;
      v_cod_un_peso                   srv_ponderacao.cod_un_peso%type;
      v_vlr_premio                    srv_ponderacao.vlr_premio%type;

      v_pct_calc_rateio               srv_realizado_func_indicador.pct_calc_rateio%type;
      v_vlr_premio_func_calc          srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_num_realz_pond                srv_realizado_func_indicador.num_realz_pond%type;
      v_num_realz_func                srv_realizado_func_indicador.num_realz%type;
      v_num_realz_func_desc           srv_realizado_func_indicador.vlr_premio_func_calc%type;

      v_cod_func                      srv_funcionario.cod_func%type;
      v_cod_cargo_func                srv_funcionario.cod_cargo%type;
      v_cpf_func                      srv_funcionario.num_cpf_func%type;

      v_cod_escala                    srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx             srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                  srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx               srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                   srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                 srv_escala_faixa.num_limite_fx%type;

      v_nm_tab_realz_fu               varchar2(30);
      v_nm_tab_realz_fi               varchar2(30);

      v_cod_grp_indic                 srv_grupo_indicador.cod_grp_indic%type;

      -- agrupamentos
      v_vr_soma_num_realz_pond_psf    srv_realizado_func_indicador.num_realz_pond%type;
      v_vr_soma_num_realz_pond_v_p    srv_realizado_func_indicador.num_realz_pond%type;
      vlr_soma_premio_v_p             srv_realizado_func_indicador.vlr_premio%type;
      vlr_soma_premio_func_calc_v_p   srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_qtde_fil_pond                 number(11);

      -- var log
      v_cod_emp                        srv_filial.cod_emp%type;
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_cod_cargo                      srv_cargo.cod_cargo%type;

      -- records
      rec_srv_realizado_func_indic     srv_realizado_func_indicador%rowtype;

      -- cursores
      cur_realz                        pkg_srv_calc_rem_var.typ_cursor;

      -- exception
      e_erro_cria_tab                  exception;

      --
      v_num_realz_pond_geral  number(10,4);
      v_vlr_premio_calc       number(10,4);
      v_num_peso_psf          number(10,4);


   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;

      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      --Operacional
      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      Begin
        for r_fil in c_fil (p_cod_emp
                           ,p_cod_fil) loop

           v_cod_fil          := r_fil.cod_fil;

           -----------------------------------------------------------------------
           -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
           -----------------------------------------------------------------------
           for r_indic_rem_loja in c_indic_rem_loja loop

              v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
              v_cod_indic        := r_indic_rem_loja.cod_indic;

              --------------------------------------------------------
              -- SE INDICADOR VENDAS
              --------------------------------------------------------
              if r_indic_rem_loja.descr_indic = 'VENDAS' then

                -- seleciona vlr premio calculado da filial
                begin
                  select a.vlr_premio_fil_calc
                        ,a.num_meta
                        ,a.cod_un_meta
                        ,a.num_realz
                        ,a.cod_un_realz
                        ,a.qtd_realz
                        ,a.num_realz_x_meta
                        ,a.cod_un_realz_x_meta
                        ,c.vlr_premio_fil
                    into v_vlr_premio_fil_calc
                        ,v_meta
                        ,v_cod_un_meta
                        ,v_num_realz_fil
                        ,v_cod_un_realz
                        ,v_qtd_realz
                        ,v_num_realz_x_meta
                        ,v_cod_un_realz_x_meta
                        ,v_vlr_premio_fil
                    from srv_realizado_filial a
                        ,srv_indicador        b
                        ,srv_meta_filial      c
                   where a.cod_indic   = b.cod_indic
                     and a.cod_emp     = r_fil.cod_emp
                     and a.cod_fil     = r_fil.cod_fil
                     and b.descr_indic = 'VENDAS'
                     and a.num_ano     = p_num_ano
                     and a.num_mes     = p_num_mes
                     and a.cod_emp     = c.cod_emp
                     and a.cod_fil     = c.cod_fil
                     and a.cod_indic   = c.cod_indic
                     and a.num_ano     = c.num_ano
                     and a.num_mes     = c.num_mes;
               exception
                  when others then
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;
               end;

               -- selecionar a ponderacao para o grupo rem var e para o indicador
               p_cod_erro   := null;
               p_descr_erro := null;

               --CARGOS OPERACIONAIS - VENDAS
               begin
                 select a.cod_grp_rem_var
                   into v_cod_grp_rem_var
                   from srv_grupo_rem_variavel a
                  where a.descr_grp_rem_var = 'OPERACIONAL_LOJA';
               exception
                 when others then
                 v_cod_grp_rem_var := 5;
               end;

               prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                   ,p_cod_grp_indic     => null
                                   ,p_cod_cargo         => null
                                   ,p_cod_grp_rem_var   => v_cod_grp_rem_var
                                   ,p_cod_pond          => v_cod_pond
                                   ,p_num_peso          => v_num_peso
                                   ,p_cod_un_peso       => v_cod_un_peso
                                   ,p_vlr_premio        => v_vlr_premio
                                   ,p_cod_erro          => p_cod_erro
                                   ,p_descr_erro        => p_descr_erro
                                   );

               if p_cod_erro is not null then
                 v_num_peso   := 0;
                 v_vlr_premio := 0;
               end if;

               p_cod_erro         := null;
               p_descr_erro       := null;

               --
               prc_calc_escala_fx (null               --p_cod_indic
                                  ,null               --p_cod_grp_indic
                                  ,v_cod_grp_rem_var  --p_cod_grp_rem_var
                                  ,v_num_realz_x_meta --p_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );

               if p_cod_erro is not null then
                  v_num_realz_fx := 0;
               end if;

               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100 then

                  v_num_realz_fx := v_num_realz_x_meta;

               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  v_num_realz_fx := v_num_limite_fx;
               end if;

               -- calcula valor unitario para multiplicar pela qtde
               v_vlr_premio_func_calc := (v_vlr_premio * v_num_realz_fx)/100;

               begin
                 -- cursor funcionarios base rem var
                 for r_func_base_rem_var in c_func_base_rem_var (p_cur_cod_emp          => r_fil.cod_emp
                                                                ,p_cur_cod_fil          => r_fil.cod_fil
                                                                ,p_cod_grp_rem_var      => v_cod_grp_rem_var) loop


                    v_cod_func                                           := r_func_base_rem_var.cod_func;
                    rec_srv_realizado_func_indic.cod_func                := r_func_base_rem_var.cod_func;
                    rec_srv_realizado_func_indic.cod_cargo               := r_func_base_rem_var.cod_cargo;
                    rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                    rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                    rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                    rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                    rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                    rec_srv_realizado_func_indic.cod_escala              := null;--v_cod_escala;
                    rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                    rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                    rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                    rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                    rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                    rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                    rec_srv_realizado_func_indic.num_realz_pond          := null;
                    rec_srv_realizado_func_indic.cod_un_realz_pond       := null;

                    rec_srv_realizado_func_indic.num_meta                := v_meta;
                    rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                    rec_srv_realizado_func_indic.num_realz               := v_num_realz_fil;
                    rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                    rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                    rec_srv_realizado_func_indic.cod_un_realz_x_meta     := 2; -- unidade PERCENTUAL
                    rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;

                    rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                    rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                    rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                    rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                    rec_srv_realizado_func_indic.seg_fil                 := null;

                    -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                    prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                   ,p_cod_erro                  => p_cod_erro
                                                   ,p_descr_erro                => p_descr_erro
                                                    );

                 end loop;

                 commit;

               exception
                 when others then
                 null;
               end;

              --------------------------------------------------------
              -- SE INDICADORES DO GRUPO PSF_PROD_SERV_FINANCEIROS
              --------------------------------------------------------
              elsif r_indic_rem_loja.descr_grp_indic = 'PSF_PROD_SERV_FINANCEIROS' then

                 -- seleciona realz X meta e vlr premio calculado da filial
                 begin
                    select a.vlr_premio_fil_calc
                          ,a.num_meta
                          ,a.cod_un_meta
                          ,a.num_realz
                          ,a.cod_un_realz
                          ,a.qtd_realz
                          ,a.num_realz_x_meta
                          ,a.cod_un_realz_x_meta
                      into v_vlr_premio_fil_calc
                          ,v_meta
                          ,v_cod_un_meta
                          ,v_num_realz_fil
                          ,v_cod_un_realz
                          ,v_qtd_realz
                          ,v_num_realz_x_meta
                          ,v_cod_un_realz_x_meta
                      from srv_realizado_filial a
                          ,srv_indicador        b
                     where a.cod_indic   = b.cod_indic
                       and a.cod_emp     = r_fil.cod_emp
                       and a.cod_fil     = r_fil.cod_fil
                       and b.descr_indic = r_indic_rem_loja.descr_indic
                       and a.num_ano     = p_num_ano
                       and a.num_mes     = p_num_mes;
                 exception
                    when no_data_found then
                       v_vlr_premio_fil_calc := 0;
                       v_meta                := 0;
                       v_cod_un_meta         := null;
                       v_num_realz_fil       := 0;
                       v_cod_un_realz        := null;
                       v_qtd_realz           := 0;
                       v_num_realz_x_meta    := 0;
                       v_cod_un_realz_x_meta := null;

                    when others then
                       v_vlr_premio_fil_calc := 0;
                       v_meta                := 0;
                       v_cod_un_meta         := null;
                       v_num_realz_fil       := 0;
                       v_cod_un_realz        := null;
                       v_qtd_realz           := 0;
                       v_num_realz_x_meta    := 0;
                       v_cod_un_realz_x_meta := null;

                       --
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro ao selecionar a tabela srv_realizado_filial ' ||
                                         ' cod_fil -  '                                       || r_fil.cod_fil ||
                                         ' cod_indic -  '                                     || r_indic_rem_loja.descr_indic ||
                                         ' erro - '                                           || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;
               end;

               if r_indic_rem_loja.descr_indic in( 'CARTAO MARISA ATIVADO PL E ITAU'
                                                  ,'CARTAO MARISA TOMBAMENTO ITAUCARD'
                                                  ,'PARTICIPACAO DO CARTAO %'
                                                  ,'PROTECAO CELULAR MARISA'
                                                  ,'COMPRA TRANQUILA PL E ITAU'
                                                  ,'CARTAO ADICIONAL PL E ITAU'
                                                  ,'VENDA COM JUROS PL E ITAU'
                                                  ,'BOLSA PROTEGIDA PL E ITAU'
                                                  ,'MARISA MULHER/AUTO PROTECAO/CASA PROTEGIDA'
                                                  ,'ASSISTENCIA ODONTOLOGICA LOJA') then

                 --------------------------------------------------------------------------
                 -- CARGOS OPERACIONAIS - GRUPO DE INDICADORES PSF_PROD_SERV_FINANCEIROS
                 --------------------------------------------------------------------------
                 begin

                    -- seleciona o cod grupo rem var para OPERACIONAL_LOJA
                    select a.cod_grp_rem_var
                      into v_cod_grp_rem_var
                      from srv_grupo_rem_variavel a
                     where a.descr_grp_rem_var = 'OPERACIONAL_LOJA';

                    -- selecionar a ponderacao para o grupo rem var e para o indicador
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --
                    prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                        ,p_cod_grp_indic     => null
                                        ,p_cod_cargo         => null
                                        ,p_cod_grp_rem_var   => v_cod_grp_rem_var
                                        ,p_cod_pond          => v_cod_pond
                                        ,p_num_peso          => v_num_peso
                                        ,p_cod_un_peso       => v_cod_un_peso
                                        ,p_vlr_premio        => v_vlr_premio
                                        ,p_cod_erro          => p_cod_erro
                                        ,p_descr_erro        => p_descr_erro
                                        );
                    --
                    if  p_cod_erro is not null then

                       --
                       v_num_peso   := 0;
                       v_vlr_premio := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                      raise e_erro;

                    -- erro ao calcular ponderacao
                    end if;

                    --
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --
                    prc_calc_escala_fx (null                           --p_cod_indic
                                       ,r_indic_rem_loja.cod_grp_indic --p_cod_grp_indic
                                       ,null                           --p_cod_grp_rem_var
                                       ,v_num_realz_x_meta             --p_num_realz_x_meta
                                       ,v_cod_escala
                                       ,v_num_seq_escala_fx
                                       ,v_num_realz_fx
                                       ,v_cod_un_realz_fx
                                       ,v_flg_pct_100
                                       ,v_num_limite_fx
                                       ,p_cod_erro
                                       ,p_descr_erro
                                       );
                    if p_cod_erro is not null then

                       --
                       v_num_realz_fx := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;

                    -- erro ao calcular escala
                    end if;

                    -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                    -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                    if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                       --
                       v_num_realz_fx := v_num_realz_x_meta;
                    end if;

                    -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                    -- entao assumir o valor limite
                    if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                       --
                       v_num_realz_fx := v_num_limite_fx;
                    end if;

                    begin
                       -- calcula valor unitario para multiplicar pela qtde
                       v_num_realz_pond  := (v_vlr_premio * v_num_realz_fx)/100;
                    exception
                       when others then
                          p_cod_erro     := 1;
                          p_descr_erro   := 'Erro ao calcular num realz pond para indicadores PSF Cargos Operacionais' ||
                                            ' cod_fil:  '    || v_cod_fil ||
                                            ' cod_indic:  '  || v_cod_indic ||
                                              ' erro: '        || sqlerrm;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                    -- erro ao calcular vr unitario
                    end;

                    -- tabela gerada de apuracao realizado para o indicador
                    select a.nm_tab_realz_fil  ||'_'|| trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                          ,a.nm_tab_realz_func ||'_'|| trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                      into v_nm_tab_realz_fi
                          ,v_nm_tab_realz_fu
                      from srv_realizado_tab_tmp a
                     where a.cod_indic         = r_indic_rem_loja.cod_indic;

                    begin

                       -- selecionar todos os funcionarios desse cargo para essa filial e
                       v_var_sql :=              '   select b.cod_func '                      || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '         ,b.cod_cargo '                     || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '         ,a.cpf_vendedor '                  || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '         ,count(1) qtde '                   || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '     from SRV.' || v_nm_tab_realz_fu   || ' a ' || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '         ,srv_funcionario               b ' || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '    where a.cpf_vendedor = b.num_cpf_func ' || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '      and a.fil_cod = '    || r_fil.cod_fil || chr(13) || chr(10);

                       v_var_sql := v_var_sql || '
               -- funcionario esteve empregado pelo menos 1 dia no mes
              and b.dt_admissao                    <= last_day(to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'23:59:59'',''dd/mm/yyyy hh24:mi:ss''))
              and (b.dt_demissao                    is null
                   OR
                   b.dt_demissao                    > to_date(''01/'||trim(to_char(p_num_mes, '00'))||'/'||trim(to_char(p_num_ano, '0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                  )
              -- situacao do funcionario
              and (b.cod_sit_rh                     = 1 -- Em Atividade
                   OR
                   nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                   OR
                     -- situacao atual Gozando Ferias OU
                     -- situacao anterior Gozando Ferias E
                     -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                   ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                    OR
                    (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                     and
                     nvl(b.dt_ini_sit_rh, to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss''))
                                                    >= to_date(''02/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                    )
                   )
                  )' || chr(13) || chr(10);

                       v_var_sql := v_var_sql || 'group by b.cod_func '                       || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '        ,b.cod_cargo '                      || chr(13) || chr(10);
                       v_var_sql := v_var_sql || '        ,a.cpf_vendedor '                   || chr(13) || chr(10);

                       open cur_realz for v_var_sql;
                       loop
                          fetch cur_realz
                           into  v_cod_func
                                ,v_cod_cargo_func
                                ,v_cpf_func
                                ,v_num_realz_func;
                          --
                          exit when cur_realz%notfound;

                          --
                          v_cod_un_realz := 3; --unidade UNIDADE
                          --
                          v_vlr_premio_func_calc := (v_num_realz_func - nvl(v_num_realz_func_desc,0)) * v_num_realz_pond;

                          -- gravar na srv_realizado_func_indicador
                          rec_srv_realizado_func_indic.cod_func                := v_cod_func;
                          rec_srv_realizado_func_indic.cod_cargo               := v_cod_cargo_func;
                          rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                          rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                          rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                          rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                          rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                          rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                          rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                          rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                          rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                          rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                          rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                          rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                          rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                          rec_srv_realizado_func_indic.cod_un_realz_pond       := 1; -- unidade VALOR

                          rec_srv_realizado_func_indic.num_meta                := v_meta;
                          rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                          rec_srv_realizado_func_indic.num_realz               := v_num_realz_func - nvl(v_num_realz_func_desc,0);
                          rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                          rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                          rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                          rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                          rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                          rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                          rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                          rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                          rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;


                          -- inserir o realizado do funcionario pelo indicador
                          prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                      ,p_cod_erro                  => p_cod_erro
                                                      ,p_descr_erro                => p_descr_erro
                                                       );
                          --
                          if p_cod_erro is not null then

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;

                          -- erro ao inserir realizado func indicador
                          end if;


                       -- cur_venda
                       end loop;
                       --
                       close cur_realz;

                       --
                       commit;
                    --
                    exception
                       /*when e_erro then
                          raise e_erro;*/
                       when others then
                          p_cod_erro     := 1;
                          p_descr_erro   := 'Erro ao inserir indicadores PSF Cargos Operacionais' ||
                                            ' num_ano: '     || p_num_ano   ||
                                            ' num_mes: '     || p_num_mes   ||
                                            ' cod_fil:  '    || v_cod_fil   ||
                                            ' cod_indic:  '  || v_cod_indic ||
                                            ' cod_func:  '   || v_cod_func  ||
                                            ' erro: '        || sqlerrm;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                    --
                    end;

                 exception
                   /* when e_erro then
                       raise e_erro;*/
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular indicadores PSF Cargos Operacionais' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

                 --
                 end;

               end if;

              ---------------------------------------------
              -- if p_descr_indic = VENDAS, etc...
              ---------------------------------------------
              end if;

              -- commit por indicador
              commit;

           ---------------------------------------------
           -- c_indic_rem_loja
           ---------------------------------------------
           end loop;

           ---------------------------------------------
           -- commit por filial
           ---------------------------------------------
           commit;

        ---------------------------------------------
        -- c_fil
        ---------------------------------------------
        end loop;

        commit;

      Exception
        When others then
          null;

      end;

      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      -- Lider 1
      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      Begin
        for r_fil in c_fil (p_cod_emp
                           ,p_cod_fil) loop

           v_cod_fil          := r_fil.cod_fil;

           -----------------------------------------------------------------------
           -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
           -----------------------------------------------------------------------
           for r_indic_rem_loja in c_indic_rem_loja loop

              v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
              v_cod_indic        := r_indic_rem_loja.cod_indic;

              --------------------------------------------------------
              -- SE INDICADOR VENDAS
              --------------------------------------------------------
              if r_indic_rem_loja.descr_indic = 'VENDAS' then

                -- seleciona vlr premio calculado da filial
                begin
                  select a.vlr_premio_fil_calc
                        ,a.num_meta
                        ,a.cod_un_meta
                        ,a.num_realz
                        ,a.cod_un_realz
                        ,a.qtd_realz
                        ,a.num_realz_x_meta
                        ,a.cod_un_realz_x_meta
                        ,c.vlr_premio_fil
                    into v_vlr_premio_fil_calc
                        ,v_meta
                        ,v_cod_un_meta
                        ,v_num_realz_fil
                        ,v_cod_un_realz
                        ,v_qtd_realz
                        ,v_num_realz_x_meta
                        ,v_cod_un_realz_x_meta
                        ,v_vlr_premio_fil
                    from srv_realizado_filial a
                        ,srv_indicador        b
                        ,srv_meta_filial      c
                   where a.cod_indic   = b.cod_indic
                     and a.cod_emp     = r_fil.cod_emp
                     and a.cod_fil     = r_fil.cod_fil
                     and b.descr_indic = 'VENDAS'
                     and a.num_ano     = p_num_ano
                     and a.num_mes     = p_num_mes
                     and a.cod_emp     = c.cod_emp
                     and a.cod_fil     = c.cod_fil
                     and a.cod_indic   = c.cod_indic
                     and a.num_ano     = c.num_ano
                     and a.num_mes     = c.num_mes;
               exception
                  when others then
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;
               end;

               -- selecionar a ponderacao para o grupo rem var e para o indicador
               p_cod_erro   := null;
               p_descr_erro := null;

               ---------------------------------------------------------------
               -- CARGOS LIDERANCA - VENDAS
               ---------------------------------------------------------------
               begin
                  -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
                  for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                                 ,p_flg_agrupa_fil_lider => 'N') loop

                    v_cod_cargo           := r_cargo_grp_rem_var.cod_cargo;

                  -- selecionar a ponderacao para o cargo e para o indicador VENDAS
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                      ,p_cod_grp_indic     => null
                                      ,p_cod_cargo         => r_cargo_grp_rem_var.cod_cargo
                                      ,p_cod_grp_rem_var   => null
                                      ,p_cod_pond          => v_cod_pond
                                      ,p_num_peso          => v_num_peso
                                      ,p_cod_un_peso       => v_cod_un_peso
                                      ,p_vlr_premio        => v_vlr_premio
                                      ,p_cod_erro          => p_cod_erro
                                      ,p_descr_erro        => p_descr_erro
                                      );
                  --
                  if  p_cod_erro is not null then

                     --
                     v_num_peso   := 0;
                     v_vlr_premio := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

  --                      raise e_erro;

                  -- erro ao calcular ponderacao
                  end if;

                  --
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                     ,null                           --p_cod_grp_indic
                                     ,null                           --p_cod_grp_rem_var
                                     ,v_num_realz_x_meta             --p_num_realz_x_meta
                                     ,v_cod_escala
                                     ,v_num_seq_escala_fx
                                     ,v_num_realz_fx
                                     ,v_cod_un_realz_fx
                                     ,v_flg_pct_100
                                     ,v_num_limite_fx
                                     ,p_cod_erro
                                     ,p_descr_erro
                                     );
                  if p_cod_erro is not null then

                     --
                     v_num_realz_x_meta := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

  --                     raise e_erro;

                  -- erro ao calcular escala
                  end if;

                  -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                  -- entao assumir o valor limite
                  if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_x_meta > v_num_limite_fx then

                     v_num_realz_x_meta := v_num_limite_fx;

                  end if;

                  begin
                    --
                    v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;
                    --
                  exception
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao calcular num realz pond para indicadores PSF Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                            ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;

                  -- erro ao calcular vr unitario
                  end;

                    -- selecionar todos os funcionarios desse cargo para essa filial e
                    begin
                       for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                        ,p_cur_cod_emp          => r_fil.cod_emp
                                                        ,p_cur_cod_fil          => r_fil.cod_fil
                                                        ,p_flg_agrupa_fil_lider => 'N') loop

                           v_cod_func           := r_func_cargo.cod_func;

                           -- gravar na srv_realizado_func_indicador
                           rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                           rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                           rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                           rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                           rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                           rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                           rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                           rec_srv_realizado_func_indic.cod_escala              := null;
                           rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                           rec_srv_realizado_func_indic.num_realz_fx            := null;
                           rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                           rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                           rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                           rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                           rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                           rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                           rec_srv_realizado_func_indic.num_meta                := v_meta;
                           rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                           rec_srv_realizado_func_indic.num_realz               := v_num_realz_fil;
                           rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                           rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                           rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                           rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                           rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                           rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null;
                           rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                           rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                           rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                           rec_srv_realizado_func_indic.seg_fil                 := null;

                           -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                           prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                          ,p_cod_erro                  => p_cod_erro
                                                          ,p_descr_erro                => p_descr_erro
                                                           );

                           --
                           if p_cod_erro is not null then

                              -- enviar email
                              v_body       := p_cod_erro || ' - ' || p_descr_erro;

                              v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                      ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                      ,p_body    => v_body
                                                                                      );

                              -- logar tabela
                              v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                        ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                        ,p_num_ano     => p_num_ano
                                                                        ,p_num_mes     => p_num_mes
                                                                        ,p_cod_fil     => v_cod_fil
                                                                        ,p_cod_func    => v_cod_func
                                                                        ,p_cod_indic   => v_cod_indic
                                                                        ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                        );

                              if v_ins_log_erro is not null then
                                 -- enviar email
                                 v_body       := v_ins_log_erro;
                                 --
                                 v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                         ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                         ,p_body    => v_body
                                                                                         );
                              --v_ins_log_erro is not null
                              end if;

  --                              raise e_erro;

                           -- erro ao inserir realizado func indicador
                           end if;


                       -- c_func_cargo
                       end loop;

                    exception
                       /*when e_erro then
                          raise e_erro;*/
                       when others then
                          p_cod_erro     := 1;
                          p_descr_erro   := 'Erro ao inserir realizado funcionario Vendas Cargos Lideranca' ||
                                            ' cod_fil:  '    || v_cod_fil ||
                                            ' cod_indic:  '  || v_cod_indic ||
                                            ' cod_cargo:  '  || v_cod_cargo ||
                                            ' cod_func:  '   || v_cod_func ||
                                            ' erro: '        || sqlerrm;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                          raise e_erro;
                    end;

                  -- c_cargo_grp_rem_var
                  end loop;

                  --
                  commit;

               exception
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro Geral ao calcular indicador Vendas para Cargos Lideranca ' ||
                                       ' cod_fil:  '    || v_cod_fil   ||
                                       ' cod_indic:  '  || v_cod_indic ||
                                       ' cod_cargo:  '  || v_cod_cargo ||
                                       ' cod_func:  '   || v_cod_func  ||
                                       ' erro: '        || sqlerrm;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

               end;

              --------------------------------------------------------
              -- SE INDICADORES DO GRUPO PSF_PROD_SERV_FINANCEIROS
              --------------------------------------------------------
              elsif r_indic_rem_loja.descr_grp_indic = 'PSF_PROD_SERV_FINANCEIROS' then

                 -- seleciona realz X meta e vlr premio calculado da filial
                 begin
                    select a.vlr_premio_fil_calc
                          ,a.num_meta
                          ,a.cod_un_meta
                          ,a.num_realz
                          ,a.cod_un_realz
                          ,a.qtd_realz
                          ,a.num_realz_x_meta
                          ,a.cod_un_realz_x_meta
                      into v_vlr_premio_fil_calc
                          ,v_meta
                          ,v_cod_un_meta
                          ,v_num_realz_fil
                          ,v_cod_un_realz
                          ,v_qtd_realz
                          ,v_num_realz_x_meta
                          ,v_cod_un_realz_x_meta
                      from srv_realizado_filial a
                          ,srv_indicador        b
                     where a.cod_indic   = b.cod_indic
                       and a.cod_emp     = r_fil.cod_emp
                       and a.cod_fil     = r_fil.cod_fil
                       and b.descr_indic = r_indic_rem_loja.descr_indic
                       and a.num_ano     = p_num_ano
                       and a.num_mes     = p_num_mes;
                 exception
                    when no_data_found then
                       v_vlr_premio_fil_calc := 0;
                       v_meta                := 0;
                       v_cod_un_meta         := null;
                       v_num_realz_fil       := 0;
                       v_cod_un_realz        := null;
                       v_qtd_realz           := 0;
                       v_num_realz_x_meta    := 0;
                       v_cod_un_realz_x_meta := null;

                    when others then
                       v_vlr_premio_fil_calc := 0;
                       v_meta                := 0;
                       v_cod_un_meta         := null;
                       v_num_realz_fil       := 0;
                       v_cod_un_realz        := null;
                       v_qtd_realz           := 0;
                       v_num_realz_x_meta    := 0;
                       v_cod_un_realz_x_meta := null;

                       --
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro ao selecionar a tabela srv_realizado_filial ' ||
                                         ' cod_fil -  '                                       || r_fil.cod_fil ||
                                         ' cod_indic -  '                                     || r_indic_rem_loja.descr_indic ||
                                         ' erro - '                                           || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;
                 end;

                 -----------------------------------------------------------------------
                 -- CARGOS LIDERANCA - GRUPO DE INDICADORES PSF_PROD_SERV_FINANCEIROS
                 -----------------------------------------------------------------------
                 begin
                    -- Limitador de Atingimento da Meta para Cargos Lideranca por indicador
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --
                    prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                       ,null                           --p_cod_grp_indic
                                       ,null                           --p_cod_grp_rem_var
                                       ,v_num_realz_x_meta             --p_num_realz_x_meta
                                       ,v_cod_escala
                                       ,v_num_seq_escala_fx
                                       ,v_num_realz_fx
                                       ,v_cod_un_realz_fx
                                       ,v_flg_pct_100
                                       ,v_num_limite_fx
                                       ,p_cod_erro
                                       ,p_descr_erro
                                       );

                    -- armazena vr original de atingimento
                    v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                    -- se nao houver escala de limitador cadastrada ou
                    -- se der erro manter o valor do atingimento original (sem limitador)
                    if p_cod_erro is not null then

                       --
                       v_num_realz_fx := v_num_realz_x_meta;

                       -- zera var de escala
                       v_cod_escala         := null;
                       v_num_seq_escala_fx  := null;
                       v_num_realz_fx       := null;
                       v_cod_un_realz_fx    := null;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;

                    -- se nao houve erro ao buscar escala
                    else
                       -- se o atingimento passou o valor do limitador, entao pegar o valor
                       -- do limitador como atingimento
                       if v_num_realz_x_meta > v_num_realz_fx then
                          --
                          v_num_realz_x_meta_limitador := v_num_realz_fx;

                       -- se o atingimento nao passou a fx limitador
                       else
                          v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                          -- zera var de escala
                          v_cod_escala         := null;
                          v_num_seq_escala_fx  := null;
                          v_num_realz_fx       := null;
                          v_cod_un_realz_fx    := null;

                       end if;

                    -- erro ao calcular escala
                    end if;


                    begin
                       -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
                       for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                                      ,p_flg_agrupa_fil_lider => 'N') loop

                          -- selecionar a ponderacao para o grupo rem var ou cargo,
                          -- indicador e tipo filial e filial
                          p_cod_erro         := null;
                          p_descr_erro       := null;
                          --


                          prc_calc_ponderacao_tp_fil2(p_cod_indic         => r_indic_rem_loja.cod_indic
                                                     ,p_cod_grp_indic     => null
                                                     ,p_cod_cargo         => r_cargo_grp_rem_var.cod_cargo
                                                     ,p_cod_grp_rem_var   => null
                                                     ,p_cod_tipo_fil      => r_fil.cod_tipo_fil
                                                     ,p_cod_emp           => r_fil.cod_emp
                                                     ,p_cod_fil           => r_fil.cod_fil
                                                     ,p_cod_pond          => v_cod_pond
                                                     ,p_num_peso          => v_num_peso
                                                     ,p_cod_un_peso       => v_cod_un_peso
                                                     ,p_vlr_premio        => v_vlr_premio
                                                     ,p_cod_erro          => p_cod_erro
                                                     ,p_descr_erro        => p_descr_erro
                                                     );
                          --
                          if  p_cod_erro is not null then
                             --
                             v_num_peso   := 0;
                             v_vlr_premio := 0;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

        --                      raise e_erro;
                          -- erro ao calcular ponderacao
                          end if;


                          begin
                             -- realz X meta da filial (COM LIMITADOR SE HOUVER) multiplicar pelo peso

                             --v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;
                             v_num_realz_pond := (v_num_realz_x_meta_limitador * v_num_peso)/100;

                          exception
                             when others then
                                --
                                v_num_realz_pond := 0;

                                --
                                p_cod_erro     := 1;
                                p_descr_erro   := 'Erro ao calcular realz pond dos indicadores PSF Cargos Lideranca Loja' ||
                                                  ' cod_fil:  '    || v_cod_fil   ||
                                                  ' cod_indic:  '  || v_cod_indic ||
                                                  ' erro: '        || sqlerrm;

                                -- enviar email
                                v_body       := p_cod_erro || ' - ' || p_descr_erro;

                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                        ,p_body    => v_body
                                                                                        );

                                -- logar tabela
                                v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                          ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                          ,p_num_ano     => p_num_ano
                                                                          ,p_num_mes     => p_num_mes
                                                                          ,p_cod_fil     => v_cod_fil
                                                                          ,p_cod_func    => v_cod_func
                                                                          ,p_cod_indic   => v_cod_indic
                                                                          ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                          );

                                if v_ins_log_erro is not null then
                                   -- enviar email
                                   v_body       := v_ins_log_erro;
                                   --
                                   v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                           ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                           ,p_body    => v_body
                                                                                           );
                                --v_ins_log_erro is not null
                                end if;

        --                        raise e_erro;
                          -- erro ao calcular realz pond
                          end;


                        -- selecionar todos os funcionarios desse cargo para essa filial e cargo
                        for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                         ,p_cur_cod_emp          => r_fil.cod_emp
                                                         ,p_cur_cod_fil          => r_fil.cod_fil
                                                         ,p_flg_agrupa_fil_lider => 'N') loop

                             -- gravar na srv_realizado_func_indicador
                             rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                             rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                             rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                             rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                             rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                             rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                             rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                             rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                             rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                             rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                             rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                             rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                             rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                             rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                             rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                             rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                             rec_srv_realizado_func_indic.num_meta                := v_meta;
                             rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                             --
                             --ALTERADO ALEXANDRE BEZERRA
                             if r_indic_rem_loja.descr_indic in ('VENDA COM JUROS PL', 'VENDA COM JUROS ITAU') then
                                rec_srv_realizado_func_indic.num_realz            := v_qtd_realz;
                                rec_srv_realizado_func_indic.cod_un_realz         := 3;  --unidade UNIDADE v_cod_un_realz;
                             else
                                rec_srv_realizado_func_indic.num_realz            := v_num_realz_fil;
                                rec_srv_realizado_func_indic.cod_un_realz         := v_cod_un_realz;
                             end if;
                             --
                             rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                             rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta_limitador; --v_num_realz_x_meta;
                             rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                             rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                             rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                             rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                             rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                             rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                             rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                             rec_srv_realizado_func_indic.seg_fil                 := null;

                             -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                             prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                            ,p_cod_erro                  => p_cod_erro
                                                            ,p_descr_erro                => p_descr_erro
                                                             );

                             --
                             if p_cod_erro is not null then

                                -- enviar email
                                v_body       := p_cod_erro || ' - ' || p_descr_erro;

                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                        ,p_body    => v_body
                                                                                        );

                                -- logar tabela
                                v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                          ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                          ,p_num_ano     => p_num_ano
                                                                          ,p_num_mes     => p_num_mes
                                                                          ,p_cod_fil     => v_cod_fil
                                                                          ,p_cod_func    => v_cod_func
                                                                          ,p_cod_indic   => v_cod_indic
                                                                          ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                          );

                                if v_ins_log_erro is not null then
                                   -- enviar email
                                   v_body       := v_ins_log_erro;
                                   --
                                   v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                           ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                           ,p_body    => v_body
                                                                                           );
                                --v_ins_log_erro is not null
                                end if;

  --                              raise e_erro;
                             -- erro ao inserir realizado func indicador
                             end if;


                         -- c_func_cargo
                         end loop;

                       -- c_cargo_grp_rem_var
                       end loop;

                       --
                       commit;
                   --
                   exception
                       /*when e_erro then
                          raise e_erro;*/
                      when others then
                         p_cod_erro     := 1;
                         p_descr_erro   := 'Erro Geral ao inserir indicadores PSF Cargos Lideranca Loja' ||
                                           ' cod_fil:  '    || v_cod_fil   ||
                                           ' cod_indic:  '  || v_cod_indic ||
                                           ' cod_cargo:  '  || v_cod_cargo ||
                                           ' cod_func:  '   || v_cod_func  ||
                                           ' erro: '        || sqlerrm;

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                   --
                   end;
                 --
                 exception
                    /*when e_erro then
                       raise e_erro;*/
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular indicadores PSF Cargos Lideranca' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

                 end;
              ---------------------------------------------------------
              -- if p_descr_indic = VENDAS, etc...
              ---------------------------------------------------------
              end if;

              -- commit por indicador
              commit;

           ------------------------------------------------------------
           -- c_indic_rem_loja
           ------------------------------------------------------------
           end loop;

           --
           commit;

           -----------------------------------------------------------------------
           -- CALCULAR O AGRUPAMENTO PSF
           -----------------------------------------------------------------------
           begin
              for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_PSF_LOJA_LID') loop

                 v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
                 v_cod_indic        := r_indic_sistemico.cod_indic;

                 -----------------------------------------------------------------------------------
                 -- somar todos os pesos dos resultados dos PSF
                 -----------------------------------------------------------------------------------
                 -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
                 for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                                ,p_flg_agrupa_fil_lider => 'N') loop

                   -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                   for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                    ,p_cur_cod_emp          => r_fil.cod_emp
                                                    ,p_cur_cod_fil          => r_fil.cod_fil
                                                    ,p_flg_agrupa_fil_lider => 'N') loop

                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;

                      -- somar os resultados dos pesos das ponderacoes para todos os indicadores PSF
                      begin
                         select c.cod_grp_indic
                               ,sum(a.num_realz_pond)
                           into v_cod_grp_indic
                               ,v_vr_soma_num_realz_pond_psf
                           from srv_realizado_func_indicador a
                               ,srv_indicador                b
                               ,srv_grupo_indicador          c
                          where a.cod_indic                = b.cod_indic
                            and b.cod_grp_indic            = c.cod_grp_indic
                            and a.cod_func                 = r_func_cargo.cod_func
                            and a.cod_emp                  = r_fil.cod_emp
                            and a.cod_fil                  = r_fil.cod_fil
                            and a.num_ano                  = p_num_ano
                            and a.num_mes                  = p_num_mes
                            and c.descr_grp_indic          = 'PSF_PROD_SERV_FINANCEIROS'
                            and (b.cod_indic_sis            is null or cod_indic_sis ='SAX_PSF')
                       group by c.cod_grp_indic;
                      exception
                         when others then
                            v_cod_grp_indic               := 3;
                            v_vr_soma_num_realz_pond_psf  := 0;
                      end;

                      -- selecionar a ponderacao para o cargo e para o grupo indicador
                      prc_calc_ponderacao (p_cod_indic         => null
                                          ,p_cod_grp_indic     => r_indic_sistemico.cod_grp_indic
                                          ,p_cod_cargo         => r_cargo_grp_rem_var.cod_cargo
                                          ,p_cod_grp_rem_var   => null
                                          ,p_cod_pond          => v_cod_pond
                                          ,p_num_peso          => v_num_peso
                                          ,p_cod_un_peso       => v_cod_un_peso
                                          ,p_vlr_premio        => v_vlr_premio
                                          ,p_cod_erro          => p_cod_erro
                                          ,p_descr_erro        => p_descr_erro
                                          );
                      --
                      if p_cod_erro is not null then
                         --
                         v_num_peso   := 0;
                         v_vlr_premio := 0;

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao calcular ponderacao
                      end if;

                      -- aplicar a ponderacao sobre a soma de todas as ponderacoes de todos os indicadores PSF
                      v_num_realz_pond := (v_vr_soma_num_realz_pond_psf * v_num_peso)/100;

                      -- gravar na srv_realizado_func_indicador
                      rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                      rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                      rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                      rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                      rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                      rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                      rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                      rec_srv_realizado_func_indic.cod_escala              := null;
                      rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                      rec_srv_realizado_func_indic.num_realz_fx            := null;
                      rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                      rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                      rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                      rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                      rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                      rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                      rec_srv_realizado_func_indic.num_meta                := null;
                      rec_srv_realizado_func_indic.cod_un_meta             := null;
                      rec_srv_realizado_func_indic.num_realz               := v_vr_soma_num_realz_pond_psf; --null;
                      rec_srv_realizado_func_indic.cod_un_realz            := 2; -- unidade PERCENTUAL --null;
                      rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                      rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                      rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                      rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                      rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                      rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                      rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                      rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                      rec_srv_realizado_func_indic.seg_fil                 := null;

                      -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                      prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                     ,p_cod_erro                  => p_cod_erro
                                                     ,p_descr_erro                => p_descr_erro
                                                      );

                      --
                      if p_cod_erro is not null then

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao inserir realizado func indicador
                      end if;

                    -- c_func_cargo
                   end loop;

                 -- c_cargo_grp_rem_var
                 end loop;

              -- c_indic_sistemico AGRUPAMENTO LIDER PSF
              end loop;

              -- commit por indicador
              commit;

           --
           exception
              /*when e_erro then
                 raise e_erro;*/
              when others then
                 p_cod_erro     := 1;
                 p_descr_erro   := 'Erro Geral ao calcular O AGRUPAMENTO PSF Lideranca Loja' ||
                                   ' cod_fil:  '    || v_cod_fil   ||
                                   ' cod_indic:  '  || v_cod_indic ||
                                   ' cod_func:  '   || v_cod_func ||
                                   ' erro: '        || sqlerrm;

                 -- enviar email
                 v_body       := p_cod_erro || ' - ' || p_descr_erro;

                 v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                         ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                         ,p_body    => v_body
                                                                         );

                 -- logar tabela
                 v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                           ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                           ,p_num_ano     => p_num_ano
                                                           ,p_num_mes     => p_num_mes
                                                           ,p_cod_fil     => v_cod_fil
                                                           ,p_cod_func    => v_cod_func
                                                           ,p_cod_indic   => v_cod_indic
                                                           ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                           );

                 if v_ins_log_erro is not null then
                    -- enviar email
                    v_body       := v_ins_log_erro;
                    --
                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                            ,p_body    => v_body
                                                                            );
                 --v_ins_log_erro is not null
                 end if;
           --
           end;


           -----------------------------------------------------------------------
           -- CALCULAR O AGRUPAMENTO REM LOJA LIDER
           -----------------------------------------------------------------------
           begin

              for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_REM_LOJA_LID') loop

                 v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
                 v_cod_indic        := r_indic_sistemico.cod_indic;

                 -----------------------------------------------------------------------------------
                 -- somar todos os pesos dos resultados dos PSF
                 -----------------------------------------------------------------------------------
                 -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
                 for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                                ,p_flg_agrupa_fil_lider => 'N') loop

                    -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                    for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                     ,p_cur_cod_emp          => r_fil.cod_emp
                                                     ,p_cur_cod_fil          => r_fil.cod_fil
                                                     ,p_flg_agrupa_fil_lider => 'N') loop


                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;

                       -- somar os indicadores VENDAS E AGRUPAMENTO PSF
                       begin
                          select sum(a.num_realz_pond)        vr_soma_num_realz_pond_v_p
                                ,sum(a.vlr_premio)            vlr_soma_premio_v_p
                                ,sum(a.vlr_premio_func_calc)  vlr_soma_premio_func_calc_v_p
                            into v_vr_soma_num_realz_pond_v_p
                                ,vlr_soma_premio_v_p
                                ,vlr_soma_premio_func_calc_v_p
                            from srv_realizado_func_indicador a
                                ,srv_indicador                b
                           where a.cod_indic                = b.cod_indic
                             and a.cod_emp                  = r_fil.cod_emp
                             and a.cod_fil                  = r_fil.cod_fil
                             and a.cod_func                 = r_func_cargo.cod_func
                             and a.num_ano                  = p_num_ano
                             and a.num_mes                  = p_num_mes
                             and b.descr_indic              in ('VENDAS', 'AGRUPAMENTO PSF_LOJA LIDER');
                       --
                       exception
                          when others then
                             --
                             v_vr_soma_num_realz_pond_v_p  := 0;
                             vlr_soma_premio_v_p           := 0;
                             vlr_soma_premio_func_calc_v_p := 0;

                             --
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao selecionar somatoria dos realz pond no agrupameento Rem Loja Lider ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;


                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       end;

                       -- aplicar a escala do indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       p_cod_erro         := null;
                       p_descr_erro       := null;
                       --
                       prc_calc_escala_fx (r_indic_sistemico.cod_indic     -- p_cod_indic
                                          ,null                            -- p_cod_grp_indic
                                          ,null                            -- p_cod_grp_rem_var
                                          ,v_vr_soma_num_realz_pond_v_p
                                          ,v_cod_escala
                                          ,v_num_seq_escala_fx
                                          ,v_num_realz_fx
                                          ,v_cod_un_realz_fx
                                          ,v_flg_pct_100
                                          ,v_num_limite_fx
                                          ,p_cod_erro
                                          ,p_descr_erro
                                          );
                       --
                       if p_cod_erro is not null then
                          --
                          v_num_realz_fx := 0;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                       -- erro ao calcular escala
                       end if;

                       -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                       -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                       if (nvl(v_flg_pct_100, 'N') = 'S' and v_vr_soma_num_realz_pond_v_p > 100) then
                          --
                          v_num_realz_fx := v_vr_soma_num_realz_pond_v_p;
                       end if;

                       -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                       -- entao assumir o valor limite
                       if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                          --
                          v_num_realz_fx := v_num_limite_fx;
                       end if;

                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e indicador VENDAS
                       -- gravar o vlr premio calc na realz func para o indicador VENDAS
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'VENDAS')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc para o indicador VENDAS - Agrupamento Rem Loja Lider' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - VENDAS
                       end;

                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e grupo de indicadores PSF
                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO PSF_LOJA LIDER
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'AGRUPAMENTO PSF_LOJA LIDER')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc npara o indicador AGRUPAMENTO PSF_LOJA LIDER ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - PSF
                       end;

                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       begin
                          vlr_soma_premio_func_calc_v_p := (vlr_soma_premio_v_p * v_num_realz_fx)/100;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao calcular o vlr premio calc para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       end;

                       -- inserir o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       -- gravar na srv_realizado_func_indicador
                       rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                       rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                       rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                       rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                       rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                       rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                       rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                       rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                       rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                       rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                       rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                       rec_srv_realizado_func_indic.cod_pond                := null;
                       rec_srv_realizado_func_indic.num_peso                := null;
                       rec_srv_realizado_func_indic.cod_un_peso             := null;
                       rec_srv_realizado_func_indic.num_realz_pond          := v_vr_soma_num_realz_pond_v_p;
                       rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                       rec_srv_realizado_func_indic.num_meta                := null;
                       rec_srv_realizado_func_indic.cod_un_meta             := null;
                       rec_srv_realizado_func_indic.num_realz               := null;
                       rec_srv_realizado_func_indic.cod_un_realz            := null;
                       rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                       rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                       rec_srv_realizado_func_indic.vlr_premio              := vlr_soma_premio_v_p;
                       rec_srv_realizado_func_indic.vlr_premio_func_calc    := vlr_soma_premio_func_calc_v_p;
                       rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                       rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                       rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                       rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                       rec_srv_realizado_func_indic.seg_fil                 := null;

                       -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                       prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                      ,p_cod_erro                  => p_cod_erro
                                                      ,p_descr_erro                => p_descr_erro
                                                       );

                       --
                       if p_cod_erro is not null then

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

                       --raise e_erro;
                       --erro ao inserir realizado func indicador
                       end if;

                       --################################################
                       --Calcula Valor por Incicador
                       --################################################
                       Begin

                         begin
                           select (num_peso / 100)
                             into v_num_peso_psf
                             from srv_realizado_func_indicador
                            where num_ano   = p_num_ano
                              and num_mes   = p_num_mes
                              and cod_func  = r_func_cargo.cod_func
                              and cod_fil   = r_fil.cod_fil
                              and cod_indic = 39;
                         exception
                           when others then
                             v_num_peso_psf := 0;
                         end;
                         --
                         begin
                           select vlr_premio, num_realz_fx, num_realz_pond
                             into v_vlr_premio, v_num_realz_fx, v_num_realz_pond_geral
                             from srv_realizado_func_indicador
                            where num_ano   = p_num_ano
                              and num_mes   = p_num_mes
                              and cod_func  = r_func_cargo.cod_func
                              and cod_fil   = r_fil.cod_fil
                              and cod_indic = 40;
                         exception
                           when others then
                             v_vlr_premio := 0;
                             v_num_realz_fx := 0;
                             v_num_realz_pond_geral := 0;
                         end;
                         --
                         begin
                           for i in (select a.*
                                       from srv_realizado_func_indicador a
                                      where a.num_ano = p_num_ano
                                        and a.num_mes = p_num_mes
                                        and cod_func  = r_func_cargo.cod_func
                                        and cod_fil   = r_fil.cod_fil
                                        and a.cod_indic not in (39,40)) loop

                             if i.cod_indic = 1 then
                               --VENDAS
                               select nvl(num_realz_pond,0)
                                 into v_num_realz_pond
                                 from srv_realizado_func_indicador
                                where cod_func  = i.cod_func
                                  and num_ano   = i.num_ano
                                  and num_mes   = i.num_mes
                                  and cod_fil   = i.cod_fil
                                  and cod_indic = 1;

                             else
                               --PSF/EP
                               select nvl((num_realz_pond * v_num_peso_psf),0)
                                 into v_num_realz_pond
                                 from srv_realizado_func_indicador
                                where cod_func  = i.cod_func
                                  and num_ano   = i.num_ano
                                  and num_mes   = i.num_mes
                                  and cod_fil   = i.cod_fil
                                  and cod_indic = i.cod_indic;

                             end if;
                             --
                             begin
                               v_num_realz_pond := (v_num_realz_pond / v_num_realz_pond_geral) * v_num_realz_fx;
                             exception
                               when others then
                                 v_num_realz_pond := 0;
                             end;
                             --
                             begin
                               v_vlr_premio_calc := (v_vlr_premio * v_num_realz_pond) / 100;
                             exception
                               when others then
                                 v_vlr_premio_calc := 0;
                             end;
                             --
                             begin
                               update srv_realizado_func_indicador
                                  set vlr_premio_func_calc = v_vlr_premio_calc
                                where cod_func  = i.cod_func
                                  and num_ano   = i.num_ano
                                  and num_mes   = i.num_mes
                                  and cod_fil   = i.cod_fil
                                  and cod_indic = i.cod_indic;
                             exception
                               when others then
                                 null;
                             end;
                             --
                           end loop;

                          exception
                           when others then
                             null;

                         end;
                         --
                         Commit;
                         --
                       Exception
                         When Others Then
                           null;

                       End;
                       --################

                    -- c_func_cargo
                    end loop;

                 -- c_cargo_grp_rem_var
                 end loop;

                 -- commit por indicador
                 commit;

              -- c_indic_sistemico AGRUPAMENTO LOJA LIDER
              end loop;

           --
           exception
              /*when e_erro then
                 raise e_erro;*/
              when others then
                 p_cod_erro     := 1;
                 p_descr_erro   := 'Erro Geral ao calcular O AGRUPAMENTO LOJA LIDER Lideranca Loja' ||
                                   ' cod_fil:  '    || v_cod_fil   ||
                                   ' cod_indic:  '  || v_cod_indic ||
                                   ' cod_func:  '   || v_cod_func ||
                                   ' erro: '        || sqlerrm;

                 -- enviar email
                 v_body       := p_cod_erro || ' - ' || p_descr_erro;

                 v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                         ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                         ,p_body    => v_body
                                                                         );

                 -- logar tabela
                 v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                           ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                           ,p_num_ano     => p_num_ano
                                                           ,p_num_mes     => p_num_mes
                                                           ,p_cod_fil     => v_cod_fil
                                                           ,p_cod_func    => v_cod_func
                                                           ,p_cod_indic   => v_cod_indic
                                                           ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                           );

                 if v_ins_log_erro is not null then
                    -- enviar email
                    v_body       := v_ins_log_erro;
                    --
                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                            ,p_body    => v_body
                                                                            );
                 --v_ins_log_erro is not null
                 end if;


           --
           end;


           ---------------------------------------------
           -- commit por filial
           ---------------------------------------------
           commit;

        ------------------------------------------------
        -- c_fil
        ------------------------------------------------
        end loop;

        commit;

      exception
        when others then
          null;
      end;

      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      -- CALCULO DO PREMIO DOS GERENTES POR 2 LOJAS
      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      Begin
        for r_fil in c_fil (p_cod_emp
                           ,p_cod_fil) loop

           v_cod_fil          := r_fil.cod_fil;

          for r_indic_rem_loja in c_indic_rem_loja loop

             v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
             v_cod_indic        := r_indic_rem_loja.cod_indic;

             --------------------------------------------------------
             -- SE INDICADOR VENDAS
             --------------------------------------------------------
             if r_indic_rem_loja.descr_indic = 'VENDAS' then

                -- LIDERANCA_LOJA
                -- realizado e meta de todas as filiais do Lider Regional / Nacional pelo indicador
                begin
                   for r_lid_reg_nac in c_func_Lid_premio_2_fil (p_descr_indic       => r_indic_rem_loja.descr_indic
                                                                ,p_cod_fil           => v_cod_fil
                                                                ,p_descr_grp_rem_var => 'LIDERANCA_LOJA') loop

                       v_cod_cargo := r_lid_reg_nac.cod_cargo;
                       v_cod_func  := r_lid_reg_nac.cod_func;

                      ---------------------------------------------------------------
                      -- CARGOS LIDERANCA - VENDAS
                      ---------------------------------------------------------------
                      if r_lid_reg_nac.num_meta > 0 then
                         v_num_realz_x_meta := (r_lid_reg_nac.num_realz / r_lid_reg_nac.num_meta) * 100;
                      else
                         v_num_realz_x_meta := 100; --r_lid_reg_nac.num_realz;
                      end if;
                      v_cod_un_meta         := 1; -- unidade VALOR
                      v_cod_un_realz        := 1; -- unidade VALOR
                      v_cod_un_realz_x_meta := 2; -- unidade PERCENTUAL

                      -- selecionar a ponderacao para o cargo e para o indicador VENDAS
                      prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                          ,p_cod_grp_indic     => null
                                          ,p_cod_cargo         => r_lid_reg_nac.cod_cargo
                                          ,p_cod_grp_rem_var   => null
                                          ,p_cod_pond          => v_cod_pond
                                          ,p_num_peso          => v_num_peso
                                          ,p_cod_un_peso       => v_cod_un_peso
                                          ,p_vlr_premio        => v_vlr_premio
                                          ,p_cod_erro          => p_cod_erro
                                          ,p_descr_erro        => p_descr_erro
                                          );

                      if p_cod_erro is not null then
                        v_num_peso   := 0;
                        v_vlr_premio := 0;
                      end if;

                      prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                         ,null                           --p_cod_grp_indic
                                         ,null                           --p_cod_grp_rem_var
                                         ,v_num_realz_x_meta             --p_num_realz_x_meta
                                         ,v_cod_escala
                                         ,v_num_seq_escala_fx
                                         ,v_num_realz_fx
                                         ,v_cod_un_realz_fx
                                         ,v_flg_pct_100
                                         ,v_num_limite_fx
                                         ,p_cod_erro
                                         ,p_descr_erro
                                         );

                      if p_cod_erro is not null then
                         --
                         v_num_realz_x_meta := 0;

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                      end if;

                      -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                      -- entao assumir o valor limite
                      if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_x_meta > v_num_limite_fx then

                         v_num_realz_x_meta := v_num_limite_fx;

                      end if;

                      -- realz X meta da filial multiplicar pelo peso (referente a vendas)
                      v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;

                      -- gravar na srv_realizado_func_indicador
                      rec_srv_realizado_func_indic.cod_func                := r_lid_reg_nac.cod_func;
                      rec_srv_realizado_func_indic.cod_cargo               := r_lid_reg_nac.cod_cargo;
                      rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                      rec_srv_realizado_func_indic.cod_emp                 := r_lid_reg_nac.cod_emp;
                      rec_srv_realizado_func_indic.cod_fil                 := r_lid_reg_nac.cod_fil;
                      rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                      rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                      rec_srv_realizado_func_indic.cod_escala              := null;
                      rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                      rec_srv_realizado_func_indic.num_realz_fx            := null;
                      rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                      rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                      rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                      rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                      rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                      rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                      rec_srv_realizado_func_indic.num_meta                := r_lid_reg_nac.num_meta;
                      rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                      rec_srv_realizado_func_indic.num_realz               := r_lid_reg_nac.num_realz;
                      rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                      rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                      rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                      rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                      rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                      rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null;
                      rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                      rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                      rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                      rec_srv_realizado_func_indic.seg_fil                 := 'S';

                      -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                      prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                     ,p_cod_erro                  => p_cod_erro
                                                     ,p_descr_erro                => p_descr_erro
                                                      );

                      --
                      if p_cod_erro is not null then

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );
                      end if;

                   end loop;
                   --
                   commit;

                --
                exception
                   when others then
                      p_cod_erro     := 1;
                      p_descr_erro   := 'Erro Geral ao calcular realizado e meta de todas as filiais do Lider Regional / Nacional LIDERANCA LOJA para o indicador VENDAS ' ||
                                        ' cod_fil:  '    || v_cod_fil   ||
                                        ' cod_indic:  '  || v_cod_indic ||
                                        ' cod_cargo:  '  || v_cod_cargo ||
                                        ' cod_func:  '   || v_cod_func  ||
                                        ' erro: '        || sqlerrm;

                      -- enviar email
                      v_body       := p_cod_erro || ' - ' || p_descr_erro;

                      v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                              ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                              ,p_body    => v_body
                                                                              );

                      -- logar tabela
                      v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                ,p_num_ano     => p_num_ano
                                                                ,p_num_mes     => p_num_mes
                                                                ,p_cod_fil     => v_cod_fil
                                                                ,p_cod_func    => v_cod_func
                                                                ,p_cod_indic   => v_cod_indic
                                                                ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                );

                      if v_ins_log_erro is not null then
                         -- enviar email
                         v_body       := v_ins_log_erro;
                         --
                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                 ,p_body    => v_body
                                                                                 );
                      --v_ins_log_erro is not null
                      end if;
                --
                end;

             --------------------------------------------------------
             -- SE INDICADORES DO GRUPO PSF_PROD_SERV_FINANCEIROS
             --------------------------------------------------------
             elsif r_indic_rem_loja.descr_grp_indic = 'PSF_PROD_SERV_FINANCEIROS' then

                -- LIDERANCA_LOJA
                -- realizado e meta de todas as filiais do Lider Regional / Nacional pelo indicador
                begin
                   for r_lid_reg_nac in c_func_Lid_premio_2_fil (p_descr_indic       => r_indic_rem_loja.descr_indic
                                                                ,p_cod_fil           => v_cod_fil
                                                                ,p_descr_grp_rem_var => 'LIDERANCA_LOJA') loop

                      v_cod_cargo := r_lid_reg_nac.cod_cargo;
                      v_cod_func  := r_lid_reg_nac.cod_func;


                      -----------------------------------------------------------------------
                      -- CARGOS LIDERANCA - GRUPO DE INDICADORES PSF_PROD_SERV_FINANCEIROS
                      -----------------------------------------------------------------------
                      if r_lid_reg_nac.num_meta > 0 then
                         v_num_realz_x_meta := (r_lid_reg_nac.num_realz / r_lid_reg_nac.num_meta) * 100;
                      else
                         v_num_realz_x_meta := 100; --r_lid_reg_nac.num_realz;
                      end if;
                      if r_indic_rem_loja.descr_indic in ('VENDA COM JUROS PL', 'VENDA COM JUROS ITAU') then
                         v_cod_un_meta         := 1; -- unidade VALOR
                         v_cod_un_realz        := 1; -- unidade VALOR
                      else
                         v_cod_un_meta         := 3; -- unidade UNIDADE
                         v_cod_un_realz        := 3; -- unidade UNIDADE
                      end if;
                      v_cod_un_realz_x_meta    := 2; -- unidade PERCENTUAL

                      -- Limitador de Atingimento da Meta para Cargos Lideranca por indicador
                      p_cod_erro         := null;
                      p_descr_erro       := null;

                      --
                      prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                         ,null                           --p_cod_grp_indic
                                         ,null                           --p_cod_grp_rem_var
                                         ,v_num_realz_x_meta             --p_num_realz_x_meta
                                         ,v_cod_escala
                                         ,v_num_seq_escala_fx
                                         ,v_num_realz_fx
                                         ,v_cod_un_realz_fx
                                         ,v_flg_pct_100
                                         ,v_num_limite_fx
                                         ,p_cod_erro
                                         ,p_descr_erro
                                         );
                      -- armazena vr original de atingimento
                      v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                      -- se nao houver escala de limitador cadastrada ou
                      -- se der erro manter o valor do atingimento original (sem limitador)
                      if p_cod_erro is not null then

                         --
                         v_num_realz_fx := v_num_realz_x_meta;

                         -- zera var de escala
                         v_cod_escala         := null;
                         v_num_seq_escala_fx  := null;
                         v_num_realz_fx       := null;
                         v_cod_un_realz_fx    := null;

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

    --                     raise e_erro;

                      -- se nao houve erro ao buscar escala
                      else
                         -- se o atingimento passou o valor do limitador, entao pegar o valor
                         -- do limitador como atingimento
                         if v_num_realz_x_meta > v_num_realz_fx then
                            --
                            v_num_realz_x_meta_limitador := v_num_realz_fx;

                         -- se o atingimento nao passou a fx limitador
                         else
                            v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                            -- zera var de escala
                            v_cod_escala         := null;
                            v_num_seq_escala_fx  := null;
                            v_num_realz_fx       := null;
                            v_cod_un_realz_fx    := null;

                         end if;

                      -- erro ao calcular escala
                      end if;


                      -- selecionar a ponderacao para o grupo rem var e para o indicador
                      p_cod_erro         := null;
                      p_descr_erro       := null;
                      --
                      prc_calc_ponderacao_tp_fil2(p_cod_indic         => r_indic_rem_loja.cod_indic
                                                 ,p_cod_grp_indic     => null
                                                 ,p_cod_cargo         => r_lid_reg_nac.cod_cargo
                                                 ,p_cod_grp_rem_var   => null
                                                 ,p_cod_tipo_fil      => 1 --Tipo Filial Loja
                                                 ,p_cod_emp           => null
                                                 ,p_cod_fil           => null
                                                 ,p_cod_pond          => v_cod_pond
                                                 ,p_num_peso          => v_num_peso
                                                 ,p_cod_un_peso       => v_cod_un_peso
                                                 ,p_vlr_premio        => v_vlr_premio
                                                 ,p_cod_erro          => p_cod_erro
                                                 ,p_descr_erro        => p_descr_erro
                                                 );
                      --
                      if  p_cod_erro is not null then
                         --
                         v_num_peso   := 0;
                         v_vlr_premio := 0;

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

    --                      raise e_erro;
                      -- erro ao calcular ponderacao
                      end if;


                      -- realz X meta da filial multiplicar pelo peso
                      begin
                         -- realz X meta da filial (COM LIMITADOR SE HOUVER) multiplicar pelo peso

                         --v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;
                         v_num_realz_pond := (v_num_realz_x_meta_limitador * v_num_peso)/100;

                      exception
                         when others then
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao calcular num realz pond - PSF Lideranca Loja do Lider Regional / Nacional ' ||
                                              ' cod_fil:  '    || v_cod_fil   ||
                                              ' cod_indic:  '  || v_cod_indic ||
                                              ' cod_func:  '   || v_cod_func ||
                                              ' erro: '        || sqlerrm;

                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

    --                        raise e_erro;
                      --realz X meta da filial multiplicar pelo peso
                      end;

                      -- gravar na srv_realizado_func_indicador
                      rec_srv_realizado_func_indic.cod_func                := r_lid_reg_nac.cod_func;
                      rec_srv_realizado_func_indic.cod_cargo               := r_lid_reg_nac.cod_cargo;
                      rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                      rec_srv_realizado_func_indic.cod_emp                 := r_lid_reg_nac.cod_emp;
                      rec_srv_realizado_func_indic.cod_fil                 := r_lid_reg_nac.cod_fil;
                      rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                      rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                      rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                      rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                      rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                      rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                      rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                      rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                      rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                      rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                      rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                      rec_srv_realizado_func_indic.num_meta                := r_lid_reg_nac.num_meta;
                      rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                      rec_srv_realizado_func_indic.num_realz               := r_lid_reg_nac.num_realz;
                      rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                      rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta_limitador; --v_num_realz_x_meta;
                      rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                      rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                      rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                      rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                      rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                      rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                      rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                      rec_srv_realizado_func_indic.seg_fil                 := 'S';

                      -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                      prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                     ,p_cod_erro                  => p_cod_erro
                                                     ,p_descr_erro                => p_descr_erro
                                                      );

                      --
                      if p_cod_erro is not null then

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

    --                     raise e_erro;
                      -- erro ao inserir realizado func indicador
                      end if;

                   -- c_lid_reg_nac
                   end loop;

                   --
                   commit;

                --
                exception
                   when others then
                      p_cod_erro     := 1;
                      p_descr_erro   := 'Erro Geral ao calcular realizado e meta de todas as filiais do Lider Regional / Nacional LIDERANCA LOJA para os indicadores PSF ' ||
                                        ' cod_fil:  '    || v_cod_fil   ||
                                        ' cod_indic:  '  || v_cod_indic ||
                                        ' cod_cargo:  '  || v_cod_cargo ||
                                        ' cod_func:  '   || v_cod_func  ||
                                        ' erro: '        || sqlerrm;


                      -- enviar email
                      v_body       := p_cod_erro || ' - ' || p_descr_erro;

                      v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                              ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                              ,p_body    => v_body
                                                                              );

                      -- logar tabela
                      v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                ,p_num_ano     => p_num_ano
                                                                ,p_num_mes     => p_num_mes
                                                                ,p_cod_fil     => v_cod_fil
                                                                ,p_cod_func    => v_cod_func
                                                                ,p_cod_indic   => v_cod_indic
                                                                ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                );

                      if v_ins_log_erro is not null then
                         -- enviar email
                         v_body       := v_ins_log_erro;
                         --
                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                 ,p_body    => v_body
                                                                                 );
                      --v_ins_log_erro is not null
                      end if;

    --                  raise e_erro;
                --
                end;


             ------------------------------------------
             -- if p_descr_indic = VENDAS, etc...
             ------------------------------------------
             end if;

           end loop;

           -- commit por indicador
           commit;

           for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_PSF_LOJA_LID') loop

              v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
              v_cod_indic        := r_indic_sistemico.cod_indic;

              -----------------------------------------------------------------------------------
              -- somar todos os pesos dos resultados dos PSF
              -----------------------------------------------------------------------------------
              -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
              for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                             ,p_flg_agrupa_fil_lider => 'N' ) loop

                begin
                   -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                   for r_func_cargo in c_func_cargo_2_fil (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                          ,p_cur_cod_emp          => r_fil.cod_emp
                                                          ,p_cur_cod_fil          => r_fil.cod_fil
                                                          ,p_flg_agrupa_fil_lider => 'N' ) loop

                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;


                      -- somar os resultados dos pesos das ponderacoes para todos os indicadores PSF
                      begin
                         select c.cod_grp_indic
                               ,sum(a.num_realz_pond)
                           into v_cod_grp_indic
                               ,v_vr_soma_num_realz_pond_psf
                           from srv_realizado_func_indicador a
                               ,srv_indicador                b
                               ,srv_grupo_indicador          c
                          where a.cod_indic                = b.cod_indic
                            and b.cod_grp_indic            = c.cod_grp_indic
                            and a.cod_func                 = r_func_cargo.cod_func
                            and a.cod_emp                  = r_fil.cod_emp
                            and a.cod_fil                  = r_fil.cod_fil
                            and a.num_ano                  = p_num_ano
                            and a.num_mes                  = p_num_mes
                            and c.descr_grp_indic          = 'PSF_PROD_SERV_FINANCEIROS'
                            and (b.cod_indic_sis            is null or cod_indic_sis ='SAX_PSF')
                       group by c.cod_grp_indic;
                      exception
                         when no_data_found then
                            v_cod_grp_indic              := null;
                            v_vr_soma_num_realz_pond_psf := 0;
                         when others then
                            --
                            v_cod_grp_indic              := null;
                            v_vr_soma_num_realz_pond_psf := 0;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar a soma dos num_realz_pond para o indicador ' ||
                                              ' sistemico AGRUPA_PSF_LOJA_LID para os cargos com Agrupamento Filiais '   ||
                                              ' cod_fil -  '                                         || r_fil.cod_fil ||
                                              ' indic -  '                                           || 'AGRUPA_PSF_LOJA_LID' ||
                                              ' cod_func - '                                         || r_func_cargo.cod_func ||
                                              ' erro - '                                             || sqlerrm;

                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;
                      --
                      end;

                      -- selecionar a ponderacao para o cargo e para o grupo indicador
                      prc_calc_ponderacao (p_cod_indic         => null
                                          ,p_cod_grp_indic     => r_indic_sistemico.cod_grp_indic
                                          ,p_cod_cargo         => r_cargo_grp_rem_var.cod_cargo
                                          ,p_cod_grp_rem_var   => null
                                          ,p_cod_pond          => v_cod_pond
                                          ,p_num_peso          => v_num_peso
                                          ,p_cod_un_peso       => v_cod_un_peso
                                          ,p_vlr_premio        => v_vlr_premio
                                          ,p_cod_erro          => p_cod_erro
                                          ,p_descr_erro        => p_descr_erro
                                          );
                      --
                      if p_cod_erro is not null then

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao calcular ponderacao
                      end if;

                      -- aplicar a ponderacao sobre a soma de todas as ponderacoes de todos os indicadores PSF
                      begin
                         v_num_realz_pond := (v_vr_soma_num_realz_pond_psf * v_num_peso)/100;
                      exception
                         when others then
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao calcular num realz pond do PSF do Agrupamento PSF Lider Regional / Nacional ' ||
                                              ' cod_fil:  '    || v_cod_fil   ||
                                              ' cod_indic:  '  || v_cod_indic ||
                                              ' cod_func:  '   || v_cod_func ||
                                              ' erro: '        || sqlerrm;

                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;

                      --aplicar a ponderacao sobre a soma de todas as ponderacoes de todos os indicadores PSF
                      end;

                      -- gravar na srv_realizado_func_indicador
                      rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                      rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                      rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                      rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                      rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                      rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                      rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                      rec_srv_realizado_func_indic.cod_escala              := null;
                      rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                      rec_srv_realizado_func_indic.num_realz_fx            := null;
                      rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                      rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                      rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                      rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                      rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                      rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                      rec_srv_realizado_func_indic.num_meta                := null;
                      rec_srv_realizado_func_indic.cod_un_meta             := null;
                      rec_srv_realizado_func_indic.num_realz               := null;
                      rec_srv_realizado_func_indic.cod_un_realz            := null;
                      rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                      rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                      rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                      rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                      rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                      rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                      rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                      rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                      rec_srv_realizado_func_indic.seg_fil                 := 'S';

                      -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                      prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                     ,p_cod_erro                  => p_cod_erro
                                                     ,p_descr_erro                => p_descr_erro
                                                      );

                      --
                      if p_cod_erro is not null then
                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao inserir realizado func indicador
                      end if;

                    -- c_func_cargo
                   end loop;

                 --
                 exception
                    /*when e_erro then
                       raise e_erro;*/
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular O AGRUPAMENTO PSF DOS LIDERES REGIONAIS / NACIONAIS  ' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' cod_cargo:  '  || v_cod_cargo ||
                                         ' cod_func:  '   || v_cod_func  ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                 --
                 end;

              -- c_cargo_grp_rem_var
              end loop;

           -- c_indic_sistemico AGRUPAMENTO LIDER PSF
           end loop;

           -- commit por indicador
           commit;

           ----------------------------------------------------------------------------
           -- CALCULAR O AGRUPAMENTO REM LOJA GERENTE POR 2 LOJAS
           ----------------------------------------------------------------------------
           for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_REM_LOJA_LID') loop

              v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
              v_cod_indic        := r_indic_sistemico.cod_indic;

              -----------------------------------------------------------------------------------
              -- somar todos os pesos dos resultados dos PSF
              -----------------------------------------------------------------------------------
              -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
              for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                             ,p_flg_agrupa_fil_lider => 'N' ) loop


                 begin
                    -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                    for r_func_cargo in c_func_cargo_2_fil (p_cod_cargo             => r_cargo_grp_rem_var.cod_cargo
                                                            ,p_cur_cod_emp          => r_fil.cod_emp
                                                            ,p_cur_cod_fil          => r_fil.cod_fil
                                                            ,p_flg_agrupa_fil_lider => 'N' ) loop

                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;

                       -- somar os indicadores VENDAS E AGRUPAMENTO PSF
                       begin
                          select sum(a.num_realz_pond)        vr_soma_num_realz_pond_v_p
                                ,sum(a.vlr_premio)            vlr_soma_premio_v_p
                                ,sum(a.vlr_premio_func_calc)  vlr_soma_premio_func_calc_v_p
                            into v_vr_soma_num_realz_pond_v_p
                                ,vlr_soma_premio_v_p
                                ,vlr_soma_premio_func_calc_v_p
                            from srv_realizado_func_indicador a
                                ,srv_indicador         b
                           where a.cod_indic                = b.cod_indic
                             and a.cod_emp                  = r_fil.cod_emp
                             and a.cod_fil                  = r_fil.cod_fil
                             and a.cod_func                 = r_func_cargo.cod_func
                             and a.num_ano                  = p_num_ano
                             and a.num_mes                  = p_num_mes
                             and b.descr_indic              in ('VENDAS', 'AGRUPAMENTO PSF_LOJA LIDER');
                      exception
                         when no_data_found then
                            v_vr_soma_num_realz_pond_v_p  := 0;
                            vlr_soma_premio_v_p           := 0;
                            vlr_soma_premio_func_calc_v_p := 0;
                         when others then
                            --
                            v_vr_soma_num_realz_pond_v_p  := 0;
                            vlr_soma_premio_v_p           := 0;
                            vlr_soma_premio_func_calc_v_p := 0;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar a soma dos indicadores VENDAS E AGRUPAMENTO PSF ' ||
                                              ' para o indic sistemico AGRUPA_REM_LOJA_LID para os cargos com Agrupamento Filiais '   ||
                                              ' cod_fil -  '                                         || r_fil.cod_fil ||
                                              ' indic -  '                                           || 'AGRUPA_REM_LOJA_LID' ||
                                              ' cod_func - '                                         || r_func_cargo.cod_func ||
                                              ' erro - '                                             || sqlerrm;


                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;

                      --somar os indicadores VENDAS E AGRUPAMENTO PSF
                      end;

                       -- aplicar a escala do indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       p_cod_erro         := null;
                       p_descr_erro       := null;
                       --
                       prc_calc_escala_fx (null                            -- p_cod_indic
                                          ,null                            -- p_cod_grp_indic
                                          ,15                              -- p_cod_grp_rem_var
                                          ,v_vr_soma_num_realz_pond_v_p
                                          ,v_cod_escala
                                          ,v_num_seq_escala_fx
                                          ,v_num_realz_fx
                                          ,v_cod_un_realz_fx
                                          ,v_flg_pct_100
                                          ,v_num_limite_fx
                                          ,p_cod_erro
                                          ,p_descr_erro
                                          );

                       if p_cod_erro is not null then
                          --
                          v_num_realz_fx := 0;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                       -- erro ao calcular
                       end if;

                       -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                       -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                       if (nvl(v_flg_pct_100, 'N') = 'S' and v_vr_soma_num_realz_pond_v_p > 100) then
                          --
                          v_num_realz_fx := v_vr_soma_num_realz_pond_v_p;
                       end if;

                       -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                       -- entao assumir o valor limite
                       if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                          --
                          v_num_realz_fx := v_num_limite_fx;
                       end if;



                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e indicador VENDAS
                       -- gravar o vlr premio calc na realz func para o indicador VENDAS
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'VENDAS')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc para o indicador VENDAS - Lideres Regionais e Nacionais ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - VENDAS
                       end;

                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e grupo de indicadores PSF
                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO PSF_LOJA LIDER
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'AGRUPAMENTO PSF_LOJA LIDER')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc para o indicador AGRUPAMENTO PSF_LOJA LIDER  - Lideres Regionais e Nacionais ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - AGRUPAMENTO PSF_LOJA LIDER
                       end;

                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       begin
                          vlr_soma_premio_func_calc_v_p := (vlr_soma_premio_v_p * v_num_realz_fx)/100;
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao calcular soma do premio calculado para Agrupamento Rem Loja Lider - Lider Regional / Nacional ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       end;

                       -- inserir o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       -- gravar na srv_realizado_func_indicador
                       rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                       rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                       rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                       rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                       rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                       rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                       rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                       rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                       rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                       rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                       rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                       rec_srv_realizado_func_indic.cod_pond                := null;
                       rec_srv_realizado_func_indic.num_peso                := null;
                       rec_srv_realizado_func_indic.cod_un_peso             := null;
                       rec_srv_realizado_func_indic.num_realz_pond          := v_vr_soma_num_realz_pond_v_p;
                       rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                       rec_srv_realizado_func_indic.num_meta                := null;
                       rec_srv_realizado_func_indic.cod_un_meta             := null;
                       rec_srv_realizado_func_indic.num_realz               := null;
                       rec_srv_realizado_func_indic.cod_un_realz            := null;
                       rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                       rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                       rec_srv_realizado_func_indic.vlr_premio              := vlr_soma_premio_v_p;
                       rec_srv_realizado_func_indic.vlr_premio_func_calc    := vlr_soma_premio_func_calc_v_p;
                       rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                       rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                       rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                       rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                       rec_srv_realizado_func_indic.seg_fil                 := 'S';

                       -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                       prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                      ,p_cod_erro                  => p_cod_erro
                                                      ,p_descr_erro                => p_descr_erro
                                                       );

                       --
                       if p_cod_erro is not null then

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

                        end if;

                    -- c_func_cargo
                    end loop;
                 --
                 exception
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular AGRUPAMENTO REM LOJA LIDER DOS LIDERES REGIONAIS / NACIONAIS ' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' cod_cargo:  '  || v_cod_cargo ||
                                         ' cod_func:  '   || v_cod_func  ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                 --
                 end;

              -- c_cargo_grp_rem_var
              end loop;

              -- commit por indicador
              commit;

           -----------------------------------------------------
           -- c_indic_sistemico AGRUPAMENTO LOJA LIDER
           -----------------------------------------------------
           end loop;

        ----------------------------------------------------
        -- c_fil
        ----------------------------------------------------
        end loop;

        commit;

      Exception
        When Others Then
          Null;
      end;



      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      -- AGRUPAMENTO DE FILIAIS REGIONAL / NACIONAL E VISUAL MERCHANDISING LOJA
      ------------------------------------------------------------------------------------------
      ------------------------------------------------------------------------------------------
      Begin
        for r_indic_rem_loja in c_indic_rem_loja loop

           v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
           v_cod_indic        := r_indic_rem_loja.cod_indic;

           --------------------------------------------------------
           -- SE INDICADOR VENDAS
           --------------------------------------------------------
           if r_indic_rem_loja.descr_indic = 'VENDAS' then

              -- LIDERANCA_LOJA
              -- realizado e meta de todas as filiais do Lider Regional / Nacional pelo indicador
              begin
                 for r_lid_reg_nac in c_lid_reg_nac (p_descr_indic         => r_indic_rem_loja.descr_indic
                                                    ,p_descr_grp_rem_var => 'LIDERANCA_LOJA'
                                                    ) loop

                     v_cod_cargo := r_lid_reg_nac.cod_cargo;
                     v_cod_func  := r_lid_reg_nac.cod_func;

                    ---------------------------------------------------------------
                    -- CARGOS LIDERANCA - VENDAS
                    ---------------------------------------------------------------
                    if r_lid_reg_nac.num_meta > 0 then
                       v_num_realz_x_meta := (r_lid_reg_nac.num_realz / r_lid_reg_nac.num_meta) * 100;
                    else
                       v_num_realz_x_meta := 100; --r_lid_reg_nac.num_realz;
                    end if;
                    v_cod_un_meta         := 1; -- unidade VALOR
                    v_cod_un_realz        := 1; -- unidade VALOR
                    v_cod_un_realz_x_meta := 2; -- unidade PERCENTUAL

                    -- selecionar a ponderacao para o cargo e para o indicador VENDAS
                    prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                        ,p_cod_grp_indic     => null
                                        ,p_cod_cargo         => r_lid_reg_nac.cod_cargo
                                        ,p_cod_grp_rem_var   => null
                                        ,p_cod_pond          => v_cod_pond
                                        ,p_num_peso          => v_num_peso
                                        ,p_cod_un_peso       => v_cod_un_peso
                                        ,p_vlr_premio        => v_vlr_premio
                                        ,p_cod_erro          => p_cod_erro
                                        ,p_descr_erro        => p_descr_erro
                                        );
                    --
                    if p_cod_erro is not null then
                       --
                       v_num_peso   := 0;
                       v_vlr_premio := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;


  --                     raise e_erro;
                    -- erro ao calcular ponderacao
                    end if;

                    -- realz X meta da filial multiplicar pelo peso (referente a vendas)
                    v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;

                    -- gravar na srv_realizado_func_indicador
                    rec_srv_realizado_func_indic.cod_func                := r_lid_reg_nac.cod_func;
                    rec_srv_realizado_func_indic.cod_cargo               := r_lid_reg_nac.cod_cargo;
                    rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                    rec_srv_realizado_func_indic.cod_emp                 := r_lid_reg_nac.cod_emp;
                    rec_srv_realizado_func_indic.cod_fil                 := r_lid_reg_nac.cod_fil;
                    rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                    rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                    rec_srv_realizado_func_indic.cod_escala              := null;
                    rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                    rec_srv_realizado_func_indic.num_realz_fx            := null;
                    rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                    rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                    rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                    rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                    rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                    rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                    rec_srv_realizado_func_indic.num_meta                := r_lid_reg_nac.num_meta;
                    rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                    rec_srv_realizado_func_indic.num_realz               := r_lid_reg_nac.num_realz;
                    rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                    rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                    rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                    rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                    rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null;
                    rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                    rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                    rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                    rec_srv_realizado_func_indic.seg_fil                 := null;

                    -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                    prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                   ,p_cod_erro                  => p_cod_erro
                                                   ,p_descr_erro                => p_descr_erro
                                                    );

                    --
                    if p_cod_erro is not null then

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                    -- erro ao inserir realizado func indicador
                    end if;

                 -- c_lid_reg_nac
                 end loop;

                 --
                 commit;

              --
              exception
                 /*when e_erro then
                    raise e_erro;*/
                 when others then
                    p_cod_erro     := 1;
                    p_descr_erro   := 'Erro Geral ao calcular realizado e meta de todas as filiais do Lider Regional / Nacional LIDERANCA LOJA para o indicador VENDAS ' ||
                                      ' cod_fil:  '    || v_cod_fil   ||
                                      ' cod_indic:  '  || v_cod_indic ||
                                      ' cod_cargo:  '  || v_cod_cargo ||
                                      ' cod_func:  '   || v_cod_func  ||
                                      ' erro: '        || sqlerrm;

                    -- enviar email
                    v_body       := p_cod_erro || ' - ' || p_descr_erro;

                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                            ,p_body    => v_body
                                                                            );

                    -- logar tabela
                    v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                              ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                              ,p_num_ano     => p_num_ano
                                                              ,p_num_mes     => p_num_mes
                                                              ,p_cod_fil     => v_cod_fil
                                                              ,p_cod_func    => v_cod_func
                                                              ,p_cod_indic   => v_cod_indic
                                                              ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                              );

                    if v_ins_log_erro is not null then
                       -- enviar email
                       v_body       := v_ins_log_erro;
                       --
                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                               ,p_body    => v_body
                                                                               );
                    --v_ins_log_erro is not null
                    end if;

  --                  raise e_erro;
              --
              end;

              -- VISUAL_MERCHANDISING_LOJA
              -- realizado e meta de todas as filiais do Lider VISUAL_MERCHANDISING_LOJA
              begin
                 for r_lid_reg_nac in c_lid_reg_nac (p_descr_indic       => r_indic_rem_loja.descr_indic
                                                    ,p_descr_grp_rem_var => 'VISUAL_MERCHANDISING_LOJA'
                                                    ) loop

                     v_cod_cargo := r_lid_reg_nac.cod_cargo;
                     v_cod_func  := r_lid_reg_nac.cod_func;

                    ---------------------------------------------------------------
                    -- VISUAL_MERCHANDISING_LOJA - VENDAS
                    ---------------------------------------------------------------
                    if r_lid_reg_nac.num_meta > 0 then
                       v_num_realz_x_meta := (r_lid_reg_nac.num_realz / r_lid_reg_nac.num_meta) * 100;
                    else
                       v_num_realz_x_meta := 100; --r_lid_reg_nac.num_realz;
                    end if;
                    v_cod_un_meta         := 1; -- unidade VALOR
                    v_cod_un_realz        := 1; -- unidade VALOR
                    v_cod_un_realz_x_meta := 2; -- unidade PERCENTUAL

                    -- selecionar a ponderacao para o cargo e para o indicador VENDAS
                    prc_calc_ponderacao (p_cod_indic         => r_indic_rem_loja.cod_indic
                                        ,p_cod_grp_indic     => null
                                        ,p_cod_cargo         => r_lid_reg_nac.cod_cargo
                                        ,p_cod_grp_rem_var   => null
                                        ,p_cod_pond          => v_cod_pond
                                        ,p_num_peso          => v_num_peso
                                        ,p_cod_un_peso       => v_cod_un_peso
                                        ,p_vlr_premio        => v_vlr_premio
                                        ,p_cod_erro          => p_cod_erro
                                        ,p_descr_erro        => p_descr_erro
                                        );
                    --
                    if p_cod_erro is not null then
                       --
                       v_num_peso   := 0;
                       v_vlr_premio := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                    -- erro ao calcular ponderacao
                    end if;

                    --
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --
                    prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                       ,null                           --p_cod_grp_indic
                                       ,null                           --p_cod_grp_rem_var
                                       ,v_num_realz_x_meta             --p_num_realz_x_meta
                                       ,v_cod_escala
                                       ,v_num_seq_escala_fx
                                       ,v_num_realz_fx
                                       ,v_cod_un_realz_fx
                                       ,v_flg_pct_100
                                       ,v_num_limite_fx
                                       ,p_cod_erro
                                       ,p_descr_erro
                                       );
                    if p_cod_erro is not null then

                       --
                       v_num_realz_fx := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                    -- erro ao calcular escala
                    end if;

                    -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                    -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                    if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                       --
                       v_num_realz_fx := v_num_realz_x_meta;
                    end if;

                    -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                    -- entao assumir o valor limite
                    if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                       --
                       v_num_realz_fx := v_num_limite_fx;
                    end if;

                    -- calcula valor do premio pela faixa %
                    begin
                    v_vlr_premio_func_calc  := (v_vlr_premio * v_num_realz_fx)/100;
                    --
                    exception
                       when others then
                          p_cod_erro     := 1;
                          p_descr_erro   := 'Erro ao calcular vlr premio func calculado - Lider VISUAL_MERCHANDISING_LOJA' ||
                                            ' cod_fil:  '    || v_cod_fil   ||
                                            ' cod_indic:  '  || v_cod_indic ||
                                            ' cod_func:  '   || v_cod_func ||
                                            ' erro: '        || sqlerrm;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                    --calcula valor do premio pela faixa %
                    end;

                    -- gravar na srv_realizado_func_indicador
                    rec_srv_realizado_func_indic.cod_func                := r_lid_reg_nac.cod_func;
                    rec_srv_realizado_func_indic.cod_cargo               := r_lid_reg_nac.cod_cargo;
                    rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                    rec_srv_realizado_func_indic.cod_emp                 := r_lid_reg_nac.cod_emp;
                    rec_srv_realizado_func_indic.cod_fil                 := r_lid_reg_nac.cod_fil;
                    rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                    rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                    rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                    rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                    rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                    rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                    rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                    rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                    rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                    rec_srv_realizado_func_indic.num_realz_pond          := null;
                    rec_srv_realizado_func_indic.cod_un_realz_pond       := null;

                    rec_srv_realizado_func_indic.num_meta                := r_lid_reg_nac.num_meta;
                    rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                    rec_srv_realizado_func_indic.num_realz               := r_lid_reg_nac.num_realz;
                    rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                    rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                    rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                    rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                    rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                    rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                    rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                    rec_srv_realizado_func_indic.seg_fil                 := null;

                    -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                    prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                   ,p_cod_erro                  => p_cod_erro
                                                   ,p_descr_erro                => p_descr_erro
                                                    );

                    --
                    if p_cod_erro is not null then

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                    -- erro ao inserir realizado func indicador
                    end if;

                 -- c_lid_reg_nac
                 end loop;

                 --
                 commit;

              --
              exception
                 /*when e_erro then
                    raise e_erro;*/
                 when others then
                    p_cod_erro     := 1;
                    p_descr_erro   := 'Erro Geral ao calcular realizado e meta de todas as filiais do Lider VISUAL_MERCHANDISING_LOJA' ||
                                      ' cod_fil:  '    || v_cod_fil   ||
                                      ' cod_indic:  '  || v_cod_indic ||
                                      ' cod_cargo:  '  || v_cod_cargo ||
                                      ' cod_func:  '   || v_cod_func  ||
                                      ' erro: '        || sqlerrm;

                    -- enviar email
                    v_body       := p_cod_erro || ' - ' || p_descr_erro;

                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                            ,p_body    => v_body
                                                                            );

                    -- logar tabela
                    v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                              ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                              ,p_num_ano     => p_num_ano
                                                              ,p_num_mes     => p_num_mes
                                                              ,p_cod_fil     => v_cod_fil
                                                              ,p_cod_func    => v_cod_func
                                                              ,p_cod_indic   => v_cod_indic
                                                              ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                              );

                    if v_ins_log_erro is not null then
                       -- enviar email
                       v_body       := v_ins_log_erro;
                       --
                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                               ,p_body    => v_body
                                                                               );
                    --v_ins_log_erro is not null
                    end if;

  --                  raise e_erro;
              --
              end;

           --------------------------------------------------------
           -- SE INDICADORES DO GRUPO PSF_PROD_SERV_FINANCEIROS
           --------------------------------------------------------
           elsif r_indic_rem_loja.descr_grp_indic = 'PSF_PROD_SERV_FINANCEIROS' then

              -- LIDERANCA_LOJA
              -- realizado e meta de todas as filiais do Lider Regional / Nacional pelo indicador
              begin
                 for r_lid_reg_nac in c_lid_reg_nac (p_descr_indic       => r_indic_rem_loja.descr_indic
                                                    ,p_descr_grp_rem_var => 'LIDERANCA_LOJA'
                                                    ) loop

                    v_cod_cargo := r_lid_reg_nac.cod_cargo;
                    v_cod_func  := r_lid_reg_nac.cod_func;


                    -----------------------------------------------------------------------
                    -- CARGOS LIDERANCA - GRUPO DE INDICADORES PSF_PROD_SERV_FINANCEIROS
                    -----------------------------------------------------------------------
                    if r_lid_reg_nac.num_meta > 0 then
                       v_num_realz_x_meta := (r_lid_reg_nac.num_realz / r_lid_reg_nac.num_meta) * 100;
                    else
                       v_num_realz_x_meta := 100; --r_lid_reg_nac.num_realz;
                    end if;
                    if r_indic_rem_loja.descr_indic in ('VENDA COM JUROS PL', 'VENDA COM JUROS ITAU') then
                       v_cod_un_meta         := 1; -- unidade VALOR
                       v_cod_un_realz        := 1; -- unidade VALOR
                    else
                       v_cod_un_meta         := 3; -- unidade UNIDADE
                       v_cod_un_realz        := 3; -- unidade UNIDADE
                    end if;
                    v_cod_un_realz_x_meta    := 2; -- unidade PERCENTUAL



                    -- Limitador de Atingimento da Meta para Cargos Lideranca por indicador
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --

                    prc_calc_escala_fx (r_indic_rem_loja.cod_indic     --p_cod_indic
                                       ,null                           --p_cod_grp_indic
                                       ,null                           --p_cod_grp_rem_var
                                       ,v_num_realz_x_meta             --p_num_realz_x_meta
                                       ,v_cod_escala
                                       ,v_num_seq_escala_fx
                                       ,v_num_realz_fx
                                       ,v_cod_un_realz_fx
                                       ,v_flg_pct_100
                                       ,v_num_limite_fx
                                       ,p_cod_erro
                                       ,p_descr_erro
                                       );
                    -- armazena vr original de atingimento
                    v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                    -- se nao houver escala de limitador cadastrada ou
                    -- se der erro manter o valor do atingimento original (sem limitador)
                    if p_cod_erro is not null then

                       --
                       v_num_realz_fx := v_num_realz_x_meta;

                       -- zera var de escala
                       v_cod_escala         := null;
                       v_num_seq_escala_fx  := null;
                       v_num_realz_fx       := null;
                       v_cod_un_realz_fx    := null;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;

                    -- se nao houve erro ao buscar escala
                    else
                       -- se o atingimento passou o valor do limitador, entao pegar o valor
                       -- do limitador como atingimento
                       if v_num_realz_x_meta > v_num_realz_fx then
                          --
                          v_num_realz_x_meta_limitador := v_num_realz_fx;

                       -- se o atingimento nao passou a fx limitador
                       else
                          v_num_realz_x_meta_limitador := v_num_realz_x_meta;

                          -- zera var de escala
                          v_cod_escala         := null;
                          v_num_seq_escala_fx  := null;
                          v_num_realz_fx       := null;
                          v_cod_un_realz_fx    := null;

                       end if;

                    -- erro ao calcular escala
                    end if;


                    -- selecionar a ponderacao para o grupo rem var e para o indicador
                    p_cod_erro         := null;
                    p_descr_erro       := null;
                    --

                    --
                    prc_calc_ponderacao_tp_fil2(p_cod_indic         => r_indic_rem_loja.cod_indic
                                               ,p_cod_grp_indic     => null
                                               ,p_cod_cargo         => r_lid_reg_nac.cod_cargo
                                               ,p_cod_grp_rem_var   => null
                                               ,p_cod_tipo_fil      => 1  -- tipo fil Loja
                                               ,p_cod_emp           => null
                                               ,p_cod_fil           => null
                                               ,p_cod_pond          => v_cod_pond
                                               ,p_num_peso          => v_num_peso
                                               ,p_cod_un_peso       => v_cod_un_peso
                                               ,p_vlr_premio        => v_vlr_premio
                                               ,p_cod_erro          => p_cod_erro
                                               ,p_descr_erro        => p_descr_erro
                                               );
                    --
                    if  p_cod_erro is not null then
                       --
                       v_num_peso   := 0;
                       v_vlr_premio := 0;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                      raise e_erro;
                    -- erro ao calcular ponderacao
                    end if;


                    -- realz X meta da filial multiplicar pelo peso
                    begin
                       -- realz X meta da filial (COM LIMITADOR SE HOUVER) multiplicar pelo peso

                       --v_num_realz_pond := (v_num_realz_x_meta * v_num_peso)/100;
                       v_num_realz_pond := (v_num_realz_x_meta_limitador * v_num_peso)/100;

                    exception
                       when others then
                          p_cod_erro     := 1;
                          p_descr_erro   := 'Erro ao calcular num realz pond - PSF Lideranca Loja do Lider Regional / Nacional ' ||
                                            ' cod_fil:  '    || v_cod_fil   ||
                                            ' cod_indic:  '  || v_cod_indic ||
                                            ' cod_func:  '   || v_cod_func ||
                                            ' erro: '        || sqlerrm;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                    --realz X meta da filial multiplicar pelo peso
                    end;


                    -- gravar na srv_realizado_func_indicador
                    rec_srv_realizado_func_indic.cod_func                := r_lid_reg_nac.cod_func;
                    rec_srv_realizado_func_indic.cod_cargo               := r_lid_reg_nac.cod_cargo;
                    rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                    rec_srv_realizado_func_indic.cod_emp                 := r_lid_reg_nac.cod_emp;
                    rec_srv_realizado_func_indic.cod_fil                 := r_lid_reg_nac.cod_fil;
                    rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                    rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                    rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                    rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                    rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                    rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                    rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                    rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                    rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                    rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                    rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                    rec_srv_realizado_func_indic.num_meta                := r_lid_reg_nac.num_meta;
                    rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                    rec_srv_realizado_func_indic.num_realz               := r_lid_reg_nac.num_realz;
                    rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                    rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta_limitador; --v_num_realz_x_meta;
                    rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                    rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                    rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                    rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                    rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                    rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                    rec_srv_realizado_func_indic.seg_fil                 := null;

                    -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                    prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                   ,p_cod_erro                  => p_cod_erro
                                                   ,p_descr_erro                => p_descr_erro
                                                    );

                    --
                    if p_cod_erro is not null then

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                    -- erro ao inserir realizado func indicador
                    end if;

                 -- c_lid_reg_nac
                 end loop;

                 --
                 commit;

              --
              exception
                 /*when e_erro then
                    raise e_erro;*/
                 when others then
                    p_cod_erro     := 1;
                    p_descr_erro   := 'Erro Geral ao calcular realizado e meta de todas as filiais do Lider Regional / Nacional LIDERANCA LOJA para os indicadores PSF ' ||
                                      ' cod_fil:  '    || v_cod_fil   ||
                                      ' cod_indic:  '  || v_cod_indic ||
                                      ' cod_cargo:  '  || v_cod_cargo ||
                                      ' cod_func:  '   || v_cod_func  ||
                                      ' erro: '        || sqlerrm;


                    -- enviar email
                    v_body       := p_cod_erro || ' - ' || p_descr_erro;

                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                            ,p_body    => v_body
                                                                            );

                    -- logar tabela
                    v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                              ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                              ,p_num_ano     => p_num_ano
                                                              ,p_num_mes     => p_num_mes
                                                              ,p_cod_fil     => v_cod_fil
                                                              ,p_cod_func    => v_cod_func
                                                              ,p_cod_indic   => v_cod_indic
                                                              ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                              );

                    if v_ins_log_erro is not null then
                       -- enviar email
                       v_body       := v_ins_log_erro;
                       --
                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                               ,p_body    => v_body
                                                                               );
                    --v_ins_log_erro is not null
                    end if;

  --                  raise e_erro;
              --
              end;


           ------------------------------------------
           -- if p_descr_indic = VENDAS, etc...
           ------------------------------------------
           end if;

           -- commit por indicador
           commit;

        --------------------------------------------
        -- c_indic_rem_loja
        --------------------------------------------
        end loop;

        -----------------------------------------------------------------------
        -- CALCULAR O AGRUPAMENTO PSF DOS LIDERES REGIONAIS / NACIONAIS
        -----------------------------------------------------------------------
        for r_fil in c_fil (p_cod_emp  => null
                           ,p_cod_fil  => null
                           ) loop

           v_cod_fil          := r_fil.cod_fil;

           for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_PSF_LOJA_LID') loop

              v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
              v_cod_indic        := r_indic_sistemico.cod_indic;

              -----------------------------------------------------------------------------------
              -- somar todos os pesos dos resultados dos PSF
              -----------------------------------------------------------------------------------
              -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
              for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                             ,p_flg_agrupa_fil_lider => 'S' ) loop

                begin
                   -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                   for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                    ,p_cur_cod_emp          => r_fil.cod_emp
                                                    ,p_cur_cod_fil          => r_fil.cod_fil
                                                    ,p_flg_agrupa_fil_lider => 'S' ) loop

                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;


                      -- somar os resultados dos pesos das ponderacoes para todos os indicadores PSF
                      begin
                         select c.cod_grp_indic
                               ,sum(a.num_realz_pond)
                           into v_cod_grp_indic
                               ,v_vr_soma_num_realz_pond_psf
                           from srv_realizado_func_indicador a
                               ,srv_indicador                b
                               ,srv_grupo_indicador          c
                          where a.cod_indic                = b.cod_indic
                            and b.cod_grp_indic            = c.cod_grp_indic
                            and a.cod_func                 = r_func_cargo.cod_func
                            and a.cod_emp                  = r_fil.cod_emp
                            and a.cod_fil                  = r_fil.cod_fil
                            and a.num_ano                  = p_num_ano
                            and a.num_mes                  = p_num_mes
                            and c.descr_grp_indic          = 'PSF_PROD_SERV_FINANCEIROS'
                            and (b.cod_indic_sis            is null or cod_indic_sis ='SAX_PSF')
                       group by c.cod_grp_indic;
                      exception
                         when no_data_found then
                            v_cod_grp_indic              := null;
                            v_vr_soma_num_realz_pond_psf := 0;
                         when others then
                            --
                            v_cod_grp_indic              := null;
                            v_vr_soma_num_realz_pond_psf := 0;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar a soma dos num_realz_pond para o indicador ' ||
                                              ' sistemico AGRUPA_PSF_LOJA_LID para os cargos com Agrupamento Filiais '   ||
                                              ' cod_fil -  '                                         || r_fil.cod_fil ||
                                              ' indic -  '                                           || 'AGRUPA_PSF_LOJA_LID' ||
                                              ' cod_func - '                                         || r_func_cargo.cod_func ||
                                              ' erro - '                                             || sqlerrm;

                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;
                      --
                      end;

                      -- selecionar a ponderacao para o cargo e para o grupo indicador
                      prc_calc_ponderacao (p_cod_indic         => null
                                          ,p_cod_grp_indic     => r_indic_sistemico.cod_grp_indic
                                          ,p_cod_cargo         => r_cargo_grp_rem_var.cod_cargo
                                          ,p_cod_grp_rem_var   => null
                                          ,p_cod_pond          => v_cod_pond
                                          ,p_num_peso          => v_num_peso
                                          ,p_cod_un_peso       => v_cod_un_peso
                                          ,p_vlr_premio        => v_vlr_premio
                                          ,p_cod_erro          => p_cod_erro
                                          ,p_descr_erro        => p_descr_erro
                                          );
                      --
                      if p_cod_erro is not null then

                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao calcular ponderacao
                      end if;

                      -- aplicar a ponderacao sobre a soma de todas as ponderacoes de todos os indicadores PSF
                      begin
                         v_num_realz_pond := (v_vr_soma_num_realz_pond_psf * v_num_peso)/100;
                      exception
                         when others then
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao calcular num realz pond do PSF do Agrupamento PSF Lider Regional / Nacional ' ||
                                              ' cod_fil:  '    || v_cod_fil   ||
                                              ' cod_indic:  '  || v_cod_indic ||
                                              ' cod_func:  '   || v_cod_func ||
                                              ' erro: '        || sqlerrm;

                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;

                      --aplicar a ponderacao sobre a soma de todas as ponderacoes de todos os indicadores PSF
                      end;

                      -- gravar na srv_realizado_func_indicador
                      rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                      rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                      rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                      rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                      rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                      rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                      rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                      rec_srv_realizado_func_indic.cod_escala              := null;
                      rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                      rec_srv_realizado_func_indic.num_realz_fx            := null;
                      rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                      rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                      rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                      rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                      rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                      rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                      rec_srv_realizado_func_indic.num_meta                := null;
                      rec_srv_realizado_func_indic.cod_un_meta             := null;
                      rec_srv_realizado_func_indic.num_realz               := null;
                      rec_srv_realizado_func_indic.cod_un_realz            := null;
                      rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                      rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                      rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                      rec_srv_realizado_func_indic.vlr_premio_func_calc    := null;
                      rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; -- unidade VALOR
                      rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                      rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                      rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                      rec_srv_realizado_func_indic.seg_fil                 := null;

                      -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                      prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                     ,p_cod_erro                  => p_cod_erro
                                                     ,p_descr_erro                => p_descr_erro
                                                      );

                      --
                      if p_cod_erro is not null then
                         -- enviar email
                         v_body       := p_cod_erro || ' - ' || p_descr_erro;

                         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                 ,p_body    => v_body
                                                                                 );

                         -- logar tabela
                         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                   ,p_num_ano     => p_num_ano
                                                                   ,p_num_mes     => p_num_mes
                                                                   ,p_cod_fil     => v_cod_fil
                                                                   ,p_cod_func    => v_cod_func
                                                                   ,p_cod_indic   => v_cod_indic
                                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                   );

                         if v_ins_log_erro is not null then
                            -- enviar email
                            v_body       := v_ins_log_erro;
                            --
                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                    ,p_body    => v_body
                                                                                    );
                         --v_ins_log_erro is not null
                         end if;

  --                       raise e_erro;
                      -- erro ao inserir realizado func indicador
                      end if;

                    -- c_func_cargo
                   end loop;

                 --
                 exception
                    /*when e_erro then
                       raise e_erro;*/
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular O AGRUPAMENTO PSF DOS LIDERES REGIONAIS / NACIONAIS  ' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' cod_cargo:  '  || v_cod_cargo ||
                                         ' cod_func:  '   || v_cod_func  ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                 --
                 end;

              -- c_cargo_grp_rem_var
              end loop;

           -- c_indic_sistemico AGRUPAMENTO LIDER PSF
           end loop;

           -- commit por indicador
           commit;

           ----------------------------------------------------------------------------
           -- CALCULAR O AGRUPAMENTO REM LOJA LIDER DOS LIDERES REGIONAIS / NACIONAIS
           ----------------------------------------------------------------------------
           for r_indic_sistemico in c_indic_sistemico (p_cod_indic_sistemico => 'AGRUPA_REM_LOJA_LID') loop

              v_cod_grp_indic    := r_indic_sistemico.cod_grp_indic;
              v_cod_indic        := r_indic_sistemico.cod_indic;

              -----------------------------------------------------------------------------------
              -- somar todos os pesos dos resultados dos PSF
              -----------------------------------------------------------------------------------
              -- pegar todos os grupos de cargos e cargos para o Grupo Rem Var = Lideranca Loja
              for r_cargo_grp_rem_var in c_cargo_grp_rem_var (p_descr_grp_rem_var    => 'LIDERANCA_LOJA'
                                                             ,p_flg_agrupa_fil_lider => 'S' ) loop


                 begin
                    -- selecionar todos os funcionarios desse cargo para essa filial, cargos e funcionarios
                    for r_func_cargo in c_func_cargo (p_cod_cargo            => r_cargo_grp_rem_var.cod_cargo
                                                     ,p_cur_cod_emp          => r_fil.cod_emp
                                                     ,p_cur_cod_fil          => r_fil.cod_fil
                                                     ,p_flg_agrupa_fil_lider => 'S' ) loop

                      v_cod_cargo := r_func_cargo.cod_cargo;
                      v_cod_func  := r_func_cargo.cod_func;

                       -- somar os indicadores VENDAS E AGRUPAMENTO PSF
                       begin
                          select sum(a.num_realz_pond)        vr_soma_num_realz_pond_v_p
                                ,sum(a.vlr_premio)            vlr_soma_premio_v_p
                                ,sum(a.vlr_premio_func_calc)  vlr_soma_premio_func_calc_v_p
                            into v_vr_soma_num_realz_pond_v_p
                                ,vlr_soma_premio_v_p
                                ,vlr_soma_premio_func_calc_v_p
                            from srv_realizado_func_indicador a
                                ,srv_indicador                b
                           where a.cod_indic                = b.cod_indic
                             and a.cod_emp                  = r_fil.cod_emp
                             and a.cod_fil                  = r_fil.cod_fil
                             and a.cod_func                 = r_func_cargo.cod_func
                             and a.num_ano                  = p_num_ano
                             and a.num_mes                  = p_num_mes
                             and b.descr_indic              in ('VENDAS', 'AGRUPAMENTO PSF_LOJA LIDER');
                      exception
                         when no_data_found then
                            v_vr_soma_num_realz_pond_v_p  := 0;
                            vlr_soma_premio_v_p           := 0;
                            vlr_soma_premio_func_calc_v_p := 0;
                         when others then
                            --
                            v_vr_soma_num_realz_pond_v_p  := 0;
                            vlr_soma_premio_v_p           := 0;
                            vlr_soma_premio_func_calc_v_p := 0;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar a soma dos indicadores VENDAS E AGRUPAMENTO PSF ' ||
                                              ' para o indic sistemico AGRUPA_REM_LOJA_LID para os cargos com Agrupamento Filiais '   ||
                                              ' cod_fil -  '                                         || r_fil.cod_fil ||
                                              ' indic -  '                                           || 'AGRUPA_REM_LOJA_LID' ||
                                              ' cod_func - '                                         || r_func_cargo.cod_func ||
                                              ' erro - '                                             || sqlerrm;


                            -- enviar email
                            v_body       := p_cod_erro || ' - ' || p_descr_erro;

                            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                    ,p_body    => v_body
                                                                                    );

                            -- logar tabela
                            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                      ,p_num_ano     => p_num_ano
                                                                      ,p_num_mes     => p_num_mes
                                                                      ,p_cod_fil     => v_cod_fil
                                                                      ,p_cod_func    => v_cod_func
                                                                      ,p_cod_indic   => v_cod_indic
                                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                      );

                            if v_ins_log_erro is not null then
                               -- enviar email
                               v_body       := v_ins_log_erro;
                               --
                               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                       ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                       ,p_body    => v_body
                                                                                       );
                            --v_ins_log_erro is not null
                            end if;

  --                          raise e_erro;

                      --somar os indicadores VENDAS E AGRUPAMENTO PSF
                      end;

                       -- aplicar a escala do indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       p_cod_erro         := null;
                       p_descr_erro       := null;
                       --
                       prc_calc_escala_fx (r_indic_sistemico.cod_indic     -- p_cod_indic
                                          ,null                            -- p_cod_grp_indic
                                          ,null                            -- p_cod_grp_rem_var
                                          ,v_vr_soma_num_realz_pond_v_p
                                          ,v_cod_escala
                                          ,v_num_seq_escala_fx
                                          ,v_num_realz_fx
                                          ,v_cod_un_realz_fx
                                          ,v_flg_pct_100
                                          ,v_num_limite_fx
                                          ,p_cod_erro
                                          ,p_descr_erro
                                          );

                       if p_cod_erro is not null then
                          --
                          v_num_realz_fx := 0;

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

  --                        raise e_erro;
                       -- erro ao calcular
                       end if;

                       -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                       -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                       if (nvl(v_flg_pct_100, 'N') = 'S' and v_vr_soma_num_realz_pond_v_p > 100) then
                          --
                          v_num_realz_fx := v_vr_soma_num_realz_pond_v_p;
                       end if;

                       -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                       -- entao assumir o valor limite
                       if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                          --
                          v_num_realz_fx := v_num_limite_fx;
                       end if;

                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e indicador VENDAS
                       -- gravar o vlr premio calc na realz func para o indicador VENDAS
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'VENDAS')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;
                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc para o indicador VENDAS - Lideres Regionais e Nacionais ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - VENDAS
                       end;

                       -- pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao
                       -- para o cargo e grupo de indicadores PSF
                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO PSF_LOJA LIDER
                       begin
                          update srv_realizado_func_indicador a
                             set a.vlr_premio_func_calc = (a.vlr_premio * v_num_realz_fx)/100
                           where a.cod_indic            = (select cod_indic
                                                             from srv_indicador
                                                            where descr_indic = 'AGRUPAMENTO PSF_LOJA LIDER')
                             and a.cod_func             = r_func_cargo.cod_func
                             and a.cod_emp              = r_fil.cod_emp
                             and a.cod_fil              = r_fil.cod_fil
                             and a.num_ano              = p_num_ano
                             and a.num_mes              = p_num_mes;


                       --
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao atualizar na srv_realizado_func_indicador o vlr premio calc para o indicador AGRUPAMENTO PSF_LOJA LIDER  - Lideres Regionais e Nacionais ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --pegar o result da fx da escala e multiplicar pelo vlr do premio da ponderacao - AGRUPAMENTO PSF_LOJA LIDER
                       end;

                       -- gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       begin
                          vlr_soma_premio_func_calc_v_p := (vlr_soma_premio_v_p * v_num_realz_fx)/100;
                       exception
                          when others then
                             p_cod_erro     := 1;
                             p_descr_erro   := 'Erro ao calcular soma do premio calculado para Agrupamento Rem Loja Lider - Lider Regional / Nacional ' ||
                                               ' cod_fil:  '    || v_cod_fil   ||
                                               ' cod_indic:  '  || v_cod_indic ||
                                               ' cod_func:  '   || v_cod_func ||
                                               ' erro: '        || sqlerrm;

                             -- enviar email
                             v_body       := p_cod_erro || ' - ' || p_descr_erro;

                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                     ,p_body    => v_body
                                                                                     );

                             -- logar tabela
                             v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                       ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                       ,p_num_ano     => p_num_ano
                                                                       ,p_num_mes     => p_num_mes
                                                                       ,p_cod_fil     => v_cod_fil
                                                                       ,p_cod_func    => v_cod_func
                                                                       ,p_cod_indic   => v_cod_indic
                                                                       ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                       );

                             if v_ins_log_erro is not null then
                                -- enviar email
                                v_body       := v_ins_log_erro;
                                --
                                v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                        ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                        ,p_body    => v_body
                                                                                        );
                             --v_ins_log_erro is not null
                             end if;

  --                           raise e_erro;
                       --gravar o vlr premio calc na realz func para o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       end;

                       -- inserir o indicador AGRUPAMENTO REMUNERACAO LOJA LIDER
                       -- gravar na srv_realizado_func_indicador
                       rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
                       rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
                       rec_srv_realizado_func_indic.cod_indic               := r_indic_sistemico.cod_indic;
                       rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                       rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                       rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                       rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                       rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                       rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                       rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                       rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                       rec_srv_realizado_func_indic.cod_pond                := null;
                       rec_srv_realizado_func_indic.num_peso                := null;
                       rec_srv_realizado_func_indic.cod_un_peso             := null;
                       rec_srv_realizado_func_indic.num_realz_pond          := v_vr_soma_num_realz_pond_v_p;
                       rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

                       rec_srv_realizado_func_indic.num_meta                := null;
                       rec_srv_realizado_func_indic.cod_un_meta             := null;
                       rec_srv_realizado_func_indic.num_realz               := null;
                       rec_srv_realizado_func_indic.cod_un_realz            := null;
                       rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
                       rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                       rec_srv_realizado_func_indic.vlr_premio              := vlr_soma_premio_v_p;
                       rec_srv_realizado_func_indic.vlr_premio_func_calc    := vlr_soma_premio_func_calc_v_p;
                       rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                       rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                       rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                       rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
                       rec_srv_realizado_func_indic.seg_fil                 := null;

                       -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                       prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                      ,p_cod_erro                  => p_cod_erro
                                                      ,p_descr_erro                => p_descr_erro
                                                       );

                       --
                       if p_cod_erro is not null then

                          -- enviar email
                          v_body       := p_cod_erro || ' - ' || p_descr_erro;

                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                  ,p_body    => v_body
                                                                                  );

                          -- logar tabela
                          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                    ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                    ,p_num_ano     => p_num_ano
                                                                    ,p_num_mes     => p_num_mes
                                                                    ,p_cod_fil     => v_cod_fil
                                                                    ,p_cod_func    => v_cod_func
                                                                    ,p_cod_indic   => v_cod_indic
                                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                    );

                          if v_ins_log_erro is not null then
                             -- enviar email
                             v_body       := v_ins_log_erro;
                             --
                             v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                     ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                     ,p_body    => v_body
                                                                                     );
                          --v_ins_log_erro is not null
                          end if;

   --                       raise e_erro;
                       -- erro ao inserir realizado func indicador
                        end if;

                    -- c_func_cargo
                    end loop;

                 --
                 exception
                    /*when e_erro then
                       raise e_erro;*/
                    when others then
                       p_cod_erro     := 1;
                       p_descr_erro   := 'Erro Geral ao calcular AGRUPAMENTO REM LOJA LIDER DOS LIDERES REGIONAIS / NACIONAIS ' ||
                                         ' cod_fil:  '    || v_cod_fil   ||
                                         ' cod_indic:  '  || v_cod_indic ||
                                         ' cod_cargo:  '  || v_cod_cargo ||
                                         ' cod_func:  '   || v_cod_func  ||
                                         ' erro: '        || sqlerrm;

                       -- enviar email
                       v_body       := p_cod_erro || ' - ' || p_descr_erro;

                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                               ,p_body    => v_body
                                                                               );

                       -- logar tabela
                       v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                 ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                                 ,p_num_ano     => p_num_ano
                                                                 ,p_num_mes     => p_num_mes
                                                                 ,p_cod_fil     => v_cod_fil
                                                                 ,p_cod_func    => v_cod_func
                                                                 ,p_cod_indic   => v_cod_indic
                                                                 ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                 );

                       if v_ins_log_erro is not null then
                          -- enviar email
                          v_body       := v_ins_log_erro;
                          --
                          v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                                  ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                  ,p_body    => v_body
                                                                                  );
                       --v_ins_log_erro is not null
                       end if;

  --                     raise e_erro;
                 --
                 end;

              -- c_cargo_grp_rem_var
              end loop;

              -- commit por indicador
              commit;

           -----------------------------------------------------
           -- c_indic_sistemico AGRUPAMENTO LOJA LIDER
           -----------------------------------------------------
           end loop;

        ----------------------------------------------------
        -- c_fil
        ----------------------------------------------------
        end loop;

        commit;

      Exception
        When others then
          null;
      end;

   exception
      when e_erro then

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

         --
         return;
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na procedure prc_calc_realz_Func_Indic_Lj: Calculo do realizado Funcionario Indicador Loja: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' ||
                           'cod_cargo: '         || v_cod_cargo           || ' - ' ||
                           'cod_func: '          || v_cod_func            || ' - ' || sqlerrm;

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception geral: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 69 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_LJ
                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


   end prc_calc_realz_Func_Indic_Lj;



   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO SAX
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_realz_Func_Indic_SAX (p_num_ano      in number
                                           ,p_num_mes      in number
                                           ,p_cod_emp      in number     default null
                                           ,p_cod_fil      in number     default null
                                           ,p_cod_indic    in number     default null
                                           ,p_descr_indic  in varchar2   default null
                                           ,p_cod_usuario  in number
                                           ,p_cod_erro     out number
                                           ,p_descr_erro   out varchar2
                                            ) is

      -- FILIAIS
      cursor c_fil (p_cod_emp number
                   ,p_cod_fil number) is
         select distinct f.cod_emp
                        ,f.cod_fil
                        ,0 as mes_inauguracao
                        ,f.cod_tipo_fil
           from srv_filial               f
               ,srv_realizado_filial     r
          where f.cod_emp              = r.cod_emp
            and f.cod_fil              = r.cod_fil
            and f.flg_ativ             = 'S'
            and (f.cod_emp             = p_cod_emp or p_cod_emp is null)
            and (f.cod_fil             = p_cod_fil or p_cod_fil is null)
            and r.num_ano              = p_num_ano
            and r.num_mes              = p_num_mes
       order by f.cod_fil;



      -- REMUNERACAO LOJAS
      cursor c_indic_rem_loja is
         select t.cod_tipo_rem_var
               ,t.descr_tipo_rem_var
               ,g.cod_grp_indic
               ,g.descr_grp_indic
               ,i.cod_indic
               ,i.descr_indic
           from srv_tipo_rem_var        t
               ,srv_grupo_indicador     g
               ,srv_indicador           i
          where t.cod_tipo_rem_var    = g.cod_tipo_rem_var
            and t.descr_tipo_rem_var  = 'REMUNERACAO_LOJA'
            and g.cod_grp_indic       = i.cod_grp_indic
            and i.cod_grp_indic       in (4,5,9,3) -- EP SAX , Seguro SAX e Indicacao EP
            and i.cod_indic_sis       = 'SAX_PSF'
            and (i.descr_indic        = p_descr_indic or p_descr_indic is null)
            and i.flg_indic_ativ      = 'S'
       order by g.cod_grp_indic
               ,i.cod_indic;



      -- var controle
      v_var_sql                        varchar2(4000);

      -- variaveis
      v_cod_grp_rem_var               srv_grupo_rem_variavel.cod_grp_rem_var%type;

      v_vlr_premio_fil_calc           srv_realizado_filial.vlr_premio_fil_calc%type;
      v_meta                          srv_realizado_filial.num_meta%type;
      v_cod_un_meta                   srv_realizado_filial.cod_un_meta%type;
      v_num_realz_fil                 srv_realizado_filial.num_realz%type;
      v_cod_un_realz                  srv_realizado_filial.cod_un_realz%type;
      v_qtd_realz                     srv_realizado_filial.qtd_realz%type;
      v_num_realz_x_meta              srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta           srv_realizado_filial.cod_un_realz_x_meta%type;

      v_cod_pond                      srv_ponderacao.cod_pond%type;
      v_num_peso                      srv_ponderacao.num_peso%type;
      v_cod_un_peso                   srv_ponderacao.cod_un_peso%type;
      v_vlr_premio                    srv_ponderacao.vlr_premio%type;

      v_vlr_premio_func_calc          srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_num_realz_pond                srv_realizado_func_indicador.num_realz_pond%type;
      v_num_realz_func                srv_realizado_func_indicador.num_realz%type;

      v_cod_func                      srv_funcionario.cod_func%type;
      v_cod_cargo_func                srv_funcionario.cod_cargo%type;
      v_quant_indic_func              srv_realizado_func_indicador.num_realz%type;

      -- indicacoes
      v_vr_desc_indic_func            srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_cod_grp_indic_indicacao       srv_grupo_indicador.cod_grp_indic%type;
      v_cod_grp_rem_var_indicacao     srv_grupo_rem_variavel.cod_grp_rem_var%type;
      v_cod_pond_indicacao            srv_ponderacao.cod_pond%type;
      v_num_peso_indicacao            srv_ponderacao.num_peso%type;
      v_cod_un_peso_indicacao         srv_ponderacao.cod_un_peso%type;
      v_num_realz_pond_indicacao      srv_realizado_func_indicador.num_realz_pond%type;
      v_vlr_premio_indicacao          srv_ponderacao.vlr_premio%type;
      v_num_realz_x_meta_limitador    srv_realizado_filial.num_realz_x_meta%type;

      v_cod_escala                    srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx             srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                  srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx               srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                   srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                 srv_escala_faixa.num_limite_fx%type;

      v_nm_tab_realz_fu                varchar2(30);
      v_nm_tab_realz_fi                varchar2(30);
      v_mes                            number;

      v_cod_grp_indic                 srv_grupo_indicador.cod_grp_indic%type;

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_descr_indic                    srv_indicador.descr_indic%type;
      v_cod_cargo                      srv_cargo.cod_cargo%type;


      -- records
      rec_srv_realizado_func_indic     srv_realizado_func_indicador%rowtype;

      -- cursores
      cur_realz                        pkg_srv_calc_rem_var.typ_cursor;





   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;

      -----------------------------------------------------------------------
      -- SELECIONA FILIAIS ATIVAS
      -----------------------------------------------------------------------
      for r_fil in c_fil (p_cod_emp
                         ,p_cod_fil) loop


         v_cod_fil          := r_fil.cod_fil;
         v_mes              := r_fil.mes_inauguracao;

         -----------------------------------------------------------------------
         -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
         -----------------------------------------------------------------------
         for r_indic_rem_loja in c_indic_rem_loja loop

            v_cod_grp_indic    := r_indic_rem_loja.cod_grp_indic;
            v_cod_indic        := r_indic_rem_loja.cod_indic;


            ---------------------------------------------------------------------------
            -- SELECIONA META E REALIZADO DA FILIAL PARA EP SAX
            -- E PARA INDICACAO EP SAX E O MESMO DO EP SAX
            --------------------------------------------------------------------------
            if r_indic_rem_loja.descr_indic in ('EMPRESTIMO PESSOAL (EP) SAX / PSF'
                                               ,'INDICACAO EMPRESTIMO PESSOAL (EP) SAX / PSF') then

               -- seleciona realz X meta e vlr premio calculado da filial
               -- SEMPRE do indicador SAX EP
               begin
                  v_descr_indic := 'EMPRESTIMO PESSOAL (EP) SAX';
                  --v_descr_indic := r_indic_rem_loja.descr_indic;

                  select a.vlr_premio_fil_calc
                        ,a.num_meta
                        ,a.cod_un_meta
                        ,a.num_realz
                        ,a.cod_un_realz
                        ,a.qtd_realz
                        ,a.num_realz_x_meta
                        ,a.cod_un_realz_x_meta
                    into v_vlr_premio_fil_calc
                        ,v_meta
                        ,v_cod_un_meta
                        ,v_num_realz_fil
                        ,v_cod_un_realz
                        ,v_qtd_realz
                        ,v_num_realz_x_meta
                        ,v_cod_un_realz_x_meta
                    from srv_realizado_filial a
                        ,srv_indicador        b
                   where a.cod_indic        = b.cod_indic
                     and a.cod_emp          = r_fil.cod_emp
                     and a.cod_fil          = r_fil.cod_fil
                     and b.descr_indic      = v_descr_indic --r_indic_rem_loja.descr_indic
                     and a.num_ano          = p_num_ano
                     and a.num_mes          = p_num_mes;
               exception
                  when no_data_found then
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;
                  when others then
                     --
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;

                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao selecionar a tabela srv_realizado_filial ' ||
                                       ' cod_fil -  '                                       || r_fil.cod_fil ||
                                       ' descr_indic -  '                                   || v_descr_indic || --r_indic_rem_loja.descr_indic ||
                                       ' erro - '                                           || sqlerrm;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
               -- seleciona realz X meta e vlr premio calculado da filial
               end;

            -- if indicador EP SAX OU INDICACAO EP SAX
            end if;

            --------------------------------------------------------
            -- SE INDICADOR EMPRESTIMO PESSOAL (EP) SAX
            --------------------------------------------------------
            if r_indic_rem_loja.descr_indic in ('EMPRESTIMO PESSOAL (EP) SAX / PSF') then

               --------------------------------------------------------------------------
               -- CARGOS OPERACIONAIS - EMPRESTIMO PESSOAL (EP) SAX
               --------------------------------------------------------------------------
               begin
                  -- seleciona o cod grupo rem var para OPERACIONAL_SAX EP
                  select a.cod_grp_rem_var
                    into v_cod_grp_rem_var--7
                    from srv_grupo_rem_variavel a
                   where a.descr_grp_rem_var = 'OPERACIONAL_SAX_EP';

                  -- selecionar a ponderacao para o grupo rem var e para o indicador
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_ponderacao (p_cod_indic         => null
                                      ,p_cod_grp_indic     => (case when r_indic_rem_loja.cod_grp_indic = 3 then 4 end)
                                      ,p_cod_cargo         => null
                                      ,p_cod_grp_rem_var   => v_cod_grp_rem_var
                                      ,p_cod_pond          => v_cod_pond
                                      ,p_num_peso          => v_num_peso
                                      ,p_cod_un_peso       => v_cod_un_peso
                                      ,p_vlr_premio        => v_vlr_premio
                                      ,p_cod_erro          => p_cod_erro
                                      ,p_descr_erro        => p_descr_erro
                                      );
                  --
                  if  p_cod_erro is not null then

                     --
                     v_num_peso   := 0;
                     v_vlr_premio := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                      raise e_erro;
                  -- erro o calcular ponderacao
                  end if;



                  -----------------------------------------------------------------------
                  -- SELECIONA A O VALOR DO PREMIO DA INDICACAO
                  -----------------------------------------------------------------------
                  -- seleciona o cod grupo rem var para OPERACIONAL_SAX_INDICACAO_EP
                  begin
                     select a.cod_grp_rem_var
                       into v_cod_grp_rem_var_indicacao
                       from srv_grupo_rem_variavel a
                      where a.descr_grp_rem_var = 'OPERACIONAL_SAX_INDICACAO_EP'; -- 12
                  exception
                     when others then
                        v_cod_grp_rem_var_indicacao := 12;
                  end;
                  --
                  begin
                     select cod_grp_indic
                       into v_cod_grp_indic_indicacao
                       from srv_grupo_indicador
                      where descr_grp_indic  = 'INDICACAO_EMPRESTIMO_PESSOAL_SAX'; -- 9
                  exception
                     when others then
                        v_cod_grp_indic_indicacao := 9;
                  end;

                  -- selecionar a ponderacao para o grupo rem var e para o indicador
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_ponderacao (p_cod_indic         => null
                                      ,p_cod_grp_indic     => v_cod_grp_indic_indicacao
                                      ,p_cod_cargo         => null
                                      ,p_cod_grp_rem_var   => v_cod_grp_rem_var_indicacao
                                      ,p_cod_pond          => v_cod_pond_indicacao
                                      ,p_num_peso          => v_num_peso_indicacao
                                      ,p_cod_un_peso       => v_cod_un_peso_indicacao
                                      ,p_vlr_premio        => v_vlr_premio_indicacao
                                      ,p_cod_erro          => p_cod_erro
                                      ,p_descr_erro        => p_descr_erro
                                      );
                  --
                  if  p_cod_erro is not null then

                     --
                     v_num_peso   := 0;
                     v_vlr_premio := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => 54 --v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                      raise e_erro;
                  -- erro o calcular ponderacao INDICACAO
                  end if;


                  ------------------------
                  -- SELECIONAR A ESCALA
                  ------------------------
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_escala_fx (null                           -- ALT201402 p_cod_indic
                                     ,null                           --p_cod_grp_indic
                                     ,v_cod_grp_rem_var              --p_cod_grp_rem_var
                                     ,v_num_realz_x_meta             --p_num_realz_x_meta
                                     ,v_cod_escala
                                     ,v_num_seq_escala_fx
                                     ,v_num_realz_fx
                                     ,v_cod_un_realz_fx
                                     ,v_flg_pct_100
                                     ,v_num_limite_fx
                                     ,p_cod_erro
                                     ,p_descr_erro
                                     );
                  if p_cod_erro is not null then

                     --
                     v_num_realz_fx := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
                  -- erro ao calcular escala
                  end if;

                  -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                  -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                  if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                     --
                     v_num_realz_fx := v_num_realz_x_meta;
                  end if;

                  -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                  -- entao assumir o valor limite
                  if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx and v_mes <= 6 then
                     --
                     v_num_realz_fx := v_num_limite_fx;
                  end if;

                  -- calcula valor unitario para multiplicar pela qtde
                  begin
                     v_num_realz_pond            := (v_vlr_premio           * v_num_realz_fx)/100;
                     v_num_realz_pond_indicacao  := (v_vlr_premio_indicacao * v_num_realz_fx)/100;

                  --
                  exception
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao calcular num realz pond para EP Sax Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;

--                        raise e_erro;
                  --calcula valor unitario para multiplicar pela qtde
                  end;


                  begin
                     -- tabela gerada de apuracao realizado para o indicador
                     select a.nm_tab_realz_fil  ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                           ,a.nm_tab_realz_func ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                       into v_nm_tab_realz_fi
                           ,v_nm_tab_realz_fu
                       from srv_realizado_tab_tmp a
                      where a.cod_indic         = r_indic_rem_loja.cod_indic;


                     -- selecionar todos os funcionarios dos cargos do grupo de remuneracao SAX EP para a filial,
                     v_var_sql :=              '  select b.cod_func                                                    ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,b.cod_cargo                                                   ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,nvl(count(a.cod_contrato),0) as qtde                          ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,nvl(f.quant_indicacoes,0)    as quant_indicacoes              ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    from ' || v_nm_tab_realz_fu || '  a                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_funcionario              b                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_cargo                    c                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_grupo_cargo              d                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_grupo_rem_variavel       e                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,(select g.fil_cod                                             ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '                ,g.cpf_vendedor                                        ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '                ,nvl(count(g.cpf_usu_indicador),0) as quant_indicacoes ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '            from ' || v_nm_tab_realz_fu || '       g                   ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '           where g.cpf_usu_indicador is not null                       ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '             and g.cpf_usu_indicador <> g.cpf_vendedor                 ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       group by  g.fil_cod                                             ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '                ,g.cpf_vendedor                                        ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '         ) f                                                           ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '   where a.cpf_vendedor                  = b.num_cpf_func              ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and b.cod_cargo                     = c.cod_cargo                 ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and c.cod_cargo                     = d.cod_cargo                 ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and d.cod_grp_rem_var               = e.cod_grp_rem_var           ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and nvl(c.flg_agrupa_fil_lider, ''N'') = ''N'' -- operacional     ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and e.cod_grp_rem_var                  =     ' || v_cod_grp_rem_var || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.fil_cod                        = f.fil_cod      (+)         ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.cpf_vendedor                   = f.cpf_vendedor (+)         ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.flg_doc_digitalizado = ''S''                                ' || chr(13) || chr(10);
										 v_var_sql := v_var_sql || '     and a.fil_cod                          =         ' || r_fil.cod_fil || chr(13) || chr(10);

                     v_var_sql := v_var_sql || '
             -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'23:59:59'',''dd/mm/yyyy hh24:mi:ss''))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date(''01/'||trim(to_char(p_num_mes, '00'))||'/'||trim(to_char(p_num_ano, '0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                  OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss''))
                                                  >= to_date(''02/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                  )
                 )
                )' || chr(13) || chr(10);


                     v_var_sql := v_var_sql || ' group by b.cod_func                                                   ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '         ,b.cod_cargo                                                  ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '         ,nvl(f.quant_indicacoes,0)                                    ' || chr(13) || chr(10);

                     open cur_realz for v_var_sql;
                     loop
                        fetch cur_realz
                         into  v_cod_func
                              ,v_cod_cargo_func
                              ,v_num_realz_func
                              ,v_quant_indic_func;

                        --
                        exit when cur_realz%notfound;


                        --
                        v_cod_un_realz := 3; --unidade UNIDADE

                        -- calcula o valor das indicacoes para subtrair do valor do cpf_vendedor
                        v_vr_desc_indic_func    := v_quant_indic_func * v_num_realz_pond_indicacao; --v_vlr_premio_indicacao;
                        --
                        v_vlr_premio_func_calc  := v_num_realz_func   * v_num_realz_pond;

                        -- subtrair o valor do descontos do valor das indicacoes
                        v_vlr_premio_func_calc := v_vlr_premio_func_calc - v_vr_desc_indic_func;
                        -- se valor negativo considerar zero
                        if v_vlr_premio_func_calc < 0 then
                           v_vlr_premio_func_calc := 0;
                        end if;

                        -- gravar na srv_realizado_func_indicador
                        rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                        rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                        rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                        rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                        rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                        -- indicacoes
                        rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                        rec_srv_realizado_func_indic.vlr_desc_indicacao      := v_vr_desc_indic_func;
                        rec_srv_realizado_func_indic.qtd_desc_indicacao      := v_quant_indic_func;
                        --
                        rec_srv_realizado_func_indic.cod_func                := v_cod_func;
                        rec_srv_realizado_func_indic.cod_cargo               := v_cod_cargo_func;
                        rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                        rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                        rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                        rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                        rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                        rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                        rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                        rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                        rec_srv_realizado_func_indic.cod_un_realz_pond       := 1; -- unidade VALOR

                        rec_srv_realizado_func_indic.num_meta                := v_meta;
                        rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                        rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
                        rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                        rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                        rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                        rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                        rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                        rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                        rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                        rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;


                        -- inserir o realizado do funcionario pelo indicador
                        prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                    ,p_cod_erro                  => p_cod_erro
                                                    ,p_descr_erro                => p_descr_erro
                                                     );
                        --
                        if p_cod_erro is not null then

                           -- enviar email
                           v_body       := p_cod_erro || ' - ' || p_descr_erro;

                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                   ,p_body    => v_body
                                                                                   );

                           -- logar tabela
                           v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                     ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                     ,p_num_ano     => p_num_ano
                                                                     ,p_num_mes     => p_num_mes
                                                                     ,p_cod_fil     => v_cod_fil
                                                                     ,p_cod_func    => v_cod_func
                                                                     ,p_cod_indic   => v_cod_indic
                                                                     ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                     );

                           if v_ins_log_erro is not null then
                              -- enviar email
                              v_body       := v_ins_log_erro;
                              --
                              v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                      ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                      ,p_body    => v_body
                                                                                      );
                           --v_ins_log_erro is not null
                           end if;

--                           raise e_erro;
                        -- erro ao inserir realizado func indicador
                        end if;

                        --

                     -- cur_venda
                     end loop;
                     --
                     close cur_realz;

                     --
                     commit;

                  --
                  exception
                     /*when e_erro then
                        raise e_erro;*/
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao inserir Emprestimo Pessoal SAX Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' cod_func:  '   || v_cod_func  ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;


--                        raise e_erro;
                  --
                  end;

               --
               exception
                  /*when e_erro then
                     raise e_erro;*/
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro Geral ao calcular indicador Emprestimo Pessoal SAX Cargos Operacionais' ||
                                       ' cod_fil:  '    || v_cod_fil   ||
                                       ' cod_indic:  '  || v_cod_indic ||
                                       ' erro: '        || sqlerrm;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

               end;


            --------------------------------------------------------
            -- SE INDICADOR INDICACAO EMPRESTIMO PESSOAL (EP) SAX
            --------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic in('INDICACAO EMPRESTIMO PESSOAL (EP) SAX / PSF') then

               --------------------------------------------------------------------------
               -- CARGOS OPERACIONAIS - INDICACAO EMPRESTIMO PESSOAL (EP) SAX
               --------------------------------------------------------------------------
               begin
                  -- seleciona o cod grupo rem var para OPERACIONAL_SAX_INDICACAO_EP
                  select a.cod_grp_rem_var
                    into v_cod_grp_rem_var
                    from srv_grupo_rem_variavel a
                   where a.descr_grp_rem_var = 'OPERACIONAL_SAX_INDICACAO_EP'; -- 12

                  -- selecionar a ponderacao para o grupo rem var e para o indicador
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_ponderacao (p_cod_indic         => null
                                      ,p_cod_grp_indic     => (case when r_indic_rem_loja.cod_grp_indic = 3 then 9 end)
                                      ,p_cod_cargo         => null
                                      ,p_cod_grp_rem_var   => v_cod_grp_rem_var
                                      ,p_cod_pond          => v_cod_pond
                                      ,p_num_peso          => v_num_peso
                                      ,p_cod_un_peso       => v_cod_un_peso
                                      ,p_vlr_premio        => v_vlr_premio
                                      ,p_cod_erro          => p_cod_erro
                                      ,p_descr_erro        => p_descr_erro
                                      );
                  --
                  if  p_cod_erro is not null then

                     --
                     v_num_peso   := 0;
                     v_vlr_premio := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                      raise e_erro;
                  -- erro o calcular ponderacao
                  end if;


                  ------------------------
                  -- SELECIONAR A ESCALA
                  ------------------------
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_escala_fx (null--r_indic_rem_loja.cod_indic                           -- Alt201402 p_cod_indic
                                     ,null                           --p_cod_grp_indic
                                     ,v_cod_grp_rem_var              --p_cod_grp_rem_var
                                     ,v_num_realz_x_meta             --p_num_realz_x_meta
                                     ,v_cod_escala
                                     ,v_num_seq_escala_fx
                                     ,v_num_realz_fx
                                     ,v_cod_un_realz_fx
                                     ,v_flg_pct_100
                                     ,v_num_limite_fx
                                     ,p_cod_erro
                                     ,p_descr_erro
                                     );
                  if p_cod_erro is not null then

                     --
                     v_num_realz_fx := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
                  -- erro ao calcular escala
                  end if;

                  -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                  -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                  if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                     --
                     v_num_realz_fx := v_num_realz_x_meta;
                  end if;

                  -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                  -- entao assumir o valor limite
                  if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                     --
                     v_num_realz_fx := v_num_limite_fx;
                  end if;

                  -- calcula valor unitario para multiplicar pela qtde
                  begin
                     v_num_realz_pond            := (v_vlr_premio           * v_num_realz_fx)/100;
                  --
                  exception
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao calcular num realz pond para INDICACAO EP Sax Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;

--                        raise e_erro;
                  --calcula valor unitario para multiplicar pela qtde
                  end;


                  begin
                     -- tabela gerada de apuracao realizado para o indicador
                     select a.nm_tab_realz_fil  ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                           ,a.nm_tab_realz_func ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                       into v_nm_tab_realz_fi
                           ,v_nm_tab_realz_fu
                       from srv_realizado_tab_tmp a
                      where a.cod_indic         = r_indic_rem_loja.cod_indic;


                     -- selecionar todos os funcionarios dos cargos do grupo de remuneracao INDICACAO SAX EP para a filial,
                     v_var_sql :=              '  select b.cod_func                                                    ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,b.cod_cargo                                                   ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,nvl(count(a.cod_contrato),0) as qtde                          ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    from ' || v_nm_tab_realz_fu || '  a                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_funcionario              b                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_cargo                    c                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_grupo_cargo              d                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,srv_grupo_rem_variavel       e                                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '   where a.cpf_usu_indicador              = b.num_cpf_func             ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and b.cod_cargo                      = c.cod_cargo                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and c.cod_cargo                      = d.cod_cargo                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and d.cod_grp_rem_var                = e.cod_grp_rem_var          ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and nvl(c.flg_agrupa_fil_lider, ''N'') = ''N''                    ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and e.cod_grp_rem_var                  =     ' || v_cod_grp_rem_var || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.cpf_usu_indicador                is not null                ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.cpf_usu_indicador               <> a.cpf_vendedor           ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '     and a.fil_cod                          =         ' || r_fil.cod_fil || chr(13) || chr(10);

                     v_var_sql := v_var_sql || '
             -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'23:59:59'',''dd/mm/yyyy hh24:mi:ss''))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date(''01/'||trim(to_char(p_num_mes, '00'))||'/'||trim(to_char(p_num_ano, '0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                  OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss''))
                                                  >= to_date(''02/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                  )
                 )
                )' || chr(13) || chr(10);

                     v_var_sql := v_var_sql || ' group by b.cod_func                                                   ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '         ,b.cod_cargo                                                  ' || chr(13) || chr(10);


                     open cur_realz for v_var_sql;
                     loop
                        fetch cur_realz
                         into  v_cod_func
                              ,v_cod_cargo_func
                              ,v_num_realz_func;

                        --
                        exit when cur_realz%notfound;

                        -- calcula a apuracao feita pelo indicador
                        v_cod_un_realz := 3; --unidade UNIDADE
                        --
                        v_vlr_premio_func_calc                               := v_num_realz_func * v_num_realz_pond;
                        -- se valor negativo considerar zero
                        if v_vlr_premio_func_calc < 0 then
                           v_vlr_premio_func_calc := 0;
                        end if;

                        -- gravar na srv_realizado_func_indicador
                        rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                        rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                        rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                        rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                        rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;

                        rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                        rec_srv_realizado_func_indic.vlr_desc_indicacao      := null;
                        rec_srv_realizado_func_indic.qtd_desc_indicacao      := null;

                        rec_srv_realizado_func_indic.cod_func                := v_cod_func;
                        rec_srv_realizado_func_indic.cod_cargo               := v_cod_cargo_func;
                        rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                        rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                        rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                        rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                        rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                        rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                        rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                        rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                        rec_srv_realizado_func_indic.cod_un_realz_pond       := 1; -- unidade VALOR

                        rec_srv_realizado_func_indic.num_meta                := v_meta;
                        rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                        rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
                        rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                        rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                        rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                        rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                        rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                        rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                        rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                        rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;


                        -- inserir o realizado do funcionario pelo indicador
                        prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                    ,p_cod_erro                  => p_cod_erro
                                                    ,p_descr_erro                => p_descr_erro
                                                     );
                        --
                        if p_cod_erro is not null then

                           -- enviar email
                           v_body       := p_cod_erro || ' - ' || p_descr_erro;

                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                   ,p_body    => v_body
                                                                                   );

                           -- logar tabela
                           v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                     ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                     ,p_num_ano     => p_num_ano
                                                                     ,p_num_mes     => p_num_mes
                                                                     ,p_cod_fil     => v_cod_fil
                                                                     ,p_cod_func    => v_cod_func
                                                                     ,p_cod_indic   => v_cod_indic
                                                                     ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                     );

                           if v_ins_log_erro is not null then
                              -- enviar email
                              v_body       := v_ins_log_erro;
                              --
                              v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                      ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                      ,p_body    => v_body
                                                                                      );
                           --v_ins_log_erro is not null
                           end if;

--                           raise e_erro;
                        -- erro ao inserir realizado func indicador
                        end if;

                        --

                     -- cur_venda
                     end loop;
                     --
                     close cur_realz;

                     --
                     commit;

                  --
                  exception
                     /*when e_erro then
                        raise e_erro;*/
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao inserir INDICACAO EP SAX Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' cod_func:  '   || v_cod_func  ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;


--                        raise e_erro;
                  --
                  end;

               --
               exception
                  /*when e_erro then
                     raise e_erro;*/
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro Geral ao calcular indicador INDICACAO EP SAX Cargos Operacionais' ||
                                       ' cod_fil:  '    || v_cod_fil   ||
                                       ' cod_indic:  '  || v_cod_indic ||
                                       ' erro: '        || sqlerrm;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
               --
               end;



            --------------------------------------------------------
            -- SE INDICADOR SEGURO EMPRESTIMO PESSOAL (EP) SAX
            --------------------------------------------------------
            elsif r_indic_rem_loja.descr_indic in('SEGURO EMPRESTIMO PESSOAL (EP) SAX / PSF') then

               v_descr_indic := 'SEGURO EMPRESTIMO PESSOAL (EP) SAX';
               -- seleciona realz X meta e vlr premio calculado da filial
               begin
                  select a.vlr_premio_fil_calc
                        ,a.num_meta
                        ,a.cod_un_meta
                        ,a.num_realz
                        ,a.cod_un_realz
                        ,a.qtd_realz
                        ,a.num_realz_x_meta
                        ,a.cod_un_realz_x_meta
                    into v_vlr_premio_fil_calc
                        ,v_meta
                        ,v_cod_un_meta
                        ,v_num_realz_fil
                        ,v_cod_un_realz
                        ,v_qtd_realz
                        ,v_num_realz_x_meta
                        ,v_cod_un_realz_x_meta
                    from srv_realizado_filial a
                        ,srv_indicador        b
                   where a.cod_indic        = b.cod_indic
                     and a.cod_emp          = r_fil.cod_emp
                     and a.cod_fil          = r_fil.cod_fil
                     and b.descr_indic      = v_descr_indic--r_indic_rem_loja.descr_indic
                     and a.num_ano          = p_num_ano
                     and a.num_mes          = p_num_mes;
               exception
                  when no_data_found then
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;
                  when others then
                     --
                     v_vlr_premio_fil_calc := 0;
                     v_meta                := 0;
                     v_cod_un_meta         := null;
                     v_num_realz_fil       := 0;
                     v_cod_un_realz        := null;
                     v_qtd_realz           := 0;
                     v_num_realz_x_meta    := 0;
                     v_cod_un_realz_x_meta := null;

                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao selecionar a tabela srv_realizado_filial ' ||
                                       ' cod_fil -  '                                       || r_fil.cod_fil ||
                                       ' cod_indic -  '                                     || r_indic_rem_loja.descr_indic ||
                                       ' erro - '                                           || sqlerrm;


                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;

               --seleciona realz X meta e vlr premio calculado da filial
               end;

               --------------------------------------------------------------------------
               -- CARGOS OPERACIONAIS - SEGURO EMPRESTIMO PESSOAL (EP) SAX
               --------------------------------------------------------------------------
               begin
                  -- seleciona o cod grupo rem var
                  begin
                     select a.cod_grp_rem_var
                      into v_cod_grp_rem_var
                      from srv_grupo_rem_variavel a
                     where a.descr_grp_rem_var = 'OPERACIONAL_SAX_SEGURO (EP)';
                  exception
                     when others then
                        v_cod_grp_rem_var := 11;
                  end;

                  -- selecionar a ponderacao para o cod_grp_rem_var e para o cod_grp_indic
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_ponderacao (p_cod_indic         => null
                                      ,p_cod_grp_indic     => (case when r_indic_rem_loja.cod_grp_indic = 3 then 5 end)
                                      ,p_cod_cargo         => null
                                      ,p_cod_grp_rem_var   => v_cod_grp_rem_var
                                      ,p_cod_pond          => v_cod_pond
                                      ,p_num_peso          => v_num_peso
                                      ,p_cod_un_peso       => v_cod_un_peso
                                      ,p_vlr_premio        => v_vlr_premio
                                      ,p_cod_erro          => p_cod_erro
                                      ,p_descr_erro        => p_descr_erro
                                      );



                  --
                  if  p_cod_erro is not null then
                     --
                     v_num_peso   := 0;
                     v_vlr_premio := 0;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                      raise e_erro;
                  -- erro ao calcular ponderacao
                  end if;


                  --
                  p_cod_erro         := null;
                  p_descr_erro       := null;
                  --
                  prc_calc_escala_fx (null --r_indic_rem_loja.cod_indic                           -- Alt201402 p_cod_indic
                                     ,null                           --p_cod_grp_indic
                                     ,v_cod_grp_rem_var              --p_cod_grp_rem_var
                                     ,v_num_realz_x_meta             --p_num_realz_x_meta
                                     ,v_cod_escala
                                     ,v_num_seq_escala_fx
                                     ,v_num_realz_fx
                                     ,v_cod_un_realz_fx
                                     ,v_flg_pct_100
                                     ,v_num_limite_fx
                                     ,p_cod_erro
                                     ,p_descr_erro
                                     );
                  if p_cod_erro is not null then
                     --
                     v_num_realz_fx := 0;

                    -- enviar email
                    v_body       := p_cod_erro || ' - ' || p_descr_erro;

                    v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                            ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                            ,p_body    => v_body
                                                                            );

                    -- logar tabela
                    v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                              ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                              ,p_num_ano     => p_num_ano
                                                              ,p_num_mes     => p_num_mes
                                                              ,p_cod_fil     => v_cod_fil
                                                              ,p_cod_func    => v_cod_func
                                                              ,p_cod_indic   => v_cod_indic
                                                              ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                              );

                    if v_ins_log_erro is not null then
                       -- enviar email
                       v_body       := v_ins_log_erro;
                       --
                       v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                               ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                               ,p_body    => v_body
                                                                               );
                    --v_ins_log_erro is not null
                    end if;

--                     raise e_erro;
                  -- erro ao calcular escala
                  end if;

                  -- verifica se a faixa deve seguir a proporcionalidade apos 100%
                  -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
                  if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                     --
                     v_num_realz_fx := v_num_realz_x_meta;
                  end if;

                  -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
                  -- entao assumir o valor limite
                  if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                     --
                     v_num_realz_fx := v_num_limite_fx;
                  end if;

                  begin
                     -- calcula valor unitario para multiplicar pela qtde
                     v_num_realz_pond  := (v_vlr_premio * v_num_realz_fx)/100;
                  --
                  exception
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao calcular valor unitario para Seguro EP Sax Cargos Operacionais' ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;


--                        raise e_erro;
                  -- calcula valor unitario para multiplicar pela qtde
                  end;

                  --
                  begin
                     -- tabela gerada de apuracao realizado para o indicador
                     select a.nm_tab_realz_fil  ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                           ,a.nm_tab_realz_func ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                       into v_nm_tab_realz_fi
                           ,v_nm_tab_realz_fu
                       from srv_realizado_tab_tmp a
                      where a.cod_indic         = r_indic_rem_loja.cod_indic;


                     -- selecionar todos os funcionarios desse cargo para essa filial e
                     v_var_sql :=              ' select b.cod_func '                      || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,b.cod_cargo '                     || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,nvl(count(a.cod_contrato),0) as qtde ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '   from ' || v_nm_tab_realz_fu || '   a ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,srv_funcionario               b ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,srv_cargo                     c ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,srv_grupo_cargo               d ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '       ,srv_grupo_rem_variavel        e ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '  where a.cpf_vendedor    = b.num_cpf_func ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and b.cod_cargo       = c.cod_cargo ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and c.cod_cargo       = d.cod_cargo ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and d.cod_grp_rem_var = e.cod_grp_rem_var ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and a.seguro          = ''S''                  ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and a.flg_doc_digitalizado = ''S''             ' || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and nvl(c.flg_agrupa_fil_lider, ''N'') = ''N'''  || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and e.cod_grp_rem_var =   ' || v_cod_grp_rem_var || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '    and a.fil_cod =           ' || r_fil.cod_fil     || chr(13) || chr(10);

                     v_var_sql := v_var_sql || '
             -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'23:59:59'',''dd/mm/yyyy hh24:mi:ss''))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date(''01/'||trim(to_char(p_num_mes, '00'))||'/'||trim(to_char(p_num_ano, '0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                  OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date(''01/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss''))
                                                  >= to_date(''02/'||trim(to_char(p_num_mes,'00'))||'/'||trim(to_char(p_num_ano,'0000'))||'00:00:00'',''dd/mm/yyyy hh24:mi:ss'')
                  )
                 )
                )' || chr(13) || chr(10);

                     v_var_sql := v_var_sql || 'group by b.cod_func '           || chr(13) || chr(10);
                     v_var_sql := v_var_sql || '        ,b.cod_cargo '          || chr(13) || chr(10);


                     open cur_realz for v_var_sql;
                     loop
                        fetch cur_realz
                         into  v_cod_func
                              ,v_cod_cargo_func
                              ,v_num_realz_func;
                        --
                        exit when cur_realz%notfound;

                        --
                        v_cod_un_realz := 3; --unidade UNIDADE
                        --
                        v_vlr_premio_func_calc := v_num_realz_func * v_num_realz_pond;

                        -- gravar na srv_realizado_func_indicador
                        rec_srv_realizado_func_indic.cod_func                := v_cod_func;
                        rec_srv_realizado_func_indic.cod_cargo               := v_cod_cargo_func;
                        rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                        rec_srv_realizado_func_indic.cod_emp                 := r_fil.cod_emp;
                        rec_srv_realizado_func_indic.cod_fil                 := r_fil.cod_fil;
                        rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                        rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                        rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
                        rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
                        rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
                        rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

                        rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
                        rec_srv_realizado_func_indic.num_peso                := v_num_peso;
                        rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
                        rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
                        rec_srv_realizado_func_indic.cod_un_realz_pond       := 1; -- unidade VALOR

                        rec_srv_realizado_func_indic.num_meta                := v_meta;
                        rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
                        rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
                        rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
                        rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
                        rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

                        rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                        -- se valor negativo considerar zero
                        if v_vlr_premio_func_calc < 0 then
                           v_vlr_premio_func_calc := 0;
                        end if;
                        rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                        rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                        rec_srv_realizado_func_indic.pct_calc_rateio         := null;
                        rec_srv_realizado_func_indic.vlr_desc_indicacao      := null;
                        rec_srv_realizado_func_indic.qtd_desc_indicacao      := null;

                        rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                        rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;


                        -- inserir o realizado do funcionario pelo indicador
                        prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                                    ,p_cod_erro                  => p_cod_erro
                                                    ,p_descr_erro                => p_descr_erro
                                                     );
                        --
                        if p_cod_erro is not null then

                           -- enviar email
                           v_body       := p_cod_erro || ' - ' || p_descr_erro;

                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                   ,p_body    => v_body
                                                                                   );

                           -- logar tabela
                           v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                     ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                     ,p_num_ano     => p_num_ano
                                                                     ,p_num_mes     => p_num_mes
                                                                     ,p_cod_fil     => v_cod_fil
                                                                     ,p_cod_func    => v_cod_func
                                                                     ,p_cod_indic   => v_cod_indic
                                                                     ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                     );

                           if v_ins_log_erro is not null then
                              -- enviar email
                              v_body       := v_ins_log_erro;
                              --
                              v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                      ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                      ,p_body    => v_body
                                                                                      );
                           --v_ins_log_erro is not null
                           end if;

--                           raise e_erro;
                        -- erro ao inserir realizado func indicador
                        end if;

                        --


                     -- cur_venda
                     end loop;
                     --
                     close cur_realz;

                     --
                     commit;

                  --
                  exception
                     /*when e_erro then
                        raise e_erro;*/
                     when others then
                        p_cod_erro     := 1;
                        p_descr_erro   := 'Erro ao inserir Seguro EP SAX Cargos Operacionais' ||
                                          ' num_ano: '     || p_num_ano ||
                                          ' num_mes: '     || p_num_mes ||
                                          ' cod_fil:  '    || v_cod_fil   ||
                                          ' cod_indic:  '  || v_cod_indic ||
                                          ' cod_func:  '   || v_cod_func  ||
                                          ' erro: '        || sqlerrm;

                        -- enviar email
                        v_body       := p_cod_erro || ' - ' || p_descr_erro;

                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                                ,p_body    => v_body
                                                                                );

                        -- logar tabela
                        v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                                  ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                                  ,p_num_ano     => p_num_ano
                                                                  ,p_num_mes     => p_num_mes
                                                                  ,p_cod_fil     => v_cod_fil
                                                                  ,p_cod_func    => v_cod_func
                                                                  ,p_cod_indic   => v_cod_indic
                                                                  ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                                  );

                        if v_ins_log_erro is not null then
                           -- enviar email
                           v_body       := v_ins_log_erro;
                           --
                           v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                   ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                   ,p_body    => v_body
                                                                                   );
                        --v_ins_log_erro is not null
                        end if;

--                        raise e_erro;
                  --
                  end;

               --
               exception
                  /*when e_erro then
                     raise e_erro;*/
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro Geral ao calcular indicador Seguro EP SAX Cargos Operacionais' ||
                                       ' cod_fil:  '    || v_cod_fil   ||
                                       ' cod_indic:  '  || v_cod_indic ||
                                       ' erro: '        || sqlerrm;


                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                             ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                               ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                                ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

               end;


            ---------------------------------------------------------
            -- if p_descr_indic = EMPRESTIMO PESSOAL (EP) SAX, etc...
            ---------------------------------------------------------
            end if;

            -- commit por indicador
            commit;

         ------------------------------------------------------------
         -- c_indic_rem_loja
         ------------------------------------------------------------
         end loop;


         ---------------------------------------------
         -- commit por filial
         ---------------------------------------------
         commit;

      ------------------------------------------------
      -- c_fil
      ------------------------------------------------
      end loop;

      --
      commit;

   exception
      when e_erro then

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                   ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

         --
         return;
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na procedure prc_calc_realz_Func_Indic_SAX: Calculo do realizado Funcionario Indicador Loja: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' ||
                           'cod_cargo: '         || v_cod_cargo           || ' - ' ||
                           'cod_func: '          || v_cod_func            || ' - ' || sqlerrm;

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                 ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro exception geral: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                   ,p_nome_proc   => 'prc_calc_realz_Func_Indic_SAX'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 74 -- SRV - prc_calc_realz_Func_Indic_SAX
                                                                    ,p_subject => 'SRV Calculo Realizado Func Indicador - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


   end prc_calc_realz_Func_Indic_SAX;

   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO CALL CENTER
   -----------------------------------------------------------------------------------------------



   --#######################################
   --Lider
   --#######################################


   --#########################################################
   --Assistente
   --#########################################################



   --################################
   --Coordenador
   --################################


  -----------------------------------------------------------------------------------------------
  -- CALCULO TRIMESTRAL DO CALL CENTER
  -----------------------------------------------------------------------------------------------


   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO CORPORATIVO
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_realz_Func_Indic_Corp (p_num_ano        in number
                                            ,p_num_mes        in number
                                            ,p_cod_fil        in number
                                            ,p_cod_cargo      in number    default null
                                            ,p_cod_func       in number    default null
                                            ,p_sta_calc_realz in number    default null
                                            ,p_cod_usuario    in number
                                            ,p_cod_erro       out number
                                            ,p_descr_erro     out varchar2
                                            ) is


      cursor c_func_cargo_indic (p_cod_cargo number
                                ,p_cod_func  number
                                ,p_num_ano   number
                                ,p_num_mes   number
                                ,p_cod_fil   number) is
         select distinct b.cod_cargo
               ,b.cod_func
               ,b.cod_emp
               ,f.cod_fil
               ,f.cod_indic
               ,g.cod_grp_indic
               ,d.cod_grp_rem_var
               ,f.num_ano
               ,f.num_mes
               ,f.num_peso
               ,f.cod_un_peso
               ,f.num_meta
               ,f.cod_un_meta
               ,f.descr_meta
               ,nvl(f.num_realz_x_meta, 0) num_realz_x_meta
               ,f.cod_un_realz_x_meta
               ,g.cod_escala
               ,k.flg_aplica_fx_result_no_realz
               ,f.num_realz
               ,f.cod_un_realz
           from srv_funcionario              b
               ,srv_cargo                    c
               ,srv_grupo_cargo              d
               ,srv_grupo_rem_variavel       e
               ,srv_realizado_func_indicador f
               ,srv_indicador                g
               ,srv_grupo_indicador          h
               ,srv_grp_indic_grp_rem_var    i
               ,srv_escala                   k
          where b.cod_cargo               = c.cod_cargo
            and c.cod_cargo               = d.cod_cargo
            and d.cod_grp_rem_var         = e.cod_grp_rem_var
            and b.cod_func                = f.cod_func
            and f.cod_indic               = g.cod_indic
            and g.cod_grp_indic           = h.cod_grp_indic
            and h.cod_grp_indic           = i.cod_grp_indic
            and i.cod_grp_rem_var         = e.cod_grp_rem_var
            and e.cod_grp_rem_var        in (1) --CORPORATIVO
            and g.cod_escala              = k.cod_escala (+)
            and(b.cod_cargo               = p_cod_cargo or p_cod_cargo is null)
            and(b.cod_func                = p_cod_func or p_cod_func is null)
            and f.num_ano                 = p_num_ano
            and f.num_mes                 = p_num_mes
            and g.flg_indic_ativ          = 'S'
            and nvl(g.cod_indic_sis, 'N') = 'N'
            and f.cod_fil                 = p_cod_fil
          order by b.cod_cargo
                  ,b.cod_func
                  ,f.cod_indic;


      cursor c_func_cargo (p_cod_cargo number
                          ,p_cod_func  number
                          ,p_num_ano   number
                          ,p_num_mes   number
                          ,p_cod_fil   number) is
         select distinct b.cod_cargo
                ,b.cod_func
                ,b.cod_emp
                ,f.cod_fil
                ,j.cod_clas_hay
                ,j.qtd_salario_min
                ,j.qtd_salario_max
                ,e.pct_min_ating
                ,b.dt_promo_eleg
                ,b.flg_ccst_comercial
                ,b.qtd_dias_afastam
                ,b.dt_demissao
                ,b.dt_admissao
                ,b.cod_mot_demissao
                ,sum(nvl(f.num_realz_pond,0)) vr_soma_num_realz_pond_v_p
                ,sum(nvl(f.num_peso,0))       vr_soma_num_peso_v_p
           from srv_funcionario              b
               ,srv_cargo                    c
               ,srv_grupo_cargo              d
               ,srv_grupo_rem_variavel       e
               ,srv_realizado_func_indicador f
               ,srv_indicador                g
               ,srv_grupo_indicador          h
               ,srv_grp_indic_grp_rem_var    i
               ,srv_classe_hay               j
          where b.cod_cargo               = c.cod_cargo
            and c.cod_cargo               = d.cod_cargo
            and d.cod_grp_rem_var         = e.cod_grp_rem_var
            and b.cod_func                = f.cod_func
            and f.cod_indic               = g.cod_indic
            and g.cod_grp_indic           = h.cod_grp_indic
            and h.cod_grp_indic           = i.cod_grp_indic
            and i.cod_grp_rem_var         = e.cod_grp_rem_var
            and e.cod_grp_rem_var         in (1) -- CORPORATIVO
            and (b.cod_cargo              = p_cod_cargo or p_cod_cargo is null)
            and (b.cod_func               = p_cod_func or p_cod_func is null)
            and c.cod_clas_hay            = j.cod_clas_hay
            and f.num_ano                 = p_num_ano
            and f.num_mes                 = p_num_mes
            and g.flg_indic_ativ          = 'S'
            and nvl(g.cod_indic_sis, 'N') = 'N'
            and f.cod_fil                 = p_cod_fil
          group by b.cod_cargo
                  ,b.cod_func
                  ,b.cod_emp
                  ,f.cod_fil
                  ,j.cod_clas_hay
                  ,j.qtd_salario_min
                  ,j.qtd_salario_max
                  ,e.pct_min_ating
                  ,b.dt_promo_eleg
                  ,b.flg_ccst_comercial
                  ,b.qtd_dias_afastam
                  ,b.dt_admissao
                  ,b.dt_demissao
                  ,b.cod_mot_demissao
          order by b.cod_cargo
                  ,b.cod_func;


      -- variaveis
      v_num_meta                      srv_realizado_func_indicador.num_meta%type;
      v_cod_un_meta                   srv_realizado_func_indicador.cod_un_meta%type;
      v_descr_meta                    srv_realizado_func_indicador.descr_meta%type;
      v_cod_un_realz                  srv_realizado_func_indicador.cod_un_realz%type;
      v_num_realz_x_meta              srv_realizado_func_indicador.num_realz_x_meta%type;
      v_cod_un_realz_x_meta           srv_realizado_func_indicador.cod_un_realz_x_meta%type;

      v_cod_pond                      srv_ponderacao.cod_pond%type;
      v_num_peso                      srv_ponderacao.num_peso%type;
      v_cod_un_peso                   srv_ponderacao.cod_un_peso%type;
      v_vlr_premio                    srv_ponderacao.vlr_premio%type;

      v_vlr_premio_func_calc          srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_num_realz_pond                srv_realizado_func_indicador.num_realz_pond%type;
      v_num_realz_func                srv_realizado_func_indicador.num_realz%type;

      v_cod_escala                    srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx             srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                  srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx               srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                   srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                 srv_escala_faixa.num_limite_fx%type;
      v_flg_apl_fx_result_no_realz    srv_escala.flg_aplica_fx_result_no_realz%type;
      v_result_aplica_escala          srv_realizado_func_indicador.num_realz_x_meta%type;

      v_vr_soma_num_realz_pond_v_p    srv_realizado_func_indicador.num_realz_pond%type;
      v_vr_soma_num_peso_v_p          srv_realizado_func_indicador.num_peso%type;
      v_cod_indic_agrup_corp          srv_indicador.cod_indic%type;
      v_cod_indic_gat_EBITDA          srv_indicador.cod_indic%type;
      v_escala_indic_gat_EBITDA       srv_escala_faixa.cod_escala%type;
      v_cod_periodo                   srv_calendario_comercial.cod_periodo%type;

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_grp_indic                  srv_grupo_indicador.cod_grp_indic%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_cod_cargo                      srv_cargo.cod_cargo%type;
      v_cod_func                       srv_funcionario.cod_func%type;
      v_ano                            srv_calendario_comercial.num_ano%type;
      v_mes                            srv_calendario_comercial.num_mes%type;
      v_dia                            number;
      v_meses_avos                     number := 12;
      v_dias_mes                       number := 15;
      -- records
      rec_srv_realizado_func_indic    srv_realizado_func_indicador%rowtype;


   begin
      --
      begin
         --
         for r_func_cargo_indic in c_func_cargo_indic (p_cod_cargo
                                                      ,p_cod_func
                                                      ,p_num_ano
                                                      ,p_num_mes
                                                      ,p_cod_fil) loop

            --
            v_cod_fil                       := r_func_cargo_indic.cod_fil;
            v_cod_grp_indic                 := r_func_cargo_indic.cod_grp_indic;
            v_cod_indic                     := r_func_cargo_indic.cod_indic;
            v_cod_cargo                     := r_func_cargo_indic.cod_cargo;
            v_cod_func                      := r_func_cargo_indic.cod_func;

            --
            v_num_realz_func                := r_func_cargo_indic.num_realz;
            v_cod_un_realz                  := r_func_cargo_indic.cod_un_realz;
            --
            v_num_realz_x_meta              := r_func_cargo_indic.num_realz_x_meta;
            v_cod_un_realz_x_meta           := r_func_cargo_indic.cod_un_realz_x_meta;
            --
            v_num_peso                      := r_func_cargo_indic.num_peso;
            v_cod_un_peso                   := r_func_cargo_indic.cod_un_peso;
            --
            v_result_aplica_escala          := r_func_cargo_indic.num_realz_x_meta;
            --
            v_num_meta                      := r_func_cargo_indic.num_meta;
            v_cod_un_meta                   := r_func_cargo_indic.cod_un_meta;
            v_descr_meta                    := r_func_cargo_indic.descr_meta;
            v_cod_escala                    := r_func_cargo_indic.cod_escala;
            v_flg_apl_fx_result_no_realz    := r_func_cargo_indic.flg_aplica_fx_result_no_realz;

            -- verifica escala para o indicador
            p_cod_erro         := null;
            p_descr_erro       := null;

            begin
              v_num_realz_x_meta := (v_num_realz_func / v_num_meta) * 100;
            exception
              when others then
                if v_num_meta = 0 then
                  v_num_realz_x_meta := v_num_realz_func;
                else
                  v_num_realz_x_meta := 0;
                end if;
            end;

            prc_calc_escala_fx_corp (r_func_cargo_indic.cod_indic
                                    ,r_func_cargo_indic.cod_escala
                                    ,v_num_realz_x_meta
                                    ,v_num_seq_escala_fx
                                    ,v_num_realz_fx
                                    ,v_cod_un_realz_fx
                                    ,v_flg_pct_100
                                    ,v_num_limite_fx
                                    ,p_cod_erro
                                    ,p_descr_erro
                                    );

            if p_cod_erro is not null then

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                       ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception e_erro: '
                                                                       ,p_body    => v_body
                                                                       );

               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => v_cod_func
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                          ,p_body    => v_body
                                                                          );
               --v_ins_log_erro is not null
               end if;


--               raise e_erro;
            end if;

            -- verifica se a faixa deve seguir a proporcionalidade apos 100%
            -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
            if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
               --
               v_num_realz_fx := v_num_realz_x_meta;
            end if;

            -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
            -- entao assumir o valor limite
            if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
               --
               v_num_realz_fx := v_num_limite_fx;
            end if;

            -- pegar a fx resultante (num_realz_fx) do funcionario / indicador multiplicar pelo peso
            begin
               v_num_realz_pond := (v_num_realz_fx * v_num_peso)/100;
            exception
               when others then
                  --
                  p_cod_erro     := 1;
                  p_descr_erro   := 'Erro ao calcular num realz pond do indicador para o funcionario corporativo - '    ||
                                    ' cod_fil: '           || v_cod_fil             || ' - ' ||
                                    ' cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                                    ' cod_indic: '         || v_cod_indic           || ' - ' ||
                                    ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                                    ' cod_func: '          || v_cod_func            ||sqlerrm;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular num realz pond do indicador para o funcionario corporativo : '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                            ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => v_cod_func
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

                  if v_ins_log_erro is not null then
                     -- enviar email
                     v_body       := v_ins_log_erro;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular num realz pond do indicador para o funcionario corporativo: '
                                                                             ,p_body    => v_body
                                                                             );
                  --v_ins_log_erro is not null
                  end if;

            end;

            begin
               --
               rec_srv_realizado_func_indic.cod_func                := r_func_cargo_indic.cod_func;
               rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo_indic.cod_cargo;
               rec_srv_realizado_func_indic.cod_indic               := r_func_cargo_indic.cod_indic;
               rec_srv_realizado_func_indic.cod_emp                 := r_func_cargo_indic.cod_emp;
               rec_srv_realizado_func_indic.cod_fil                 := r_func_cargo_indic.cod_fil;
               rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
               rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

               rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
               rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
               rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
               rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

               rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
               rec_srv_realizado_func_indic.num_peso                := v_num_peso;
               rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
               rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
               rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

               rec_srv_realizado_func_indic.num_meta                := v_num_meta;
               rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
               rec_srv_realizado_func_indic.descr_meta              := v_descr_meta;
               rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
               rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
               rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
               rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

               rec_srv_realizado_func_indic.vlr_premio              := null;
               rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
               rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
               rec_srv_realizado_func_indic.pct_calc_rateio         := null;

               rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
               rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;

               rec_srv_realizado_func_indic.sta_calc_realz          := nvl(p_sta_calc_realz,1); -- NAO INICIADO

               -- alteracao, manter apenas um registro para o funcionario se a filial mudou
               prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                              ,p_cod_erro                  => p_cod_erro
                                              ,p_descr_erro                => p_descr_erro
                                               );


               if p_cod_erro is not null then

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro na proc ao inserir realizado func indicador: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                            ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => v_cod_func
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

                  if v_ins_log_erro is not null then
                     -- enviar email
                     v_body       := v_ins_log_erro;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro na proc ao inserir realizado func indicador: '
                                                                             ,p_body    => v_body
                                                                             );
                  --v_ins_log_erro is not null
                  end if;

--                  raise e_erro;
               -- erro ao inserir na realizado func indicador
               end if;

            exception
               when others then
                  --
                  p_cod_erro     := 1;
                  p_descr_erro   := 'Erro ao inserir realizado funcionario corporativo - '    ||
                                    ' cod_fil: '           || v_cod_fil             || ' - ' ||
                                    ' cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                                    ' cod_indic: '         || v_cod_indic           || ' - ' ||
                                    ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                                    ' cod_func: '          || v_cod_func            ||sqlerrm;

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao inserir realizado funcionario corporativo: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                            ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => v_cod_func
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

                  if v_ins_log_erro is not null then
                     -- enviar email
                     v_body       := v_ins_log_erro;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao inserir realizado funcionario corporativo: '
                                                                             ,p_body    => v_body
                                                                             );
                  --v_ins_log_erro is not null
                  end if;

--                  raise e_erro;
            end;

         -- c_func_cargo_indic
         end loop;

         -- commit
         commit;

      exception
         /*when e_erro then
            raise e_erro;*/
         when others then
            --
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao calcular o indicador para o funcionario corporativo - '    ||
                              ' cod_fil: '           || v_cod_fil             || ' - ' ||
                              ' cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                              ' cod_indic: '         || v_cod_indic           || ' - ' ||
                              ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                              ' cod_func: '          || v_cod_func            ||sqlerrm;


            -- enviar email
            v_body       := p_cod_erro || ' - ' || p_descr_erro;

            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                    ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular o indicador para o funcionario corporativo: '
                                                                    ,p_body    => v_body
                                                                    );

            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => v_cod_func
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                      );

            if v_ins_log_erro is not null then
               -- enviar email
               v_body       := v_ins_log_erro;
               --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                       ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular o indicador para o funcionario corporativo: '
                                                                       ,p_body    => v_body
                                                                       );
            --v_ins_log_erro is not null
            end if;
      end;

      -----------------------------------------------------------------------
      -- CALCULAR O AGRUPAMENTO CORPORATIVO
      -----------------------------------------------------------------------
      begin
         for r_func_cargo in c_func_cargo (p_cod_cargo
                                          ,p_cod_func
                                          ,p_num_ano
                                          ,p_num_mes
                                          ,p_cod_fil) loop


            --
            v_cod_fil          := r_func_cargo.cod_fil;
            v_cod_cargo        := r_func_cargo.cod_cargo;
            v_cod_func         := r_func_cargo.cod_func;


            -- verifica indicador de agrupamento para CORPORATIVO
            begin
               select i.cod_indic
                 into v_cod_indic_agrup_corp
                 from srv_indicador i
                where i.cod_indic_sis = 'AGRUPA_CORP'
                  and nvl(i.flg_indic_ativ, 'N') = 'S';
            exception
               when others then
                  v_cod_indic_agrup_corp := 48;
            end;
            --
            v_cod_indic        := v_cod_indic_agrup_corp;

            -- soma dos indicadores CORPORATIVO
            v_vr_soma_num_realz_pond_v_p := r_func_cargo.vr_soma_num_realz_pond_v_p;
            v_vr_soma_num_peso_v_p       := r_func_cargo.vr_soma_num_peso_v_p;


            -- se a somatoria das ponderacoes nao obtiver o % minimo de atingimento
            -- entao NAO premiar o funcionario
            if v_vr_soma_num_realz_pond_v_p < r_func_cargo.pct_min_ating then
               --
               v_vlr_premio_func_calc := 0;
               --
               v_cod_escala           := null;
               v_num_seq_escala_fx    := null;
               v_num_realz_fx         := null;
               v_cod_un_realz_fx      := null;

            -- se a somatoria das ponderacoes for >= ao parametro de % de atingimento minimo,
            -- entao premiar o funcionario
            else

               --
               begin
                  v_vlr_premio_func_calc := (v_vr_soma_num_realz_pond_v_p * r_func_cargo.qtd_salario_min)/100;
                  --
                  if v_vlr_premio_func_calc > r_func_cargo.qtd_salario_max then
                     v_vlr_premio_func_calc := r_func_cargo.qtd_salario_max;
                  end if;
               exception
                  when others then
                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao calcular valor do premio antes do gatilho EBITDA - AGRUPAMENTO CORPORATIVO funcionario corporativo - ' ||
                                       ' cod_fil: '           || v_cod_fil             || ' - ' ||
                                       ' cod_indic: '         || v_cod_indic           || ' - ' ||
                                       ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                                       ' cod_func: '          || v_cod_func            ||sqlerrm;


                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular valor do premio antes do gatilho EBITDA: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                                ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao calcular valor do premio antes do gatilho EBITDA: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
               -- Erro ao calcular valor do premio antes do gatilho EBITDA
               end;

               -- verifica indicador de gatilho para EBITDA
               begin
                  select i.cod_indic
                        ,i.cod_escala
                        ,e.flg_aplica_fx_result_no_realz
                    into v_cod_indic_gat_EBITDA
                        ,v_escala_indic_gat_EBITDA
                        ,v_flg_apl_fx_result_no_realz
                    from srv_indicador       i
                        ,srv_escala          e
                   where i.cod_escala     = e.cod_escala
                     and i.descr_indic    = 'GATILHO EBITDA'
                     and i.flg_indic_ativ = 'S';
               exception
                  when others then
                     v_cod_indic_gat_EBITDA       := 38;
                     v_escala_indic_gat_EBITDA    := 8;
                     v_flg_apl_fx_result_no_realz := 'N';
               end;

               -- verifica realz X meta do indicador de EBITDA ou LUCRO LIQUIDO para o funcionario
               p_cod_erro   := null;
               p_descr_erro := null;
               --
               begin
                  select a.num_realz_x_meta
                        ,a.num_realz
                        ,a.cod_un_realz
                    into v_num_realz_x_meta
                        ,v_num_realz_func
                        ,v_cod_un_realz
                    from srv_realizado_func_indicador a
                        ,srv_indicador                b
                   where a.cod_indic                = b.cod_indic
                     and a.cod_func                 = r_func_cargo.cod_func
                     and b.descr_indic              = 'EBITDA EMPRESA'
                     and a.num_ano                  = p_num_ano
                     and a.num_mes                  = p_num_mes
                     and a.cod_fil                  = p_cod_fil;
               exception
                  when no_data_found then
                      begin
                         select a.num_realz_x_meta
                               ,a.num_realz
                               ,a.cod_un_realz
                           into v_num_realz_x_meta
                               ,v_num_realz_func
                               ,v_cod_un_realz
                           from srv_realizado_func_indicador a
                               ,srv_indicador                b
                          where a.cod_indic                = b.cod_indic
                            and a.cod_func                 = r_func_cargo.cod_func
                            and b.descr_indic              = 'LUCRO LIQUIDO'
                            and a.num_ano                  = p_num_ano
                            and a.num_mes                  = p_num_mes
                            and a.cod_fil                  = p_cod_fil;
                      exception
                         when no_data_found then
                            v_num_realz_x_meta := 0;
                            v_num_realz_func   := 0;
                            v_cod_un_realz     := null;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar o indicador LUCRO LIQUIDO - nenhum indicador encontrado - ' ||
                                              ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                              ' - erro: '                             || sqlerrm;

                         when too_many_rows then
                            v_num_realz_x_meta := 0;
                            v_num_realz_func   := 0;
                            v_cod_un_realz     := null;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar o indicador LUCRO LIQUIDO - mais de uma linha encontrada - ' ||
                                              ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                              ' - erro: '                             || sqlerrm;
                         when others then
                            v_num_realz_x_meta := 0;
                            v_num_realz_func   := 0;
                            v_cod_un_realz     := null;
                            --
                            p_cod_erro     := 1;
                            p_descr_erro   := 'Erro ao selecionar o indicador LUCRO LIQUIDO p/ o funcion CORPORATIVO - ' ||
                                              ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                              ' - erro: '                             || sqlerrm;
                      end;

                  --
                  when too_many_rows then
                     v_num_realz_x_meta := 0;
                     v_num_realz_func   := 0;
                     v_cod_un_realz     := null;
                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao selecionar o indicador EBITDA - mais de uma linha encontrada - ' ||
                                       ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                       ' - erro: '                             || sqlerrm;
                  when others then
                     v_num_realz_x_meta := 0;
                     v_num_realz_func   := 0;
                     v_cod_un_realz     := null;
                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao selecionar o indicador EBITDA p/ o funcion CORPORATIVO - ' ||
                                       ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                       ' - erro: '                             || sqlerrm;


               end;

               --
               if p_cod_erro is not null then
                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro exception ao selecionar o indicador EBITDA p/ o funcion CORPORATIVO: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                                ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
               -- erro verifica realz X meta do indicador de EBITDA para o funcionario
               end if;

               --
               v_result_aplica_escala          := v_num_realz_x_meta;
               --

               -- verifica flag se a escala deve ser aplicada sobre o realizado ou sobre o atingimento
               -- se for sobre o realizado, verifica se a unidade do realizado e percentual
               if nvl(v_flg_apl_fx_result_no_realz, 'N') = 'S' then
                  --
                  v_result_aplica_escala := v_num_realz_func;
               end if;

               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx_corp (v_cod_indic_gat_EBITDA
                                       ,v_escala_indic_gat_EBITDA
                                       ,v_result_aplica_escala --v_num_realz_x_meta
                                       ,v_num_seq_escala_fx
                                       ,v_num_realz_fx
                                       ,v_cod_un_realz_fx
                                       ,v_flg_pct_100
                                       ,v_num_limite_fx
                                       ,p_cod_erro
                                       ,p_descr_erro
                                       );
               if p_cod_erro is not null then

                  -- enviar email
                  v_body       := p_cod_erro || ' - ' || p_descr_erro;

                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Escala nao encontrada para o Gatilho EBITDA: '
                                                                          ,p_body    => v_body
                                                                          );

                  -- logar tabela
                  v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                            ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                            ,p_num_ano     => p_num_ano
                                                            ,p_num_mes     => p_num_mes
                                                            ,p_cod_fil     => v_cod_fil
                                                            ,p_cod_func    => v_cod_func
                                                            ,p_cod_indic   => v_cod_indic
                                                            ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                            );

                  if v_ins_log_erro is not null then
                     -- enviar email
                     v_body       := v_ins_log_erro;
                     --
                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                             ,p_body    => v_body
                                                                             );
                  --v_ins_log_erro is not null
                  end if;

--                  raise e_erro;
               -- erro ao calcular escala
               end if;

               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
                  --
                  v_num_realz_fx := v_num_realz_x_meta;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
               end if;

               --
               begin
                  --
                  v_vlr_premio_func_calc := (v_num_realz_fx * v_vlr_premio_func_calc)/100;
                  --
                  if v_vlr_premio_func_calc > r_func_cargo.qtd_salario_max then
                     v_vlr_premio_func_calc := r_func_cargo.qtd_salario_max;
                  end if;
               exception
                  when others then
                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao calcular aplicacao da escala Gatilho EBITDA ao valor do premio calculado funcionario - AGRUPAMENTO CORPORATIVO '    ||
                                       ' cod_fil: '           || v_cod_fil             || ' - ' ||
                                       ' cod_indic: '         || v_cod_indic           || ' - ' ||
                                       ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                                       ' cod_func: '          || v_cod_func            ||sqlerrm;

                     -- enviar email
                     v_body       := p_cod_erro || ' - ' || p_descr_erro;

                     v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                             ,p_subject => 'SRV Calculo Realizado Func Bonus - erro ao calcular aplicacao da escala Gatilho EBITDA ao valor do premio calculado funcionario: '
                                                                             ,p_body    => v_body
                                                                             );

                     -- logar tabela
                     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                               ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                               ,p_num_ano     => p_num_ano
                                                               ,p_num_mes     => p_num_mes
                                                               ,p_cod_fil     => v_cod_fil
                                                               ,p_cod_func    => v_cod_func
                                                               ,p_cod_indic   => v_cod_indic
                                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                               );

                     if v_ins_log_erro is not null then
                        -- enviar email
                        v_body       := v_ins_log_erro;
                        --
                        v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                                ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                                ,p_body    => v_body
                                                                                );
                     --v_ins_log_erro is not null
                     end if;

--                     raise e_erro;
               -- erro ao calcular aplicacao da escala Gatilho EBITDA ao valor do premio calculado funcionario
               end;


            -- se a somatoria das ponderacoes nao obtiver o % min de atngimento nao premiar o funcionario
            --if v_vr_soma_num_realz_pond_v_p < r_func_cargo.pct_min_ating
            end if;

            --
            rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
            rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic               := v_cod_indic_agrup_corp;
            rec_srv_realizado_func_indic.cod_emp                 := r_func_cargo.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                 := r_func_cargo.cod_fil;
            rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

            rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
            rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
            rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
            rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

            rec_srv_realizado_func_indic.cod_pond                := null;
            rec_srv_realizado_func_indic.num_peso                := v_vr_soma_num_peso_v_p;
            rec_srv_realizado_func_indic.cod_un_peso             := 2; -- unidade PERCENTUAL
            rec_srv_realizado_func_indic.num_realz_pond          := v_vr_soma_num_realz_pond_v_p;
            rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

            rec_srv_realizado_func_indic.num_meta                := null;
            rec_srv_realizado_func_indic.cod_un_meta             := null;
            rec_srv_realizado_func_indic.descr_meta              := v_descr_meta;
            rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
            rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
            rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

            rec_srv_realizado_func_indic.vlr_premio              := r_func_cargo.qtd_salario_min;
            rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 3; -- unidade UNIDADE
            rec_srv_realizado_func_indic.pct_calc_rateio         := null;

            rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
            rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;

            rec_srv_realizado_func_indic.sta_calc_realz          := nvl(p_sta_calc_realz,1); -- NAO INICIADO

            if r_func_cargo.flg_ccst_comercial = 'S'  and r_func_cargo.dt_demissao is null then

                 --Situacao 01 comercial
                 if  to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr') > to_date ('15/11/'||p_num_ano,'dd/mm/rrrr') and  r_func_cargo.dt_promo_eleg is null then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := trunc(months_between(to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'),to_date ('15/11/'||p_num_ano,'dd/mm/rrrr')));
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 12;

                 elsif to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr') > to_date ('15/11/'||p_num_ano,'dd/mm/rrrr') then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := trunc(months_between(to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'),to_date ('15/11/'||p_num_ano,'dd/mm/rrrr')));
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 12;


                 --Situacao 02 comercial
                 elsif months_between(to_date ('15/11/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr')) > v_meses_avos and r_func_cargo.dt_promo_eleg is null then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 1;

                 elsif ceil(months_between(to_date ('15/11/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'))) >= v_meses_avos  then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 1;

                 --Situacao 12 comercial
                 elsif to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr') <= to_date ('15/11/'||p_num_ano,'dd/mm/rrrr') and trunc(months_between(to_date ('15/11/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'))) < v_meses_avos and extract(year from r_func_cargo.dt_admissao) = p_num_ano and r_func_cargo.dt_promo_eleg is null then

                    v_ano := extract(year from r_func_cargo.dt_admissao);

                    v_mes := extract(month from r_func_cargo.dt_admissao);

                    v_dia := extract(day from r_func_cargo.dt_admissao);

                   begin
                      select round(MONTHS_BETWEEN(dt_fim_periodo,r_func_cargo.dt_admissao),0)
                        into v_cod_periodo
                        from srv_calendario_comercial
                       where num_ano = extract(year from sysdate)
                         and cod_periodo  = 12;
                    exception
                      when others then
                        null;
                    end;


                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_cod_periodo;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := ((v_vlr_premio_func_calc /v_meses_avos) * v_cod_periodo);
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 3;

                elsif to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr') <= to_date ('15/11/'||p_num_ano,'dd/mm/rrrr') and trunc(months_between(to_date ('15/11/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'))) < v_meses_avos and extract(year from r_func_cargo.dt_promo_eleg) = p_num_ano then

                    v_ano := extract(year from r_func_cargo.dt_promo_eleg);

                    v_mes := extract(month from r_func_cargo.dt_promo_eleg);

                    v_dia := extract(day from r_func_cargo.dt_promo_eleg);

                   begin
                      select round(MONTHS_BETWEEN(dt_fim_periodo,r_func_cargo.dt_promo_eleg),0)
                        into v_cod_periodo
                        from srv_calendario_comercial
                       where num_ano = p_num_ano
                         and cod_periodo  = 12;
                    exception
                      when others then
                        null;
                    end;



                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_cod_periodo;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := ((v_vlr_premio_func_calc / v_meses_avos)* v_cod_periodo);
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 3;

                end if;

            elsif nvl(r_func_cargo.flg_ccst_comercial,'N') = 'N' and r_func_cargo.dt_demissao is null then
                --Situacao 01 comum
                if (to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr') > to_date ('15/09/'||p_num_ano,'dd/mm/rrrr') or  to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr') > to_date ('15/09/'||p_num_ano,'dd/mm/rrrr') ) then

                  rec_srv_realizado_func_indic.qtd_meses_prop            := (case when r_func_cargo.dt_promo_eleg is null then
                                                                                       trunc(months_between(to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'),to_date ('15/09/'||p_num_ano,'dd/mm/rrrr')))
                                                                                    else
                                                                                       trunc(months_between(to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'),to_date ('15/09/'||p_num_ano,'dd/mm/rrrr'))) end);
                  rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                  rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 13;

                 --Situacao 02 comum
                elsif  trunc(months_between(to_date ('15/09/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'))) >= v_meses_avos  and r_func_cargo.dt_promo_eleg is null then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 2;

                elsif trunc(months_between(to_date ('15/09/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'))) >= v_meses_avos then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 2;

                 --Situacao 12 comum
                 elsif to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr') <= to_date ('15/09/'||p_num_ano,'dd/mm/rrrr') and trunc(months_between(to_date ('15/09/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'))) < v_meses_avos  and extract(year from r_func_cargo.dt_admissao) = p_num_ano and r_func_cargo.dt_promo_eleg is null then


                      v_dia := extract(day from r_func_cargo.dt_admissao);


                      if v_dia <= v_dias_mes then
                         v_cod_periodo := trunc(months_between(to_date('31/12/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr'))+1);
                      else
                         v_cod_periodo := trunc(months_between(to_date('31/12/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_admissao,'dd/mm/rrrr')));
                      end if;

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_cod_periodo;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := ((v_vlr_premio_func_calc / v_meses_avos) * v_cod_periodo);
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 4;

                elsif to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr') <= to_date ('15/09/'||p_num_ano,'dd/mm/rrrr') and trunc(months_between(to_date ('15/09/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'))) < v_meses_avos and extract(year from r_func_cargo.dt_promo_eleg) = p_num_ano then


                      v_dia := extract(day from r_func_cargo.dt_promo_eleg);

                      if v_dia <= v_dias_mes then
                         v_cod_periodo := trunc(months_between(to_date('31/12/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr'))+1);
                      else
                         v_cod_periodo := trunc(months_between(to_date('31/12/'||p_num_ano,'dd/mm/rrrr'),to_date(r_func_cargo.dt_promo_eleg,'dd/mm/rrrr')));
                      end if;

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_cod_periodo;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := ((v_vlr_premio_func_calc / v_meses_avos) * v_cod_periodo);
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 4;


                else

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 12;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 2;

                end if;

            elsif r_func_cargo.flg_ccst_comercial = 'S'  and r_func_cargo.dt_demissao is not null then


               --Situacao 03 comercial
               if to_date(r_func_cargo.dt_demissao,'dd/mm/rrrr') <= to_date ('31/12/'||p_num_ano,'dd/mm/rrrr') and r_func_cargo.cod_mot_demissao = 1 then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 5;

               else
                 --Situacao 04 comercial
                 if r_func_cargo.cod_mot_demissao = 2 then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 7;

                 --Situacao 05 comercial
                 elsif r_func_cargo.cod_mot_demissao in (3,4,6) then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 8;

                 end if;
               end if;

            elsif nvl(r_func_cargo.flg_ccst_comercial,'N') = 'N'  and r_func_cargo.dt_demissao is not null then

               --Situacao 03 comum
               if to_date(r_func_cargo.dt_demissao,'dd/mm/rrrr') <= to_date ('31/12/'||p_num_ano,'dd/mm/rrrr') and r_func_cargo.cod_mot_demissao = 1 then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 6;

               elsif to_date(r_func_cargo.dt_demissao,'dd/mm/rrrr') > to_date ('31/12/'||p_num_ano,'dd/mm/rrrr') and r_func_cargo.cod_mot_demissao = 1 then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 1;

               else
                 --Situacao 04 comum
                 if r_func_cargo.cod_mot_demissao = 2 then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 7;

                 --Situacao 05 comum
                 elsif r_func_cargo.cod_mot_demissao in (3,4,6) /*and to_date(r_func_cargo.dt_demissao,'dd/mm/rrrr') <= to_date ('31/03/'||p_num_ano,'dd/mm/rrrr')*/ then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 8;

                 end if;
               end if;

            --situacao 06
            elsif r_func_cargo.qtd_dias_afastam <= 212 and extract(year from r_func_cargo.dt_admissao) = p_num_ano and r_func_cargo.dt_promo_eleg is null then

                    v_cod_periodo :=  case when trunc(r_func_cargo.qtd_dias_afastam/30) = 0 then
                                                1
                                          else
                                          trunc(r_func_cargo.qtd_dias_afastam/30)
                                      end ;

                    rec_srv_realizado_func_indic.qtd_meses_prop            := (v_meses_avos - v_cod_periodo);
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 11;

            elsif r_func_cargo.qtd_dias_afastam <= 212 and extract(year from r_func_cargo.dt_promo_eleg) = p_num_ano  then

                    v_cod_periodo := case when trunc(r_func_cargo.qtd_dias_afastam/30) = 0 then
                                                1
                                          else
                                          trunc(r_func_cargo.qtd_dias_afastam/30)
                                      end ;

                    rec_srv_realizado_func_indic.qtd_meses_prop            := (v_meses_avos - v_cod_periodo);
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 11;

            elsif r_func_cargo.qtd_dias_afastam <= 212 and  extract(year from r_func_cargo.dt_admissao) < p_num_ano and  r_func_cargo.dt_promo_eleg is null then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 11;

            elsif  extract(year from r_func_cargo.dt_promo_eleg) < p_num_ano  then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := v_meses_avos;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := v_vlr_premio_func_calc;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 11;

            elsif r_func_cargo.qtd_dias_afastam > 212  then

                    rec_srv_realizado_func_indic.qtd_meses_prop            := 0;
                    rec_srv_realizado_func_indic.vlr_premio_func_calc_prop := 0;
                    rec_srv_realizado_func_indic.cod_sit_calc_realz_func   := 9;

            end if;

            -- inserir o realizado do funcionario pelo indicador
            /*prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                        ,p_cod_erro                  => p_cod_erro
                                        ,p_descr_erro                => p_descr_erro
                                         );*/
            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                           ,p_cod_erro                  => p_cod_erro
                                           ,p_descr_erro                => p_descr_erro
                                            );


            --
            if p_cod_erro is not null then

               -- enviar email
               v_body       := p_cod_erro || ' - ' || p_descr_erro;

               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                       ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir realizado func indicador: '
                                                                       ,p_body    => v_body
                                                                       );

               -- logar tabela
               v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                         ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                         ,p_num_ano     => p_num_ano
                                                         ,p_num_mes     => p_num_mes
                                                         ,p_cod_fil     => v_cod_fil
                                                         ,p_cod_func    => v_cod_func
                                                         ,p_cod_indic   => v_cod_indic
                                                         ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                         );

               if v_ins_log_erro is not null then
                  -- enviar email
                  v_body       := v_ins_log_erro;
                  --
                  v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                          ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                          ,p_body    => v_body
                                                                          );
               --v_ins_log_erro is not null
               end if;


--               raise e_erro;
            -- erro ao inserir realizado func indicador
            end if;

         -- c_func_cargo
         end loop;

         --
         commit;

      exception
        /* when e_erro then
            raise e_erro; */
         when others then
            --
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro geral ao calcular o agrupamento corporativo para o funcionario - '    ||
                              ' cod_fil: '           || v_cod_fil             || ' - ' ||
                              ' cod_indic: '         || v_cod_indic           || ' - ' ||
                              ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                              ' cod_func: '          || v_cod_func            ||sqlerrm;

            -- enviar email
            v_body       := p_cod_erro || ' - ' || p_descr_erro;

            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                    ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro Exception Geral ao calcular o agrupamento corporativo para o funcionario: '
                                                                    ,p_body    => v_body
                                                                    );

            -- logar tabela
            v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                      ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                      ,p_num_ano     => p_num_ano
                                                      ,p_num_mes     => p_num_mes
                                                      ,p_cod_fil     => v_cod_fil
                                                      ,p_cod_func    => v_cod_func
                                                      ,p_cod_indic   => v_cod_indic
                                                      ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                      );

            if v_ins_log_erro is not null then
               -- enviar email
               v_body       := v_ins_log_erro;
               --
               v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                       ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                       ,p_body    => v_body
                                                                       );
            --v_ins_log_erro is not null
            end if;

--            raise e_erro;
      end;

   exception
      when e_erro then

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                 ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro geral no exception e_erro: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                    ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro ao inserir log de erro: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;

         --
         return;

      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral ao calcular realizado Funcionario Corporativo: ' ||
                           ' cod_fil: '           || v_cod_fil             || ' - ' ||
                           ' cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           ' cod_indic: '         || v_cod_indic           || ' - ' ||
                           ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                           ' cod_func: '          || v_cod_func            ||sqlerrm;

         -- enviar email
         v_body       := p_cod_erro || ' - ' || p_descr_erro;

         v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                 ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro geral ao calcular realizado Funcionario Corporativo: '
                                                                 ,p_body    => v_body
                                                                 );

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 5
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_CORP'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

         if v_ins_log_erro is not null then
            -- enviar email
            v_body       := v_ins_log_erro;
            --
            v_send_email := pkg_ccm_func_proc_geral.fnc_enviar_email(p_rot_cod => 70 -- SRV - PRC_CALC_REALZ_FUNC_INDIC_CORP
                                                                    ,p_subject => 'SRV Calculo Realizado Func Bonus - Erro geral ao calcular realizado Funcionario Corporativo: '
                                                                    ,p_body    => v_body
                                                                    );
         --v_ins_log_erro is not null
         end if;


   end prc_calc_realz_Func_Indic_Corp;


   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO ADMINISTRATIVO
   -----------------------------------------------------------------------------------------------
   procedure prc_calc_realz_Func_Indic_Adm (p_num_ano      in number
                                           ,p_num_mes      in number
                                           ,p_cod_cargo    in number     default null
                                           ,p_cod_func     in number     default null
                                           ,p_cod_usuario  in number
                                           ,p_cod_erro     out number
                                           ,p_descr_erro   out varchar2
                                           ) is

      cursor c_func_cargo_indic (p_cod_cargo           number
                                ,p_cod_func            number
                                ,p_num_ano             number
                                ,p_num_mes             number) is
         select distinct b.cod_cargo
                        ,b.cod_func
                        ,b.cod_emp
                        ,b.cod_fil
                        ,f.cod_indic
                        ,g.cod_grp_indic
                        ,d.cod_grp_rem_var
                        ,f.num_ano
                        ,f.num_mes
                        ,j.num_meta
                        ,j.cod_un_meta
                        ,j.descr_meta
                        ,nvl(f.num_realz_x_meta, 0) num_realz_x_meta
                        ,f.cod_un_realz_x_meta
           from srv_funcionario                     b
               ,srv_cargo                           c
               ,srv_grupo_cargo                     d
               ,srv_grupo_rem_variavel              e
               ,srv_realizado_func_indicador        f
               ,srv_indicador                       g
               ,srv_grupo_indicador                 h
               ,srv_grp_indic_grp_rem_var           i
               ,srv_meta_func_bonus                 j
          where b.cod_cargo                       = c.cod_cargo
            and c.cod_cargo                       = d.cod_cargo
            and d.cod_grp_rem_var                 = e.cod_grp_rem_var
            and b.cod_func                        = f.cod_func
            and f.cod_indic                       = g.cod_indic
            and g.cod_grp_indic                   = h.cod_grp_indic
            and h.cod_grp_indic                   = i.cod_grp_indic
            and i.cod_grp_rem_var                 = e.cod_grp_rem_var
            and e.cod_grp_rem_var                 in (2) -- ADMINISTRATIVO
            and (b.cod_cargo                      = p_cod_cargo or p_cod_cargo is null)
            and (b.cod_func                       = p_cod_func or p_cod_func is null)
            and f.cod_indic                       = j.cod_indic (+)
            and f.cod_func                        = j.cod_func  (+)
            and f.num_ano                         = j.num_ano   (+)
            and f.num_mes                         = j.num_mes   (+)
            and f.num_ano                         = p_num_ano
            and f.num_mes                         = p_num_mes
            and g.flg_indic_ativ                  = 'S'
            and nvl(g.cod_indic_sis, 'N')         = 'N'
   order by b.cod_cargo
           ,b.cod_func
           ,f.cod_indic;


      cursor c_func_cargo (p_cod_cargo           number
                          ,p_cod_func            number
                          ,p_num_ano             number
                          ,p_num_mes             number) is
         select distinct b.cod_cargo
                        ,b.cod_func
                        ,b.cod_emp
                        ,b.cod_fil
                        ,e.qtd_salario_min
                        ,e.qtd_salario_max
                        ,e.pct_min_ating
                        ,sum(nvl(f.num_realz_pond,0))  as vr_soma_num_realz_pond_v_p
           from srv_funcionario                     b
               ,srv_cargo                           c
               ,srv_grupo_cargo                     d
               ,srv_grupo_rem_variavel              e
               ,srv_realizado_func_indicador        f
               ,srv_indicador                       g
               ,srv_grupo_indicador                 h
               ,srv_grp_indic_grp_rem_var           i
          where b.cod_cargo                       = c.cod_cargo
            and c.cod_cargo                       = d.cod_cargo
            and d.cod_grp_rem_var                 = e.cod_grp_rem_var
            and b.cod_func                        = f.cod_func
            and f.cod_indic                       = g.cod_indic
            and g.cod_grp_indic                   = h.cod_grp_indic
            and h.cod_grp_indic                   = i.cod_grp_indic
            and i.cod_grp_rem_var                 = e.cod_grp_rem_var
            and e.cod_grp_rem_var                 in (2) -- ADMINISTRATIVO
            and (b.cod_cargo                      = p_cod_cargo or p_cod_cargo is null)
            and (b.cod_func                       = p_cod_func or p_cod_func is null)
            and f.num_ano                         = p_num_ano
            and f.num_mes                         = p_num_mes
            and g.flg_indic_ativ                  = 'S'
            and nvl(g.cod_indic_sis, 'N')         = 'N'
   group by b.cod_cargo
           ,b.cod_func
           ,b.cod_emp
           ,b.cod_fil
           ,e.qtd_salario_min
           ,e.qtd_salario_max
           ,e.pct_min_ating
   order by b.cod_cargo
           ,b.cod_func;


      -- variaveis
      v_meta                          srv_realizado_func_indicador.num_meta%type;
      v_cod_un_meta                   srv_realizado_func_indicador.cod_un_meta%type;
      v_descr_meta                    srv_realizado_func_indicador.descr_meta%type;
      v_cod_un_realz                  srv_realizado_func_indicador.cod_un_realz%type;
      v_num_realz_x_meta              srv_realizado_func_indicador.num_realz_x_meta%type;
      v_cod_un_realz_x_meta           srv_realizado_func_indicador.cod_un_realz_x_meta%type;

      v_cod_pond                      srv_ponderacao.cod_pond%type;
      v_num_peso                      srv_ponderacao.num_peso%type;
      v_cod_un_peso                   srv_ponderacao.cod_un_peso%type;

      v_vlr_premio_func_calc          srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_num_realz_pond                srv_realizado_func_indicador.num_realz_pond%type;
      v_num_realz_func                srv_realizado_func_indicador.num_realz%type;

      v_cod_escala                    srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx             srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                  srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx               srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                   srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                 srv_escala_faixa.num_limite_fx%type;

      v_vr_soma_num_realz_pond_v_p    srv_realizado_func_indicador.num_realz_pond%type;
      v_cod_indic_agrup_corp          srv_indicador.cod_indic%type;
      v_cod_indic_gat_EBITDA          srv_indicador.cod_indic%type;


      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_grp_indic                  srv_grupo_indicador.cod_grp_indic%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_cod_cargo                      srv_cargo.cod_cargo%type;
      v_cod_func                       srv_funcionario.cod_func%type;

      -- records
      rec_srv_realizado_func_indic    srv_realizado_func_indicador%rowtype;

   --
   begin
      --
      begin
         --
         for r_func_cargo_indic in c_func_cargo_indic (p_cod_cargo
                                                      ,p_cod_func
                                                      ,p_num_ano
                                                      ,p_num_mes) loop

            --
            v_cod_fil          := r_func_cargo_indic.cod_fil;
            v_cod_grp_indic    := r_func_cargo_indic.cod_grp_indic;
            v_cod_indic        := r_func_cargo_indic.cod_indic;
            v_cod_cargo        := r_func_cargo_indic.cod_cargo;
            v_cod_func         := r_func_cargo_indic.cod_func;

            --
            v_num_realz_x_meta    := r_func_cargo_indic.num_realz_x_meta;
            v_cod_un_realz_x_meta := r_func_cargo_indic.cod_un_realz_x_meta;
            v_meta                := r_func_cargo_indic.num_meta;
            v_cod_un_meta         := r_func_cargo_indic.cod_un_meta;
            v_descr_meta          := r_func_cargo_indic.descr_meta;

   /*         -- verifica escala para o indicador
            p_cod_erro         := null;
            p_descr_erro       := null;
            --
            prc_calc_escala_fx (r_func_cargo_indic.cod_indic   --p_cod_indic
                               ,r_func_cargo_indic.cod_grp_indic   --p_cod_grp_indic
                               ,r_func_cargo_indic.cod_grp_rem_var --p_cod_grp_rem_var
                               ,v_num_realz_x_meta             --p_num_realz_x_meta
                               ,v_cod_escala
                               ,v_num_seq_escala_fx
                               ,v_num_realz_fx
                               ,v_cod_un_realz_fx
                               ,v_flg_pct_100
                               ,v_num_limite_fx
                               ,p_cod_erro
                               ,p_descr_erro
                               );
            if p_cod_erro is not null then
               raise e_erro;
            end if;

            -- verifica se a faixa deve seguir a proporcionalidade apos 100%
            -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
            if (nvl(v_flg_pct_100, 'N') = 'S' and v_num_realz_x_meta > 100) then
               --
               v_num_realz_fx := v_num_realz_x_meta;
            end if;

            -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
            -- entao assumir o valor limite
            if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
               --
               v_num_realz_fx := v_num_limite_fx;
            end if; */


            /*-- verifica a ponderacao do indicador para o funcionario
            prc_calc_ponderacao (p_cod_indic         => r_func_cargo_indic.cod_indic
                                ,p_cod_grp_indic     => null
                                ,p_cod_cargo         => r_func_cargo_indic.cod_cargo
                                ,p_cod_grp_rem_var   => null
                                ,p_cod_pond          => v_cod_pond
                                ,p_num_peso          => v_num_peso
                                ,p_cod_un_peso       => v_cod_un_peso
                                ,p_vlr_premio        => v_vlr_premio
                                ,p_cod_erro          => p_cod_erro
                                ,p_descr_erro        => p_descr_erro
                                );
            --
            if p_cod_erro is not null then
               raise e_erro;
            end if;*/

            -- pegar a fx resultante (num_realz_fx) do funcionario
            v_num_realz_pond := v_num_realz_x_meta; --(v_num_realz_fx * v_num_peso)/100;


            --
            rec_srv_realizado_func_indic.cod_func                := r_func_cargo_indic.cod_func;
            rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo_indic.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic               := r_func_cargo_indic.cod_indic;
            rec_srv_realizado_func_indic.cod_emp                 := r_func_cargo_indic.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                 := r_func_cargo_indic.cod_fil;
            rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

            rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
            rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
            rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
            rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

            rec_srv_realizado_func_indic.cod_pond                := v_cod_pond;
            rec_srv_realizado_func_indic.num_peso                := v_num_peso;
            rec_srv_realizado_func_indic.cod_un_peso             := v_cod_un_peso;
            rec_srv_realizado_func_indic.num_realz_pond          := v_num_realz_pond;
            rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

            rec_srv_realizado_func_indic.num_meta                := v_meta;
            rec_srv_realizado_func_indic.cod_un_meta             := v_cod_un_meta;
            rec_srv_realizado_func_indic.descr_meta              := v_descr_meta;
            rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
            rec_srv_realizado_func_indic.cod_un_realz            := v_cod_un_realz;
            rec_srv_realizado_func_indic.num_realz_x_meta        := v_num_realz_x_meta;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;

            rec_srv_realizado_func_indic.vlr_premio              := null;
            rec_srv_realizado_func_indic.vlr_premio_func_calc    := null; --v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := null; --1; -- unidade VALOR
            rec_srv_realizado_func_indic.pct_calc_rateio         := null;

            rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
            rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                 := null;

            -- inserir o realizado do funcionario pelo indicador
            /*prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                        ,p_cod_erro                  => p_cod_erro
                                        ,p_descr_erro                => p_descr_erro
                                         );*/
            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                           ,p_cod_erro                  => p_cod_erro
                                           ,p_descr_erro                => p_descr_erro
                                            );


            --
            if p_cod_erro is not null then
               raise e_erro;
            end if;


         -- c_func_cargo_indic
         end loop;

         -- commit
         commit;
      --
      exception
         when e_erro then
            raise e_erro;
         when others then
            --
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao calcular o indicador para o funcionario administrativo - ' ||
                              ' cod_fil: '           || v_cod_fil             || ' - ' ||
                              ' cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                              ' cod_indic: '         || v_cod_indic           || ' - ' ||
                              ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                              ' cod_func: '          || v_cod_func            ||sqlerrm;
            raise e_erro;
      end;


      -----------------------------------------------------------------------
      -- CALCULAR O AGRUPAMENTO ADMINISTRATIVO
      -----------------------------------------------------------------------
      begin
         for r_func_cargo in c_func_cargo (p_cod_cargo
                                          ,p_cod_func
                                          ,p_num_ano
                                          ,p_num_mes) loop

            -- verifica indicador de agrupamento para CORPORATIVO
            begin
               select i.cod_indic
                 into v_cod_indic_agrup_corp
                 from srv_indicador i
                where i.cod_indic_sis = 'AGRUPA_ADM'
                  and nvl(i.flg_indic_ativ, 'N') = 'S';
            exception
               when others then
                  v_cod_indic_agrup_corp := 52;
            end;

            v_cod_fil          := r_func_cargo.cod_fil;
            v_cod_cargo        := r_func_cargo.cod_cargo;
            v_cod_func         := r_func_cargo.cod_func;
            v_cod_indic        := v_cod_indic_agrup_corp;


            -- soma dos indicadores ADMINISTRATIVOS
            v_vr_soma_num_realz_pond_v_p := r_func_cargo.vr_soma_num_realz_pond_v_p;


            -- se a somatoria das ponderacoes nao obtiver o % minimo de atingimento
            -- entao NAO premiar o funcionario
            if v_vr_soma_num_realz_pond_v_p < r_func_cargo.pct_min_ating then
               --
               v_vlr_premio_func_calc := 0;
               --
               v_cod_escala           := null;
               v_num_seq_escala_fx    := null;
               v_num_realz_fx         := null;
               v_cod_un_realz_fx      := null;

            -- se a somatoria das ponderacoes for >= ao parametro de % de atingimento minimo,
            -- entao premiar o funcionario
            else


               -- verifica indicador de gatilho para EBITDA
               begin
                  select i.cod_indic
                    into v_cod_indic_gat_EBITDA
                    from srv_indicador i
                   where i.descr_indic = 'GATILHO EBITDA';
               exception
                  when others then
                     v_cod_indic_gat_EBITDA := 38;
               end;

               -- verifica realz X meta do indicador de EBITDA para o funcionario
               begin
                  select a.num_realz_x_meta
                    into v_num_realz_x_meta
                    from srv_realizado_func_indicador a
                        ,srv_indicador                b
                   where a.cod_indic                = b.cod_indic
                     and a.cod_func                 = r_func_cargo.cod_func
                     and b.descr_indic              = 'EBITDA EMPRESA'
                     and a.num_ano                  = p_num_ano
                     and a.num_mes                  = p_num_mes;
               exception
                  when too_many_rows then
                     v_num_realz_x_meta := 0;
                  when others then
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao selecionar o indicador EBITDA p/ o funcion ADMINISTRATIVO - ' ||
                                       ' - cod_func: '                         || r_func_cargo.cod_func    ||
                                       ' - erro: '                             || sqlerrm;
                     raise e_erro;
               end;

               --
               p_cod_erro         := null;
               p_descr_erro       := null;
               --
               prc_calc_escala_fx (v_cod_indic_gat_EBITDA         --p_cod_indic
                                  ,null                           --p_cod_grp_indic
                                  ,null                           --p_cod_grp_rem_var
                                  ,v_vr_soma_num_realz_pond_v_p   --p_num_realz_x_meta
                                  ,v_cod_escala
                                  ,v_num_seq_escala_fx
                                  ,v_num_realz_fx
                                  ,v_cod_un_realz_fx
                                  ,v_flg_pct_100
                                  ,v_num_limite_fx
                                  ,p_cod_erro
                                  ,p_descr_erro
                                  );
               if p_cod_erro is not null then
                  raise e_erro;
               end if;

               -- verifica se a faixa deve seguir a proporcionalidade apos 100%
               -- se sim entao assumir o valor proporcional superior a 100% que deu no resultado do realz X meta
               if (nvl(v_flg_pct_100, 'N') = 'S' and v_vr_soma_num_realz_pond_v_p > 100) then
                  --
                  v_num_realz_fx := v_vr_soma_num_realz_pond_v_p;
               end if;

               -- verifica se ha limite superior da faixa, e se a faixa resultado foi maior que o limite
               -- entao assumir o valor limite
               if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_fx > v_num_limite_fx then
                  --
                  v_num_realz_fx := v_num_limite_fx;
               end if;


               --
               begin
                  v_vlr_premio_func_calc := (v_num_realz_fx * r_func_cargo.qtd_salario_min)/100;
                  --
                  if v_vlr_premio_func_calc > r_func_cargo.qtd_salario_max then
                     v_vlr_premio_func_calc := r_func_cargo.qtd_salario_max;
                  end if;
               exception
                  when others then
                     --
                     p_cod_erro     := 1;
                     p_descr_erro   := 'Erro ao calcular vlr do premio funcionario do indicador AGRUPAMENTO ADMINISTRATIVO '    ||
                                       ' cod_fil: '           || v_cod_fil             || ' - ' ||
                                       ' cod_indic: '         || v_cod_indic           || ' - ' ||
                                       ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                                       ' cod_func: '          || v_cod_func            ||sqlerrm;
                     raise e_erro;
               end;
            -- se a somatoria das ponderacoes nao obtiver o % min de atngimento nao premiar o funcionario
            --if v_vr_soma_num_realz_pond_v_p < r_func_cargo.pct_min_ating
            end if;

            --
            rec_srv_realizado_func_indic.cod_func                := r_func_cargo.cod_func;
            rec_srv_realizado_func_indic.cod_cargo               := r_func_cargo.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic               := v_cod_indic_agrup_corp;
            rec_srv_realizado_func_indic.cod_emp                 := r_func_cargo.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                 := r_func_cargo.cod_fil;
            rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

            rec_srv_realizado_func_indic.cod_escala              := v_cod_escala;
            rec_srv_realizado_func_indic.num_seq_escala_fx       := v_num_seq_escala_fx;
            rec_srv_realizado_func_indic.num_realz_fx            := v_num_realz_fx;
            rec_srv_realizado_func_indic.cod_un_realz_fx         := v_cod_un_realz_fx;

            rec_srv_realizado_func_indic.cod_pond                := null;
            rec_srv_realizado_func_indic.num_peso                := null;
            rec_srv_realizado_func_indic.cod_un_peso             := null;
            rec_srv_realizado_func_indic.num_realz_pond          := v_vr_soma_num_realz_pond_v_p;
            rec_srv_realizado_func_indic.cod_un_realz_pond       := 2; -- unidade PERCENTUAL

            rec_srv_realizado_func_indic.num_meta                := null;
            rec_srv_realizado_func_indic.cod_un_meta             := null;
            rec_srv_realizado_func_indic.descr_meta              := v_descr_meta;
            rec_srv_realizado_func_indic.num_realz               := null;
            rec_srv_realizado_func_indic.cod_un_realz            := null;
            rec_srv_realizado_func_indic.num_realz_x_meta        := 0;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

            rec_srv_realizado_func_indic.vlr_premio              := r_func_cargo.qtd_salario_min;
            rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 3; -- unidade UNIDADE
            rec_srv_realizado_func_indic.pct_calc_rateio         := null;

            rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
            rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                 := null;

            -- inserir o realizado do funcionario pelo indicador
            /*prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                        ,p_cod_erro                  => p_cod_erro
                                        ,p_descr_erro                => p_descr_erro
                                         );*/
            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                           ,p_cod_erro                  => p_cod_erro
                                           ,p_descr_erro                => p_descr_erro
                                            );

            --
            if p_cod_erro is not null then
               raise e_erro;
            end if;

         -- c_func_cargo
         end loop;

         --
         commit;
      --
      exception
         when e_erro then
            raise e_erro;
         when others then
            --
            p_cod_erro     := 1;
            p_descr_erro   := 'Erro ao calcular o indicador agrupamento administrativo para o funcionario - '    ||
                              ' cod_fil: '           || v_cod_fil             || ' - ' ||
                              ' cod_indic: '         || v_cod_indic           || ' - ' ||
                              ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                              ' cod_func: '          || v_cod_func            ||sqlerrm;
            raise e_erro;
      end;

   exception
      when e_erro then
         return;
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro Geral ao calcular realizado Funcionario Administrativo: ' ||
                           ' cod_fil: '           || v_cod_fil             || ' - ' ||
                           ' cod_indic: '         || v_cod_indic           || ' - ' ||
                           ' cod_cargo: '         || v_cod_cargo           || ' - ' ||
                           ' cod_func: '          || v_cod_func            ||sqlerrm;

  end prc_calc_realz_Func_Indic_Adm;

  procedure prc_gera_relatorios(p_num_ano     in number,
                                p_num_mes     in number,
                                p_cod_rel     in number,
                                p_cod_erro    out number,
                                p_descr_erro  out varchar2) is

  begin

    if p_cod_rel = 1 then
      begin
        execute immediate 'drop table srv_tmp_relatorio' ;
      exception
        when others then
          null;
      end;

      execute immediate 'create table srv_tmp_relatorio /*tablespace tsdvar*/ pctfree 0 nologging as
          SELECT  A.NUM_ANO,
                  A.NUM_MES,
                  A.COD_FIL AS COD_FILIAL,
                  A.COD_FUNC AS COD_FUNCIONARIO,
                  F.NOME_FUNC AS NOME_FUNCIONARIO,
                  G.DESCR_CARGO AS DESCR_CARGO,
                  ROUND(A.NUM_REALZ, 2) AS RESULT_PERC_PSF_LOJA,
                  A.NUM_PESO AS PSF_POR_CARGO,
                  A.NUM_REALZ_POND AS PSF_PREMIO_X_PESO_CARGO,
                  B.NUM_REALZ_X_META AS RESULTADO_PERC_VENDAS_LOJA,
                  B.NUM_PESO AS VENDAS_POR_CARGO,
                  B.NUM_REALZ_POND AS VENDAS_PREMIO_X_PESO_CARGO,
                  K.NUM_REALZ_POND AS PSF_MAIS_VENDAS,
                  K.VLR_PREMIO AS VLR_PREMIO_100,
                  DECODE(K.NUM_REALZ_FX, 0, ''Nao Recebe'', K.NUM_REALZ_FX) AS A_RECEBER_POR_FAIXA,
                  K.VLR_PREMIO_FUNC_CALC AS VLR_PREMIO_A_RECEBER,
                  F.COD_FIL AS LOJA_DE_CADASTRO,
                  DECODE(A.COD_FIL, F.COD_FIL, 0, L.QT_LOJAS + 1) AS ANALISE_DE_PAGAMENTO
             FROM SRV_REALIZADO_FUNC_INDICADOR A, --
                  SRV_REALIZADO_FUNC_INDICADOR B, --
                  SRV_INDICADOR C,
                  SRV_GRUPO_INDICADOR D,
                  SRV_GRP_INDIC_GRP_REM_VAR E,
                  SRV_FUNCIONARIO F, --
                  srv_cargo G,
                  srv_grupo_rem_variavel H,
                  srv_grupo_cargo I,
                  SRV_REALIZADO_FUNC_INDICADOR K,
                  (SELECT SFB1.COD_FIL,
                          SFB1.COD_FUNC,
                          SFB1.NUM_ANO,
                          SFB1.NUM_MES,
                          SFB2.QT_LOJAS
                     FROM (SELECT SFB.* FROM SRV_FUNC_BASE_REM_VAR SFB) SFB1,
                          (SELECT SFB.COD_FUNC,
                                  SFB.NUM_ANO,
                                  SFB.NUM_MES,
                                  COUNT(1) QT_LOJAS
                             FROM SRV_FUNC_BASE_REM_VAR SFB
                            GROUP BY SFB.COD_FUNC, SFB.NUM_ANO, SFB.NUM_MES) SFB2
                    WHERE SFB2.COD_FUNC = SFB1.COD_FUNC
                      AND SFB2.NUM_ANO = SFB1.NUM_ANO
                      AND SFB2.NUM_MES = SFB1.NUM_MES) L
            WHERE A.COD_FUNC = F.COD_FUNC
              AND A.COD_INDIC = C.COD_INDIC
              AND C.COD_GRP_INDIC = D.COD_GRP_INDIC
              AND D.COD_GRP_INDIC = E.COD_GRP_INDIC
              AND F.COD_CARGO = G.COD_CARGO
              AND E.COD_GRP_REM_VAR = H.COD_GRP_REM_VAR
              AND G.COD_CARGO = I.COD_CARGO
              AND I.COD_GRP_REM_VAR = H.COD_GRP_REM_VAR
              AND K.COD_FUNC = A.COD_FUNC
              AND K.COD_INDIC = 40
              AND K.COD_EMP = A.COD_EMP
              AND K.COD_FIL = A.COD_FIL
              AND K.NUM_ANO = A.NUM_ANO
              AND K.NUM_MES = A.NUM_MES
              AND B.COD_FUNC = A.COD_FUNC
              AND B.COD_INDIC = 1
              AND B.COD_EMP = A.COD_EMP
              AND B.COD_FIL = A.COD_FIL
              AND B.NUM_ANO = A.NUM_ANO
              AND B.NUM_MES = A.NUM_MES
              AND A.NUM_ANO = L.NUM_ANO(+)
              AND A.NUM_MES = L.NUM_MES(+)
              AND A.COD_FUNC = L.COD_FUNC(+)
              AND A.COD_FIL = L.COD_FIL(+)
              AND E.COD_GRP_REM_VAR = 3
              AND D.COD_GRP_INDIC = 3
              AND A.NUM_ANO = ' || p_num_ano || '
              AND A.NUM_MES = ' || p_num_mes || '
              AND A.COD_INDIC = 39
              AND A.COD_CARGO NOT IN (1, 918, 710, 1028, 714, 907)
            ORDER BY A.COD_FIL,
                     A.COD_FUNC,
                     DECODE(C.COD_INDIC, 39, 50000, C.COD_INDIC)';

         begin
            execute immediate 'grant select on srv_tmp_relatorio to CCM_SEL';
         exception
            when others then
               null;
         end;

    end if;
  exception
    when others then
         p_cod_erro     := sqlcode;
         p_descr_erro   := sqlerrm;

  end prc_gera_relatorios;

   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO CALL CENTER
   -----------------------------------------------------------------------------------------------

   procedure prc_Calc_Realz_Fil_CCenter (p_num_ano      in number
                                        ,p_num_mes      in number
                                        ,p_cod_indic    in number    default null
                                        ,p_descr_indic  in varchar2  default null
                                        ,p_cod_usuario  in number
                                        ,p_cod_erro     out number
                                        ,p_descr_erro   out varchar2
                                         ) is


      -- REMUNERACAO CALL_CENTER
      cursor c_indic_rem_loja (p_descr_grp_indic srv_grupo_indicador.descr_grp_indic%type) is
        select c.cod_indic
             , c.descr_indic
          from srv_tipo_rem_var          a
         inner join srv_grupo_indicador  b on b.cod_tipo_rem_var = a.cod_tipo_rem_var
         inner join srv_indicador        c on c.cod_grp_indic    = b.cod_grp_indic
                                          and upper(c.flg_indic_ativ) = 'S'
         where b.descr_grp_indic = p_descr_grp_indic;


      -- variaveis controle
      v_var_sql                        varchar2(2000);
      v_nm_tab_realz_fu                varchar2(30);
      v_nm_tab_realz_fi                varchar2(30);

      -- variaveis calculo
      v_vlr_realizado                  srv_realizado_filial.num_realz%type;
      v_qtd_realizado                  srv_realizado_filial.qtd_realz%type;
      v_cod_un_realz                   srv_realizado_filial.cod_un_realz%type;
      v_meta                           srv_meta_filial.num_meta%type;
      v_pct_calc_meta                  srv_meta_filial.pct_calc_meta%type;
      v_cod_un_meta                    srv_meta_filial.cod_un_meta%type;
      v_vlr_premio_fil                 srv_meta_filial.vlr_premio_fil%type;
      --v_num_realz_x_meta               srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta            srv_realizado_filial.cod_un_realz_x_meta%type;
      v_cod_escala                     srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx              srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                   srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx                srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_meta_100_pct_realz         srv_filial.flg_meta_100_pct_realz%type;

      -- var log
      v_cod_fil                        srv_filial.cod_fil%type;
      v_cod_tipo_rem_var               srv_tipo_rem_var.cod_tipo_rem_var%type;
      v_cod_grp_indic                  srv_grupo_indicador.cod_grp_indic%type;
      v_cod_indic                      srv_indicador.cod_indic%type;
      v_descr_indic                    srv_indicador.descr_indic%type;

      -- cursores
      cur_realz                        pkg_srv_calc_rem_var.typ_cursor;

      --
      rec_srv_realizado_filial         srv_realizado_filial%rowtype;
      --
      e_erro                           exception;


   ---------------------------------------------------------------------------
   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;
      --
      -----------------------------------------------------------------------
      -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
      -----------------------------------------------------------------------
      for r_indic_rem_Call_Center in c_indic_rem_loja (p_descr_grp_indic => 'TLMKT') loop

         v_cod_fil   := 900;
         v_cod_indic := r_indic_rem_Call_Center.cod_indic;

         if p_descr_indic is not null then
            v_descr_indic := p_descr_indic;
          else
            v_descr_indic := r_indic_rem_call_center.descr_indic;
         end if;

        --SE INDICADOR TLMKT CARTAO ITAU APROVADO
        if (v_descr_indic is null or v_descr_indic = 'TLMKT CARTAO ITAU APROVADO') then

           --
           v_nm_tab_realz_fi  := 'SRV_REALZFI_TLMKT_APROV_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));

           --Filial
           begin
             execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
           exception
             when others then
               null;
           end;
           --
           begin
             execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                  select a.cod_fil
                                        ,a.cod_indic
                                        ,b.descr_indic
                                        ,a.num_ano
                                        ,a.num_mes
                                        ,a.num_realz qtde
                                   from srv_realizado_filial_indic a
                                    inner join srv_indicador       b on b.cod_indic = a.cod_indic
                                                                    and b.descr_indic = ''TLMKT CARTAO ITAU APROVADO''
                                    where a.num_ano = '|| p_num_ano ||'
                                      and a.num_mes = '|| p_num_mes ||'
                                      and a.cod_fil = 900';

           exception
             when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                   ' erro - '                || sqlerrm;
               raise e_erro;
           end;
           --
           begin
              execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
           exception
              when others then
                 null;
           end;

        --SE INDICADOR TLMKT CARTAO ITAU ATIVADO
        elsif (v_descr_indic is null or v_descr_indic = 'TLMKT CARTAO ITAU ATIVADO') then

           --
           v_nm_tab_realz_fi  := 'SRV_REALZFI_TLMKT_ATIV_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));

           --Filial
           begin
             execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
           exception
             when others then
               null;
           end;
           --
           begin
             execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                  select a.cod_fil
                                          ,a.cod_indic
                                          ,b.descr_indic
                                          ,a.num_ano
                                          ,a.num_mes
                                          ,a.num_realz qtde
                                     from srv_realizado_filial_indic a
                                      inner join srv_indicador       b on b.cod_indic = a.cod_indic
                                                                      and b.descr_indic = ''TLMKT CARTAO ITAU ATIVADO''
                                      where a.num_ano = '|| p_num_ano ||'
                                        and a.num_mes = '|| p_num_mes ||'
                                        and a.cod_fil = 900';
           exception
             when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                   ' erro - '                || sqlerrm;
               raise e_erro;
           end;
           --
           begin
              execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
           exception
              when others then
                 null;
           end;

        --SE INDICADOR TLMKT CARTAO ITAU ADICIONAL
        elsif (v_descr_indic is null or v_descr_indic = 'TLMKT CARTAO ITAU ADICIONAL') then

           --
           v_nm_tab_realz_fi  := 'SRV_REALZFI_TLMKT_ADIC_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));

           --Filial
           begin
             execute immediate 'drop table '|| v_nm_tab_realz_fi ||' ';
           exception
             when others then
               null;
           end;
           --
           begin
             execute immediate 'create table '|| v_nm_tab_realz_fi ||'  pctfree 0 nologging as
                                  select a.cod_fil
                                        ,a.cod_indic
                                        ,b.descr_indic
                                        ,a.num_ano
                                        ,a.num_mes
                                        ,a.num_realz qtde
                                   from srv_realizado_filial_indic a
                                    inner join srv_indicador       b on b.cod_indic = a.cod_indic
                                                                    and b.descr_indic = ''TLMKT CARTAO ITAU ADICIONAL''
                                    where a.num_ano = '|| p_num_ano ||'
                                      and a.num_mes = '|| p_num_mes ||'
                                      and a.cod_fil = 900';
           exception
             when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fi ||
                                   ' erro - '                || sqlerrm;
               raise e_erro;
           end;
           --
           begin
              execute immediate 'grant select on ' || v_nm_tab_realz_fi || ' to CCM_SEL';
           exception
              when others then
                 null;
           end;

        /*--SE INDICADOR CARTAO MARISA APROVADO PL E ITAU CALL CENTER
        elsif (v_descr_indic is null or v_descr_indic = 'CARTAO MARISA APROVADO PL E ITAU CALL CENTER') then

           --
           v_nm_tab_realz_fu  := 'SRV_REALZFU_CT_AP_CC_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));
           \*v_nm_tab_realz_fi  := 'SRV_REALZFI_CT_AP_CC_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));*\
           --
           begin
             execute immediate 'drop table '|| v_nm_tab_realz_fu ||' ';
           exception
             when others then
               null;
           end;
           --
           begin
             execute immediate 'create table '|| v_nm_tab_realz_fu ||'  pctfree 0 nologging as
                                   select b.cli_cpf,
                                         18 cod_indic,
                                        ''CARTAO MARISA APROVADO ITAU'' descr_indic,
                                         b.data_aceite,
                                         b.cpf_vendedor,
                                         a.fil_cod
                                    from ccm_usuario@lksrv a
                                   inner join ccm_itau_cliente@lksrv b on b.cpf_vendedor = a.usu_cpf
                                                                       and b.stat_cod not in (1, 8, 13, 96, 97, 98)
                                                                       and b.data_aceite between to_date(' || chr(39) || v_dt_ini || chr(39) ||','' dd / mm / yyyy hh24 :mi :ss '')
                                                                                             and to_date(' || chr(39) || v_dt_fim || chr(39) ||','' dd / mm / yyyy hh24 :mi :ss '')
                                   inner join ccm_cliente@lksrv c on c.cli_cpf = b.cli_cpf
                                   where a.fil_cod in (900,1021)
                                   order by 1,3';
           exception
             when others then
               p_cod_erro     := 1;
               p_descr_erro   := 'Erro ao criar a tabela ' || v_nm_tab_realz_fu ||
                                   ' erro - '                || sqlerrm;
               raise e_erro;
           end;
           --
           begin
             execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
           exception
             when others then
               null;
           end;
           begin
             execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
           exception
             when others then
               null;
           end;
           begin
             execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
           exception
             when others then
               null;
           end;

        --Indicador BOLSA PROTEGIDA CALL CENTER
        elsif (v_descr_indic is null or v_descr_indic = 'BOLSA PROTEGIDA CALL CENTER') then

           v_nm_tab_realz_fu := 'SRV_REALZFU_B_PROT_CC_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));
           \*v_nm_tab_realz_fi := 'SRV_REALZFI_B_PROT_CC_'
                                ||trim(to_char(p_num_ano, '0000'))
                                ||trim(to_char(p_num_mes, '00'));*\

           --
           begin
             execute immediate 'drop table ' || v_nm_tab_realz_fu;
           exception
             when others then
               null;
           end;
           --
           begin
              execute immediate 'create table ' || v_nm_tab_realz_fu || '  pctfree 0 nologging as
                                  SELECT E.FIL_COD                                  FIL_COD
                                        ,A.CLI_CPF                                  CLI_CPF
                                        ,C.PSS_VND_CPF                              CPF_VENDEDOR
                                        ,A.PSS_PRD_CODIGO                           COD_INDIC
                                        ,''BOLSA PROTEGIDA PL''                     DESCR_INDIC
                                        ,A.PSS_CTR_CODIGO                           CONTRATO_TITULAR
                                        ,TRUNC(A.PSS_CTR_DATA_ADESAO)               DATA_ADESAO_TITULAR
                                        ,TO_CHAR(A.PSS_CTR_DATA_ADESAO,''MM/YYYY'') MES_ADESAO
                                    FROM CCM_PSS_CONTRATO_CLIENTE@lksrv A,
                                         CCM_PSS_PRODUTO@lksrv          B,
                                         CCM_PSS_VENDEDOR@lksrv         C,
                                         CCM_PSS_CANAL_VENDA@lksrv      E
                                   WHERE E.FIL_COD IN(900,991,1021)
                                     AND A.PSS_CNL_CODIGO = E.PSS_CNL_CODIGO
                                     AND A.PSS_VND_CODIGO = C.PSS_VND_CODIGO(+)
                                     AND A.PSS_PRD_CODIGO = B.PSS_PRD_CODIGO(+)
                                     AND A.PSS_PRD_CODIGO IN (17,20,21,41,64,65,66,67,69,96,105)
                                     AND A.PSS_CTR_IN_SITUACAO IN (1)
                                     AND A.PSS_CTR_DATA_ADESAO between to_date('|| chr(39) || v_dt_ini || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')
                                                                   and to_date('|| chr(39) || v_dt_fim || chr(39) ||',''dd/mm/yyyy hh24:mi:ss'')

                                  UNION ALL

                                  SELECT B.FIL_COD
                                        ,A.CLI_CPF
                                        ,B.USU_CPF
                                        ,a.cod_prod_cartao
                                        ,''BOLSA PROTEGIDA ITAU''
                                        ,NULL
                                        ,TRUNC(A.DATA_ACEITE)
                                        ,TO_CHAR(A.DATA_ACEITE,''MM/YYYY'')
                                    FROM CCM_ITAU_CLIENTE@lksrv     A
                                       , CCM_ITAU_CLIENTE_LOG@lksrv B
                                   WHERE B.FIL_COD IN(900,991,1021)
                                     AND A.CLI_CPF = B.CLI_CPF
                                     AND A.DATA_ACEITE = B.DT_LOG
                                     AND B.STAT_COD = 2
                                     AND B.STAT_COD_ANT = 1
                                     AND A.COD_PROD_CARTAO = 1850
                                     AND A.FLAG_SEG_PERDA_ROUBO = ''S''
                                     AND B.COD_MOT_RECUSA IS NULL
                                     AND A.DATA_ACEITE BETWEEN TO_DATE('|| CHR(39) || V_DT_INI || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                                           AND TO_DATE('|| CHR(39) || V_DT_FIM || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                  UNION ALL

                                  select e.fil_cod
                                        ,a.cli_cpf
                                        ,c.pss_vnd_cpf
                                        ,a.pss_prd_codigo
                                        ,''BOLSA PROTEGIDA PL''
                                        ,TO_NUMBER(NULL)
                                        ,trunc(f.pss_dpt_dt_adesao)
                                        ,to_char(f.pss_dpt_dt_adesao,''mm/yyyy'')
                                    from ccm_pss_dependente@lksrv       f,
                                         ccm_pss_vendedor@lksrv         c,
                                         ccm_pss_canal_venda@lksrv      e,
                                         ccm_pss_contrato_cliente@lksrv a,
                                         ccm_pss_produto@lksrv          b
                                   where e.fil_cod in(900,991,1021)
                                     and a.pss_ctr_codigo = f.pss_ctr_codigo
                                     and f.pss_vnd_codigo = c.pss_vnd_codigo
                                     and a.pss_prd_codigo = b.pss_prd_codigo
                                     and f.pss_cnl_codigo = e.pss_cnl_codigo
                                     and f.stat_cod = 1
                                     and f.pss_dpt_dt_adesao between TO_DATE('|| CHR(39) || V_DT_INI || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                                                 AND TO_DATE('|| CHR(39) || V_DT_FIM || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                  UNION ALL

                                  select u.fil_cod,
                                         d.cli_cpf,
                                         d.cpf_vendedor,
                                         d.prod_cod,
                                         ''BOLSA PROTEGIDA ITAU'',
                                         TO_NUMBER(NULL),
                                         trunc(d.data_adesao),
                                         to_char(d.data_adesao,''mm/yyyy'')
                                    from ccm_itau_cliente_produto_depen@lksrv d,
                                         ccm_pss_produto@lksrv                p,
                                         ccm_status@lksrv                     sta,
                                         ccm_usuario@lksrv                    u,
                                         ccm_itau_cliente@lksrv               c
                                   where u.fil_cod in (900,991,1021)
                                     and d.cli_cpf = c.cli_cpf
                                     and d.stat_cod = sta.stat_cod
                                     and d.prod_cod = p.pss_prd_codigo
                                     and d.stat_tabela = sta.stat_tabela
                                     and u.usu_cpf = d.cpf_vendedor
                                     and c.cod_mot_recusa is null
                                     and d.stat_cod <> 2
                                     and c.stat_cod in (5, 6, 7, 9, 10, 11)
                                     and d.data_adesao between TO_DATE('|| CHR(39) || V_DT_INI || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                                           AND TO_DATE('|| CHR(39) || V_DT_FIM || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')

                                  UNION ALL

                                  select u.fil_cod,
                                         i.cli_cpf,
                                         i.cpf_vendedor,
                                         i.prod_cod cod_prod_itau,
                                         ''BOLSA PROTEGIDA ITAU'',
                                         to_number(null),
                                         trunc(i.data_adesao),
                                         to_char(i.data_adesao,''mm/yyyy'')
                                    from ccm_itau_cliente_produto@lksrv i,
                                         ccm_pss_produto@lksrv          p,
                                         ccm_status@lksrv               sta,
                                         ccm_usuario@lksrv              u,
                                         ccm_itau_cliente@lksrv         c
                                    where u.fil_cod in(900,991,1021)
                                      and i.cli_cpf = c.cli_cpf
                                      and i.stat_cod = sta.stat_cod
                                      and i.prod_cod = p.pss_prd_codigo
                                      and i.stat_tabela = sta.stat_tabela
                                      and c.cod_mot_recusa is null
                                      and i.stat_cod <> 2
                                      and c.stat_cod in (5, 6, 7, 9, 10, 11)
                                      and u.usu_cpf = i.cpf_vendedor
                                      and i.data_adesao between TO_DATE('|| CHR(39) || V_DT_INI || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')
                                                            AND TO_DATE('|| CHR(39) || V_DT_FIM || CHR(39) ||',''DD/MM/YYYY HH24:MI:SS'')';
           exception
              when others then
                 p_cod_erro     := 1;
                 p_descr_erro   := 'Erro ao criar a tabela '||v_nm_tab_realz_fu ||
                                   ' erro - '                || sqlerrm;
                 raise e_erro;
           end;
           --
           begin
             execute immediate 'create index i_' || substr(v_nm_tab_realz_fu,1,28) ||' on ' || v_nm_tab_realz_fu || ' (fil_cod, cpf_vendedor)';
           exception
             when others then
               null;
           end;
           begin
             execute immediate 'analyze table ' || v_nm_tab_realz_fu || ' estimate statistics sample 10 percent';
           exception
             when others then
               null;
           end;
           begin
             execute immediate 'grant select on ' || v_nm_tab_realz_fu || ' to CCM_SEL';
           exception
             when others then
               null;
           end;*/

        end if; --SE INDICADOR BOLSA PROTEGIDA CALL CENTER

      end loop;
      --
      commit;

   exception
      when e_erro then
         return;
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral ao calcular realizado Filiais Remun Call Center: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_tipo_rem_var: '  || v_cod_tipo_rem_var    || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' || sqlerrm;

   end prc_Calc_Realz_Fil_CCenter;



   -----------------------------------------------------------------------------------------------
   -----------------------------------------------------------------------------------------------
   -- CALCULA ATINGIMENTO (CALCULO) CALL CENTER
   -----------------------------------------------------------------------------------------------
   -----------------------------------------------------------------------------------------------
   procedure prc_Calc_Ating_Fil_CCenter(p_num_ano     in number,
                                        p_num_mes     in number,
                                        p_cod_emp     in number default null,
                                        p_cod_fil     in number default null,
                                        p_cod_indic   in number default null,
                                        p_descr_indic in varchar2 default null,
                                        p_cod_usuario in number,
                                        p_cod_erro    out number,
                                        p_descr_erro  out varchar2) is

     -- REMUNERACAO LOJAS
     cursor c_indic_rem_loja (p_descr_grp_indic srv_grupo_indicador.descr_grp_indic%type) is
       select c.cod_indic
            , c.descr_indic
         from srv_tipo_rem_var          a
        inner join srv_grupo_indicador  b on b.cod_tipo_rem_var = a.cod_tipo_rem_var
        inner join srv_indicador        c on c.cod_grp_indic    = b.cod_grp_indic
                                         and upper(c.flg_indic_ativ) = 'S'
        where b.descr_grp_indic = p_descr_grp_indic;

     -- variaveis controle
     v_var_sql               varchar2(2000);
     v_nm_tab_realz_fu       varchar2(30);
     v_nm_tab_realz_fi       varchar2(30);
     v_nm_tab_realz_fi_lr_vs varchar2(30);
     v_nm_tab_meta           varchar2(30);
     v_nm_tab_realz_fi_pc    varchar2(30);
     v_nm_tab_realz_fi_bp    varchar2(30);
     v_nm_tab_realz_fi_odo   varchar2(30);
     v_nm_tab_realz_fi_mm    varchar2(30);

     -- variaveis calculo
     v_vlr_vdas_bruta      number(11, 2);
     v_vlr_devolucao       number(11, 2);
     v_vlr_realizado       srv_realizado_filial.num_realz%type;
     v_qtd_realizado       number(11, 2); --srv_realizado_filial.qtd_realz%type;
     v_cod_un_realz        srv_realizado_filial.cod_un_realz%type;
     v_meta                srv_meta_filial.num_meta%type;
     v_cod_un_meta         srv_meta_filial.cod_un_meta%type;
     v_vlr_premio_fil      srv_meta_filial.vlr_premio_fil%type;
     v_pct_calc_meta       srv_meta_filial.pct_calc_meta%type;
     v_num_realz_x_meta    srv_realizado_filial.num_realz_x_meta%type;
     v_cod_un_realz_x_meta srv_realizado_filial.cod_un_realz_x_meta%type;
     v_vlr_premio_fil_calc srv_realizado_filial.vlr_premio_fil_calc%type := 0;
     v_cod_escala          srv_escala_faixa.cod_escala%type;
     v_num_seq_escala_fx   srv_escala_faixa.num_seq_escala_fx%type;
     v_num_realz_fx        srv_escala_faixa.num_realz_fx%type;
     v_cod_un_realz_fx     srv_escala_faixa.cod_un_realz_fx%type;
     v_flg_pct_100         srv_escala_faixa.flg_pct_100%type;
     v_num_limite_fx       srv_escala_faixa.num_limite_fx%type;
     v_vr_vendas_tot       srv_meta_filial.num_meta%type;
     v_qtde_vendas_parc    srv_meta_filial.num_meta%type;

     -- var log
     v_cod_fil                srv_filial.cod_fil%type;
     v_cod_emp                srv_filial.cod_emp%type;
     v_flg_meta_100_pct_realz srv_filial.flg_meta_100_pct_realz%type;
     v_cod_tipo_rem_var       srv_tipo_rem_var.cod_tipo_rem_var%type;
     v_cod_grp_indic          srv_grupo_indicador.cod_grp_indic%type;
     v_cod_indic              srv_indicador.cod_indic%type;

     -- cursores
     cur_realz pkg_srv_calc_rem_var.typ_cursor;

     --
     rec_srv_realizado_filial srv_realizado_filial%rowtype;

     -- exception
     e_erro_cria_tab exception;

   -------------
   --Calc TLMKT
   -------------
   begin

     v_data := sysdate;
     --
     v_dt_ini := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
     --
     select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/' || to_char(p_num_ano, '0000')),'dd/mm/yyyy')),'dd/mm/yyyy') || ' ' || '23:59:59'
       into v_dt_fim
       from dual;

     v_cod_fil                := 900;
     v_cod_emp                := 1;
     v_flg_meta_100_pct_realz := 'S';

     -----------------------------------------------------------------------
     -- SELECIONA INDICADORES PARA O GRUPO DE REMUNERACAO LOJAS
     -----------------------------------------------------------------------
     for r_indic_rem_loja in c_indic_rem_loja (p_descr_grp_indic => 'TLMKT') loop

       v_cod_indic := r_indic_rem_loja.cod_indic;

       --TLMKT CARTAO ITAU APROVADO
       if r_indic_rem_loja.descr_indic = 'TLMKT CARTAO ITAU APROVADO' then
          --
          v_nm_tab_realz_fu := 'SRV_REALZFU_TLMKT_APROV_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          v_nm_tab_realz_fi := 'SRV_REALZFI_TLMKT_APROV_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          --
          v_qtd_realizado                  := 0;
          v_vlr_realizado                  := 0;
          --
          v_cod_un_realz                   := null;
          v_meta                           := 0;
          v_cod_un_meta                    := null;
          v_vlr_premio_fil                 := 0;
          v_num_realz_x_meta               := 0;
          v_cod_un_realz_x_meta            := null;
          v_vlr_premio_fil_calc            := 0;
          v_cod_escala                     := null;
          v_num_seq_escala_fx              := null;
          v_num_realz_fx                   := 0;
          v_cod_un_realz_fx                := null;
          v_flg_pct_100                    := 0;
          v_num_limite_fx                  := 0;

          --
          v_var_sql :=              ' select nvl(qtde,0) qtde '         || chr(13) || chr(10);
          v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi      || chr(13) || chr(10);
          v_var_sql := v_var_sql || '  where cod_fil = ' || v_cod_fil   || chr(13) || chr(10);

          open cur_realz for v_var_sql;
          loop
             fetch cur_realz
              into v_qtd_realizado;
             --
             exit when cur_realz%notfound;
          -- cur_venda
          end loop;
          --
          close cur_realz;
          --
          v_qtd_realizado       := nvl(v_qtd_realizado, 0);
          v_vlr_realizado       := nvl(v_vlr_realizado, 0);
          --
          v_cod_un_realz           := 3; -- unidade de UNIDADE

          -- calcular meta da filial para o indicador
          p_cod_erro         := null;
          p_descr_erro       := null;
          --
          prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                            ,p_cod_emp          => v_cod_emp
                            ,p_cod_fil          => v_cod_fil
                            ,p_ano_meta         => p_num_ano
                            ,p_mes_meta         => p_num_mes
                            ,p_meta             => v_meta
                            ,p_cod_un_meta      => v_cod_un_meta
                            ,p_vlr_premio_fil   => v_vlr_premio_fil
                            ,p_pct_calc_meta    => v_pct_calc_meta
                            ,p_cod_erro         => p_cod_erro
                            ,p_descr_erro       => p_descr_erro
                            );

          -- se nao exitir a meta, assumir o valor de realizado como meta
          if p_cod_erro is not null then
             v_meta          := v_qtd_realizado;
             v_cod_un_meta   := 3; -- unidade de UNIDADE
          end if;

          --3 Alt201401
          if v_meta = 0 and v_qtd_realizado > 0 then
             v_meta := v_qtd_realizado;
          end if;

          if v_meta > 0 then
             v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
          elsif v_qtd_realizado = 0 then
             v_num_realz_x_meta       := 0;
          elsif v_flg_meta_100_pct_realz = 'S' then
             v_num_realz_x_meta       := 100;
          else
             v_num_realz_x_meta       := 0;
          end if;
          v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

          -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
          v_vlr_realizado := v_qtd_realizado;

       end if;

       --TLMKT CARTAO ITAU ATIVADO
       if r_indic_rem_loja.descr_indic = 'TLMKT CARTAO ITAU ATIVADO' then
          --
          v_nm_tab_realz_fu := 'SRV_REALZFU_TLMKT_ATIV_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          v_nm_tab_realz_fi := 'SRV_REALZFI_TLMKT_ATIV_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          --
          v_qtd_realizado                  := 0;
          v_vlr_realizado                  := 0;
          --
          v_cod_un_realz                   := null;
          v_meta                           := 0;
          v_cod_un_meta                    := null;
          v_vlr_premio_fil                 := 0;
          v_num_realz_x_meta               := 0;
          v_cod_un_realz_x_meta            := null;
          v_vlr_premio_fil_calc            := 0;
          v_cod_escala                     := null;
          v_num_seq_escala_fx              := null;
          v_num_realz_fx                   := 0;
          v_cod_un_realz_fx                := null;
          v_flg_pct_100                    := 0;
          v_num_limite_fx                  := 0;

          --
          v_var_sql :=              ' select nvl(qtde,0) qtde '           || chr(13) || chr(10);
          v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi        || chr(13) || chr(10);
          v_var_sql := v_var_sql || '  where cod_fil = ' || v_cod_fil     || chr(13) || chr(10);

          open cur_realz for v_var_sql;
          loop
             fetch cur_realz
              into v_qtd_realizado;
             --
             exit when cur_realz%notfound;
          -- cur_venda
          end loop;
          --
          close cur_realz;
          --
          v_qtd_realizado       := nvl(v_qtd_realizado, 0);
          v_vlr_realizado       := nvl(v_vlr_realizado, 0);
          --
          v_cod_un_realz           := 3; -- unidade de UNIDADE

          -- calcular meta da filial para o indicador
          p_cod_erro         := null;
          p_descr_erro       := null;
          --
          prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                            ,p_cod_emp          => v_cod_emp
                            ,p_cod_fil          => v_cod_fil
                            ,p_ano_meta         => p_num_ano
                            ,p_mes_meta         => p_num_mes
                            ,p_meta             => v_meta
                            ,p_cod_un_meta      => v_cod_un_meta
                            ,p_vlr_premio_fil   => v_vlr_premio_fil
                            ,p_pct_calc_meta    => v_pct_calc_meta
                            ,p_cod_erro         => p_cod_erro
                            ,p_descr_erro       => p_descr_erro
                            );

          -- se nao exitir a meta, assumir o valor de realizado como meta
          if p_cod_erro is not null then
             v_meta             := v_qtd_realizado;
             v_cod_un_meta      := 3; -- unidade de UNIDADE
          end if;

          --3 Alt201401
          if v_meta = 0 and v_qtd_realizado > 0 then
             v_meta := v_qtd_realizado;
          end if;

          if v_meta > 0 then
             v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
          elsif v_qtd_realizado = 0 then
             v_num_realz_x_meta       := 0;
          elsif v_flg_meta_100_pct_realz = 'S' then
             v_num_realz_x_meta       := 100;
          else
             v_num_realz_x_meta       := 0;
          end if;
          v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

          -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
          v_vlr_realizado := v_qtd_realizado;

       end if;

       --TLMKT CARTAO ITAU ADICIONAL
       if r_indic_rem_loja.descr_indic = 'TLMKT CARTAO ITAU ADICIONAL' then
          --
          v_nm_tab_realz_fu := 'SRV_REALZFU_TLMKT_ADIC_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          v_nm_tab_realz_fi := 'SRV_REALZFI_TLMKT_ADIC_'
                               ||trim(to_char(p_num_ano, '0000'))
                               ||trim(to_char(p_num_mes, '00'));
          --
          v_qtd_realizado                  := 0;
          v_vlr_realizado                  := 0;
          --
          v_cod_un_realz                   := null;
          v_meta                           := 0;
          v_cod_un_meta                    := null;
          v_vlr_premio_fil                 := 0;
          v_num_realz_x_meta               := 0;
          v_cod_un_realz_x_meta            := null;
          v_vlr_premio_fil_calc            := 0;
          v_cod_escala                     := null;
          v_num_seq_escala_fx              := null;
          v_num_realz_fx                   := 0;
          v_cod_un_realz_fx                := null;
          v_flg_pct_100                    := 0;
          v_num_limite_fx                  := 0;

          --
          v_var_sql :=              ' select nvl(qtde,0) qtde '        || chr(13) || chr(10);
          v_var_sql := v_var_sql || '   from '|| v_nm_tab_realz_fi     || chr(13) || chr(10);
          v_var_sql := v_var_sql || '  where cod_fil = ' || v_cod_fil  || chr(13) || chr(10);

          open cur_realz for v_var_sql;
          loop
             fetch cur_realz
              into v_qtd_realizado;
             --
             exit when cur_realz%notfound;
          -- cur_venda
          end loop;
          --
          close cur_realz;
          --
          v_qtd_realizado       := nvl(v_qtd_realizado, 0);
          v_vlr_realizado       := nvl(v_vlr_realizado, 0);
          --
          v_cod_un_realz           := 3; -- unidade de UNIDADE

          -- calcular meta da filial para o indicador
          p_cod_erro         := null;
          p_descr_erro       := null;
          --
          prc_calc_meta_fil (p_cod_indic        => r_indic_rem_loja.cod_indic
                            ,p_cod_emp          => v_cod_emp
                            ,p_cod_fil          => v_cod_fil
                            ,p_ano_meta         => p_num_ano
                            ,p_mes_meta         => p_num_mes
                            ,p_meta             => v_meta
                            ,p_cod_un_meta      => v_cod_un_meta
                            ,p_vlr_premio_fil   => v_vlr_premio_fil
                            ,p_pct_calc_meta    => v_pct_calc_meta
                            ,p_cod_erro         => p_cod_erro
                            ,p_descr_erro       => p_descr_erro
                            );

          -- se nao exitir a meta, assumir o valor de realizado como meta
          if p_cod_erro is not null then
             v_meta             := v_qtd_realizado;
             v_cod_un_meta      := 3; -- unidade de UNIDADE
          end if;

          --3 Alt201401
          if v_meta = 0 and v_qtd_realizado > 0 then
             v_meta := v_qtd_realizado;
          end if;

          if v_meta > 0 then
             v_num_realz_x_meta      := (v_qtd_realizado / v_meta) * 100;
          elsif v_qtd_realizado = 0 then
             v_num_realz_x_meta       := 0;
          elsif v_flg_meta_100_pct_realz = 'S' then
             v_num_realz_x_meta       := 100;
          else
             v_num_realz_x_meta       := 0;
          end if;
          v_cod_un_realz_x_meta      := 2; -- unidade de PERCENTUAL

          -- para salvar no num_realz da realizado filial salvar o realizado correto (Vlr ou qtde)
          v_vlr_realizado := v_qtd_realizado;

       end if;
       --
       rec_srv_realizado_filial.cod_indic               := r_indic_rem_loja.cod_indic;
       rec_srv_realizado_filial.cod_emp                 := v_cod_emp;
       rec_srv_realizado_filial.cod_fil                 := v_cod_fil;
       rec_srv_realizado_filial.num_ano                 := p_num_ano;
       rec_srv_realizado_filial.num_mes                 := p_num_mes;
       rec_srv_realizado_filial.num_meta                := v_meta;
       rec_srv_realizado_filial.cod_un_meta             := v_cod_un_meta;
       rec_srv_realizado_filial.num_realz               := v_vlr_realizado;
       rec_srv_realizado_filial.cod_un_realz            := v_cod_un_realz;
       rec_srv_realizado_filial.qtd_realz               := v_qtd_realizado;
       rec_srv_realizado_filial.num_realz_x_meta        := v_num_realz_x_meta;
       rec_srv_realizado_filial.cod_un_realz_x_meta     := v_cod_un_realz_x_meta;
       rec_srv_realizado_filial.vlr_premio_fil_calc     := null;
       rec_srv_realizado_filial.cod_un_premio_fil_calc  := null;
       rec_srv_realizado_filial.dt_ini_sit_srv          := v_data;
       rec_srv_realizado_filial.cod_usuario             := p_cod_usuario;
       rec_srv_realizado_filial.cod_escala              := v_cod_escala;
       rec_srv_realizado_filial.num_seq_escala_fx       := v_num_seq_escala_fx;
       rec_srv_realizado_filial.num_realz_fx            := v_num_realz_fx;
       rec_srv_realizado_filial.cod_un_realz_fx         := v_cod_un_realz_fx;


       -- insere o realizado da filial para o indicador
       prc_insere_realz_fil (p_rec_srv_realz_fil  => rec_srv_realizado_filial
                            ,p_cod_erro           => p_cod_erro
                            ,p_descr_erro         => p_descr_erro
                             );
       --
       if p_cod_erro is not null then
          -- logar tabela
          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                                    ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                                    ,p_num_ano     => p_num_ano
                                                    ,p_num_mes     => p_num_mes
                                                    ,p_cod_fil     => v_cod_fil
                                                    ,p_cod_func    => null
                                                    ,p_cod_indic   => v_cod_indic
                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                    );

       -- if p_cod_erro is not null
       end if;

       -- commit por indicador
       commit;

     -- c_indic_rem_loja
     end loop;

     --
     commit;
     --
   exception
     when others then
       p_cod_erro := 1;
       p_descr_erro   := 'Erro geral ao calcular Atingimento Filiais Remun Loja: ' ||
                         'cod_fil: '           || v_cod_fil             || ' - ' ||
                         'cod_tipo_rem_var: '  || v_cod_tipo_rem_var    || ' - ' ||
                         'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                         'cod_indic: '         || v_cod_indic           || ' - ' || sqlerrm;


     -- logar tabela
     v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 7
                                               ,p_nome_proc   => 'PRC_CALC_ATING_FIL_LJ'
                                               ,p_num_ano     => p_num_ano
                                               ,p_num_mes     => p_num_mes
                                               ,p_cod_fil     => v_cod_fil
                                               ,p_cod_func    => null
                                               ,p_cod_indic   => v_cod_indic
                                               ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                               );


   end prc_Calc_Ating_Fil_CCenter;

   -----------------------------------------------------------------------------------------------
   -----------------------------------------------------------------------------------------------
   -- CALCULA REALIZADO FUNCIONARIO LJ
   -----------------------------------------------------------------------------------------------
   -----------------------------------------------------------------------------------------------
   procedure prc_Calc_Realz_Func_CCenter (p_num_ano      in number
                                         ,p_num_mes      in number
                                         ,p_cod_indic    in number     default null
                                         ,p_descr_indic  in varchar2   default null
                                         ,p_cod_usuario  in number
                                         ,p_cod_erro     out number
                                         ,p_descr_erro   out varchar2
                                          ) is

      -- cursor Cargos para os grupos de Remuneracao Variavel LIDERANCA
      cursor c_cargo_grp_rem_var (p_descr_grp_rem_var varchar2) is
         select b.cod_cargo
               ,b.cod_grp_rem_var
           from srv_grupo_rem_variavel a
               ,srv_grupo_cargo        b
          where a.cod_grp_rem_var = b.cod_grp_rem_var
            and a.descr_grp_rem_var = p_descr_grp_rem_var
       order by b.cod_cargo;

      -- cursor dos funcionarios para o cargo LIDERANCA para a filial
      cursor c_func_cargo (p_cod_cargo   number
                          ,p_cur_cod_emp number
                          ,p_cur_cod_fil number) is
         select b.cod_func
               ,b.cod_cargo
           from srv_cargo       a
               ,srv_funcionario b
               ,srv_func_eleg_tlmkt c
          where a.cod_cargo = b.cod_cargo
            and b.cod_func = c.cod_func
            and a.cod_cargo = p_cod_cargo
            and b.cod_emp = p_cur_cod_emp
            and b.cod_fil = p_cur_cod_fil
            and c.num_ano = p_num_ano
            and c.num_mes = p_num_mes

            -- funcionario esteve empregado pelo menos 1 dia no mes
            and b.dt_admissao                    <= last_day(to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                                       '/' || trim(to_char(p_num_ano, '0000')) ||
                                                                       ' 23:59:59', 'dd/mm/yyyy hh24:mi:ss'))
            and (b.dt_demissao                    is null
                 OR
                 b.dt_demissao                    > to_date('01/' || trim(to_char(p_num_mes, '00'))   ||
                                                              '/' || trim(to_char(p_num_ano, '0000')) ||
                                                              ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                )
            -- situacao do funcionario
            and (b.cod_sit_rh                     = 1 -- Em Atividade
                 OR
                 nvl(b.qtd_dias_trab_per,0)       > 0  -- trabalhou pelo menos 1 dia
                 OR
                   -- situacao atual Gozando Ferias OU
                   -- situacao anterior Gozando Ferias E
                   -- situacao atual >= 2o. dia do periodo (esteve pelo menos 1 dia Gozando Ferias)
                 ( b.cod_sit_rh                    = 9 -- Gozando Ferias
                   OR
                  (nvl(b.cod_sit_rh_ant,1)         = 9 -- Gozando Ferias
                   and
                   nvl(b.dt_ini_sit_rh, to_date('01/' || trim(to_char(p_num_mes, '00'))||
                                                  '/' || trim(to_char(p_num_ano, '0000')) ||
                                                  ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
                                                  >= to_date('02/' || trim(to_char(p_num_mes, '00'))   ||
                                                               '/' || trim(to_char(p_num_ano, '0000')) ||
                                                               ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')
                  )
                 )
                )
          order by b.cod_func;

      -- REMUNERACAO LOJAS
      cursor c_indic_rem_loja (p_descr_grp_indic srv_grupo_indicador.descr_grp_indic%type) is
        select c.cod_indic
             , c.descr_indic
          from srv_tipo_rem_var          a
         inner join srv_grupo_indicador  b on b.cod_tipo_rem_var = a.cod_tipo_rem_var
         inner join srv_indicador        c on c.cod_grp_indic    = b.cod_grp_indic
                                          and upper(c.flg_indic_ativ) = 'S'
         where b.descr_grp_indic = p_descr_grp_indic;

      --Variables
      v_meta                          srv_realizado_filial.num_meta%type;
      v_cod_un_meta                   srv_realizado_filial.cod_un_meta%type;
      v_num_realz_fil                 srv_realizado_filial.num_realz%type;
      v_cod_un_realz                  srv_realizado_filial.cod_un_realz%type;
      v_num_realz_x_meta              srv_realizado_filial.num_realz_x_meta%type;
      v_cod_un_realz_x_meta           srv_realizado_filial.cod_un_realz_x_meta%type;
      v_num_realz_x_meta_limitador    srv_realizado_filial.num_realz_x_meta%type;
      v_cod_pond                      srv_ponderacao.cod_pond%type;
      v_num_peso                      srv_ponderacao.num_peso%type;
      v_cod_un_peso                   srv_ponderacao.cod_un_peso%type;
      v_vlr_premio                    srv_ponderacao.vlr_premio%type;
      v_vlr_premio_func_calc          srv_realizado_func_indicador.vlr_premio_func_calc%type;
      v_num_realz_pond                srv_realizado_func_indicador.num_realz_pond%type;
      v_cod_func                      srv_funcionario.cod_func%type;
      v_cod_escala                    srv_escala_faixa.cod_escala%type;
      v_num_seq_escala_fx             srv_escala_faixa.num_seq_escala_fx%type;
      v_num_realz_fx                  srv_escala_faixa.num_realz_fx%type;
      v_cod_un_realz_fx               srv_escala_faixa.cod_un_realz_fx%type;
      v_flg_pct_100                   srv_escala_faixa.flg_pct_100%type;
      v_num_limite_fx                 srv_escala_faixa.num_limite_fx%type;
      v_cod_grp_indic                 srv_grupo_indicador.cod_grp_indic%type;
      v_cod_emp                       srv_filial.cod_emp%type;
      v_cod_fil                       srv_filial.cod_fil%type;
      v_cod_indic                     srv_indicador.cod_indic%type;
      v_cod_cargo                     srv_cargo.cod_cargo%type;
      rec_srv_realizado_func_indic    srv_realizado_func_indicador%rowtype;

      v_cod_grp_rem_var               srv_grupo_rem_variavel.cod_grp_rem_var%type;
      v_nm_tab_realz_fi               srv_realizado_tab_tmp.nm_tab_realz_fil%type;
      v_nm_tab_realz_fu               srv_realizado_tab_tmp.nm_tab_realz_func%type;
      v_var_sql                       varchar2(2000);
      cur_realz                       pkg_srv_calc_rem_var.typ_cursor;
      v_cpf_vendedor                  number(11);
      v_cod_cargo_func                srv_funcionario.cod_cargo%type;
      v_num_realz_func                srv_realizado_func_indicador.num_realz%type;

   begin

      v_data    := sysdate;
      --
      v_dt_ini  := '01/' || trim(to_char(p_num_mes, '00')) || '/' || trim(to_char(p_num_ano, '0000')) || ' ' || '00:00:00';
      --
      select to_char(last_day(to_date(('01/' || to_char(p_num_mes, '00') || '/'||to_char(p_num_ano, '0000')), 'dd/mm/yyyy')), 'dd/mm/yyyy')|| ' ' || '23:59:59'
        into v_dt_fim
        from dual;

      -------------------------------
      -- TLMKT
      -------------------------------
      Begin

        for r_indic_rem_loja in c_indic_rem_loja(p_descr_grp_indic => 'TLMKT') loop

          v_cod_indic     := r_indic_rem_loja.cod_indic;
          v_cod_fil       := 900;
          v_cod_emp       := 1;

          -- seleciona realz X meta e vlr premio calculado da filial
          begin
            select a.num_meta,
                   a.cod_un_meta,
                   a.num_realz,
                   a.cod_un_realz,
                   a.num_realz_x_meta,
                   a.cod_un_realz_x_meta
              into v_meta,
                   v_cod_un_meta,
                   v_num_realz_fil,
                   v_cod_un_realz,
                   v_num_realz_x_meta,
                   v_cod_un_realz_x_meta
              from srv_realizado_filial a
                 , srv_indicador        b
             where a.cod_indic = b.cod_indic
               and a.cod_emp = v_cod_emp
               and a.cod_fil = v_cod_fil
               and b.descr_indic = r_indic_rem_loja.descr_indic
               and a.num_ano = p_num_ano
               and a.num_mes = p_num_mes;
          exception
            when others then
              v_meta                := 0;
              v_cod_un_meta         := null;
              v_num_realz_fil       := 0;
              v_cod_un_realz        := null;
              v_num_realz_x_meta    := 0;
              v_cod_un_realz_x_meta := null;
          end;

          -----------------------------------------------------------------------
          -- CARGOS LIDERANCA DO TLMKT
          -----------------------------------------------------------------------
          begin

            for r_cargo_grp_rem_var in c_cargo_grp_rem_var(p_descr_grp_rem_var => 'TLMKT') loop

              v_cod_cargo := r_cargo_grp_rem_var.cod_cargo;

              -- Extrai Poderacao
              begin
                prc_calc_ponderacao_tp_fil2(p_cod_indic       => r_indic_rem_loja.cod_indic,
                                            p_cod_grp_indic   => null,
                                            p_cod_cargo       => r_cargo_grp_rem_var.cod_cargo,
                                            p_cod_grp_rem_var => null,
                                            p_cod_tipo_fil    => 1,
                                            p_cod_emp         => v_cod_emp,
                                            p_cod_fil         => v_cod_fil,
                                            p_cod_pond        => v_cod_pond,
                                            p_num_peso        => v_num_peso,
                                            p_cod_un_peso     => v_cod_un_peso,
                                            p_vlr_premio      => v_vlr_premio,
                                            p_cod_erro        => p_cod_erro,
                                            p_descr_erro      => p_descr_erro);
              exception
                when others then
                  null;
              end;

              -- Extrai escala
              begin
                prc_calc_escala_fx(r_indic_rem_loja.cod_indic, --p_cod_indic
                                   null,                       --p_cod_grp_indic
                                   null,                       --p_cod_grp_rem_var
                                   v_num_realz_x_meta,         --p_num_realz_x_meta
                                   v_cod_escala,
                                   v_num_seq_escala_fx,
                                   v_num_realz_fx,
                                   v_cod_un_realz_fx,
                                   v_flg_pct_100,
                                   v_num_limite_fx,
                                   p_cod_erro,
                                   p_descr_erro);
              exception
                when others then
                  null;
              end;

              -- armazena vr original de atingimento
              v_num_realz_x_meta_limitador := v_num_realz_x_meta;

              -- Limitar 100% a faixa para o cargo 752(ANL MIS E PLANEJAMENTO PL)
              if r_cargo_grp_rem_var.cod_cargo = 752 and nvl(v_num_limite_fx, 0) > 0 then

                v_num_limite_fx := 100;

              end if;

              /*verifica se ha limite superior da faixa, e se a faixa resultado
              for maior que o limite entao assumir o valor limite*/
              if nvl(v_num_limite_fx, 0) > 0 and v_num_realz_x_meta_limitador > v_num_limite_fx then

                v_num_realz_x_meta_limitador := v_num_limite_fx;

              end if;

              if nvl(v_num_realz_fx, 0) <> 0 then

                v_num_realz_fx := v_num_realz_x_meta_limitador;

              end if;

              begin
                v_num_realz_pond := (v_num_realz_x_meta * v_num_peso) / 100;
              exception
                when others then
                  null;
              end;

              v_vlr_premio_func_calc := ((v_vlr_premio * v_num_realz_fx) / 100);

              -- selecionar todos os funcionarios desse cargo para essa filial e
              Begin
                for r_func_cargo in c_func_cargo(p_cod_cargo   => r_cargo_grp_rem_var.cod_cargo
                                                ,p_cur_cod_emp => v_cod_emp
                                                ,p_cur_cod_fil => v_cod_fil) loop

                  v_cod_func := r_func_cargo.cod_func;

                  -- gravar na srv_realizado_func_indicador
                  rec_srv_realizado_func_indic.cod_func                      := r_func_cargo.cod_func;
                  rec_srv_realizado_func_indic.cod_cargo                     := r_func_cargo.cod_cargo;
                  rec_srv_realizado_func_indic.cod_indic                     := r_indic_rem_loja.cod_indic;
                  rec_srv_realizado_func_indic.cod_emp                       := v_cod_emp;
                  rec_srv_realizado_func_indic.cod_fil                       := v_cod_fil;
                  rec_srv_realizado_func_indic.num_ano                       := p_num_ano;
                  rec_srv_realizado_func_indic.num_mes                       := p_num_mes;

                  rec_srv_realizado_func_indic.cod_escala                    := v_cod_escala;
                  rec_srv_realizado_func_indic.num_seq_escala_fx             := v_num_seq_escala_fx;
                  rec_srv_realizado_func_indic.num_realz_fx                  := v_num_realz_fx;
                  rec_srv_realizado_func_indic.cod_un_realz_fx               := v_cod_un_realz_fx;

                  rec_srv_realizado_func_indic.cod_pond                      := v_cod_pond;
                  rec_srv_realizado_func_indic.num_peso                      := v_num_peso;
                  rec_srv_realizado_func_indic.cod_un_peso                   := v_cod_un_peso;
                  rec_srv_realizado_func_indic.num_realz_pond                := v_num_realz_pond;
                  rec_srv_realizado_func_indic.cod_un_realz_pond             := 2; -- unidade PERCENTUAL

                  rec_srv_realizado_func_indic.num_meta                      := v_meta;
                  rec_srv_realizado_func_indic.cod_un_meta                   := v_cod_un_meta;
                  rec_srv_realizado_func_indic.num_realz                     := v_num_realz_fil;
                  rec_srv_realizado_func_indic.cod_un_realz                  := v_cod_un_realz;
                  rec_srv_realizado_func_indic.num_realz_x_meta              := v_num_realz_x_meta;
                  rec_srv_realizado_func_indic.cod_un_realz_x_meta           := v_cod_un_realz_x_meta;

                  rec_srv_realizado_func_indic.vlr_premio                    := v_vlr_premio;
                  rec_srv_realizado_func_indic.vlr_premio_func_calc          := v_vlr_premio_func_calc;
                  rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc   := null;
                  rec_srv_realizado_func_indic.pct_calc_rateio               := null;

                  rec_srv_realizado_func_indic.dt_ini_sit_srv                := v_data;
                  rec_srv_realizado_func_indic.cod_usuario                   := p_cod_usuario;
                  rec_srv_realizado_func_indic.seg_fil                       := 'N';

                  -- alteracao, manter apenas um registro para o funcionario se a filial mudou
                  prc_ins_realz_func_indic_ultfi(p_rec_srv_realz_func_indic => rec_srv_realizado_func_indic,
                                                 p_cod_erro                 => p_cod_erro,
                                                 p_descr_erro               => p_descr_erro);

                -- c_func_cargo
                end loop;

              Exception
                When Others Then
                  Null;
              End;

            -- c_cargo_grp_rem_var
            end loop;

            --
            commit;

          exception
            when others then
              p_cod_erro   := 1;
              p_descr_erro := 'Erro Geral ao calcular indicador Vendas para Cargos Lideranca ' ||
                              ' cod_fil:  ' || v_cod_fil ||
                              ' cod_indic:  ' || v_cod_indic ||
                              ' cod_cargo:  ' || v_cod_cargo ||
                              ' cod_func:  ' || v_cod_func || ' erro: ' ||
                              sqlerrm;

              -- logar tabela
              v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                        p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                        p_num_ano   => p_num_ano,
                                                        p_num_mes   => p_num_mes,
                                                        p_cod_fil   => v_cod_fil,
                                                        p_cod_func  => v_cod_func,
                                                        p_cod_indic => v_cod_indic,
                                                        p_erro      => p_cod_erro || ' - ' || p_descr_erro);

          end;

          -- commit por indicador
          commit;

        ------------------------------------------------
        -- c_indic_rem_loja
        ------------------------------------------------
        end loop;

        ------------------------------------------------
        -- commit por filial
        ------------------------------------------------
        commit;

      exception
        when others then
           p_cod_erro     := 1;
           p_descr_erro   := 'Erro geral na procedure prc_calc_realz_Func_Indic_Lj: Calculo do realizado Funcionario Indicador Loja: ' ||
                             'cod_fil: '           || v_cod_fil             || ' - ' ||
                             'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                             'cod_indic: '         || v_cod_indic           || ' - ' ||
                             'cod_cargo: '         || v_cod_cargo           || ' - ' ||
                             'cod_func: '          || v_cod_func            || ' - ' || sqlerrm;

           -- logar tabela
           v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                     ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                     ,p_num_ano     => p_num_ano
                                                     ,p_num_mes     => p_num_mes
                                                     ,p_cod_fil     => v_cod_fil
                                                     ,p_cod_func    => v_cod_func
                                                     ,p_cod_indic   => v_cod_indic
                                                     ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                     );
      end;


      -------------------------------
      -- SAC
      -------------------------------
      /*begin

        for r_indic_rem_loja in c_indic_rem_loja(p_descr_grp_indic => 'SAC') loop

          --Variables
          v_cod_emp       := 1;
          v_cod_fil       := 900;
          v_cod_indic     := r_indic_rem_loja.cod_indic;

          -- calcula valor unitario para multiplicar pela qtde
          v_vlr_premio    := (50 / 100);
          v_num_limite_fx := 400;

          -- tabela gerada de apuracao realizado para o indicador
          select a.nm_tab_realz_fil  ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
                ,a.nm_tab_realz_func ||'_'||trim(to_char(p_num_ano, '0000'))||trim(to_char(p_num_mes, '00'))
            into v_nm_tab_realz_fi
                ,v_nm_tab_realz_fu
            from srv_realizado_tab_tmp@lksrv a
           where a.cod_indic = r_indic_rem_loja.cod_indic;

          -- selecionar todos os funcionarios desse cargo para essa filial e
          begin
            v_var_sql :=              'select b.cod_func'                                                      || chr(13) || chr(10);
            v_var_sql := v_var_sql || '      ,b.cod_cargo'                                                     || chr(13) || chr(10);
            v_var_sql := v_var_sql || '      ,count(*) num_realz_func'                                         || chr(13) || chr(10);
            v_var_sql := v_var_sql || '  from '||v_nm_tab_realz_fu ||' a'                                      || chr(13) || chr(10);
            v_var_sql := v_var_sql || ' inner join srv_funcionario@lksrv b on b.num_cpf_func = a.cpf_vendedor' || chr(13) || chr(10);
            v_var_sql := v_var_sql || '                                   and b.cod_sit_rh <> 2'               || chr(13) || chr(10);
            v_var_sql := v_var_sql || ' where a.cod_fil = '|| v_cod_fil                                        || chr(13) || chr(10);
            v_var_sql := v_var_sql || ' group by a.cpf_vendedor'                                               || chr(13) || chr(10);
            v_var_sql := v_var_sql || '         ,b.cod_func'                                                   || chr(13) || chr(10);
            v_var_sql := v_var_sql || '         ,b.cod_cargo';

            open cur_realz for v_var_sql;
              loop
                fetch cur_realz
                into v_cod_func
                    ,v_cod_cargo_func
                    ,v_num_realz_func;

                exit when cur_realz%notfound;
                --
                v_vlr_premio_func_calc := v_num_realz_func * v_vlr_premio;

                if v_vlr_premio_func_calc  > v_num_limite_fx then
                   v_vlr_premio_func_calc := v_num_limite_fx;
                end if;

                -- gravar na srv_realizado_func_indicador
                rec_srv_realizado_func_indic.cod_func                := v_cod_func;
                rec_srv_realizado_func_indic.cod_cargo               := v_cod_cargo_func;
                rec_srv_realizado_func_indic.cod_indic               := r_indic_rem_loja.cod_indic;
                rec_srv_realizado_func_indic.cod_emp                 := v_cod_emp;
                rec_srv_realizado_func_indic.cod_fil                 := v_cod_fil;
                rec_srv_realizado_func_indic.num_ano                 := p_num_ano;
                rec_srv_realizado_func_indic.num_mes                 := p_num_mes;

                rec_srv_realizado_func_indic.cod_escala              := null;
                rec_srv_realizado_func_indic.num_seq_escala_fx       := null;
                rec_srv_realizado_func_indic.num_realz_fx            := null;
                rec_srv_realizado_func_indic.cod_un_realz_fx         := null;

                rec_srv_realizado_func_indic.cod_pond                := null;
                rec_srv_realizado_func_indic.num_peso                := null;
                rec_srv_realizado_func_indic.cod_un_peso             := null;
                rec_srv_realizado_func_indic.num_realz_pond          := null;
                rec_srv_realizado_func_indic.cod_un_realz_pond       := null;

                rec_srv_realizado_func_indic.num_meta                := null;
                rec_srv_realizado_func_indic.cod_un_meta             := null;
                rec_srv_realizado_func_indic.num_realz               := v_num_realz_func;
                rec_srv_realizado_func_indic.cod_un_realz            := 1;
                rec_srv_realizado_func_indic.num_realz_x_meta        := null;
                rec_srv_realizado_func_indic.cod_un_realz_x_meta     := null;

                rec_srv_realizado_func_indic.vlr_premio              := v_vlr_premio;
                rec_srv_realizado_func_indic.vlr_premio_func_calc    := v_vlr_premio_func_calc;
                rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
                rec_srv_realizado_func_indic.pct_calc_rateio         := null;

                rec_srv_realizado_func_indic.dt_ini_sit_srv          := v_data;
                rec_srv_realizado_func_indic.cod_usuario             := p_cod_usuario;

                -- inserir o realizado do funcionario pelo indicador
                prc_insere_realz_func_indic (p_rec_srv_realz_func_indic  => rec_srv_realizado_func_indic
                                            ,p_cod_erro                  => p_cod_erro
                                            ,p_descr_erro                => p_descr_erro
                                             );

              -- cur_venda
              end loop;
            --
            close cur_realz;

          exception
            when others then
              p_cod_erro     := 1;
              p_descr_erro   := 'Erro ao inserir realizado funcionario SAC' ||
                                ' cod_fil:  '    || v_cod_fil   ||
                                ' cod_indic:  '  || v_cod_indic ||
                                ' cod_func:  '   || v_cod_func  ||
                                ' erro: '        || sqlerrm;

              v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                        ,p_nome_proc   => 'SAC'
                                                        ,p_num_ano     => p_num_ano
                                                        ,p_num_mes     => p_num_mes
                                                        ,p_cod_fil     => v_cod_fil
                                                        ,p_cod_func    => v_cod_func
                                                        ,p_cod_indic   => v_cod_indic
                                                        ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                        );
          end;

          -- commit por indicador
          commit;

        --c_indic_rem_loja
        end loop;

      exception
        when others then
          p_cod_erro     := 1;
          p_descr_erro   := 'Erro ao calcular indicadores SAC' ||
                            ' cod_fil:  '    || v_cod_fil   ||
                            ' cod_indic:  '  || v_cod_indic ||
                            ' cod_func:  '   || v_cod_func  ||
                            ' erro: '        || sqlerrm;

          v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                    ,p_nome_proc   => 'SAC'
                                                    ,p_num_ano     => p_num_ano
                                                    ,p_num_mes     => p_num_mes
                                                    ,p_cod_fil     => v_cod_fil
                                                    ,p_cod_func    => v_cod_func
                                                    ,p_cod_indic   => v_cod_indic
                                                    ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                    );
      --FIM do Calculo do SAC
      end;*/


   exception
      when others then
         p_cod_erro     := 1;
         p_descr_erro   := 'Erro geral na procedure prc_calc_realz_Func_Indic_Lj: Calculo do realizado Funcionario Indicador Loja: ' ||
                           'cod_fil: '           || v_cod_fil             || ' - ' ||
                           'cod_grp_indic: '     || v_cod_grp_indic       || ' - ' ||
                           'cod_indic: '         || v_cod_indic           || ' - ' ||
                           'cod_cargo: '         || v_cod_cargo           || ' - ' ||
                           'cod_func: '          || v_cod_func            || ' - ' || sqlerrm;

         -- logar tabela
         v_ins_log_erro := fnc_insere_log_processo (p_cod_proc    => 3
                                                   ,p_nome_proc   => 'PRC_CALC_REALZ_FUNC_INDIC_LJ'
                                                   ,p_num_ano     => p_num_ano
                                                   ,p_num_mes     => p_num_mes
                                                   ,p_cod_fil     => v_cod_fil
                                                   ,p_cod_func    => v_cod_func
                                                   ,p_cod_indic   => v_cod_indic
                                                   ,p_erro        => p_cod_erro || ' - ' || p_descr_erro
                                                   );

   end prc_Calc_Realz_Func_CCenter;



  /*##########################################################################
  Processo para calculo de PPR Lojas
  ##########################################################################*/
  procedure prc_calc_realz_ppr(p_num_ano     in number,
                               p_num_mes     in number,
                               p_cod_emp     in number default null,
                               p_cod_fil     in number default null,
                               p_cod_indic   in number default null,
                               p_descr_indic in varchar2 default null,
                               p_cod_usuario in number,
                               p_cod_erro    out number,
                               p_descr_erro  out varchar2) is

    v_meta                       srv_realizado_filial.num_meta%type;
    v_num_realz                  srv_realizado_filial.num_realz%type;
    v_num_realz_x_meta           srv_realizado_filial.num_realz_x_meta%type;
    v_num_realz_x_meta_limitador srv_realizado_filial.num_realz_x_meta%type;
    v_vlr_premio_func_calc       srv_realizado_func_indicador.vlr_premio_func_calc%type;
    v_vlr_premio_seg_fil         srv_realizado_func_indicador.vlr_premio_func_calc%type;
    v_cod_func                   srv_funcionario.cod_func%type;
    v_cod_fil                    srv_filial.cod_fil%type;
    v_cod_indic                  srv_indicador.cod_indic%type;
    v_descr_indic                srv_indicador.descr_indic%type;
    rec_srv_realizado_func_indic srv_realizado_func_indicador%rowtype;

    -- FILIAIS
    cursor c_fil(p_cod_emp number, p_cod_fil number) is
      select cod_emp, cod_fil
        from srv_filial
       where flg_ativ = 'S'
         --and cod_fil = 10
         and (cod_emp = p_cod_emp or p_cod_emp is null)
         and (cod_fil = p_cod_fil or p_cod_fil is null)
       order by cod_fil;

    -- INDICADORES LIDER VENDAS
    cursor c_indic_sistemico_vendas is
      select cod_indic, descr_indic
        from srv_indicador
       where cod_indic in (524, 525, 528)
         and (descr_indic = p_descr_indic or p_descr_indic is null)
         and flg_indic_ativ = 'S'
       order by cod_indic;

    -- INDICADORES LIDER PSF
    cursor c_indic_sistemico_psf is
      select cod_indic, descr_indic
        from srv_indicador
       where cod_indic in (526, 527, 528)
         and (descr_indic = p_descr_indic or p_descr_indic is null)
         and flg_indic_ativ = 'S'
       order by cod_indic;

    -- INDICADORES OPERACIONAL
    cursor c_indic_sistemico_operacional is
      select cod_indic, descr_indic
        from srv_indicador
       where cod_indic in (524, 528)
         and (descr_indic = p_descr_indic or p_descr_indic is null)
         and flg_indic_ativ = 'S'
       order by cod_indic;

    -- INDICADORES ASSIST ADM
      cursor c_indic_sistemico_assist_adm is
      select cod_indic, descr_indic
        from srv_indicador
       where cod_indic in (524, 528)
         and (descr_indic = p_descr_indic or p_descr_indic is null)
         and flg_indic_ativ = 'S'
       order by cod_indic;

    -- FUNCIONARIO VENDAS
    cursor c_func_vendas(v_cod_fil number, p_num_ano number, p_num_mes number) is
      select a.cod_func,
             c.cod_cargo,
             sum(case
                   when a.cod_cargo in (select cod_cargo
                                          from srv_grupo_cargo
                                         where cod_grp_rem_var = 3) and cod_indic <> 40 then
                    0
                   when a.cod_cargo in(select cod_cargo
                                         from srv_grupo_cargo
                                        where cod_grp_rem_var in (4, 5)) and cod_indic <> 1 then
                    0
                   else
                    nvl(vlr_premio_func_calc, 0)
                 end) vlr_premio,
             b.cod_func_n_elegivel
        from srv_realizado_func_indicador a
           , srv_funcionario              c
           , tmp_func_n_elegivel          b
       where a.cod_func = c.cod_func
         and a.cod_func = b.cod_func_n_elegivel(+)
         and c.cod_fil = v_cod_fil
         and a.num_ano = p_num_ano
         and a.num_mes between (p_num_mes - 2) and p_num_mes
         and nvl(a.seg_fil,'N') = 'N'
         and c.cod_cargo in (select cod_cargo
                               from srv_grupo_cargo
                              where cod_grp_rem_var = 3) --LIDERANCA DE LOJA
         and c.cod_cargo not in (710, 714, 963, 1170, 1166, 1167, 918) --SEM CARGOS DE PSF
         and c.cod_cargo not in (467, 344, 473) --SEM CARGOS DE ASSISTENTES ADM
       group by a.cod_func, c.cod_cargo, b.cod_func_n_elegivel;

    -- FUNCIONARIO PSF
    cursor c_func_psf(v_cod_fil number, p_num_ano number, p_num_mes number) is
      select a.cod_func,
             c.cod_cargo,
             sum(case
                   when a.cod_cargo in (select cod_cargo
                                          from srv_grupo_cargo
                                         where cod_grp_rem_var = 3) and cod_indic <> 40 then
                    0
                   when a.cod_cargo in(select cod_cargo
                                         from srv_grupo_cargo
                                        where cod_grp_rem_var in (4, 5)) and cod_indic <> 1 then
                    0
                   else
                    nvl(vlr_premio_func_calc, 0)
                 end) vlr_premio,
             b.cod_func_n_elegivel
        from srv_realizado_func_indicador a,
             srv_funcionario              c,
             tmp_func_n_elegivel          b
       where a.cod_func = c.cod_func
         and a.cod_func = b.cod_func_n_elegivel(+)
         and c.cod_fil = v_cod_fil
         and a.num_ano = p_num_ano
         and a.num_mes between (p_num_mes - 2) and p_num_mes
         and c.cod_cargo in (710, 714, 963, 1170, 1166, 1167, 918) --SOMENTE CARGOS DE PSF
         and nvl(a.seg_fil,'N') = 'N'
       group by a.cod_func, c.cod_cargo, b.cod_func_n_elegivel;

    -- FUNCIONARIO OPERACIONAL
    cursor c_func_operacional(v_cod_fil number, p_num_ano number, p_num_mes number) is
       select a.cod_func,
              b.cod_cargo,
              sum(case
                   when a.cod_cargo in (select cod_cargo
                                          from srv_grupo_cargo
                                         where cod_grp_rem_var = 3) and cod_indic <> 40 then
                    0
                   when a.cod_cargo in(select cod_cargo
                                         from srv_grupo_cargo
                                        where cod_grp_rem_var in (4, 5)) and cod_indic <> 1 then
                    0
                   else
                    nvl(vlr_premio_func_calc, 0)
                 end) vlr_premio,
             d.cod_func_n_elegivel
        from srv_realizado_func_indicador a,
             srv_funcionario              b,
             srv_grupo_cargo              c,
             tmp_func_n_elegivel          d
       where a.cod_func = b.cod_func
         and b.cod_cargo = c.cod_cargo
         and a.cod_func = d.cod_func_n_elegivel(+)
         and c.cod_grp_rem_var in(4,5)
         and b.cod_fil = v_cod_fil
         and a.num_ano = p_num_ano
         and a.num_mes between (p_num_mes - 2) and p_num_mes
       group by a.cod_func, b.cod_cargo,d.cod_func_n_elegivel;

    -- FUNCIONARIO ASSIST ADM
    cursor c_func_assist_adm(v_cod_fil number, p_num_ano number, p_num_mes number) is
      select a.cod_func,
             c.cod_cargo,
             sum(case
                   when a.cod_cargo in (select cod_cargo
                                          from srv_grupo_cargo
                                         where cod_grp_rem_var = 3) and cod_indic <> 40 then
                    0
                   when a.cod_cargo in(select cod_cargo
                                         from srv_grupo_cargo
                                        where cod_grp_rem_var in (4, 5)) and cod_indic <> 1 then
                    0
                   else
                    nvl(vlr_premio_func_calc, 0)
                 end) vlr_premio,
             b.cod_func_n_elegivel
        from srv_realizado_func_indicador a,
             srv_funcionario              c,
             tmp_func_n_elegivel          b
       where a.cod_func = c.cod_func
         and a.cod_func = b.cod_func_n_elegivel(+)
         and c.cod_fil = v_cod_fil
         and a.num_ano = p_num_ano
         and a.num_mes between (p_num_mes - 2) and p_num_mes
         and c.cod_cargo in(467,344,473) --SOMENTE CARGOS DE ASSIST ADM
       group by a.cod_func, c.cod_cargo, b.cod_func_n_elegivel;

  begin

    v_data := sysdate;

    -----------------------------------------------------------------------
    -- SELECIONA FILIAIS ATIVAS
    -----------------------------------------------------------------------
    for r_fil in c_fil(p_cod_emp, p_cod_fil) loop

      v_cod_fil := r_fil.cod_fil;

      --#####################################################################
      --CARGO DE VENDAS
      --#####################################################################
      begin

        -- somar os resultados dos pesos das ponderacoes para todos os indicadores VENDAS
        for r_func_vendas in c_func_vendas(v_cod_fil, p_num_ano, p_num_mes) loop

          for r_indic_sistemico in c_indic_sistemico_vendas loop

            v_cod_indic   := r_indic_sistemico.cod_indic;
            v_descr_indic := r_indic_sistemico.descr_indic;

            if v_descr_indic = 'ALAVANCADOR VENDAS' then

              begin
                select sum(num_meta)
                     , sum(num_realz)
                     ,(sum(num_realz) / sum(num_meta)) * 100
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_vendas.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 1 --VENDAS
                   and nvl(seg_fil,'N') = 'N';
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_vendas.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_vendas.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then
                v_vlr_premio_func_calc := (r_func_vendas.vlr_premio * 15) / 100;
              else
                v_vlr_premio_func_calc := 0;
              end if;

            elsif v_descr_indic = 'ALAVANCADOR PPT - PECAS POR TICKET' then

              begin
                select sum(num_meta)
                     , sum(num_realz)
                     ,(sum(num_realz) / sum(num_meta)) * 100
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_vendas.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 23 --PPT - PECAS POR TICKET
                   and nvl(seg_fil,'N') = 'N';
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_vendas.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_vendas.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then

                -------------------------------------------------------------------
                --Efetua o pagamento mediante ao atigimento do primeiro alavancador
                -------------------------------------------------------------------
                begin
                  select num_realz_x_meta
                    into v_num_realz_x_meta_limitador
                    from srv_realizado_func_indicador
                   where cod_func = r_func_vendas.cod_func
                     and num_ano = p_num_ano
                     and num_mes = p_num_mes
                     and cod_indic = 524 --ALAVANCADOR VENDAS
                     and nvl(seg_fil,'N') = 'N';
                exception
                  when others then
                    v_num_realz_x_meta_limitador := 0;
                end;
                -------------------------------------------------------------------
                if v_num_realz_x_meta_limitador >= 100 then
                  v_vlr_premio_func_calc := (r_func_vendas.vlr_premio * 10) / 100;
                else
                  v_vlr_premio_func_calc := 0;
                end if;

              else

                v_vlr_premio_func_calc := 0;

              end if;

            elsif v_descr_indic = 'PPR' then

              begin
                select sum(vlr_premio_func_calc)
                  into v_vlr_premio_func_calc
                  from srv_realizado_func_indicador
                 where cod_func = r_func_vendas.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic in (524, 525);

                v_meta             := null;
                v_num_realz        := null;
                v_num_realz_x_meta := null;

              exception
                when others then
                  v_meta                 := null;
                  v_num_realz            := null;
                  v_num_realz_x_meta     := null;
                  v_vlr_premio_func_calc := 0;
              end;

              --Valor a receber pela segunda filial
              begin
                select nvl(sum(vlr_premio_func_calc),0)
                  into v_vlr_premio_seg_fil
                  from srv_realizado_func_indicador
                 where cod_func = r_func_vendas.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic in (40)
                   and nvl(seg_fil,'N') = 'S';

              exception
                when others then
                  v_vlr_premio_seg_fil := 0;
              end;

              v_vlr_premio_func_calc := v_vlr_premio_func_calc + r_func_vendas.vlr_premio + v_vlr_premio_seg_fil;

            end if;

            -- gravar na srv_realizado_func_indicador
            rec_srv_realizado_func_indic.cod_func                    := r_func_vendas.cod_func;
            rec_srv_realizado_func_indic.cod_cargo                   := r_func_vendas.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic                   := r_indic_sistemico.cod_indic;
            rec_srv_realizado_func_indic.cod_emp                     := r_fil.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                     := r_fil.cod_fil;
            rec_srv_realizado_func_indic.num_ano                     := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                     := p_num_mes;
            rec_srv_realizado_func_indic.cod_escala                  := 1;
            rec_srv_realizado_func_indic.num_seq_escala_fx           := null;
            rec_srv_realizado_func_indic.num_realz_fx                := null;
            rec_srv_realizado_func_indic.cod_un_realz_fx             := null;
            rec_srv_realizado_func_indic.cod_pond                    := null;
            rec_srv_realizado_func_indic.num_peso                    := null;
            rec_srv_realizado_func_indic.cod_un_peso                 := null;
            rec_srv_realizado_func_indic.num_realz_pond              := null;
            rec_srv_realizado_func_indic.cod_un_realz_pond           := null;
            rec_srv_realizado_func_indic.num_meta                    := v_meta;
            rec_srv_realizado_func_indic.cod_un_meta                 := 3;
            rec_srv_realizado_func_indic.num_realz                   := v_num_realz;
            rec_srv_realizado_func_indic.cod_un_realz                := 3;
            rec_srv_realizado_func_indic.num_realz_x_meta            := v_num_realz_x_meta;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta         := 2;
            rec_srv_realizado_func_indic.vlr_premio                  := r_func_vendas.vlr_premio;
            rec_srv_realizado_func_indic.vlr_premio_func_calc        := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
            rec_srv_realizado_func_indic.pct_calc_rateio             := null;
            rec_srv_realizado_func_indic.dt_ini_sit_srv              := v_data;
            rec_srv_realizado_func_indic.cod_usuario                 := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                     := null;

            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi(p_rec_srv_realz_func_indic => rec_srv_realizado_func_indic,
                                           p_cod_erro                 => p_cod_erro,
                                           p_descr_erro               => p_descr_erro);
            --
            if p_cod_erro is not null then

              -- logar tabela
              v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                        p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                        p_num_ano   => p_num_ano,
                                                        p_num_mes   => p_num_mes,
                                                        p_cod_fil   => v_cod_fil,
                                                        p_cod_func  => r_func_vendas.cod_func,
                                                        p_cod_indic => v_cod_indic,
                                                        p_erro      => p_cod_erro || ' - ' || p_descr_erro);
            end if;

          end loop;

        -- c_indic_sistemico AGRUPAMENTO LIDER PSF
        end loop;

        -- commit por indicador
        commit;

        --
      exception
        when others then
          p_cod_erro   := 1;
          p_descr_erro := 'Erro Geral ao calcular O AGRUPAMENTO PSF Lideranca Loja' ||
                          ' cod_fil:  ' || v_cod_fil || ' cod_indic:  ' ||
                          v_cod_indic || ' cod_func:  ' || v_cod_func ||
                          ' erro: ' || sqlerrm;

          -- logar tabela
          v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                    p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                    p_num_ano   => p_num_ano,
                                                    p_num_mes   => p_num_mes,
                                                    p_cod_fil   => v_cod_fil,
                                                    p_cod_func  => v_cod_func,
                                                    p_cod_indic => v_cod_indic,
                                                    p_erro      => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --VENDAS

      --#####################################################################
      --CARGO DE PSF
      --#####################################################################
      begin

        -- somar os resultados dos pesos das ponderacoes para todos os indicadores PSF
        for r_func_psf in c_func_psf(v_cod_fil, p_num_ano, p_num_mes) loop

          for r_indic_sistemico in c_indic_sistemico_psf loop

            v_cod_indic   := r_indic_sistemico.cod_indic;
            v_descr_indic := r_indic_sistemico.descr_indic;

            if v_descr_indic = 'ALAVANCADOR PARTICIPACAO DO CARTAO' then

              begin
                select sum(num_meta)
                    ,  sum(num_realz)
                    ,  sum(num_realz_x_meta) / count(*)
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_psf.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 20; --PARTICIPACAO DO CARTAO
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_psf.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_psf.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then
                v_vlr_premio_func_calc := (r_func_psf.vlr_premio * 15) / 100;
              else
                v_vlr_premio_func_calc := 0;
              end if;

            elsif v_descr_indic = 'ALAVANCADOR ATIVACAO DE CARTAO' then

              begin
                select sum(num_meta)
                     , sum(num_realz)
                     ,(sum(num_realz) / sum(num_meta)) * 100
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_psf.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 3; --ATIVACAO DE CARTAO
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_psf.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_psf.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then

                -------------------------------------------------------------------
                --Efetua o pagamento mediante ao atigimento do primeiro alavancador
                -------------------------------------------------------------------
                begin
                  select num_realz_x_meta
                    into v_num_realz_x_meta_limitador
                    from srv_realizado_func_indicador
                   where cod_func = r_func_psf.cod_func
                     and num_ano = p_num_ano
                     and num_mes = p_num_mes
                     and cod_indic = 526; --ALAVANCADOR PARTICIPACAO DO CARTAO
                exception
                  when others then
                    v_num_realz_x_meta_limitador := 0;
                end;
                -------------------------------------------------------------------
                if v_num_realz_x_meta_limitador >= 100 then
                  v_vlr_premio_func_calc := (r_func_psf.vlr_premio * 10) / 100;
                else
                  v_vlr_premio_func_calc := 0;
                end if;

              else

                v_vlr_premio_func_calc := 0;

              end if;

            elsif v_descr_indic = 'PPR' then

              begin
                select sum(vlr_premio_func_calc)
                  into v_vlr_premio_func_calc
                  from srv_realizado_func_indicador
                 where cod_func = r_func_psf.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic in (526, 527);

                v_meta             := null;
                v_num_realz        := null;
                v_num_realz_x_meta := null;

              exception
                when others then
                  v_meta                 := null;
                  v_num_realz            := null;
                  v_num_realz_x_meta     := null;
                  v_vlr_premio_func_calc := 0;
              end;

              v_vlr_premio_func_calc := v_vlr_premio_func_calc + r_func_psf.vlr_premio;

            end if;

            -- gravar na srv_realizado_func_indicador
            rec_srv_realizado_func_indic.cod_func                    := r_func_psf.cod_func;
            rec_srv_realizado_func_indic.cod_cargo                   := r_func_psf.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic                   := r_indic_sistemico.cod_indic;
            rec_srv_realizado_func_indic.cod_emp                     := r_fil.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                     := r_fil.cod_fil;
            rec_srv_realizado_func_indic.num_ano                     := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                     := p_num_mes;
            rec_srv_realizado_func_indic.cod_escala                  := 2;
            rec_srv_realizado_func_indic.num_seq_escala_fx           := null;
            rec_srv_realizado_func_indic.num_realz_fx                := null;
            rec_srv_realizado_func_indic.cod_un_realz_fx             := null;
            rec_srv_realizado_func_indic.cod_pond                    := null;
            rec_srv_realizado_func_indic.num_peso                    := null;
            rec_srv_realizado_func_indic.cod_un_peso                 := null;
            rec_srv_realizado_func_indic.num_realz_pond              := null;
            rec_srv_realizado_func_indic.cod_un_realz_pond           := null;
            rec_srv_realizado_func_indic.num_meta                    := v_meta;
            rec_srv_realizado_func_indic.cod_un_meta                 := 3;
            rec_srv_realizado_func_indic.num_realz                   := v_num_realz;
            rec_srv_realizado_func_indic.cod_un_realz                := 3;
            rec_srv_realizado_func_indic.num_realz_x_meta            := v_num_realz_x_meta;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta         := 2;
            rec_srv_realizado_func_indic.vlr_premio                  := r_func_psf.vlr_premio;
            rec_srv_realizado_func_indic.vlr_premio_func_calc        := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
            rec_srv_realizado_func_indic.pct_calc_rateio             := null;
            rec_srv_realizado_func_indic.dt_ini_sit_srv              := v_data;
            rec_srv_realizado_func_indic.cod_usuario                 := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                     := null;

            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi(p_rec_srv_realz_func_indic => rec_srv_realizado_func_indic,
                                           p_cod_erro                 => p_cod_erro,
                                           p_descr_erro               => p_descr_erro);
            --
            if p_cod_erro is not null then

              -- logar tabela
              v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                        p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                        p_num_ano   => p_num_ano,
                                                        p_num_mes   => p_num_mes,
                                                        p_cod_fil   => v_cod_fil,
                                                        p_cod_func  => r_func_psf.cod_func,
                                                        p_cod_indic => v_cod_indic,
                                                        p_erro      => p_cod_erro || ' - ' || p_descr_erro);
            end if;

          end loop;

        -- c_indic_sistemico AGRUPAMENTO LIDER PSF
        end loop;

        -- commit por indicador
        commit;

      exception
        when others then
          p_cod_erro   := 1;
          p_descr_erro := 'Erro Geral ao calcular O AGRUPAMENTO PSF Lideranca Loja' ||
                          ' cod_fil:  ' || v_cod_fil || ' cod_indic:  ' ||
                          v_cod_indic || ' cod_func:  ' || v_cod_func ||
                          ' erro: ' || sqlerrm;

          -- logar tabela
          v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                    p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                    p_num_ano   => p_num_ano,
                                                    p_num_mes   => p_num_mes,
                                                    p_cod_fil   => v_cod_fil,
                                                    p_cod_func  => v_cod_func,
                                                    p_cod_indic => v_cod_indic,
                                                    p_erro      => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --PSF

      --#####################################################################
      --CARGO DE OPERACIONAL
      --#####################################################################
      begin

        -- somar os resultados dos pesos das ponderacoes para todos os indicadores VENDAS
        for r_func_operacional in c_func_operacional(v_cod_fil, p_num_ano, p_num_mes) loop

          for r_indic_sistemico in c_indic_sistemico_operacional loop

            v_cod_indic   := r_indic_sistemico.cod_indic;
            v_descr_indic := r_indic_sistemico.descr_indic;

            if v_descr_indic = 'ALAVANCADOR VENDAS' then

              begin
                select sum(num_meta)
                     , sum(num_realz)
                     , (sum(num_realz) / sum(num_meta)) * 100
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_operacional.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 1; --VENDAS
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_operacional.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_operacional.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then
                v_vlr_premio_func_calc := (r_func_operacional.vlr_premio * 15) / 100;
              else
                v_vlr_premio_func_calc := 0;
              end if;

            elsif v_descr_indic = 'PPR' then

              begin
                select sum(vlr_premio_func_calc)
                  into v_vlr_premio_func_calc
                  from srv_realizado_func_indicador
                 where cod_func = r_func_operacional.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic in (524);

                v_meta             := null;
                v_num_realz        := null;
                v_num_realz_x_meta := null;

              exception
                when others then
                  v_meta                 := null;
                  v_num_realz            := null;
                  v_num_realz_x_meta     := null;
                  v_vlr_premio_func_calc := 0;
              end;

              v_vlr_premio_func_calc := v_vlr_premio_func_calc + r_func_operacional.vlr_premio;

            end if;

            -- gravar na srv_realizado_func_indicador
            rec_srv_realizado_func_indic.cod_func                    := r_func_operacional.cod_func;
            rec_srv_realizado_func_indic.cod_cargo                   := r_func_operacional.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic                   := r_indic_sistemico.cod_indic;
            rec_srv_realizado_func_indic.cod_emp                     := r_fil.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                     := r_fil.cod_fil;
            rec_srv_realizado_func_indic.num_ano                     := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                     := p_num_mes;
            rec_srv_realizado_func_indic.cod_escala                  := 3;
            rec_srv_realizado_func_indic.num_seq_escala_fx           := null;
            rec_srv_realizado_func_indic.num_realz_fx                := null;
            rec_srv_realizado_func_indic.cod_un_realz_fx             := null;
            rec_srv_realizado_func_indic.cod_pond                    := null;
            rec_srv_realizado_func_indic.num_peso                    := null;
            rec_srv_realizado_func_indic.cod_un_peso                 := null;
            rec_srv_realizado_func_indic.num_realz_pond              := null;
            rec_srv_realizado_func_indic.cod_un_realz_pond           := null;
            rec_srv_realizado_func_indic.num_meta                    := v_meta;
            rec_srv_realizado_func_indic.cod_un_meta                 := 3;
            rec_srv_realizado_func_indic.num_realz                   := v_num_realz;
            rec_srv_realizado_func_indic.cod_un_realz                := 3;
            rec_srv_realizado_func_indic.num_realz_x_meta            := v_num_realz_x_meta;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta         := 2;
            rec_srv_realizado_func_indic.vlr_premio                  := r_func_operacional.vlr_premio;
            rec_srv_realizado_func_indic.vlr_premio_func_calc        := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
            rec_srv_realizado_func_indic.pct_calc_rateio             := null;
            rec_srv_realizado_func_indic.dt_ini_sit_srv              := v_data;
            rec_srv_realizado_func_indic.cod_usuario                 := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                     := null;

            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi(p_rec_srv_realz_func_indic => rec_srv_realizado_func_indic,
                                           p_cod_erro                 => p_cod_erro,
                                           p_descr_erro               => p_descr_erro);
            --
            if p_cod_erro is not null then

              -- logar tabela
              v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                        p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                        p_num_ano   => p_num_ano,
                                                        p_num_mes   => p_num_mes,
                                                        p_cod_fil   => v_cod_fil,
                                                        p_cod_func  => r_func_operacional.cod_func,
                                                        p_cod_indic => v_cod_indic,
                                                        p_erro      => p_cod_erro || ' - ' || p_descr_erro);
            end if;

          end loop;

        -- c_indic_sistemico AGRUPAMENTO LIDER PSF
        end loop;

        -- commit por indicador
        commit;

        --
      exception
        when others then
          p_cod_erro   := 1;
          p_descr_erro := 'Erro Geral ao calcular O AGRUPAMENTO PSF Lideranca Loja' ||
                          ' cod_fil:  ' || v_cod_fil || ' cod_indic:  ' ||
                          v_cod_indic || ' cod_func:  ' || v_cod_func ||
                          ' erro: ' || sqlerrm;

          -- logar tabela
          v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                    p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                    p_num_ano   => p_num_ano,
                                                    p_num_mes   => p_num_mes,
                                                    p_cod_fil   => v_cod_fil,
                                                    p_cod_func  => v_cod_func,
                                                    p_cod_indic => v_cod_indic,
                                                    p_erro      => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --Operacional

      --#####################################################################
      --CARGO ASSIST ADM
      --#####################################################################
      begin

        -- somar os resultados dos pesos das ponderacoes para todos os indicadores VENDAS
        for r_func_assist_adm in c_func_assist_adm(v_cod_fil, p_num_ano, p_num_mes) loop

          for r_indic_sistemico in c_indic_sistemico_assist_adm loop

            v_cod_indic   := r_indic_sistemico.cod_indic;
            v_descr_indic := r_indic_sistemico.descr_indic;

            if v_descr_indic = 'ALAVANCADOR VENDAS' then

              begin
                select sum(num_meta)
                     , sum(num_realz)
                     ,(sum(num_realz) / sum(num_meta)) * 100
                  into v_meta
                     , v_num_realz
                     , v_num_realz_x_meta
                  from srv_realizado_func_indicador
                 where cod_func = r_func_assist_adm.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic = 1; --VENDAS
              exception
                when others then
                  v_meta             := 0;
                  v_num_realz        := 0;
                  v_num_realz_x_meta := 0;
              end;

              if r_func_assist_adm.cod_func_n_elegivel is not null then
                v_num_realz_x_meta := 0;
                --r_func_assist_adm.vlr_premio := 0;
              end if;

              if v_num_realz_x_meta >= 100 then
                v_vlr_premio_func_calc := (r_func_assist_adm.vlr_premio * 15) / 100;
              else
                v_vlr_premio_func_calc := 0;
              end if;

            elsif v_descr_indic = 'PPR' then

              begin
                select sum(vlr_premio_func_calc)
                  into v_vlr_premio_func_calc
                  from srv_realizado_func_indicador
                 where cod_func = r_func_assist_adm.cod_func
                   and num_ano = p_num_ano
                   and num_mes between (p_num_mes - 2) and p_num_mes
                   and cod_indic in (524);

                v_meta             := null;
                v_num_realz        := null;
                v_num_realz_x_meta := null;

              exception
                when others then
                  v_meta                 := null;
                  v_num_realz            := null;
                  v_num_realz_x_meta     := null;
                  v_vlr_premio_func_calc := 0;
              end;

              v_vlr_premio_func_calc := v_vlr_premio_func_calc + r_func_assist_adm.vlr_premio;

            end if;

            -- gravar na srv_realizado_func_indicador
            rec_srv_realizado_func_indic.cod_func                    := r_func_assist_adm.cod_func;
            rec_srv_realizado_func_indic.cod_cargo                   := r_func_assist_adm.cod_cargo;
            rec_srv_realizado_func_indic.cod_indic                   := r_indic_sistemico.cod_indic;
            rec_srv_realizado_func_indic.cod_emp                     := r_fil.cod_emp;
            rec_srv_realizado_func_indic.cod_fil                     := r_fil.cod_fil;
            rec_srv_realizado_func_indic.num_ano                     := p_num_ano;
            rec_srv_realizado_func_indic.num_mes                     := p_num_mes;
            rec_srv_realizado_func_indic.cod_escala                  := 4;
            rec_srv_realizado_func_indic.num_seq_escala_fx           := null;
            rec_srv_realizado_func_indic.num_realz_fx                := null;
            rec_srv_realizado_func_indic.cod_un_realz_fx             := null;
            rec_srv_realizado_func_indic.cod_pond                    := null;
            rec_srv_realizado_func_indic.num_peso                    := null;
            rec_srv_realizado_func_indic.cod_un_peso                 := null;
            rec_srv_realizado_func_indic.num_realz_pond              := null;
            rec_srv_realizado_func_indic.cod_un_realz_pond           := null;
            rec_srv_realizado_func_indic.num_meta                    := v_meta;
            rec_srv_realizado_func_indic.cod_un_meta                 := 3;
            rec_srv_realizado_func_indic.num_realz                   := v_num_realz;
            rec_srv_realizado_func_indic.cod_un_realz                := 3;
            rec_srv_realizado_func_indic.num_realz_x_meta            := v_num_realz_x_meta;
            rec_srv_realizado_func_indic.cod_un_realz_x_meta         := 2;
            rec_srv_realizado_func_indic.vlr_premio                  := r_func_assist_adm.vlr_premio;
            rec_srv_realizado_func_indic.vlr_premio_func_calc        := v_vlr_premio_func_calc;
            rec_srv_realizado_func_indic.cod_un_vlr_premio_func_calc := 1; -- unidade VALOR
            rec_srv_realizado_func_indic.pct_calc_rateio             := null;
            rec_srv_realizado_func_indic.dt_ini_sit_srv              := v_data;
            rec_srv_realizado_func_indic.cod_usuario                 := p_cod_usuario;
            rec_srv_realizado_func_indic.seg_fil                     := null;

            -- alteracao, manter apenas um registro para o funcionario se a filial mudou
            prc_ins_realz_func_indic_ultfi(p_rec_srv_realz_func_indic => rec_srv_realizado_func_indic,
                                           p_cod_erro                 => p_cod_erro,
                                           p_descr_erro               => p_descr_erro);
            --
            if p_cod_erro is not null then

              -- logar tabela
              v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                        p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                        p_num_ano   => p_num_ano,
                                                        p_num_mes   => p_num_mes,
                                                        p_cod_fil   => v_cod_fil,
                                                        p_cod_func  => r_func_assist_adm.cod_func,
                                                        p_cod_indic => v_cod_indic,
                                                        p_erro      => p_cod_erro || ' - ' || p_descr_erro);
            end if;

          end loop;

        -- c_indic_sistemico ASSIST ADM
        end loop;

        -- commit por indicador
        commit;
        --
      exception
        when others then
          p_cod_erro   := 1;
          p_descr_erro := 'Erro Geral ao calcular o processo ASSIST ADM' ||
                          ' cod_fil:  ' || v_cod_fil || ' cod_indic:  ' ||
                          v_cod_indic || ' cod_func:  ' || v_cod_func ||
                          ' erro: ' || sqlerrm;

          -- logar tabela
          v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                    p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                    p_num_ano   => p_num_ano,
                                                    p_num_mes   => p_num_mes,
                                                    p_cod_fil   => v_cod_fil,
                                                    p_cod_func  => v_cod_func,
                                                    p_cod_indic => v_cod_indic,
                                                    p_erro      => p_cod_erro || ' - ' || p_descr_erro);
      end;
      --Assist ADM

      -- commit por filial
      commit;

    --FIM DO CURSOR FILIAL(c_fil)
    end loop;

    commit;

  exception
    when others then
      p_cod_erro   := 1;
      p_descr_erro := 'Erro geral na procedure prc_calc_realz_Func_Indic_Lj: ' || sqlerrm;

      -- logar tabela
      v_ins_log_erro := fnc_insere_log_processo(p_cod_proc  => 3,
                                                p_nome_proc => 'PRC_CALC_REALZ_FUNC_INDIC_LJ',
                                                p_num_ano   => p_num_ano,
                                                p_num_mes   => p_num_mes,
                                                p_cod_fil   => v_cod_fil,
                                                p_cod_func  => v_cod_func,
                                                p_cod_indic => v_cod_indic,
                                                p_erro      => p_cod_erro || ' - ' || p_descr_erro);

  end prc_calc_realz_ppr;

end pkg_srv_calc_rem_var;
/
